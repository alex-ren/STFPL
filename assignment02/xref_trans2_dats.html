<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    .atsyntax {color:#E80000;background-color:#E0E0E0}
    .atsyntax span.comment {color:#787878;font-style:italic}
    .atsyntax span.extern  {color:#A52A2A}
    .atsyntax span.keyword {color:#000000;font-weight:bold}
    .atsyntax span.neuexp  {color:#800080}
    .atsyntax span.staexp  {color:#0000FF}
    .atsyntax span.dynexp  {color:#E80000}
    .atsyntax span.prfexp  {color:#009000}
    .atsyntax span.stacstdec  {text-decoration:none}
    .atsyntax span.stacstuse  {color:#0000CF;text-decoration:underline}
    .atsyntax span.dyncstdec  {text-decoration:none}
    .atsyntax span.dyncstimp  {color:#B80000;text-decoration:underline}
    .atsyntax span.dyncstuse  {color:#B80000;text-decoration:underline}
    body {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre class="atsyntax">
<span class="comment">(*
** CAS CS525, Spring 2011
** Instructor: Hongwei Xi
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"trans1.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"trans2.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"error.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"symbol.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"libfunctions.sats"</span>

<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anon*)</span> <span class="keyword">=</span> "symbol.dats"</span>

<span class="keyword">typedef</span> <span class="staexp"><a name="239"><span class="stacstdec">opr <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fabsyn_2esats.html#1029"><span class="stacstuse">$Absyn<span class="keyword">.</span>opr</span></a></span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="264"><span class="stacstdec">loc <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fcontrib_2fparcomb_2fSATS_2fposloc_2esats.html#3210"><span class="stacstuse">$Posloc<span class="keyword">.</span>location_t</span></a></span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="297"><span class="stacstdec">symbol <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#88"><span class="stacstuse">$Symbol<span class="keyword">.</span>symbol_t</span></a></span></a></span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anon*)</span> <span class="keyword">=</span> "prelude/DATS/list.dats"</span> 
<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anon*)</span> <span class="keyword">=</span> "prelude/DATS/list0.dats"</span> 
<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anon*)</span> <span class="keyword">=</span> "prelude/DATS/reference.dats"</span> 

<span class="keyword">#define</span> <span class="neuexp">:: list0_cons</span>
<span class="keyword">#define</span> <span class="neuexp">cons list0_cons</span>
<span class="keyword">#define</span> <span class="neuexp">nil list0_nil</span>

<span class="keyword">#define</span> <span class="neuexp">Some0 option0_some</span>
<span class="keyword">#define</span> <span class="neuexp">None0 option0_none</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> list0_locate <span class="keyword">(</span>
  xs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#22196"><span class="stacstuse">list0</span></a> a</span><span class="keyword">,</span> pred<span class="keyword">:</span> <span class="staexp">a <span class="keyword">-&lt;</span>cloref1<span class="keyword">&gt;</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15152"><span class="stacstuse">bool</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#22670"><span class="stacstuse">option0</span></a> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15585"><span class="stacstuse">int</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#22196"><span class="stacstuse">list0</span></a> a</span><span class="keyword">,</span> pred<span class="keyword">:</span> <span class="staexp">a <span class="keyword">-&lt;</span>cloref1<span class="keyword">&gt;</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15152"><span class="stacstuse">bool</span></a></span><span class="keyword">,</span> accu<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15585"><span class="stacstuse">int</span></a></span><span class="keyword">)</span><span class="keyword">:</span> 
  <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#22670"><span class="stacstuse">option0</span></a> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15585"><span class="stacstuse">int</span></a></span> <span class="keyword">=</span> 
    <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>x<span class="keyword">,</span> xs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">if</span> pred <span class="keyword">(</span>x<span class="keyword">)</span> <span class="keyword">then</span> Some0 accu <span class="keyword">else</span> loop <span class="keyword">(</span>xs1<span class="keyword">,</span> pred<span class="keyword">,</span> accu + 1<span class="keyword">)</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None0
<span class="keyword">in</span>
  loop <span class="keyword">(</span>xs<span class="keyword">,</span> pred<span class="keyword">,</span> 0<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">fun</span> trans2_typlst <span class="keyword">(</span>t1yplst<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#631"><span class="stacstuse">t1yplst</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1761"><span class="stacstuse">t2yplst</span></a></span> <span class="keyword">=</span>
  <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2flist0_2esats.html#4772"><span class="dyncstuse">list0_map_fun</span></a> <span class="keyword">(</span>t1yplst<span class="keyword">,</span> <span class="keyword">lam</span> x <span class="keyword">=&gt;</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4239"><span class="dyncstuse">trans2_typ</span></a> x<span class="keyword">)</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4239"><span class="dyncstimp">trans2_typ</span></a> <span class="keyword">(</span>t1yp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> t1yp <span class="keyword">of</span>
  <span class="keyword">|</span> T1YPbase sym <span class="keyword">=&gt;</span> <span class="keyword">(</span>
    <span class="keyword">case+</span> 0 <span class="keyword">of</span> 
    <span class="keyword">|</span> _ <span class="keyword">when</span> sym <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#856"><span class="dyncstuse">symbol_BOOL</span></a> <span class="keyword">=&gt;</span> T2YPbool
    <span class="keyword">|</span> _ <span class="keyword">when</span> sym <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#909"><span class="dyncstuse">symbol_INT</span></a> <span class="keyword">=&gt;</span> T2YPint
    <span class="keyword">|</span> _ <span class="keyword">when</span> sym <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#959"><span class="dyncstuse">symbol_STRING</span></a> <span class="keyword">=&gt;</span> T2YPstr
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"trans2_typ unknown base type\n"<span class="keyword">,</span> 
      ETRACE_LEVEL_ERROR<span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ferror_2esats.html#120"><span class="dyncstuse">abort</span></a> <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">)</span>
  <span class="keyword">|</span> T1YPfun <span class="keyword">(</span>nargs_ref<span class="keyword">,</span> arg<span class="keyword">,</span> ret<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> t2yp_ret <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4239"><span class="dyncstuse">trans2_typ</span></a> <span class="keyword">(</span>ret<span class="keyword">)</span>
    <span class="keyword">val</span> t2yp_arg <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4239"><span class="dyncstuse">trans2_typ</span></a> <span class="keyword">(</span>arg<span class="keyword">)</span>    
    <span class="keyword">val</span> t2yp_args <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">if</span> <span class="keyword">!</span>nargs_ref <span class="keyword">=</span> 0 <span class="keyword">then</span> nil
                    <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">!</span>nargs_ref <span class="keyword">=</span> 1 <span class="keyword">then</span> cons <span class="keyword">(</span>t2yp_arg<span class="keyword">,</span> nil<span class="keyword">)</span>
                    <span class="keyword">else</span> <span class="keyword">(</span><span class="keyword">case+</span> t2yp_arg <span class="keyword">of</span>
                          <span class="keyword">|</span> T2YPtup <span class="keyword">(</span>t2yp_args<span class="keyword">)</span> <span class="keyword">=&gt;</span> t2yp_args
                          <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"trans2_typ must be tuple\n"<span class="keyword">,</span> 
                          ETRACE_LEVEL_ERROR<span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ferror_2esats.html#120"><span class="dyncstuse">abort</span></a> <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
                         <span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1761"><span class="stacstuse">t2yplst</span></a></span>
                    <span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1761"><span class="stacstuse">t2yplst</span></a></span>
 
    <span class="keyword">val</span> t2yp_args <span class="keyword">=</span> cons <span class="keyword">(</span>T2YPenv<span class="keyword">,</span> t2yp_args<span class="keyword">)</span>  <span class="comment">// add an extra type for first parameter
</span>    <span class="comment">// val () = fprint_string (stderr_ref, "\nnargs is " + 
</span>    <span class="comment">//   tostring_int !nargs_ref)
</span>  <span class="keyword">in</span>
    T2YPclo <span class="keyword">(</span><span class="keyword">!</span>nargs_ref + 1<span class="keyword">,</span> t2yp_args<span class="keyword">,</span> t2yp_ret<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> T1YPtup t1yplst <span class="keyword">=&gt;</span> T2YPtup <span class="keyword">(</span>trans2_typlst <span class="keyword">(</span>t1yplst<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">|</span> T1YPlist <span class="keyword">(</span>X<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> t <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#775"><span class="dyncstuse">t1Var_get_typ</span></a> <span class="keyword">(</span>X<span class="keyword">)</span>
    <span class="keyword">val</span> t2yp <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4239"><span class="dyncstuse">trans2_typ</span></a> t
  <span class="keyword">in</span>
    T2YPlist t2yp
  <span class="keyword">end</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"trans2_typ cannot process such t1yp\n"<span class="keyword">,</span> 
          ETRACE_LEVEL_ERROR<span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ferror_2esats.html#120"><span class="dyncstuse">abort</span></a> <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2586"><span class="dyncstimp">make_valprim</span></a> <span class="keyword">(</span>node<span class="keyword">,</span> typ<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  valprim_node <span class="keyword">=</span> node<span class="keyword">,</span>
  valprim_typ <span class="keyword">=</span> typ
<span class="keyword">}</span>

<span class="keyword">extern</span> <span class="keyword">val</span> <a name="2572"><span class="dyncstdec">tmpvar_void<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#382"><span class="stacstuse">tmpvar</span></a></span></span></a><span class="keyword">;</span>

<span class="keyword">fun</span> instr_add <span class="keyword">(</span>
  res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3403"><span class="stacstuse">instr</span></a></span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> res := list0_cons <span class="keyword">(</span>x<span class="keyword">,</span> res<span class="keyword">)</span>

<span class="keyword">fun</span> instr_make <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#264"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> ins_node<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2859"><span class="stacstuse">instr_node</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3403"><span class="stacstuse">instr</span></a></span> <span class="keyword">=</span> <span class="keyword">'{</span>
  instr_loc <span class="keyword">=</span> loc<span class="keyword">,</span> instr_node <span class="keyword">=</span> ins_node
<span class="keyword">}</span>  <span class="comment">// end of [instr_make]
</span>
<span class="comment">(* fully reverse *)</span>
<span class="keyword">fun</span> instr_reverse <span class="keyword">(</span>instrs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="keyword">(</span>instrs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span><span class="keyword">,</span> accu<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span> <span class="keyword">=</span>
    <span class="keyword">case+</span> instrs <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>instr<span class="keyword">,</span> instrs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> inode <span class="keyword">=</span> instr<span class="keyword">.</span>instr_node
      <span class="keyword">val</span> iloc <span class="keyword">=</span> instr<span class="keyword">.</span>instr_loc
    <span class="keyword">in</span>
      <span class="keyword">case+</span> inode <span class="keyword">of</span>
      <span class="keyword">|</span> INSTRcond <span class="keyword">(</span>tmpv<span class="keyword">,</span> typ<span class="keyword">,</span> vp<span class="keyword">,</span> ins_then<span class="keyword">,</span> ins_else<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> ins_then1 <span class="keyword">=</span> instr_reverse <span class="keyword">(</span>ins_then<span class="keyword">)</span>
        <span class="keyword">val</span> ins_else1 <span class="keyword">=</span> instr_reverse <span class="keyword">(</span>ins_else<span class="keyword">)</span>
        <span class="keyword">val</span> inode1 <span class="keyword">=</span> INSTRcond <span class="keyword">(</span>tmpv<span class="keyword">,</span> typ<span class="keyword">,</span> vp<span class="keyword">,</span> ins_then1<span class="keyword">,</span> ins_else1<span class="keyword">)</span>
        <span class="keyword">val</span> instr1 <span class="keyword">=</span> instr_make <span class="keyword">(</span>iloc<span class="keyword">,</span> inode1<span class="keyword">)</span>
        <span class="keyword">val</span> accu <span class="keyword">=</span> instr1 :: accu
      <span class="keyword">in</span>
        loop <span class="keyword">(</span>instrs1<span class="keyword">,</span> accu<span class="keyword">)</span>
      <span class="keyword">end</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> loop <span class="keyword">(</span>instrs1<span class="keyword">,</span> instr :: accu<span class="keyword">)</span>
    <span class="keyword">end</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> accu
<span class="keyword">in</span>
  loop <span class="keyword">(</span>instrs<span class="keyword">,</span> nil<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">local</span>  <span class="comment">// tmpvar
</span><span class="keyword">assume</span> <span class="staexp">tmpvar_t <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#88"><span class="stacstuse">symbol_t</span></a></span>
<span class="keyword">val</span> tmpvar_count <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2freference_2esats.html#2042"><span class="dyncstuse">ref&lt;</span></a><span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15585"><span class="stacstuse">int</span></a></span><span class="keyword">&gt;</span> <span class="keyword">(</span>0<span class="keyword">)</span>
<span class="keyword">val</span> tmpvar_prefix <span class="keyword">=</span> "v_"<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16164"><span class="stacstuse">string</span></a></span>
<span class="keyword">in</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#2572"><span class="dyncstimp">tmpvar_void</span></a> <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#222"><span class="dyncstuse">symbol_make_name</span></a> <span class="keyword">(</span>"dummy_void"<span class="keyword">)</span>
<span class="comment">// must be put here
</span><span class="keyword">val</span> valprim_void <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2586"><span class="dyncstuse">make_valprim</span></a> <span class="keyword">(</span>VPtup <span class="keyword">(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#2572"><span class="dyncstuse">tmpvar_void</span></a><span class="keyword">,</span> list0_nil<span class="keyword">)</span><span class="keyword">,</span> T2YPtup nil<span class="keyword">)</span>  

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#619"><span class="dyncstimp">tmpvar_new_anon</span></a> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> i <span class="keyword">=</span> <span class="keyword">!</span>tmpvar_count
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>tmpvar_count := i + 1

  <span class="keyword">val</span> id <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2finteger_2esats.html#5650"><span class="dyncstuse">tostring_int</span></a> <span class="keyword">(</span>i<span class="keyword">)</span>
  <span class="keyword">val</span> name <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2fstring_2esats.html#13074"><span class="dyncstuse">string0_append</span></a> <span class="keyword">(</span>tmpvar_prefix<span class="keyword">,</span> id<span class="keyword">)</span>
<span class="keyword">in</span>
  <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#222"><span class="dyncstuse">symbol_make_name</span></a> <span class="keyword">(</span>name<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#652"><span class="dyncstimp">tmpvar_new_v1ar</span></a> <span class="keyword">(</span>v<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> nam <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#180"><span class="dyncstuse">symbol_get_name</span></a> <span class="keyword">(</span>v<span class="keyword">.</span>v1ar_nam<span class="keyword">)</span>
<span class="keyword">in</span>
  <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#700"><span class="dyncstuse">tmpvar_new_string</span></a> <span class="keyword">(</span>nam<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#700"><span class="dyncstimp">tmpvar_new_string</span></a> <span class="keyword">(</span>str<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> i <span class="keyword">=</span> <span class="keyword">!</span>tmpvar_count
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>tmpvar_count := i + 1

  <span class="keyword">val</span> id <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2finteger_2esats.html#5650"><span class="dyncstuse">tostring_int</span></a> <span class="keyword">(</span>i<span class="keyword">)</span>
  <span class="keyword">val</span> fullname <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2fstring_2esats.html#13074"><span class="dyncstuse">string0_append</span></a> <span class="keyword">(</span>tmpvar_prefix<span class="keyword">,</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2fstring_2esats.html#13074"><span class="dyncstuse">string0_append</span></a> <span class="keyword">(</span>str<span class="keyword">,</span> id<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">in</span>
  <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#222"><span class="dyncstuse">symbol_make_name</span></a> <span class="keyword">(</span>fullname<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#746"><span class="dyncstimp">tmpvar_new_string_name</span></a> <span class="keyword">(</span>str<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="keyword">in</span>
  <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#222"><span class="dyncstuse">symbol_make_name</span></a> <span class="keyword">(</span>str<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#405"><span class="dyncstimp">tmpvar_get_name</span></a> <span class="keyword">(</span>v<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> ret <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#180"><span class="dyncstuse">symbol_get_name</span></a> <span class="keyword">(</span>v<span class="keyword">)</span>
<span class="keyword">in</span>
  ret
<span class="keyword">end</span>  
<span class="keyword">end</span> <span class="comment">// [end of local]
</span>
<span class="keyword">local</span>
  <span class="keyword">extern</span> <span class="keyword">castfn</span> <a name="4574"><span class="dyncstdec">valprim_encode <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2411"><span class="stacstuse">valprim</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#1304"><span class="stacstuse">valprim_t</span></a></span></span></a>
  <span class="keyword">extern</span> <span class="keyword">castfn</span> <a name="4629"><span class="dyncstdec">valprim_decode <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#1304"><span class="stacstuse">valprim_t</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2411"><span class="stacstuse">valprim</span></a></span></span></a>
<span class="keyword">in</span>
  <span class="keyword">fun</span> v1ar_get_val
    <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2299"><span class="stacstuse">v1ar</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#22670"><span class="stacstuse">option0</span></a> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2411"><span class="stacstuse">valprim</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> r <span class="keyword">=</span> x<span class="keyword">.</span>v1ar_val
  <span class="keyword">in</span>
    <span class="keyword">case+</span> <span class="keyword">!</span>r <span class="keyword">of</span>
    <span class="keyword">|</span> Some0 <span class="keyword">(</span>vp<span class="keyword">)</span> <span class="keyword">=&gt;</span> Some0 <span class="keyword">(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#4629"><span class="dyncstuse">valprim_decode</span></a> <span class="keyword">(</span>vp<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None0
  <span class="keyword">end</span> <span class="comment">// end of [v1ar_get_val]
</span>  
  <span class="keyword">fun</span> v1ar_set_val <span class="keyword">(</span>
    x<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2299"><span class="stacstuse">v1ar</span></a></span><span class="keyword">,</span> vp<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2411"><span class="stacstuse">valprim</span></a></span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> r <span class="keyword">=</span> x<span class="keyword">.</span>v1ar_val
    <span class="keyword">val</span> vp <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#4574"><span class="dyncstuse">valprim_encode</span></a> <span class="keyword">(</span>vp<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>r := Some0 <span class="keyword">(</span>vp<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="comment">// nothing
</span>  <span class="keyword">end</span> <span class="comment">// [v1ar_set_val]
</span>  
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="keyword">typedef</span> <span class="staexp"><a name="5104"><span class="stacstdec">funent <span class="keyword">=</span> <span class="keyword">'{</span>
  funent_fun <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#984"><span class="stacstuse">funlab_t</span></a>
<span class="keyword">,</span> funent_narg <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15585"><span class="stacstuse">int</span></a>
<span class="keyword">,</span> funent_args <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2534"><span class="stacstuse">valprimlst</span></a>
<span class="keyword">,</span> funent_body <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a>
<span class="keyword">,</span> funent_ret <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2411"><span class="stacstuse">valprim</span></a>
<span class="keyword">,</span> funent_env <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2534"><span class="stacstuse">valprimlst</span></a>
<span class="keyword">}</span></span></a></span>

<span class="keyword">assume</span> <span class="staexp">funent_t <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5104"><span class="stacstuse">funent</span></a></span>


<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3842"><span class="dyncstimp">funent_get_lab</span></a> <span class="keyword">(</span>ent<span class="keyword">)</span> <span class="keyword">=</span> ent<span class="keyword">.</span>funent_fun
<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3883"><span class="dyncstimp">funent_get_narg</span></a> <span class="keyword">(</span>ent<span class="keyword">)</span> <span class="keyword">=</span> ent<span class="keyword">.</span>funent_narg
<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3922"><span class="dyncstimp">funent_get_args</span></a> <span class="keyword">(</span>ent<span class="keyword">)</span> <span class="keyword">=</span> ent<span class="keyword">.</span>funent_args
<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3968"><span class="dyncstimp">funent_get_body</span></a> <span class="keyword">(</span>ent<span class="keyword">)</span> <span class="keyword">=</span> ent<span class="keyword">.</span>funent_body
<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4012"><span class="dyncstimp">funent_get_ret</span></a> <span class="keyword">(</span>ent<span class="keyword">)</span> <span class="keyword">=</span> ent<span class="keyword">.</span>funent_ret


<span class="comment">(* ***** ****** *)</span>

<span class="neuexp"><span class="keyword">symintr</span></span> funlab_make

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="5591"><span class="dyncstdec">funlab_make_anon <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1001"><span class="stacstuse">funlab</span></a></span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="5630"><span class="dyncstdec">funlab_make_name <span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2299"><span class="stacstuse">v1ar</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1001"><span class="stacstuse">funlab</span></a></span></span></a>  <span class="comment">// similar v1ar's lead to different names
</span>
<span class="neuexp"><span class="keyword">overload</span> funlab_make <span class="keyword">with</span> funlab_make_anon</span>
<span class="neuexp"><span class="keyword">overload</span> funlab_make <span class="keyword">with</span> funlab_make_name</span>

<span class="comment">(* ***** ****** *)</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4118"><span class="dyncstimp">funent_make</span></a> <span class="keyword">(</span>
  fl<span class="keyword">,</span> nargs<span class="keyword">,</span> args<span class="keyword">,</span> body<span class="keyword">,</span> ret<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  funent_fun <span class="keyword">=</span> fl<span class="keyword">,</span>
  funent_narg <span class="keyword">=</span> nargs<span class="keyword">,</span>
  funent_args <span class="keyword">=</span> args<span class="keyword">,</span>
  funent_body <span class="keyword">=</span> body<span class="keyword">,</span>
  funent_ret <span class="keyword">=</span> ret<span class="keyword">,</span>
  funent_env <span class="keyword">=</span> env
  <span class="keyword">}</span>

<span class="comment">(*
There is a global map for this function:
*)</span>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="6068"><span class="dyncstdec">funent_add <span class="keyword">(</span>fl<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1001"><span class="stacstuse">funlab</span></a></span><span class="keyword">,</span> ent<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5104"><span class="stacstuse">funent</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="6122"><span class="dyncstdec">funent_lookup <span class="keyword">(</span>fl<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1001"><span class="stacstuse">funlab</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5104"><span class="stacstuse">funent</span></a></span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="6168"><span class="dyncstdec">funent_getall <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#22196"><span class="stacstuse">list0</span></a> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5104"><span class="stacstuse">funent</span></a></span></span></a>

<span class="keyword">local</span>
<span class="keyword">val</span> funlab_count <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2freference_2esats.html#2042"><span class="dyncstuse">ref&lt;</span></a><span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15585"><span class="stacstuse">int</span></a></span><span class="keyword">&gt;</span> <span class="keyword">(</span>0<span class="keyword">)</span>
<span class="keyword">assume</span> <span class="staexp">funlab_t <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#88"><span class="stacstuse">symbol_t</span></a></span>
<span class="keyword">val</span> fun_table <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2freference_2esats.html#2042"><span class="dyncstuse">ref&lt;</span></a><span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#1634"><span class="stacstuse">symenv_t</span></a> <span class="keyword">(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5104"><span class="stacstuse">funent</span></a><span class="keyword">)</span></span><span class="keyword">&gt;</span> <span class="keyword">(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#1668"><span class="dyncstuse">symenv_make</span></a> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">val</span> fl_prefix <span class="keyword">=</span> "f_"<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16164"><span class="stacstuse">string</span></a></span>
<span class="keyword">in</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4055"><span class="dyncstimp">funlab_get_name</span></a> <span class="keyword">(</span>fl<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#180"><span class="dyncstuse">symbol_get_name</span></a> <span class="keyword">(</span>fl<span class="keyword">)</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5630"><span class="dyncstimp">funlab_make_name</span></a> <span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> nam <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#180"><span class="dyncstuse">symbol_get_name</span></a> <span class="keyword">(</span>f<span class="keyword">.</span>v1ar_nam<span class="keyword">)</span>
  <span class="keyword">val</span> i <span class="keyword">=</span> <span class="keyword">!</span>funlab_count
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>funlab_count := i + 1
  <span class="keyword">val</span> id <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2finteger_2esats.html#5650"><span class="dyncstuse">tostring_int</span></a> <span class="keyword">(</span>i<span class="keyword">)</span>
  <span class="keyword">val</span> fullname <span class="keyword">=</span> fl_prefix + nam + "_" + id
<span class="keyword">in</span>
  <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#222"><span class="dyncstuse">symbol_make_name</span></a> <span class="keyword">(</span>fullname<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5591"><span class="dyncstimp">funlab_make_anon</span></a> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> nam <span class="keyword">=</span> "lam"
  <span class="keyword">val</span> i <span class="keyword">=</span> <span class="keyword">!</span>funlab_count
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>funlab_count := i + 1
  <span class="keyword">val</span> id <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2finteger_2esats.html#5650"><span class="dyncstuse">tostring_int</span></a> <span class="keyword">(</span>i<span class="keyword">)</span>
  <span class="keyword">val</span> fullname <span class="keyword">=</span> fl_prefix + nam + "_" + id
<span class="keyword">in</span>
  <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#222"><span class="dyncstuse">symbol_make_name</span></a> <span class="keyword">(</span>fullname<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1024"><span class="dyncstimp">funlab_allocate</span></a> <span class="keyword">(</span>nam<span class="keyword">)</span> <span class="keyword">=</span>  nam

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#6068"><span class="dyncstimp">funent_add</span></a> <span class="keyword">(</span>fl<span class="keyword">,</span> ent<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> table <span class="keyword">=</span> <span class="keyword">!</span>fun_table
  <span class="keyword">val</span> table <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#1783"><span class="dyncstuse">symenv_insert</span></a> <span class="keyword">(</span>table<span class="keyword">,</span> fl<span class="keyword">,</span> ent<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>fun_table := table
<span class="keyword">in</span>
<span class="keyword">end</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#6168"><span class="dyncstimp">funent_getall</span></a> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> helper <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp"><span class="keyword">@(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#88"><span class="stacstuse">symbol_t</span></a><span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5104"><span class="stacstuse">funent</span></a><span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5104"><span class="stacstuse">funent</span></a></span> <span class="keyword">=</span> x<span class="keyword">.</span>1
  <span class="keyword">val</span> xs <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#2135"><span class="dyncstuse">symenv_listize&lt;</span></a><span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5104"><span class="stacstuse">funent</span></a></span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>fun_table<span class="keyword">)</span>
<span class="keyword">in</span>
  <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2flist0_2esats.html#4772"><span class="dyncstuse">list0_map_fun&lt;</span></a> <span class="staexp"><span class="keyword">@(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#88"><span class="stacstuse">symbol_t</span></a><span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5104"><span class="stacstuse">funent</span></a><span class="keyword">)</span></span><span class="keyword">&gt;&lt;</span><span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5104"><span class="stacstuse">funent</span></a></span><span class="keyword">&gt;</span> <span class="keyword">(</span>xs<span class="keyword">,</span> helper<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4097"><span class="dyncstimp">mainlab</span></a> <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#222"><span class="dyncstuse">symbol_make_name</span></a> <span class="keyword">(</span>"__main"<span class="keyword">)</span>

<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>
<span class="keyword">fun</span> instr_add_call <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#264"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> tmpv<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#382"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">,</span>
  vpf<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2411"><span class="stacstuse">valprim</span></a></span><span class="keyword">,</span> vpargs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2534"><span class="stacstuse">valprimlst</span></a></span><span class="keyword">,</span> typ<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1534"><span class="stacstuse">t2yp</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> ins_node <span class="keyword">=</span> INSTRcall <span class="keyword">(</span>tmpv<span class="keyword">,</span> vpf<span class="keyword">,</span> vpargs<span class="keyword">,</span> typ<span class="keyword">)</span>
  <span class="keyword">val</span> ins <span class="keyword">=</span> instr_make <span class="keyword">(</span>loc<span class="keyword">,</span> ins_node<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add <span class="keyword">(</span>res<span class="keyword">,</span> ins<span class="keyword">)</span>
<span class="keyword">in</span>
<span class="keyword">end</span>  <span class="comment">// end of [instr_add_call]
</span>
<span class="keyword">fun</span> instr_add_cond <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#264"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> tmpv<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#382"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">,</span> typ<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1534"><span class="stacstuse">t2yp</span></a></span><span class="keyword">,</span> vp_test<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2411"><span class="stacstuse">valprim</span></a></span><span class="keyword">,</span> 
  instr1<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span><span class="keyword">,</span> instr2<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> ins_node <span class="keyword">=</span> INSTRcond <span class="keyword">(</span>tmpv<span class="keyword">,</span> typ<span class="keyword">,</span> vp_test<span class="keyword">,</span> instr1<span class="keyword">,</span> instr2<span class="keyword">)</span>
  <span class="keyword">val</span> ins <span class="keyword">=</span> instr_make <span class="keyword">(</span>loc<span class="keyword">,</span> ins_node<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add <span class="keyword">(</span>res<span class="keyword">,</span> ins<span class="keyword">)</span>
<span class="keyword">in</span>
<span class="keyword">end</span>  <span class="comment">// end of [instr_add_cond]
</span>
<span class="keyword">fun</span> instr_add_move <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#264"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> tmpv<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#382"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">,</span> vp<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2411"><span class="stacstuse">valprim</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> ins_node <span class="keyword">=</span> INSTRmove_val <span class="keyword">(</span>tmpv<span class="keyword">,</span> vp<span class="keyword">)</span>
  <span class="keyword">val</span> ins <span class="keyword">=</span> instr_make <span class="keyword">(</span>loc<span class="keyword">,</span> ins_node<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add <span class="keyword">(</span>res<span class="keyword">,</span> ins<span class="keyword">)</span>
<span class="keyword">in</span>
<span class="keyword">end</span>  <span class="comment">// end of [instr_add_move]
</span>
<span class="keyword">fun</span> instr_add_opr <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#264"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> tmpv<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#382"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">,</span> typ<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1534"><span class="stacstuse">t2yp</span></a></span><span class="keyword">,</span> opr<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#239"><span class="stacstuse">opr</span></a></span><span class="keyword">,</span> 
  vps<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2534"><span class="stacstuse">valprimlst</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> ins_node <span class="keyword">=</span> INSTRopr <span class="keyword">(</span>tmpv<span class="keyword">,</span> typ<span class="keyword">,</span> opr<span class="keyword">,</span> vps<span class="keyword">)</span>
  <span class="keyword">val</span> ins <span class="keyword">=</span> instr_make <span class="keyword">(</span>loc<span class="keyword">,</span> ins_node<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add <span class="keyword">(</span>res<span class="keyword">,</span> ins<span class="keyword">)</span>
<span class="keyword">in</span>
<span class="keyword">end</span>  <span class="comment">// end of [instr_add_opr]
</span>
<span class="keyword">fun</span> instr_add_tup <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#264"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> tmpv<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#382"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">,</span>
  vps<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2534"><span class="stacstuse">valprimlst</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> ins_node <span class="keyword">=</span> INSTRtup <span class="keyword">(</span>tmpv<span class="keyword">,</span> vps<span class="keyword">)</span>
  <span class="keyword">val</span> ins <span class="keyword">=</span> instr_make <span class="keyword">(</span>loc<span class="keyword">,</span> ins_node<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add <span class="keyword">(</span>res<span class="keyword">,</span> ins<span class="keyword">)</span>
<span class="keyword">in</span>
<span class="keyword">end</span>  <span class="comment">// end of [instr_add_tup]
</span>
<span class="keyword">fun</span> instr_add_proj <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#264"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> tmpv<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#382"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">,</span> typ<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1534"><span class="stacstuse">t2yp</span></a></span><span class="keyword">,</span>
  vp<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2411"><span class="stacstuse">valprim</span></a></span><span class="keyword">,</span> pos<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15585"><span class="stacstuse">int</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> ins_node <span class="keyword">=</span> INSTRproj <span class="keyword">(</span>tmpv<span class="keyword">,</span> typ<span class="keyword">,</span> vp<span class="keyword">,</span> pos<span class="keyword">)</span>
  <span class="keyword">val</span> ins <span class="keyword">=</span> instr_make <span class="keyword">(</span>loc<span class="keyword">,</span> ins_node<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add <span class="keyword">(</span>res<span class="keyword">,</span> ins<span class="keyword">)</span>
<span class="keyword">in</span>
<span class="keyword">end</span>  <span class="comment">// end of [instr_add_proj]
</span>
<span class="keyword">fun</span> instr_add_closure <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#264"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span>
  tmpvar<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#382"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">,</span> fl<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1001"><span class="stacstuse">funlab</span></a></span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2534"><span class="stacstuse">valprimlst</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> ins_node <span class="keyword">=</span> INSTRclosure <span class="keyword">(</span>tmpvar<span class="keyword">,</span> fl<span class="keyword">,</span> env<span class="keyword">)</span>
  <span class="keyword">val</span> ins <span class="keyword">=</span> instr_make <span class="keyword">(</span>loc<span class="keyword">,</span> ins_node<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add <span class="keyword">(</span>res<span class="keyword">,</span> ins<span class="keyword">)</span>
<span class="keyword">in</span>
<span class="keyword">end</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="9206"><span class="dyncstdec">aux_exp <span class="keyword">(</span>e<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#275"><span class="stacstuse">e1xp</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2411"><span class="stacstuse">valprim</span></a></span></span></a>

<span class="comment">(* ret is supposed to be used in the evaluation *)</span>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="9312"><span class="dyncstdec">aux_exp_ret <span class="keyword">(</span>e<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#275"><span class="stacstuse">e1xp</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">,</span> ret<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#382"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2411"><span class="stacstuse">valprim</span></a></span></span></a>

<span class="comment">(* this function only handle E1XPfixclo and E1XPlamclo and E1XPann *)</span>
<span class="comment">(* caller guarantees that e is a function *)</span>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="9499"><span class="dyncstdec">aux_exp_fun <span class="keyword">(</span>e<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#275"><span class="stacstuse">e1xp</span></a></span><span class="keyword">,</span> fl<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1001"><span class="stacstuse">funlab</span></a></span><span class="keyword">,</span> 
  res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">,</span> init_res<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2411"><span class="stacstuse">valprim</span></a></span></span></a>

<span class="keyword">fun</span> auxlst_exp <span class="keyword">(</span>
  es<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2182"><span class="stacstuse">e1xplst</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span></a></span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2534"><span class="stacstuse">valprimlst</span></a></span> <span class="keyword">=</span> <span class="keyword">case+</span> es <span class="keyword">of</span>
  <span class="keyword">|</span> list0_cons <span class="keyword">(</span>e<span class="keyword">,</span> es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> v <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9206"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span>
      <span class="keyword">val</span> vs <span class="keyword">=</span> auxlst_exp <span class="keyword">(</span>es<span class="keyword">,</span> res<span class="keyword">)</span>
    <span class="keyword">in</span>
      list0_cons <span class="keyword">(</span>v<span class="keyword">,</span> vs<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> list0_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> list0_nil <span class="keyword">(</span><span class="keyword">)</span>

<span class="keyword">fun</span> aux_v1ar_valprim <span class="keyword">(</span>v<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2299"><span class="stacstuse">v1ar</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2411"><span class="stacstuse">valprim</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> vp_opt <span class="keyword">=</span> v1ar_get_val <span class="keyword">(</span>v<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> vp_opt <span class="keyword">of</span>
  <span class="keyword">|</span> Some0 <span class="keyword">(</span>vp<span class="keyword">)</span> <span class="keyword">=&gt;</span> vp
  <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"aux_v1ar v1ar doesn't have valprim\n"<span class="keyword">,</span> 
      ETRACE_LEVEL_ERROR<span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ferror_2esats.html#120"><span class="dyncstuse">abort</span></a> <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">fun</span> aux_v1ar_get_fl <span class="keyword">(</span>v<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2299"><span class="stacstuse">v1ar</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#984"><span class="stacstuse">funlab_t</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> vp_opt <span class="keyword">=</span> v1ar_get_val <span class="keyword">(</span>v<span class="keyword">)</span>
  <span class="comment">// todo: add error
</span>  <span class="keyword">val-</span> Some0 <span class="keyword">(</span>vp<span class="keyword">)</span> <span class="keyword">=</span> vp_opt
  <span class="keyword">val</span> vp_node <span class="keyword">=</span> vp<span class="keyword">.</span>valprim_node
  <span class="keyword">val-</span> VPclo <span class="keyword">(</span>_<span class="keyword">,</span> fl<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=</span> vp_node
<span class="keyword">in</span>
  fl
<span class="keyword">end</span>

<span class="comment">(* get the content from v1ar *)</span>
<span class="keyword">fun</span> v1arlst_2_valprimlst <span class="keyword">(</span>cloargs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2482"><span class="stacstuse">v1arlst</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2534"><span class="stacstuse">valprimlst</span></a></span> <span class="keyword">=</span>
  <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2flist0_2esats.html#4848"><span class="dyncstuse">list0_map_cloref&lt;</span></a><span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2299"><span class="stacstuse">v1ar</span></a></span><span class="keyword">&gt;&lt;</span><span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2411"><span class="stacstuse">valprim</span></a></span><span class="keyword">&gt;</span> <span class="keyword">(</span>cloargs<span class="keyword">,</span> 
                     <span class="keyword">lam</span> x <span class="keyword">=&gt;</span> aux_v1ar_valprim <span class="keyword">(</span>x<span class="keyword">)</span><span class="keyword">)</span>

<span class="keyword">fun</span> v1arlst_set_tmpvar <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2482"><span class="stacstuse">v1arlst</span></a></span><span class="keyword">,</span> n<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15585"><span class="stacstuse">int</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15585"><span class="stacstuse">int</span></a></span> <span class="keyword">=</span>
  <span class="keyword">case+</span> xs <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> tmpvar <span class="keyword">=</span> tmpvar_new <span class="keyword">(</span>x<span class="keyword">)</span>
      <span class="keyword">val</span> vp_node <span class="keyword">=</span> VPtmp <span class="keyword">(</span>tmpvar<span class="keyword">)</span>
      <span class="keyword">val</span> vp_typ <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4239"><span class="dyncstuse">trans2_typ</span></a> <span class="keyword">(</span>x<span class="keyword">.</span>v1ar_typ<span class="keyword">)</span>
      <span class="keyword">val</span> vp <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2586"><span class="dyncstuse">make_valprim</span></a> <span class="keyword">(</span>vp_node<span class="keyword">,</span> vp_typ<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> v1ar_set_val <span class="keyword">(</span>x<span class="keyword">,</span> vp<span class="keyword">)</span>
    <span class="keyword">in</span>
      v1arlst_set_tmpvar <span class="keyword">(</span>xs<span class="keyword">,</span> n+1<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> n

<span class="keyword">fun</span> v1arlst_set_env <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2482"><span class="stacstuse">v1arlst</span></a></span><span class="keyword">,</span> n<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15585"><span class="stacstuse">int</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15585"><span class="stacstuse">int</span></a></span> <span class="keyword">=</span>
  <span class="keyword">case+</span> xs <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> vp_node <span class="keyword">=</span> VPenv <span class="keyword">(</span>n<span class="keyword">)</span>
      <span class="keyword">val</span> vp_typ <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4239"><span class="dyncstuse">trans2_typ</span></a> <span class="keyword">(</span>x<span class="keyword">.</span>v1ar_typ<span class="keyword">)</span>
      <span class="keyword">val</span> vp <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2586"><span class="dyncstuse">make_valprim</span></a> <span class="keyword">(</span>vp_node<span class="keyword">,</span> vp_typ<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> v1ar_set_val <span class="keyword">(</span>x<span class="keyword">,</span> vp<span class="keyword">)</span>
    <span class="keyword">in</span>
      v1arlst_set_env <span class="keyword">(</span>xs<span class="keyword">,</span> n+1<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> n

<span class="keyword">fun</span> v1arlst_set_valprimlst <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2482"><span class="stacstuse">v1arlst</span></a></span><span class="keyword">,</span> vps<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2534"><span class="stacstuse">valprimlst</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span>
  <span class="keyword">case+</span> <span class="keyword">(</span>xs<span class="keyword">,</span> vps<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">(</span>cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span><span class="keyword">,</span> cons <span class="keyword">(</span>vp<span class="keyword">,</span> vps<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> v1ar_set_val <span class="keyword">(</span>x<span class="keyword">,</span> vp<span class="keyword">)</span>
    <span class="keyword">in</span>
      v1arlst_set_valprimlst <span class="keyword">(</span>xs<span class="keyword">,</span> vps<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> <span class="keyword">(</span>nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">|</span> <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"v1arlst_set_valprimlst: not of the same length\n"<span class="keyword">,</span> 
      ETRACE_LEVEL_ERROR<span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ferror_2esats.html#120"><span class="dyncstuse">abort</span></a> <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>

<span class="comment">(* f is not in cloargs *)</span>
<span class="keyword">fun</span> aux_exp_fix_lab
  <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#264"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2299"><span class="stacstuse">v1ar</span></a></span><span class="keyword">,</span> v_args<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2482"><span class="stacstuse">v1arlst</span></a></span><span class="keyword">,</span> e_body<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#275"><span class="stacstuse">e1xp</span></a></span><span class="keyword">,</span> 
   fl<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1001"><span class="stacstuse">funlab</span></a></span><span class="keyword">,</span> cloargs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2482"><span class="stacstuse">v1arlst</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">,</span> init_res<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2411"><span class="stacstuse">valprim</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>

  <span class="comment">// add new instruction to res
</span>  <span class="keyword">val</span> cloargs_valprims <span class="keyword">=</span> v1arlst_2_valprimlst <span class="keyword">(</span>cloargs<span class="keyword">)</span>
  <span class="keyword">val</span> fl_nam <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4055"><span class="dyncstuse">funlab_get_name</span></a> <span class="keyword">(</span>fl<span class="keyword">)</span>
  <span class="keyword">val</span> f_tmpvar <span class="keyword">=</span> tmpvar_new <span class="keyword">(</span>fl_nam<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add_closure <span class="keyword">(</span>loc<span class="keyword">,</span> f_tmpvar<span class="keyword">,</span> fl<span class="keyword">,</span> cloargs_valprims<span class="keyword">,</span> res<span class="keyword">)</span>

  <span class="comment">// set parameters
</span>  <span class="keyword">val</span> nargs <span class="keyword">=</span> v1arlst_set_tmpvar <span class="keyword">(</span>v_args<span class="keyword">,</span> 0<span class="keyword">)</span>
  <span class="keyword">val</span> args_valprims <span class="keyword">=</span> v1arlst_2_valprimlst <span class="keyword">(</span>v_args<span class="keyword">)</span>

  <span class="comment">// reset cloargs
</span>  <span class="keyword">val</span> ncloargs <span class="keyword">=</span> v1arlst_set_env <span class="keyword">(</span>cloargs<span class="keyword">,</span> 0<span class="keyword">)</span>
  <span class="keyword">val</span> cloargs_valprims2 <span class="keyword">=</span> v1arlst_2_valprimlst <span class="keyword">(</span>cloargs<span class="keyword">)</span>

  <span class="comment">// add instructions to init_res
</span>  <span class="comment">// treat f specially, build an instruction for it
</span>  <span class="keyword">var</span> body_res<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span> <span class="keyword">=</span> init_res
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add_closure <span class="keyword">(</span>loc<span class="keyword">,</span> f_tmpvar<span class="keyword">,</span> fl<span class="keyword">,</span> cloargs_valprims2<span class="keyword">,</span> body_res<span class="keyword">)</span>

  <span class="keyword">val</span> f_fun_typ <span class="keyword">=</span> f<span class="keyword">.</span>v1ar_typ
  <span class="keyword">val</span> f_clo_typ <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4239"><span class="dyncstuse">trans2_typ</span></a> <span class="keyword">(</span>f_fun_typ<span class="keyword">)</span>
  <span class="keyword">val</span> f_clo_node <span class="keyword">=</span> VPclo <span class="keyword">(</span>f_tmpvar<span class="keyword">,</span> fl<span class="keyword">,</span> cloargs_valprims2<span class="keyword">)</span>
  <span class="keyword">val</span> vp_f <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2586"><span class="dyncstuse">make_valprim</span></a> <span class="keyword">(</span>f_clo_node<span class="keyword">,</span> f_clo_typ<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> v1ar_set_val <span class="keyword">(</span>f<span class="keyword">,</span> vp_f<span class="keyword">)</span>

  <span class="comment">// handle the body
</span>  <span class="keyword">val</span> vp_ret <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9206"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e_body<span class="keyword">,</span> body_res<span class="keyword">)</span>
  <span class="keyword">val</span> body_res <span class="keyword">=</span> instr_reverse <span class="keyword">(</span>body_res<span class="keyword">)</span>

  
  <span class="keyword">val</span> ncloargs <span class="keyword">=</span> v1arlst_set_tmpvar <span class="keyword">(</span>cloargs<span class="keyword">,</span> 0<span class="keyword">)</span>
  <span class="keyword">val</span> cloargs_valprims3 <span class="keyword">=</span> v1arlst_2_valprimlst <span class="keyword">(</span>cloargs<span class="keyword">)</span>
  <span class="comment">// add 1 to include the env though it's not in args_valprims
</span>  <span class="keyword">val</span> ent <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4118"><span class="dyncstuse">funent_make</span></a> <span class="keyword">(</span>fl<span class="keyword">,</span> nargs + 1<span class="keyword">,</span> args_valprims<span class="keyword">,</span> body_res<span class="keyword">,</span> 
                               vp_ret<span class="keyword">,</span> cloargs_valprims3<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#6068"><span class="dyncstuse">funent_add</span></a> <span class="keyword">(</span>fl<span class="keyword">,</span> ent<span class="keyword">)</span>

  <span class="comment">// Caution: turn it back
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> v1arlst_set_valprimlst <span class="keyword">(</span>cloargs<span class="keyword">,</span> cloargs_valprims<span class="keyword">)</span>

  <span class="keyword">val</span> f_clo_node <span class="keyword">=</span> VPclo <span class="keyword">(</span>f_tmpvar<span class="keyword">,</span> fl<span class="keyword">,</span> cloargs_valprims<span class="keyword">)</span>
  <span class="keyword">val</span> f_clo <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2586"><span class="dyncstuse">make_valprim</span></a> <span class="keyword">(</span>f_clo_node<span class="keyword">,</span> f_clo_typ<span class="keyword">)</span>
<span class="keyword">in</span>
  f_clo
<span class="keyword">end</span>

<span class="keyword">fun</span> aux_exp_lam_lab <span class="keyword">(</span>
  loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#264"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> v_args<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2482"><span class="stacstuse">v1arlst</span></a></span><span class="keyword">,</span> e_body<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#275"><span class="stacstuse">e1xp</span></a></span><span class="keyword">,</span> fl<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1001"><span class="stacstuse">funlab</span></a></span><span class="keyword">,</span>
  cloargs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2482"><span class="stacstuse">v1arlst</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">,</span> init_res<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2411"><span class="stacstuse">valprim</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ETRACE_MSG <span class="keyword">(</span>"aux_exp_lam_lab\n"<span class="keyword">,</span> ETRACE_LEVEL_DEBUG<span class="keyword">)</span>

  <span class="keyword">val</span> cloargs_valprims <span class="keyword">=</span> v1arlst_2_valprimlst <span class="keyword">(</span>cloargs<span class="keyword">)</span>
  <span class="keyword">val</span> fl_nam <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4055"><span class="dyncstuse">funlab_get_name</span></a> <span class="keyword">(</span>fl<span class="keyword">)</span>
  <span class="keyword">val</span> f_tmpvar <span class="keyword">=</span> tmpvar_new <span class="keyword">(</span>fl_nam<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add_closure <span class="keyword">(</span>loc<span class="keyword">,</span> f_tmpvar<span class="keyword">,</span> fl<span class="keyword">,</span> cloargs_valprims<span class="keyword">,</span> res<span class="keyword">)</span>

  <span class="comment">// set parameters
</span>  <span class="keyword">val</span> nargs <span class="keyword">=</span> v1arlst_set_tmpvar <span class="keyword">(</span>v_args<span class="keyword">,</span> 0<span class="keyword">)</span>
  <span class="keyword">val</span> args_valprims <span class="keyword">=</span> v1arlst_2_valprimlst <span class="keyword">(</span>v_args<span class="keyword">)</span>

  <span class="comment">// reset cloargs
</span>  <span class="keyword">val</span> ncloargs <span class="keyword">=</span> v1arlst_set_env <span class="keyword">(</span>cloargs<span class="keyword">,</span> 0<span class="keyword">)</span>

  <span class="comment">// handle the body
</span>  <span class="keyword">var</span> body_res<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span> <span class="keyword">=</span> init_res
  <span class="keyword">val</span> vp_ret <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9206"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e_body<span class="keyword">,</span> body_res<span class="keyword">)</span>
  <span class="keyword">val</span> body_res <span class="keyword">=</span> instr_reverse <span class="keyword">(</span>body_res<span class="keyword">)</span>

  <span class="keyword">val</span> ncloargs <span class="keyword">=</span> v1arlst_set_tmpvar <span class="keyword">(</span>cloargs<span class="keyword">,</span> 0<span class="keyword">)</span>
  <span class="keyword">val</span> cloargs_valprims2 <span class="keyword">=</span> v1arlst_2_valprimlst <span class="keyword">(</span>cloargs<span class="keyword">)</span>

  <span class="comment">// add 1
</span>  <span class="keyword">val</span> ent <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4118"><span class="dyncstuse">funent_make</span></a> <span class="keyword">(</span>fl<span class="keyword">,</span> nargs + 1<span class="keyword">,</span> args_valprims<span class="keyword">,</span> body_res<span class="keyword">,</span> vp_ret<span class="keyword">,</span> cloargs_valprims2<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#6068"><span class="dyncstuse">funent_add</span></a> <span class="keyword">(</span>fl<span class="keyword">,</span> ent<span class="keyword">)</span>

  <span class="comment">// Caution: turn it back
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> v1arlst_set_valprimlst <span class="keyword">(</span>cloargs<span class="keyword">,</span> cloargs_valprims<span class="keyword">)</span>

  <span class="keyword">val</span> t2yp_args <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2flist0_2esats.html#4772"><span class="dyncstuse">list0_map_fun&lt;</span></a><span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2411"><span class="stacstuse">valprim</span></a></span><span class="keyword">&gt;&lt;</span><span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1534"><span class="stacstuse">t2yp</span></a></span><span class="keyword">&gt;</span> <span class="keyword">(</span>args_valprims<span class="keyword">,</span> <span class="keyword">lam</span> x <span class="keyword">=&gt;</span> x<span class="keyword">.</span>valprim_typ<span class="keyword">)</span>
  <span class="keyword">val</span> t2yp_ret <span class="keyword">=</span> vp_ret<span class="keyword">.</span>valprim_typ
  <span class="comment">// add extra T2YPenv
</span>  <span class="keyword">val</span> f_clo_typ <span class="keyword">=</span> T2YPclo <span class="keyword">(</span>nargs + 1<span class="keyword">,</span> cons <span class="keyword">(</span>T2YPenv<span class="keyword">,</span> t2yp_args<span class="keyword">)</span><span class="keyword">,</span> t2yp_ret<span class="keyword">)</span>
  <span class="keyword">val</span> f_clo_node <span class="keyword">=</span> VPclo <span class="keyword">(</span>f_tmpvar<span class="keyword">,</span> fl<span class="keyword">,</span> cloargs_valprims<span class="keyword">)</span>
  <span class="keyword">val</span> f_clo <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2586"><span class="dyncstuse">make_valprim</span></a> <span class="keyword">(</span>f_clo_node<span class="keyword">,</span> f_clo_typ<span class="keyword">)</span>
<span class="keyword">in</span>
  f_clo
<span class="keyword">end</span>

<span class="comment">(* extern fun aux_exp (e: e1xp, res: &amp;instrlst): valprim *)</span>
<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9206"><span class="dyncstimp">aux_exp</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ETRACE_MSG <span class="keyword">(</span>"trans2_exp\n"<span class="keyword">,</span> ETRACE_LEVEL_DEBUG<span class="keyword">)</span>
<span class="keyword">in</span> <span class="keyword">(</span>
  <span class="keyword">case</span> e<span class="keyword">.</span>e1xp_node <span class="keyword">of</span>
  <span class="keyword">|</span> E1XPann <span class="keyword">(</span>e<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9206"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPapp <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> wrapper <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPbool b <span class="keyword">=&gt;</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2586"><span class="dyncstuse">make_valprim</span></a> <span class="keyword">(</span>VPbool <span class="keyword">(</span>b<span class="keyword">)</span><span class="keyword">,</span> T2YPbool<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPfix <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> fl <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5591"><span class="dyncstuse">funlab_make_anon</span></a> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">in</span>
    <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9499"><span class="dyncstuse">aux_exp_fun</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> fl<span class="keyword">,</span> res<span class="keyword">,</span> nil<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> E1XPif <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> wrapper <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPint i <span class="keyword">=&gt;</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2586"><span class="dyncstuse">make_valprim</span></a> <span class="keyword">(</span>VPint <span class="keyword">(</span>i<span class="keyword">)</span><span class="keyword">,</span> T2YPint<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPlam <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> fl <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5591"><span class="dyncstuse">funlab_make_anon</span></a> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">in</span>
    <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9499"><span class="dyncstuse">aux_exp_fun</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> fl<span class="keyword">,</span> res<span class="keyword">,</span> nil<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> E1XPlet <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> wrapper <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPopr <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> wrapper <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPproj <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> wrapper <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPstr <span class="keyword">(</span>str<span class="keyword">)</span> <span class="keyword">=&gt;</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2586"><span class="dyncstuse">make_valprim</span></a> <span class="keyword">(</span>VPstr <span class="keyword">(</span>str<span class="keyword">)</span><span class="keyword">,</span> T2YPstr<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPtup exps <span class="keyword">=&gt;</span> wrapper <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPvar v <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> vp_opt <span class="keyword">=</span> v1ar_get_val <span class="keyword">(</span>v<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> vp_opt <span class="keyword">of</span>
    <span class="keyword">|</span> Some0 <span class="keyword">(</span>vp<span class="keyword">)</span> <span class="keyword">=&gt;</span> vp
    <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> vp_opt <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2flibfunctions_2esats.html#1649"><span class="dyncstuse">libFunVPFind</span></a> <span class="keyword">(</span>v<span class="keyword">.</span>v1ar_nam<span class="keyword">)</span>  <span class="comment">// libaray function
</span>    <span class="keyword">in</span>
      <span class="keyword">case+</span> vp_opt <span class="keyword">of</span>
      <span class="keyword">|</span> Some0 vp <span class="keyword">=&gt;</span> vp
      <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"aux_exp v1ar doesn't have valprim\n"<span class="keyword">,</span> 
           ETRACE_LEVEL_ERROR<span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ferror_2esats.html#120"><span class="dyncstuse">abort</span></a> <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2411"><span class="stacstuse">valprim</span></a></span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span> wrapper <span class="keyword">(</span>e<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#275"><span class="stacstuse">e1xp</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2411"><span class="stacstuse">valprim</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
      <span class="keyword">val</span> tmp_ret <span class="keyword">=</span> tmpvar_new <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">in</span>
      <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9312"><span class="dyncstuse">aux_exp_ret</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">,</span> tmp_ret<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span><span class="keyword">end</span>

<span class="comment">// end of [aux_exp]
</span>
<span class="comment">(* ****** ****** *)</span>
<span class="keyword">fun</span> aux_exp_ret_if <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#264"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> e_test<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#275"><span class="stacstuse">e1xp</span></a></span><span class="keyword">,</span> e_then<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#275"><span class="stacstuse">e1xp</span></a></span><span class="keyword">,</span> oe_else<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2209"><span class="stacstuse">e1xpopt</span></a></span><span class="keyword">,</span> 
  res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">,</span> tmp_ret<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#382"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2411"><span class="stacstuse">valprim</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> v_test <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9206"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e_test<span class="keyword">,</span> res<span class="keyword">)</span>

  <span class="keyword">var</span> res_then<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span> <span class="keyword">=</span> list0_nil
  <span class="keyword">val</span> v_then <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9206"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e_then<span class="keyword">,</span> res_then<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add_move <span class="keyword">(</span>e_then<span class="keyword">.</span>e1xp_loc<span class="keyword">,</span> tmp_ret<span class="keyword">,</span> v_then<span class="keyword">,</span> res_then<span class="keyword">)</span>

  <span class="keyword">var</span> res_else<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span> <span class="keyword">=</span> list0_nil
  <span class="keyword">val</span> <span class="keyword">(</span>v_else<span class="keyword">,</span> loc_else<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> oe_else <span class="keyword">of</span>
    <span class="keyword">|</span> Some0 e_else <span class="keyword">=&gt;</span> <span class="keyword">(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9206"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e_else<span class="keyword">,</span> res_else<span class="keyword">)</span><span class="keyword">,</span> e_else<span class="keyword">.</span>e1xp_loc<span class="keyword">)</span>
    <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="comment">// val () = ETRACE_MSG ("aux_exp_ret_if -- else is none\n", ETRACE_LEVEL_DEBUG)
</span>    <span class="keyword">in</span>
      <span class="keyword">(</span>valprim_void<span class="keyword">,</span> e_then<span class="keyword">.</span>e1xp_loc<span class="keyword">)</span>  <span class="comment">// use the location of then
</span>    <span class="keyword">end</span>
    <span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add_move <span class="keyword">(</span>loc_else<span class="keyword">,</span> tmp_ret<span class="keyword">,</span> v_else<span class="keyword">,</span> res_else<span class="keyword">)</span>
  
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add_cond <span class="keyword">(</span>loc<span class="keyword">,</span> tmp_ret<span class="keyword">,</span> v_then<span class="keyword">.</span>valprim_typ<span class="keyword">,</span> 
                            v_test<span class="keyword">,</span> res_then<span class="keyword">,</span> res_else<span class="keyword">,</span> res<span class="keyword">)</span>
<span class="keyword">in</span>
  <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2586"><span class="dyncstuse">make_valprim</span></a> <span class="keyword">(</span>VPtmp <span class="keyword">(</span>tmp_ret<span class="keyword">)</span><span class="keyword">,</span> v_then<span class="keyword">.</span>valprim_typ<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">fun</span> aux_exp_ret_opr <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#264"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> opr<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#239"><span class="stacstuse">opr</span></a></span><span class="keyword">,</span> t1yp<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#258"><span class="stacstuse">t1yp</span></a></span><span class="comment">(*return typ*)</span><span class="keyword">,</span> 
  exps<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2182"><span class="stacstuse">e1xplst</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">,</span> tmp_ret<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#382"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2411"><span class="stacstuse">valprim</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> vps <span class="keyword">=</span> auxlst_exp <span class="keyword">(</span>exps<span class="keyword">,</span> res<span class="keyword">)</span>

  <span class="keyword">val</span> t2yp <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4239"><span class="dyncstuse">trans2_typ</span></a> <span class="keyword">(</span>t1yp<span class="keyword">)</span>

  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add_opr <span class="keyword">(</span>loc<span class="keyword">,</span> tmp_ret<span class="keyword">,</span> t2yp<span class="keyword">,</span> opr<span class="keyword">,</span> vps<span class="keyword">,</span> res<span class="keyword">)</span>

  <span class="keyword">val</span> opr_typ_opt <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2flibfunctions_2esats.html#1590"><span class="dyncstuse">libOprTypFind</span></a> <span class="keyword">(</span>opr<span class="keyword">)</span>
  <span class="keyword">val</span> opr_typ <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> opr_typ_opt <span class="keyword">of</span>
                <span class="keyword">|</span> Some0 opt_typ <span class="keyword">=&gt;</span> opt_typ
                <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"aux_exp_ret_opr: opr not found\n"<span class="keyword">,</span> 
                  ETRACE_LEVEL_ERROR<span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ferror_2esats.html#120"><span class="dyncstuse">abort</span></a> <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
                <span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#258"><span class="stacstuse">t1yp</span></a></span>
  <span class="keyword">val</span> ret_typ <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> opr_typ <span class="keyword">of</span>
                <span class="keyword">|</span> T1YPfun <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> ret_typ<span class="keyword">)</span> <span class="keyword">=&gt;</span> ret_typ
                <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"aux_exp_ret_opr opr should have function type\n"<span class="keyword">,</span> 
                  ETRACE_LEVEL_ERROR<span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ferror_2esats.html#120"><span class="dyncstuse">abort</span></a> <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
                <span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#258"><span class="stacstuse">t1yp</span></a></span>
  <span class="keyword">val</span> ret_typ <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4239"><span class="dyncstuse">trans2_typ</span></a> ret_typ <span class="comment">// so far, no opr returns closure
</span><span class="keyword">in</span>
  <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2586"><span class="dyncstuse">make_valprim</span></a> <span class="keyword">(</span>VPtmp <span class="keyword">(</span>tmp_ret<span class="keyword">)</span><span class="keyword">,</span> ret_typ<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="comment">(* generating init instructions for functions *)</span>
<span class="comment">(* initilize the recursively defined closures *)</span>
<span class="comment">(* r1: round 1 *)</span>
<span class="keyword">fun</span> aux_exp_v1aldeclst_rec_r1 <span class="keyword">(</span>v1aldecs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2700"><span class="stacstuse">v1aldeclst</span></a></span><span class="keyword">,</span> 
  init_res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span>
  <span class="keyword">case+</span> v1aldecs <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>v1aldec<span class="keyword">,</span> v1aldecs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> v <span class="keyword">=</span> v1aldec<span class="keyword">.</span>v1aldec_var
    <span class="keyword">val</span> e <span class="keyword">=</span> v1aldec<span class="keyword">.</span>v1aldec_def
    <span class="keyword">val</span> e_node <span class="keyword">=</span> e<span class="keyword">.</span>e1xp_node
    <span class="keyword">val</span> env_opt <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2955"><span class="dyncstuse">e1xp_node_fun_get_env</span></a> <span class="keyword">(</span>e_node<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> env_opt <span class="keyword">of</span>
      <span class="keyword">|</span> Some0 env <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="comment">// save the original content
</span>        <span class="keyword">val</span> cloargs_valprims_old <span class="keyword">=</span> v1arlst_2_valprimlst <span class="keyword">(</span>env<span class="keyword">)</span>
        <span class="comment">// set to new ones
</span>        <span class="keyword">val</span> ncloargs <span class="keyword">=</span> v1arlst_set_env <span class="keyword">(</span>env<span class="keyword">,</span> 0<span class="keyword">)</span>
        <span class="keyword">val</span> cloargs_valprims <span class="keyword">=</span> v1arlst_2_valprimlst <span class="keyword">(</span>env<span class="keyword">)</span>

        <span class="comment">// set the old one back
</span>        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> v1arlst_set_valprimlst <span class="keyword">(</span>env<span class="keyword">,</span> cloargs_valprims_old<span class="keyword">)</span>
        
        <span class="keyword">val</span> fl <span class="keyword">=</span> funlab_make <span class="keyword">(</span>v<span class="keyword">)</span>
        <span class="keyword">val</span> fl_nam <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4055"><span class="dyncstuse">funlab_get_name</span></a> <span class="keyword">(</span>fl<span class="keyword">)</span>
        <span class="keyword">val</span> f_tmpvar <span class="keyword">=</span> tmpvar_new <span class="keyword">(</span>fl_nam<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add_closure <span class="keyword">(</span>v1aldec<span class="keyword">.</span>v1aldec_loc<span class="keyword">,</span> f_tmpvar<span class="keyword">,</span> fl<span class="keyword">,</span>
              cloargs_valprims<span class="keyword">,</span> init_res<span class="keyword">)</span>

        <span class="keyword">val</span> f_fun_typ <span class="keyword">=</span> v<span class="keyword">.</span>v1ar_typ
        <span class="keyword">val</span> f_clo_typ <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4239"><span class="dyncstuse">trans2_typ</span></a> <span class="keyword">(</span>f_fun_typ<span class="keyword">)</span>
        <span class="keyword">val</span> f_clo_node <span class="keyword">=</span> VPclo <span class="keyword">(</span>f_tmpvar<span class="keyword">,</span> fl<span class="keyword">,</span> cloargs_valprims<span class="keyword">)</span>
        <span class="keyword">val</span> vp_f <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2586"><span class="dyncstuse">make_valprim</span></a> <span class="keyword">(</span>f_clo_node<span class="keyword">,</span> f_clo_typ<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> v1ar_set_val <span class="keyword">(</span>v<span class="keyword">,</span> vp_f<span class="keyword">)</span>
      <span class="keyword">in</span> <span class="keyword">end</span>
      <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span>
    <span class="keyword">in</span> 
      aux_exp_v1aldeclst_rec_r1 <span class="keyword">(</span>v1aldecs1<span class="keyword">,</span> init_res<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>

        
<span class="comment">(* translating each functions *)</span>
<span class="comment">(* r2: round 2 *)</span>
<span class="keyword">fun</span> aux_exp_v1aldeclst_rec_r2 <span class="keyword">(</span>v1aldecs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2700"><span class="stacstuse">v1aldeclst</span></a></span><span class="keyword">,</span> 
  res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">,</span> init_res<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2534"><span class="stacstuse">valprimlst</span></a></span> <span class="keyword">=</span>
  <span class="keyword">case+</span> v1aldecs <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>v1aldec<span class="keyword">,</span> v1aldecs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> v <span class="keyword">=</span> v1aldec<span class="keyword">.</span>v1aldec_var
    <span class="keyword">val</span> e <span class="keyword">=</span> v1aldec<span class="keyword">.</span>v1aldec_def
    <span class="keyword">val</span> e_node <span class="keyword">=</span> e<span class="keyword">.</span>e1xp_node
    <span class="keyword">val</span> fun_env_opt <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2955"><span class="dyncstuse">e1xp_node_fun_get_env</span></a> <span class="keyword">(</span>e_node<span class="keyword">)</span>
    <span class="keyword">val</span> vp <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> fun_env_opt <span class="keyword">of</span>
        <span class="keyword">|</span> Some0 env <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> fl <span class="keyword">=</span> aux_v1ar_get_fl <span class="keyword">(</span>v<span class="keyword">)</span>

          <span class="comment">// process the function
</span>          <span class="keyword">val</span> vp_fun <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9499"><span class="dyncstuse">aux_exp_fun</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> fl<span class="keyword">,</span> res<span class="keyword">,</span> init_res<span class="keyword">)</span>
        <span class="keyword">in</span>
          vp_fun
        <span class="keyword">end</span> 
        <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9312"><span class="dyncstuse">aux_exp_ret</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">,</span> tmpvar_new <span class="keyword">(</span>v<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2411"><span class="stacstuse">valprim</span></a></span>
  <span class="keyword">in</span>
    cons <span class="keyword">(</span>vp<span class="keyword">,</span> aux_exp_v1aldeclst_rec_r2 <span class="keyword">(</span>v1aldecs1<span class="keyword">,</span> res<span class="keyword">,</span> init_res<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> nil

<span class="comment">(* set the recursively defined v1ar by closure value *)</span>
<span class="comment">(* r3: round 3 *)</span>
<span class="keyword">fun</span> aux_exp_v1aldeclst_rec_r3 <span class="keyword">(</span>v1aldecs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2700"><span class="stacstuse">v1aldeclst</span></a></span><span class="keyword">,</span> 
  valprims<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2534"><span class="stacstuse">valprimlst</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span>
  <span class="keyword">case+</span> <span class="keyword">(</span>v1aldecs<span class="keyword">,</span> valprims<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">(</span>cons <span class="keyword">(</span>v1aldec<span class="keyword">,</span> v1aldecs1<span class="keyword">)</span><span class="keyword">,</span> cons <span class="keyword">(</span>vp<span class="keyword">,</span> vps1<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> v1ar_set_val <span class="keyword">(</span>v1aldec<span class="keyword">.</span>v1aldec_var<span class="keyword">,</span> vp<span class="keyword">)</span>
  <span class="keyword">in</span>
    aux_exp_v1aldeclst_rec_r3 <span class="keyword">(</span>v1aldecs1<span class="keyword">,</span> vps1<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> <span class="keyword">(</span>nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">|</span> <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"aux_exp_v1aldeclst_rec_r3 length not match\n"<span class="keyword">,</span> 
           ETRACE_LEVEL_ERROR<span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ferror_2esats.html#120"><span class="dyncstuse">abort</span></a> <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>

<span class="keyword">fun</span> aux_exp_v1aldeclst_rec <span class="keyword">(</span>v1aldecs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2700"><span class="stacstuse">v1aldeclst</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ETRACE_MSG <span class="keyword">(</span>"aux_exp_v1aldeclst_rec\n"<span class="keyword">,</span> ETRACE_LEVEL_DEBUG<span class="keyword">)</span>
  <span class="keyword">var</span> init_res<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span> <span class="keyword">=</span> nil
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux_exp_v1aldeclst_rec_r1 <span class="keyword">(</span>v1aldecs<span class="keyword">,</span> init_res<span class="keyword">)</span>
  <span class="keyword">val</span> vps <span class="keyword">=</span> aux_exp_v1aldeclst_rec_r2 <span class="keyword">(</span>v1aldecs<span class="keyword">,</span> res<span class="keyword">,</span> init_res<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux_exp_v1aldeclst_rec_r3 <span class="keyword">(</span>v1aldecs<span class="keyword">,</span> vps<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">fun</span> aux_exp_v1aldeclst_norec <span class="keyword">(</span>v1aldecs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2700"><span class="stacstuse">v1aldeclst</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ETRACE_MSG <span class="keyword">(</span>"aux_exp_v1aldeclst_norec\n"<span class="keyword">,</span> ETRACE_LEVEL_DEBUG<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> v1aldecs <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>v1aldec<span class="keyword">,</span> v1aldecs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> v <span class="keyword">=</span> v1aldec<span class="keyword">.</span>v1aldec_var
    <span class="keyword">val</span> e <span class="keyword">=</span> v1aldec<span class="keyword">.</span>v1aldec_def
    <span class="keyword">val</span> e_node <span class="keyword">=</span> e<span class="keyword">.</span>e1xp_node
    <span class="keyword">val</span> vp <span class="keyword">=</span> 
      <span class="keyword">if</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2907"><span class="dyncstuse">e1xp_node_is_fun</span></a> <span class="keyword">(</span>e_node<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fdyn_2esats.html#4313"><span class="dyncstuse">true</span></a> <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val</span> fl <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5630"><span class="dyncstuse">funlab_make_name</span></a> <span class="keyword">(</span>v<span class="keyword">)</span>
        <span class="keyword">val</span> vp_fun <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9499"><span class="dyncstuse">aux_exp_fun</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> fl<span class="keyword">,</span> res<span class="keyword">,</span> nil<span class="keyword">)</span> <span class="comment">// no init instructions
</span>      <span class="keyword">in</span> vp_fun <span class="keyword">end</span>
      <span class="keyword">else</span> <span class="keyword">let</span>
        <span class="keyword">val</span> vp <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9312"><span class="dyncstuse">aux_exp_ret</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">,</span> tmpvar_new <span class="keyword">(</span>v<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">in</span> vp <span class="keyword">end</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> v1ar_set_val <span class="keyword">(</span>v<span class="keyword">,</span> vp<span class="keyword">)</span>
  <span class="keyword">in</span>
    aux_exp_v1aldeclst_norec <span class="keyword">(</span>v1aldecs1<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">fun</span> aux_exp_d1eclst <span class="keyword">(</span>d1ecs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2579"><span class="stacstuse">d1eclst</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span>
  <span class="keyword">case+</span> d1ecs <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>d1ec<span class="keyword">,</span> d1ecs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val+</span> D1ECval <span class="keyword">(</span>isrec<span class="keyword">,</span> v1aldecs<span class="keyword">)</span> <span class="keyword">=</span> d1ec<span class="keyword">.</span>d1ec_node 

    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">if</span> isrec <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fdyn_2esats.html#4313"><span class="dyncstuse">true</span></a> <span class="keyword">then</span> aux_exp_v1aldeclst_rec <span class="keyword">(</span>v1aldecs<span class="keyword">,</span> res<span class="keyword">)</span>
             <span class="keyword">else</span> aux_exp_v1aldeclst_norec <span class="keyword">(</span>v1aldecs<span class="keyword">,</span> res<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">in</span>
    aux_exp_d1eclst <span class="keyword">(</span>d1ecs1<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>

<span class="keyword">fun</span> aux_exp_ret_let <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#264"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> d1ecs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2579"><span class="stacstuse">d1eclst</span></a></span><span class="keyword">,</span> e1xp<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#275"><span class="stacstuse">e1xp</span></a></span><span class="keyword">,</span> 
  res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">,</span> tmp_ret<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#382"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2411"><span class="stacstuse">valprim</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux_exp_d1eclst <span class="keyword">(</span>d1ecs<span class="keyword">,</span> res<span class="keyword">)</span>
<span class="keyword">in</span>
  <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9312"><span class="dyncstuse">aux_exp_ret</span></a> <span class="keyword">(</span>e1xp<span class="keyword">,</span> res<span class="keyword">,</span> tmp_ret<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">fun</span> aux_exp_ret_proj <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#264"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> e1xp<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#275"><span class="stacstuse">e1xp</span></a></span><span class="keyword">,</span> pos<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15585"><span class="stacstuse">int</span></a></span><span class="keyword">,</span> 
  res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">,</span> tmp_ret<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#382"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">,</span> t1yp<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#258"><span class="stacstuse">t1yp</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2411"><span class="stacstuse">valprim</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> t2yp <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4239"><span class="dyncstuse">trans2_typ</span></a> <span class="keyword">(</span>t1yp<span class="keyword">)</span>
  <span class="keyword">val</span> vp <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9206"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e1xp<span class="keyword">,</span> res<span class="keyword">)</span>

  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> 
    <span class="keyword">(</span><span class="keyword">case+</span> vp<span class="keyword">.</span>valprim_node <span class="keyword">of</span>  <span class="comment">// todo seems unnecessary
</span>    <span class="keyword">|</span> VPenv _ <span class="keyword">=&gt;</span> instr_add_proj <span class="keyword">(</span>loc<span class="keyword">,</span> tmp_ret<span class="keyword">,</span> t2yp<span class="keyword">,</span> vp<span class="keyword">,</span> pos<span class="keyword">,</span> res<span class="keyword">)</span>
    <span class="keyword">|</span> VPtmp _ <span class="keyword">=&gt;</span> instr_add_proj <span class="keyword">(</span>loc<span class="keyword">,</span> tmp_ret<span class="keyword">,</span> t2yp<span class="keyword">,</span> vp<span class="keyword">,</span> pos<span class="keyword">,</span> res<span class="keyword">)</span>
    <span class="keyword">|</span> VPtup _ <span class="keyword">=&gt;</span> instr_add_proj <span class="keyword">(</span>loc<span class="keyword">,</span> tmp_ret<span class="keyword">,</span> t2yp<span class="keyword">,</span> vp<span class="keyword">,</span> pos<span class="keyword">,</span> res<span class="keyword">)</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"aux_exp_ret_proj left part is not a tuple\n"<span class="keyword">,</span> 
           ETRACE_LEVEL_ERROR<span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ferror_2esats.html#120"><span class="dyncstuse">abort</span></a> <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">)</span>
<span class="keyword">in</span>
  <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2586"><span class="dyncstuse">make_valprim</span></a> <span class="keyword">(</span>VPtmp <span class="keyword">(</span>tmp_ret<span class="keyword">)</span><span class="keyword">,</span> t2yp<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">fun</span> aux_exp_ret_app <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#264"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> e_fun<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#275"><span class="stacstuse">e1xp</span></a></span><span class="keyword">,</span> e_arg<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#275"><span class="stacstuse">e1xp</span></a></span><span class="keyword">,</span>
  res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">,</span> tmp_ret<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#382"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">,</span> t1yp<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#258"><span class="stacstuse">t1yp</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2411"><span class="stacstuse">valprim</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="comment">// return type
</span>  <span class="keyword">val</span> t2yp <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4239"><span class="dyncstuse">trans2_typ</span></a> <span class="keyword">(</span>t1yp<span class="keyword">)</span>

  <span class="keyword">val</span> vp_clo <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9206"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e_fun<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">val</span> clo_typ <span class="keyword">=</span> vp_clo<span class="keyword">.</span>valprim_typ
  <span class="comment">// todo I am lazy now
</span>  <span class="keyword">val-</span> T2YPclo <span class="keyword">(</span>nargs<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=</span> clo_typ

  <span class="keyword">val</span> vp_arg <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9206"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e_arg<span class="keyword">,</span> res<span class="keyword">)</span>

  <span class="keyword">val</span> vp_args <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">if</span> nargs <span class="keyword">=</span> 2 <span class="comment">(*env has been counted in*)</span> 
         <span class="keyword">then</span> cons <span class="keyword">(</span>vp_arg<span class="keyword">,</span> nil<span class="keyword">)</span> <span class="keyword">else</span> 
           <span class="keyword">case+</span> vp_arg<span class="keyword">.</span>valprim_node <span class="keyword">of</span>
           <span class="keyword">|</span> VPtup <span class="keyword">(</span>_<span class="keyword">,</span> vp_args<span class="keyword">)</span> <span class="keyword">=&gt;</span> vp_args
           <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"aux_exp_ret_app argument is not tuple\n"<span class="keyword">,</span> 
           ETRACE_LEVEL_ERROR<span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ferror_2esats.html#120"><span class="dyncstuse">abort</span></a> <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
           <span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2534"><span class="stacstuse">valprimlst</span></a></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add_call <span class="keyword">(</span>loc<span class="keyword">,</span> tmp_ret<span class="keyword">,</span> vp_clo<span class="keyword">,</span> vp_args<span class="keyword">,</span> t2yp<span class="keyword">,</span> res<span class="keyword">)</span>
<span class="keyword">in</span>
  <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2586"><span class="dyncstuse">make_valprim</span></a> <span class="keyword">(</span>VPtmp <span class="keyword">(</span>tmp_ret<span class="keyword">)</span><span class="keyword">,</span> t2yp<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">fun</span> aux_exp_ret_tuple <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#264"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> e1xps<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2182"><span class="stacstuse">e1xplst</span></a></span><span class="keyword">,</span>
  res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">,</span> tmp_ret<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#382"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">,</span> t1yp<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#258"><span class="stacstuse">t1yp</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2411"><span class="stacstuse">valprim</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> t2yp <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4239"><span class="dyncstuse">trans2_typ</span></a> <span class="keyword">(</span>t1yp<span class="keyword">)</span>
  <span class="keyword">val</span> vps <span class="keyword">=</span> auxlst_exp <span class="keyword">(</span>e1xps<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add_tup <span class="keyword">(</span>loc<span class="keyword">,</span> tmp_ret<span class="keyword">,</span> vps<span class="keyword">,</span> res<span class="keyword">)</span>
<span class="keyword">in</span>
  <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2586"><span class="dyncstuse">make_valprim</span></a> <span class="keyword">(</span>VPtup <span class="keyword">(</span>tmp_ret<span class="keyword">,</span> vps<span class="keyword">)</span><span class="keyword">,</span> t2yp<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">implement</span>
<a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9312"><span class="dyncstimp">aux_exp_ret</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">,</span> ret<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> loc <span class="keyword">=</span> e<span class="keyword">.</span>e1xp_loc
  <span class="keyword">val</span> typ <span class="keyword">=</span> e<span class="keyword">.</span>e1xp_typ
  <span class="comment">// val () = ETRACE_MSG ("aux_exp_ret\n", ETRACE_LEVEL_DEBUG)
</span><span class="keyword">in</span>
  <span class="keyword">case</span> e<span class="keyword">.</span>e1xp_node <span class="keyword">of</span>
  <span class="keyword">|</span> E1XPann <span class="keyword">(</span>e<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9312"><span class="dyncstuse">aux_exp_ret</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">,</span> ret<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPapp <span class="keyword">(</span>e_fun<span class="keyword">,</span> e_arg<span class="keyword">)</span> <span class="keyword">=&gt;</span> aux_exp_ret_app <span class="keyword">(</span>loc<span class="keyword">,</span> e_fun<span class="keyword">,</span> e_arg<span class="keyword">,</span> res<span class="keyword">,</span> ret<span class="keyword">,</span> typ<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPbool _ <span class="keyword">=&gt;</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9206"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPfix <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"aux_exp_ret shouldn't handle E1XPfix\n"<span class="keyword">,</span> 
                    ETRACE_LEVEL_ERROR<span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ferror_2esats.html#120"><span class="dyncstuse">abort</span></a> <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">|</span> E1XPif <span class="keyword">(</span>e_test<span class="keyword">,</span> e_then<span class="keyword">,</span> oe_else<span class="keyword">)</span> <span class="keyword">=&gt;</span> 
    aux_exp_ret_if <span class="keyword">(</span>loc<span class="keyword">,</span> e_test<span class="keyword">,</span> e_then<span class="keyword">,</span> oe_else<span class="keyword">,</span> res<span class="keyword">,</span> ret<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPint _ <span class="keyword">=&gt;</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9206"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPlam <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"aux_exp_ret shouldn't handle E1XPlam\n"<span class="keyword">,</span> 
                    ETRACE_LEVEL_ERROR<span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ferror_2esats.html#120"><span class="dyncstuse">abort</span></a> <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">|</span> E1XPlet <span class="keyword">(</span>d1ecs<span class="keyword">,</span> e1xp<span class="keyword">)</span> <span class="keyword">=&gt;</span> aux_exp_ret_let <span class="keyword">(</span>loc<span class="keyword">,</span> d1ecs<span class="keyword">,</span> e1xp<span class="keyword">,</span> res<span class="keyword">,</span> ret<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPopr <span class="keyword">(</span>opr<span class="keyword">,</span> exps<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">in</span>
    aux_exp_ret_opr <span class="keyword">(</span>loc<span class="keyword">,</span> opr<span class="keyword">,</span> typ<span class="keyword">,</span> exps<span class="keyword">,</span> res<span class="keyword">,</span> ret<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> E1XPproj <span class="keyword">(</span>e1xp<span class="keyword">,</span> pos<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">in</span>
    aux_exp_ret_proj <span class="keyword">(</span>loc<span class="keyword">,</span> e1xp<span class="keyword">,</span> pos<span class="keyword">,</span> res<span class="keyword">,</span> ret<span class="keyword">,</span> typ<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> E1XPstr _ <span class="keyword">=&gt;</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9206"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPtup e1xps <span class="keyword">=&gt;</span> aux_exp_ret_tuple <span class="keyword">(</span>loc<span class="keyword">,</span> e1xps<span class="keyword">,</span> res<span class="keyword">,</span> ret<span class="keyword">,</span> typ<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPvar _ <span class="keyword">=&gt;</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9206"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="comment">(* extern fun aux_exp_fun (e: e1xp, fl: funlab): valprim *)</span>
<span class="comment">(* this function only handle E1XPfix and E1XPlam and E1XPann *)</span>
<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9499"><span class="dyncstimp">aux_exp_fun</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> fl<span class="keyword">,</span> res<span class="keyword">,</span> init_res<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ETRACE_MSG <span class="keyword">(</span>"aux_exp_lam_fun\n"<span class="keyword">,</span> ETRACE_LEVEL_DEBUG<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> e<span class="keyword">.</span>e1xp_node <span class="keyword">of</span>
  <span class="keyword">|</span> E1XPann <span class="keyword">(</span>e1<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9499"><span class="dyncstuse">aux_exp_fun</span></a> <span class="keyword">(</span>e1<span class="keyword">,</span> fl<span class="keyword">,</span> res<span class="keyword">,</span> init_res<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPfix <span class="keyword">(</span>f<span class="keyword">,</span> args<span class="keyword">,</span> body<span class="keyword">,</span> ref_env<span class="keyword">)</span> <span class="keyword">=&gt;</span> 
    aux_exp_fix_lab <span class="keyword">(</span>e<span class="keyword">.</span>e1xp_loc<span class="keyword">,</span> f<span class="keyword">,</span> args<span class="keyword">,</span> body<span class="keyword">,</span> fl<span class="keyword">,</span> <span class="keyword">!</span>ref_env<span class="keyword">,</span> res<span class="keyword">,</span> init_res<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPlam <span class="keyword">(</span>args<span class="keyword">,</span> body<span class="keyword">,</span> ref_env<span class="keyword">)</span> <span class="keyword">=&gt;</span> 
    aux_exp_lam_lab <span class="keyword">(</span>e<span class="keyword">.</span>e1xp_loc<span class="keyword">,</span> args<span class="keyword">,</span> body<span class="keyword">,</span> fl<span class="keyword">,</span> <span class="keyword">!</span>ref_env<span class="keyword">,</span> res<span class="keyword">,</span> init_res<span class="keyword">)</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"aux_exp_fun handle non-function\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span>
                    <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ferror_2esats.html#120"><span class="dyncstuse">abort</span></a> <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span>
<span class="comment">(* ****** ****** *)</span>


<span class="comment">(*
trans2_exp (e: e1xp): instrlst
*)</span>
<span class="keyword">implement</span>
<a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3788"><span class="dyncstimp">trans2_exp</span></a> <span class="keyword">(</span>e<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ETRACE_MSG <span class="keyword">(</span>"trans2_exp\n"<span class="keyword">,</span> ETRACE_LEVEL_DEBUG<span class="keyword">)</span>

  <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span> <span class="keyword">=</span> list0_nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">var</span> env<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2482"><span class="stacstuse">v1arlst</span></a></span> <span class="keyword">=</span> list0_nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> v <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#9206"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="comment">(* reverse the main let *)</span>
  <span class="keyword">val</span> res <span class="keyword">=</span> instr_reverse <span class="keyword">(</span>res<span class="keyword">)</span>

  <span class="keyword">val</span> fns <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#6168"><span class="dyncstuse">funent_getall</span></a> <span class="keyword">(</span><span class="keyword">)</span>

<span class="keyword">in</span>
  <span class="keyword">(</span>res<span class="keyword">,</span> fns<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="comment">(* ****** ****** *)</span>
<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4282"><span class="dyncstimp">fprint_valprim</span></a> <span class="keyword">(</span>out<span class="keyword">,</span> vp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">macdef</span> <span class="neuexp">prstr <span class="keyword">(</span>s<span class="keyword">)</span> <span class="keyword">=</span> fprint_string <span class="keyword">(</span>out<span class="keyword">,</span> <span class="keyword">,(</span>s<span class="keyword">)</span><span class="keyword">)</span></span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> vp<span class="keyword">.</span>valprim_node <span class="keyword">of</span>
  <span class="keyword">|</span> VPenv pos <span class="keyword">=&gt;</span> prstr <span class="keyword">(</span>"env[" + <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2finteger_2esats.html#5650"><span class="dyncstuse">tostring_int</span></a> <span class="keyword">(</span>pos<span class="keyword">)</span> + "]"<span class="keyword">)</span>
  <span class="keyword">|</span> VPbool b <span class="keyword">=&gt;</span> prstr <span class="keyword">(</span>"bool(" + <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2fbool_2esats.html#3780"><span class="dyncstuse">tostring_bool</span></a> b + ")"<span class="keyword">)</span>
  <span class="keyword">|</span> VPclo <span class="keyword">(</span>_<span class="keyword">,</span> fl<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> f_name <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4055"><span class="dyncstuse">funlab_get_name</span></a> <span class="keyword">(</span>fl<span class="keyword">)</span>
  <span class="keyword">in</span>
    prstr <span class="keyword">(</span>"closure(" + f_name + ")"<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> VPint <span class="keyword">(</span>i<span class="keyword">)</span> <span class="keyword">=&gt;</span> prstr <span class="keyword">(</span>"int(" + <span class="keyword">(</span><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2finteger_2esats.html#5650"><span class="dyncstuse">tostring_int</span></a> i<span class="keyword">)</span> + ")"<span class="keyword">)</span>
  <span class="keyword">|</span> VPstr s <span class="keyword">=&gt;</span> prstr <span class="keyword">(</span>"str(" + s + ")"<span class="keyword">)</span>
  <span class="keyword">|</span> VPtmp <span class="keyword">(</span>_<span class="keyword">)</span> <span class="keyword">=&gt;</span> prstr "any"
  <span class="keyword">|</span> VPtup <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> prstr "tuple(...)"
<span class="keyword">end</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4335"><span class="dyncstimp">fprint_valprimlst</span></a> <span class="keyword">(</span>out<span class="keyword">,</span> vps<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">macdef</span> <span class="neuexp">prstr <span class="keyword">(</span>s<span class="keyword">)</span> <span class="keyword">=</span> fprint_string <span class="keyword">(</span>out<span class="keyword">,</span> <span class="keyword">,(</span>s<span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="keyword">fun</span> loop <span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#21723"><span class="stacstuse">FILEref</span></a></span><span class="keyword">,</span> vps<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2534"><span class="stacstuse">valprimlst</span></a></span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15585"><span class="stacstuse">int</span></a></span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">macdef</span> <span class="neuexp">prstr <span class="keyword">(</span>s<span class="keyword">)</span> <span class="keyword">=</span> fprint_string <span class="keyword">(</span>out<span class="keyword">,</span> <span class="keyword">,(</span>s<span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> vps <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>vp<span class="keyword">,</span> vps1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> prstr ", "<span class="keyword">;</span>
                         <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4282"><span class="dyncstuse">fprint_valprim</span></a> <span class="keyword">(</span>out<span class="keyword">,</span> vp<span class="keyword">)</span><span class="keyword">;</span>
                         loop <span class="keyword">(</span>out<span class="keyword">,</span> vps1<span class="keyword">,</span> i + 1<span class="keyword">)</span>
                         <span class="keyword">)</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span>
<span class="keyword">in</span>
  prstr "("<span class="keyword">;</span>
  loop <span class="keyword">(</span>out<span class="keyword">,</span> vps<span class="keyword">,</span> 0<span class="keyword">)</span><span class="keyword">;</span>
  prstr ")"
<span class="keyword">end</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4394"><span class="dyncstimp">fprint_instr</span></a> <span class="keyword">(</span>out<span class="keyword">,</span> ins<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">macdef</span> <span class="neuexp">prstr <span class="keyword">(</span>s<span class="keyword">)</span> <span class="keyword">=</span> fprint_string <span class="keyword">(</span>out<span class="keyword">,</span> <span class="keyword">,(</span>s<span class="keyword">)</span><span class="keyword">)</span></span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> ins<span class="keyword">.</span>instr_node <span class="keyword">of</span>
  <span class="keyword">|</span> INSTRcall <span class="keyword">(</span>tmpvar<span class="keyword">,</span> f<span class="keyword">,</span> args<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> ret <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#405"><span class="dyncstuse">tmpvar_get_name</span></a> <span class="keyword">(</span>tmpvar<span class="keyword">)</span>
  <span class="keyword">in</span>
    prstr "\ncall{"<span class="keyword">;</span>
    <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4282"><span class="dyncstuse">fprint_valprim</span></a> <span class="keyword">(</span>out<span class="keyword">,</span> f<span class="keyword">)</span><span class="keyword">;</span>
    prstr "@"<span class="keyword">;</span>
    <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4335"><span class="dyncstuse">fprint_valprimlst</span></a> <span class="keyword">(</span>out<span class="keyword">,</span> args<span class="keyword">)</span><span class="keyword">;</span>
    prstr "}"
  <span class="keyword">end</span>
  <span class="keyword">|</span> INSTRcond <span class="keyword">(</span>tmpvar<span class="keyword">,</span> typ<span class="keyword">,</span> vp_test<span class="keyword">,</span> instrlst_then<span class="keyword">,</span> instrlst_else<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> ret <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#405"><span class="dyncstuse">tmpvar_get_name</span></a> <span class="keyword">(</span>tmpvar<span class="keyword">)</span>
  <span class="keyword">in</span>
    prstr "\nif{...}"
  <span class="keyword">end</span>
  <span class="keyword">|</span> INSTRmove_val <span class="keyword">(</span>tmpvar<span class="keyword">,</span> vp<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> ret <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#405"><span class="dyncstuse">tmpvar_get_name</span></a> <span class="keyword">(</span>tmpvar<span class="keyword">)</span>
  <span class="keyword">in</span>
    prstr "\nret &lt;= "<span class="keyword">;</span>
    <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4282"><span class="dyncstuse">fprint_valprim</span></a> <span class="keyword">(</span>out<span class="keyword">,</span> vp<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> INSTRopr <span class="keyword">(</span>tmpvar<span class="keyword">,</span> typ<span class="keyword">,</span> opr<span class="keyword">,</span> vps<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> ret <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#405"><span class="dyncstuse">tmpvar_get_name</span></a> <span class="keyword">(</span>tmpvar<span class="keyword">)</span>
  <span class="keyword">in</span>
    prstr "\nopr{...}"
  <span class="keyword">end</span>
  <span class="keyword">|</span> INSTRtup <span class="keyword">(</span>tmpvar<span class="keyword">,</span> vps<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> ret <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#405"><span class="dyncstuse">tmpvar_get_name</span></a> <span class="keyword">(</span>tmpvar<span class="keyword">)</span>
  <span class="keyword">in</span>
    prstr "\ntuple{...}"
  <span class="keyword">end</span>
  <span class="keyword">|</span> INSTRclosure <span class="keyword">(</span>tmpvar<span class="keyword">,</span> fl<span class="keyword">,</span> vps<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> ret <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#405"><span class="dyncstuse">tmpvar_get_name</span></a> <span class="keyword">(</span>tmpvar<span class="keyword">)</span>
  <span class="keyword">in</span>
    prstr "\nclosure{...}"
  <span class="keyword">end</span>
  <span class="keyword">|</span> INSTRproj <span class="keyword">(</span>tmpvar<span class="keyword">,</span> typ<span class="keyword">,</span> vp<span class="keyword">,</span> pos<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> ret <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#405"><span class="dyncstuse">tmpvar_get_name</span></a> <span class="keyword">(</span>tmpvar<span class="keyword">)</span>
  <span class="keyword">in</span>
    prstr "\nproj{...}"
  <span class="keyword">end</span>
<span class="keyword">end</span>
    

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4444"><span class="dyncstimp">fprint_instrlst</span></a> <span class="keyword">(</span>out<span class="keyword">,</span> inslst<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">macdef</span> <span class="neuexp">prstr <span class="keyword">(</span>s<span class="keyword">)</span> <span class="keyword">=</span> fprint_string <span class="keyword">(</span>out<span class="keyword">,</span> <span class="keyword">,(</span>s<span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="keyword">fun</span> loop <span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#21723"><span class="stacstuse">FILEref</span></a></span><span class="keyword">,</span> inslst<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#3496"><span class="stacstuse">instrlst</span></a></span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15585"><span class="stacstuse">int</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">macdef</span> <span class="neuexp">prstr <span class="keyword">(</span>s<span class="keyword">)</span> <span class="keyword">=</span> fprint_string <span class="keyword">(</span>out<span class="keyword">,</span> <span class="keyword">,(</span>s<span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> inslst <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>ins<span class="keyword">,</span> inses1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> prstr "\n "<span class="keyword">;</span>
                         <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#4394"><span class="dyncstuse">fprint_instr</span></a> <span class="keyword">(</span>out<span class="keyword">,</span> ins<span class="keyword">)</span><span class="keyword">;</span>
                         loop <span class="keyword">(</span>out<span class="keyword">,</span> inses1<span class="keyword">,</span> i + 1<span class="keyword">)</span>
                         <span class="keyword">)</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span>
<span class="keyword">in</span>
  prstr "instrlst{"<span class="keyword">;</span>
  loop <span class="keyword">(</span>out<span class="keyword">,</span> inslst<span class="keyword">,</span> 0<span class="keyword">)</span><span class="keyword">;</span>
  prstr "}"
<span class="keyword">end</span>


<span class="comment">(* end of [trans2.dats] *)</span>





</pre>
</body>
</html>
