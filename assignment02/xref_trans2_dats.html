<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    .atsyntax {color:#E80000;background-color:#E0E0E0}
    .atsyntax span.comment {color:#787878;font-style:italic}
    .atsyntax span.extern  {color:#A52A2A}
    .atsyntax span.keyword {color:#000000;font-weight:bold}
    .atsyntax span.neuexp  {color:#800080}
    .atsyntax span.staexp  {color:#0000FF}
    .atsyntax span.dynexp  {color:#E80000}
    .atsyntax span.prfexp  {color:#009000}
    .atsyntax span.stacstdec  {text-decoration:none}
    .atsyntax span.stacstuse  {color:#0000CF;text-decoration:underline}
    .atsyntax span.dyncstdec  {text-decoration:none}
    .atsyntax span.dyncstimp  {color:#B80000;text-decoration:underline}
    .atsyntax span.dyncstuse  {color:#B80000;text-decoration:underline}
    body {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre class="atsyntax">
<span class="comment">(*
** CAS CS525, Spring 2011
** Instructor: Hongwei Xi
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"trans1.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"trans2.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"error.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"symbol.sats"</span>

<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anon*)</span> <span class="keyword">=</span> "symbol.dats"</span>

<span class="keyword">typedef</span> <span class="staexp"><a name="211"><span class="stacstdec">opr <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fabsyn_2esats.html#1029"><span class="stacstuse">$Absyn<span class="keyword">.</span>opr</span></a></span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="236"><span class="stacstdec">loc <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fcontrib_2fparcomb_2fSATS_2fposloc_2esats.html#3210"><span class="stacstuse">$Posloc<span class="keyword">.</span>location_t</span></a></span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="269"><span class="stacstdec">symbol <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#88"><span class="stacstuse">$Symbol<span class="keyword">.</span>symbol_t</span></a></span></a></span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anon*)</span> <span class="keyword">=</span> "prelude/DATS/list.dats"</span> 
<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anon*)</span> <span class="keyword">=</span> "prelude/DATS/list0.dats"</span> 
<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anon*)</span> <span class="keyword">=</span> "prelude/DATS/reference.dats"</span> 

<span class="keyword">#define</span> <span class="neuexp">:: list0_cons</span>
<span class="keyword">#define</span> <span class="neuexp">cons list0_cons</span>
<span class="keyword">#define</span> <span class="neuexp">nil list0_nil</span>

<span class="keyword">#define</span> <span class="neuexp">Some0 option0_some</span>
<span class="keyword">#define</span> <span class="neuexp">None0 option0_none</span>

<span class="keyword">extern</span> <span class="keyword">val</span> <a name="596"><span class="dyncstdec">tmpvar_void<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#351"><span class="stacstuse">tmpvar</span></a></span></span></a><span class="keyword">;</span>

<span class="keyword">fun</span> instr_add <span class="keyword">(</span>
  res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2317"><span class="stacstuse">instr</span></a></span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> res := list0_cons <span class="keyword">(</span>x<span class="keyword">,</span> res<span class="keyword">)</span>

<span class="keyword">fun</span> instr_make <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#236"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> ins_node<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1878"><span class="stacstuse">instr_node</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2317"><span class="stacstuse">instr</span></a></span> <span class="keyword">=</span> <span class="keyword">'{</span>
  instr_loc <span class="keyword">=</span> loc<span class="keyword">,</span> instr_node <span class="keyword">=</span> ins_node
<span class="keyword">}</span>  <span class="comment">// end of [instr_make]
</span>
<span class="comment">(* fully reverse *)</span>
<span class="keyword">fun</span> instr_reverse <span class="keyword">(</span>instrs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="keyword">(</span>instrs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span><span class="keyword">,</span> accu<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span> <span class="keyword">=</span>
    <span class="keyword">case+</span> instrs <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>instr<span class="keyword">,</span> instrs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> inode <span class="keyword">=</span> instr<span class="keyword">.</span>instr_node
      <span class="keyword">val</span> iloc <span class="keyword">=</span> instr<span class="keyword">.</span>instr_loc
    <span class="keyword">in</span>
      <span class="keyword">case+</span> inode <span class="keyword">of</span>
      <span class="keyword">|</span> INSTRcond <span class="keyword">(</span>tmpv<span class="keyword">,</span> vp<span class="keyword">,</span> ins_then<span class="keyword">,</span> ins_else<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> ins_then1 <span class="keyword">=</span> instr_reverse <span class="keyword">(</span>ins_then<span class="keyword">)</span>
        <span class="keyword">val</span> ins_else1 <span class="keyword">=</span> instr_reverse <span class="keyword">(</span>ins_else<span class="keyword">)</span>
        <span class="keyword">val</span> inode1 <span class="keyword">=</span> INSTRcond <span class="keyword">(</span>tmpv<span class="keyword">,</span> vp<span class="keyword">,</span> ins_then1<span class="keyword">,</span> ins_else1<span class="keyword">)</span>
        <span class="keyword">val</span> instr1 <span class="keyword">=</span> instr_make <span class="keyword">(</span>iloc<span class="keyword">,</span> inode1<span class="keyword">)</span>
        <span class="keyword">val</span> accu <span class="keyword">=</span> instr1 :: accu
      <span class="keyword">in</span>
        loop <span class="keyword">(</span>instrs1<span class="keyword">,</span> accu<span class="keyword">)</span>
      <span class="keyword">end</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> loop <span class="keyword">(</span>instrs1<span class="keyword">,</span> instr :: accu<span class="keyword">)</span>
    <span class="keyword">end</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> accu
<span class="keyword">in</span>
  loop <span class="keyword">(</span>instrs<span class="keyword">,</span> nil<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="neuexp"><span class="keyword">symintr</span></span> tmpvar_new
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="1588"><span class="dyncstdec">tmpvar_new_anon <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#334"><span class="stacstuse">tmpvar_t</span></a></span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="1628"><span class="dyncstdec">tmpvar_new_name <span class="keyword">(</span>v<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2084"><span class="stacstuse">v1ar</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#334"><span class="stacstuse">tmpvar_t</span></a></span></span></a>
<span class="neuexp"><span class="keyword">overload</span> tmpvar_new <span class="keyword">with</span> tmpvar_new_anon</span>
<span class="neuexp"><span class="keyword">overload</span> tmpvar_new <span class="keyword">with</span> tmpvar_new_name</span>

<span class="keyword">local</span>
<span class="keyword">assume</span> <span class="staexp">tmpvar_t <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#88"><span class="stacstuse">symbol_t</span></a></span>
<span class="keyword">val</span> tmpvar_count <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2freference_2esats.html#2042"><span class="dyncstuse">ref&lt;</span></a><span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15585"><span class="stacstuse">int</span></a></span><span class="keyword">&gt;</span> <span class="keyword">(</span>0<span class="keyword">)</span>
<span class="keyword">val</span> tmpvar_prefix <span class="keyword">=</span> "__v_"<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16164"><span class="stacstuse">string</span></a></span>
<span class="keyword">in</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#596"><span class="dyncstimp">tmpvar_void</span></a> <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#190"><span class="dyncstuse">symbol_make_name</span></a> <span class="keyword">(</span>"dummy_void"<span class="keyword">)</span>
<span class="keyword">val</span> valprim_void <span class="keyword">=</span> VPtup <span class="keyword">(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#596"><span class="dyncstuse">tmpvar_void</span></a><span class="keyword">,</span> list0_nil<span class="keyword">)</span>  <span class="comment">// todo must be put here
</span>
<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#1588"><span class="dyncstimp">tmpvar_new_anon</span></a> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> i <span class="keyword">=</span> <span class="keyword">!</span>tmpvar_count
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>tmpvar_count := i + 1

  <span class="keyword">val</span> id <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2finteger_2esats.html#5650"><span class="dyncstuse">tostring_int</span></a> <span class="keyword">(</span>i<span class="keyword">)</span>
  <span class="keyword">val</span> name <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2fstring_2esats.html#13074"><span class="dyncstuse">string0_append</span></a> <span class="keyword">(</span>tmpvar_prefix<span class="keyword">,</span> id<span class="keyword">)</span>
<span class="keyword">in</span>
  <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#190"><span class="dyncstuse">symbol_make_name</span></a> <span class="keyword">(</span>name<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#1628"><span class="dyncstimp">tmpvar_new_name</span></a> <span class="keyword">(</span>v<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> nam <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#148"><span class="dyncstuse">symbol_get_name</span></a> <span class="keyword">(</span>v<span class="keyword">.</span>v1ar_nam<span class="keyword">)</span>

  <span class="keyword">val</span> i <span class="keyword">=</span> <span class="keyword">!</span>tmpvar_count
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>tmpvar_count := i + 1

  <span class="keyword">val</span> id <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2finteger_2esats.html#5650"><span class="dyncstuse">tostring_int</span></a> <span class="keyword">(</span>i<span class="keyword">)</span>
  <span class="keyword">val</span> fullname <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2fstring_2esats.html#13074"><span class="dyncstuse">string0_append</span></a> <span class="keyword">(</span>tmpvar_prefix<span class="keyword">,</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2fstring_2esats.html#13074"><span class="dyncstuse">string0_append</span></a> <span class="keyword">(</span>nam<span class="keyword">,</span> id<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">in</span>
  <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#190"><span class="dyncstuse">symbol_make_name</span></a> <span class="keyword">(</span>fullname<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#374"><span class="dyncstimp">tmpvar_get_name</span></a> <span class="keyword">(</span>v<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="comment">// val () = printf ("tmpvar_get_name\n", @())
</span>  <span class="keyword">val</span> ret <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#148"><span class="dyncstuse">symbol_get_name</span></a> <span class="keyword">(</span>v<span class="keyword">)</span>
  <span class="comment">// val () = printf ("tmpvar_get_name10\n", @())
</span><span class="keyword">in</span>
  ret
<span class="keyword">end</span>

<span class="keyword">end</span>

<span class="keyword">local</span>
  <span class="keyword">extern</span> <span class="keyword">castfn</span> <a name="2672"><span class="dyncstdec">valprim_encode <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1232"><span class="stacstuse">valprim</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#1348"><span class="stacstuse">valprim_t</span></a></span></span></a>
  <span class="keyword">extern</span> <span class="keyword">castfn</span> <a name="2727"><span class="dyncstdec">valprim_decode <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#1348"><span class="stacstuse">valprim_t</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1232"><span class="stacstuse">valprim</span></a></span></span></a>
<span class="keyword">in</span>
  <span class="keyword">fun</span> v1ar_get_val
    <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2084"><span class="stacstuse">v1ar</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#22670"><span class="stacstuse">option0</span></a> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1232"><span class="stacstuse">valprim</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> r <span class="keyword">=</span> x<span class="keyword">.</span>v1ar_val
  <span class="keyword">in</span>
    <span class="keyword">case+</span> <span class="keyword">!</span>r <span class="keyword">of</span>
    <span class="keyword">|</span> Some0 <span class="keyword">(</span>vp<span class="keyword">)</span> <span class="keyword">=&gt;</span> Some0 <span class="keyword">(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#2727"><span class="dyncstuse">valprim_decode</span></a> <span class="keyword">(</span>vp<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None0
  <span class="keyword">end</span> <span class="comment">// end of [v1ar_get_val]
</span>  
  <span class="keyword">fun</span> v1ar_initset_val <span class="keyword">(</span>
    x<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2084"><span class="stacstuse">v1ar</span></a></span><span class="keyword">,</span> vp<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1232"><span class="stacstuse">valprim</span></a></span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> r <span class="keyword">=</span> x<span class="keyword">.</span>v1ar_val
    <span class="keyword">val</span> vp <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#2672"><span class="dyncstuse">valprim_encode</span></a> <span class="keyword">(</span>vp<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>r := Some0 <span class="keyword">(</span>vp<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="comment">// nothing
</span>  <span class="keyword">end</span> <span class="comment">// [v1ar_set_val]
</span>  
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="keyword">typedef</span> <span class="staexp"><a name="3206"><span class="stacstdec">funent <span class="keyword">=</span> <span class="keyword">'{</span>
  funent_fun<span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#630"><span class="stacstuse">funlab_t</span></a>
<span class="keyword">,</span> funent_narg<span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15585"><span class="stacstuse">int</span></a>
<span class="keyword">,</span> funent_body<span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a>
<span class="keyword">,</span> funent_ret<span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1232"><span class="stacstuse">valprim</span></a>
<span class="keyword">}</span></span></a></span>

<span class="keyword">assume</span> <span class="staexp">funent_t <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#3206"><span class="stacstuse">funent</span></a></span>


<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2756"><span class="dyncstimp">funent_get_lab</span></a> <span class="keyword">(</span>ent<span class="keyword">)</span> <span class="keyword">=</span> ent<span class="keyword">.</span>funent_fun
<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2797"><span class="dyncstimp">funent_get_narg</span></a> <span class="keyword">(</span>ent<span class="keyword">)</span> <span class="keyword">=</span> ent<span class="keyword">.</span>funent_narg
<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2836"><span class="dyncstimp">funent_get_body</span></a> <span class="keyword">(</span>ent<span class="keyword">)</span> <span class="keyword">=</span> ent<span class="keyword">.</span>funent_body
<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2880"><span class="dyncstimp">funent_get_ret</span></a> <span class="keyword">(</span>ent<span class="keyword">)</span> <span class="keyword">=</span> ent<span class="keyword">.</span>funent_ret


<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2986"><span class="dyncstimp">funent_make_label</span></a> <span class="keyword">(</span>fl<span class="keyword">,</span> nargs<span class="keyword">,</span> body<span class="keyword">,</span> ret<span class="keyword">)</span> <span class="keyword">=</span> 
  <span class="keyword">'{</span>funent_fun <span class="keyword">=</span> fl<span class="keyword">,</span>
    funent_narg <span class="keyword">=</span> nargs<span class="keyword">,</span>
    funent_body <span class="keyword">=</span> body<span class="keyword">,</span>
    funent_ret <span class="keyword">=</span> ret
    <span class="keyword">}</span>

<span class="comment">(* ***** ****** *)</span>

<span class="neuexp"><span class="keyword">symintr</span></span> funlab_make

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="3738"><span class="dyncstdec">funlab_make_anon <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#647"><span class="stacstuse">funlab</span></a></span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="3777"><span class="dyncstdec">funlab_make_name <span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2084"><span class="stacstuse">v1ar</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#647"><span class="stacstuse">funlab</span></a></span></span></a>  <span class="comment">// simiar v1ar's lead to different names
</span>
<span class="neuexp"><span class="keyword">overload</span> funlab_make <span class="keyword">with</span> funlab_make_anon</span>
<span class="neuexp"><span class="keyword">overload</span> funlab_make <span class="keyword">with</span> funlab_make_name</span>

<span class="comment">(* ***** ****** *)</span>

<span class="keyword">fun</span> funent_make <span class="keyword">(</span>
  label<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#647"><span class="stacstuse">funlab</span></a></span><span class="keyword">,</span> narg<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15585"><span class="stacstuse">int</span></a></span><span class="keyword">,</span> body<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span><span class="keyword">,</span> ret<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1232"><span class="stacstuse">valprim</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#3206"><span class="stacstuse">funent</span></a></span> <span class="keyword">=</span> <span class="keyword">'{</span>
  funent_fun<span class="keyword">=</span> label<span class="keyword">,</span>
  funent_narg<span class="keyword">=</span> narg<span class="keyword">,</span>
  funent_body<span class="keyword">=</span> body<span class="keyword">,</span>
  funent_ret<span class="keyword">=</span> ret
  <span class="keyword">}</span>

<span class="comment">(*
There is a global map for this function:
*)</span>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="4195"><span class="dyncstdec">funent_add <span class="keyword">(</span>fl<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#647"><span class="stacstuse">funlab</span></a></span><span class="keyword">,</span> ent<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#3206"><span class="stacstuse">funent</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="4249"><span class="dyncstdec">funent_lookup <span class="keyword">(</span>fl<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#647"><span class="stacstuse">funlab</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#3206"><span class="stacstuse">funent</span></a></span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="4295"><span class="dyncstdec">funent_getall <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#22196"><span class="stacstuse">list0</span></a> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#3206"><span class="stacstuse">funent</span></a></span></span></a>

<span class="keyword">local</span>
<span class="keyword">val</span> funlab_count <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2freference_2esats.html#2042"><span class="dyncstuse">ref&lt;</span></a><span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15585"><span class="stacstuse">int</span></a></span><span class="keyword">&gt;</span> <span class="keyword">(</span>0<span class="keyword">)</span>
<span class="keyword">assume</span> <span class="staexp">funlab_t <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#88"><span class="stacstuse">symbol_t</span></a></span>
<span class="keyword">val</span> fun_table <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2freference_2esats.html#2042"><span class="dyncstuse">ref&lt;</span></a><span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#1602"><span class="stacstuse">symenv_t</span></a> <span class="keyword">(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#3206"><span class="stacstuse">funent</span></a><span class="keyword">)</span></span><span class="keyword">&gt;</span> <span class="keyword">(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#1636"><span class="dyncstuse">symenv_make</span></a> <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">val</span> fl_prefix <span class="keyword">=</span> "__f_"<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16164"><span class="stacstuse">string</span></a></span>
<span class="keyword">in</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2923"><span class="dyncstimp">funlab_get_name</span></a> <span class="keyword">(</span>fl<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#148"><span class="dyncstuse">symbol_get_name</span></a> <span class="keyword">(</span>fl<span class="keyword">)</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#3777"><span class="dyncstimp">funlab_make_name</span></a> <span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> nam <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#148"><span class="dyncstuse">symbol_get_name</span></a> <span class="keyword">(</span>f<span class="keyword">.</span>v1ar_nam<span class="keyword">)</span>
  <span class="keyword">val</span> i <span class="keyword">=</span> <span class="keyword">!</span>funlab_count
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>funlab_count := i + 1
  <span class="keyword">val</span> id <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2finteger_2esats.html#5650"><span class="dyncstuse">tostring_int</span></a> <span class="keyword">(</span>i<span class="keyword">)</span>
  <span class="keyword">val</span> fullname <span class="keyword">=</span> fl_prefix + nam + "_" + id
<span class="keyword">in</span>
  <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#190"><span class="dyncstuse">symbol_make_name</span></a> <span class="keyword">(</span>fullname<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#3738"><span class="dyncstimp">funlab_make_anon</span></a> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> nam <span class="keyword">=</span> "lam"
  <span class="keyword">val</span> i <span class="keyword">=</span> <span class="keyword">!</span>funlab_count
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>funlab_count := i + 1
  <span class="keyword">val</span> id <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2finteger_2esats.html#5650"><span class="dyncstuse">tostring_int</span></a> <span class="keyword">(</span>i<span class="keyword">)</span>
  <span class="keyword">val</span> fullname <span class="keyword">=</span> fl_prefix + nam + "_" + id
<span class="keyword">in</span>
  <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#190"><span class="dyncstuse">symbol_make_name</span></a> <span class="keyword">(</span>fullname<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#4195"><span class="dyncstimp">funent_add</span></a> <span class="keyword">(</span>fl<span class="keyword">,</span> ent<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> table <span class="keyword">=</span> <span class="keyword">!</span>fun_table
  <span class="keyword">val</span> table <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#1751"><span class="dyncstuse">symenv_insert</span></a> <span class="keyword">(</span>table<span class="keyword">,</span> fl<span class="keyword">,</span> ent<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>fun_table := table
<span class="keyword">in</span>
<span class="keyword">end</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#4295"><span class="dyncstimp">funent_getall</span></a> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> helper <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp"><span class="keyword">@(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#88"><span class="stacstuse">symbol_t</span></a><span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#3206"><span class="stacstuse">funent</span></a><span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#3206"><span class="stacstuse">funent</span></a></span> <span class="keyword">=</span> x<span class="keyword">.</span>1
  <span class="keyword">val</span> xs <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#1935"><span class="dyncstuse">symenv_listize&lt;</span></a><span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#3206"><span class="stacstuse">funent</span></a></span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>fun_table<span class="keyword">)</span>
<span class="keyword">in</span>
  <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2flist0_2esats.html#4772"><span class="dyncstuse">list0_map_fun&lt;</span></a> <span class="staexp"><span class="keyword">@(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#88"><span class="stacstuse">symbol_t</span></a><span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#3206"><span class="stacstuse">funent</span></a><span class="keyword">)</span></span><span class="keyword">&gt;&lt;</span><span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#3206"><span class="stacstuse">funent</span></a></span><span class="keyword">&gt;</span> <span class="keyword">(</span>xs<span class="keyword">,</span> helper<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2965"><span class="dyncstimp">mainlab</span></a> <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#190"><span class="dyncstuse">symbol_make_name</span></a> <span class="keyword">(</span>"__main"<span class="keyword">)</span>

<span class="keyword">end</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="5437"><span class="dyncstdec">aux_exp <span class="keyword">(</span>e<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#244"><span class="stacstuse">e1xp</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1232"><span class="stacstuse">valprim</span></a></span></span></a>

<span class="comment">(* ret is supposed to be used in the evaluation *)</span>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="5543"><span class="dyncstdec">aux_exp_ret <span class="keyword">(</span>e<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#244"><span class="stacstuse">e1xp</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">,</span> ret<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#351"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1232"><span class="stacstuse">valprim</span></a></span></span></a>

<span class="comment">(* this function only handle E1XPfix and E1XPlam and E1XPann *)</span>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="5679"><span class="dyncstdec">aux_exp_fun <span class="keyword">(</span>e<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#244"><span class="stacstuse">e1xp</span></a></span><span class="keyword">,</span> fl<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#647"><span class="stacstuse">funlab</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1232"><span class="stacstuse">valprim</span></a></span></span></a>

<span class="keyword">fun</span> auxlst_exp <span class="keyword">(</span>
  es<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#1967"><span class="stacstuse">e1xplst</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span></a></span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1630"><span class="stacstuse">valprimlst</span></a></span> <span class="keyword">=</span> <span class="keyword">case+</span> es <span class="keyword">of</span>
  <span class="keyword">|</span> list0_cons <span class="keyword">(</span>e<span class="keyword">,</span> es<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> v <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5437"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span>
      <span class="keyword">val</span> vs <span class="keyword">=</span> auxlst_exp <span class="keyword">(</span>es<span class="keyword">,</span> res<span class="keyword">)</span>
    <span class="keyword">in</span>
      list0_cons <span class="keyword">(</span>v<span class="keyword">,</span> vs<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> list0_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> list0_nil <span class="keyword">(</span><span class="keyword">)</span>

<span class="keyword">fun</span> aux_exp_fix_lab
  <span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2084"><span class="stacstuse">v1ar</span></a></span><span class="keyword">,</span> v_args<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2261"><span class="stacstuse">v1arlst</span></a></span><span class="keyword">,</span> e_body<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#244"><span class="stacstuse">e1xp</span></a></span><span class="keyword">,</span> fl<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#647"><span class="stacstuse">funlab</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1232"><span class="stacstuse">valprim</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> vp_fun <span class="keyword">=</span> VPfun <span class="keyword">(</span>fl<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> v1ar_initset_val <span class="keyword">(</span>f<span class="keyword">,</span> vp_fun<span class="keyword">)</span>
  <span class="keyword">val</span> narg <span class="keyword">=</span> loop <span class="keyword">(</span>v_args<span class="keyword">,</span> 0<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">fun</span> loop <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2261"><span class="stacstuse">v1arlst</span></a></span><span class="keyword">,</span> n<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15585"><span class="stacstuse">int</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15585"><span class="stacstuse">int</span></a></span> <span class="keyword">=</span>
      <span class="keyword">case+</span> xs <span class="keyword">of</span>
      <span class="keyword">|</span> cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> vp <span class="keyword">=</span> VParg <span class="keyword">(</span>n<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> v1ar_initset_val <span class="keyword">(</span>x<span class="keyword">,</span> vp<span class="keyword">)</span>
        <span class="keyword">in</span>
          loop <span class="keyword">(</span>xs<span class="keyword">,</span> n+1<span class="keyword">)</span>
        <span class="keyword">end</span>
      <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> n
  <span class="keyword">}</span>
  <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span> <span class="keyword">=</span> nil
  <span class="keyword">val</span> vp_ret <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5437"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e_body<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">val</span> res <span class="keyword">=</span> instr_reverse <span class="keyword">(</span>res<span class="keyword">)</span>
  <span class="keyword">val</span> ent <span class="keyword">=</span> funent_make <span class="keyword">(</span>fl<span class="keyword">,</span> narg<span class="keyword">,</span> res<span class="keyword">,</span> vp_ret<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#4195"><span class="dyncstuse">funent_add</span></a> <span class="keyword">(</span>fl<span class="keyword">,</span> ent<span class="keyword">)</span>
<span class="keyword">in</span>
  VPfun <span class="keyword">(</span>fl<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">fun</span> aux_exp_lam_lab <span class="keyword">(</span>v_args<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2261"><span class="stacstuse">v1arlst</span></a></span><span class="keyword">,</span> e_body<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#244"><span class="stacstuse">e1xp</span></a></span><span class="keyword">,</span> fl<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#647"><span class="stacstuse">funlab</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1232"><span class="stacstuse">valprim</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="comment">(* handle the arguments *)</span>
  <span class="keyword">val</span> narg <span class="keyword">=</span> loop <span class="keyword">(</span>v_args<span class="keyword">,</span> 0<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">fun</span> loop <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2261"><span class="stacstuse">v1arlst</span></a></span><span class="keyword">,</span> n<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15585"><span class="stacstuse">int</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15585"><span class="stacstuse">int</span></a></span> <span class="keyword">=</span>
      <span class="keyword">case+</span> xs <span class="keyword">of</span>
      <span class="keyword">|</span> cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> vp <span class="keyword">=</span> VParg <span class="keyword">(</span>n<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> v1ar_initset_val <span class="keyword">(</span>x<span class="keyword">,</span> vp<span class="keyword">)</span>
        <span class="keyword">in</span>
          loop <span class="keyword">(</span>xs<span class="keyword">,</span> n+1<span class="keyword">)</span>
        <span class="keyword">end</span>
      <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> n
  <span class="keyword">}</span>
  <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span> <span class="keyword">=</span> nil
  <span class="keyword">val</span> vp_ret <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5437"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e_body<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">val</span> res <span class="keyword">=</span> instr_reverse <span class="keyword">(</span>res<span class="keyword">)</span>

  <span class="keyword">val</span> ent <span class="keyword">=</span> funent_make <span class="keyword">(</span>fl<span class="keyword">,</span> narg<span class="keyword">,</span> res<span class="keyword">,</span> vp_ret<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#4195"><span class="dyncstuse">funent_add</span></a> <span class="keyword">(</span>fl<span class="keyword">,</span> ent<span class="keyword">)</span>
<span class="keyword">in</span>
  VPfun <span class="keyword">(</span>fl<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5437"><span class="dyncstimp">aux_exp</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>
  <span class="keyword">case</span> e<span class="keyword">.</span>e1xp_node <span class="keyword">of</span>
  <span class="keyword">|</span> E1XPann <span class="keyword">(</span>e<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5437"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPapp <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> wrapper <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPbool b <span class="keyword">=&gt;</span> VPbool <span class="keyword">(</span>b<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPfix <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> fl <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#3738"><span class="dyncstuse">funlab_make_anon</span></a> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">in</span>
    <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5679"><span class="dyncstuse">aux_exp_fun</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> fl<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> E1XPif <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> wrapper <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPint i <span class="keyword">=&gt;</span> VPint <span class="keyword">(</span>i<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPlam <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> fl <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#3738"><span class="dyncstuse">funlab_make_anon</span></a> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">in</span>
    <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5679"><span class="dyncstuse">aux_exp_fun</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> fl<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> E1XPlet <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> wrapper <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPopr <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> wrapper <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPproj <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> wrapper <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPstr <span class="keyword">(</span>str<span class="keyword">)</span> <span class="keyword">=&gt;</span> VPstr <span class="keyword">(</span>str<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPtup exps <span class="keyword">=&gt;</span> wrapper <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPvar v <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> vp_opt <span class="keyword">=</span> v1ar_get_val <span class="keyword">(</span>v<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> vp_opt <span class="keyword">of</span>
    <span class="keyword">|</span> Some0 <span class="keyword">(</span>vp<span class="keyword">)</span> <span class="keyword">=&gt;</span> vp
    <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span>
      ETRACE_MSG_OPR <span class="keyword">(</span>"aux_exp v1ar doesn't have valprim\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span>
                    <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ferror_2esats.html#120"><span class="dyncstuse">abort</span></a> <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>  <span class="comment">// todo closure
</span>  <span class="keyword">end</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span> wrapper <span class="keyword">(</span>e<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#244"><span class="stacstuse">e1xp</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1232"><span class="stacstuse">valprim</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
      <span class="keyword">val</span> tmp_ret <span class="keyword">=</span> tmpvar_new <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">in</span>
      <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5543"><span class="dyncstuse">aux_exp_ret</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">,</span> tmp_ret<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span>
<span class="comment">// end of [aux_exp]
</span><span class="comment">(* ****** ****** *)</span>
<span class="keyword">fun</span> instr_add_call <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#236"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> tmpv<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#351"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">,</span>
  vpf<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1232"><span class="stacstuse">valprim</span></a></span><span class="keyword">,</span> vpargs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1630"><span class="stacstuse">valprimlst</span></a></span><span class="keyword">,</span> iswrapper<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15152"><span class="stacstuse">bool</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> ins_node <span class="keyword">=</span> INSTRcall <span class="keyword">(</span>tmpv<span class="keyword">,</span> vpf<span class="keyword">,</span> vpargs<span class="keyword">,</span> iswrapper<span class="keyword">)</span>
  <span class="keyword">val</span> ins <span class="keyword">=</span> instr_make <span class="keyword">(</span>loc<span class="keyword">,</span> ins_node<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add <span class="keyword">(</span>res<span class="keyword">,</span> ins<span class="keyword">)</span>
<span class="keyword">in</span>
<span class="keyword">end</span>  <span class="comment">// end of [instr_add_call]
</span>
<span class="keyword">fun</span> instr_add_cond <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#236"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> tmpv<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#351"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">,</span> vp_test<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1232"><span class="stacstuse">valprim</span></a></span><span class="keyword">,</span> 
  instr1<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span><span class="keyword">,</span> instr2<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> ins_node <span class="keyword">=</span> INSTRcond <span class="keyword">(</span>tmpv<span class="keyword">,</span> vp_test<span class="keyword">,</span> instr1<span class="keyword">,</span> instr2<span class="keyword">)</span>
  <span class="keyword">val</span> ins <span class="keyword">=</span> instr_make <span class="keyword">(</span>loc<span class="keyword">,</span> ins_node<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add <span class="keyword">(</span>res<span class="keyword">,</span> ins<span class="keyword">)</span>
<span class="keyword">in</span>
<span class="keyword">end</span>  <span class="comment">// end of [instr_add_cond]
</span>
<span class="keyword">fun</span> instr_add_move <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#236"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> tmpv<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#351"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">,</span> vp<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1232"><span class="stacstuse">valprim</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> ins_node <span class="keyword">=</span> INSTRmove_val <span class="keyword">(</span>tmpv<span class="keyword">,</span> vp<span class="keyword">)</span>
  <span class="keyword">val</span> ins <span class="keyword">=</span> instr_make <span class="keyword">(</span>loc<span class="keyword">,</span> ins_node<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add <span class="keyword">(</span>res<span class="keyword">,</span> ins<span class="keyword">)</span>
<span class="keyword">in</span>
<span class="keyword">end</span>  <span class="comment">// end of [instr_add_move]
</span>
<span class="keyword">fun</span> instr_add_opr <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#236"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> tmpv<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#351"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">,</span> opr<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#211"><span class="stacstuse">opr</span></a></span><span class="keyword">,</span> 
  vps<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1630"><span class="stacstuse">valprimlst</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> ins_node <span class="keyword">=</span> INSTRopr <span class="keyword">(</span>tmpv<span class="keyword">,</span> opr<span class="keyword">,</span> vps<span class="keyword">)</span>
  <span class="keyword">val</span> ins <span class="keyword">=</span> instr_make <span class="keyword">(</span>loc<span class="keyword">,</span> ins_node<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add <span class="keyword">(</span>res<span class="keyword">,</span> ins<span class="keyword">)</span>
<span class="keyword">in</span>
<span class="keyword">end</span>  <span class="comment">// end of [instr_add_opr]
</span>
<span class="keyword">fun</span> instr_add_tup <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#236"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> tmpv<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#351"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">,</span>
  vps<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1630"><span class="stacstuse">valprimlst</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> ins_node <span class="keyword">=</span> INSTRtup <span class="keyword">(</span>tmpv<span class="keyword">,</span> vps<span class="keyword">)</span>
  <span class="keyword">val</span> ins <span class="keyword">=</span> instr_make <span class="keyword">(</span>loc<span class="keyword">,</span> ins_node<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add <span class="keyword">(</span>res<span class="keyword">,</span> ins<span class="keyword">)</span>
<span class="keyword">in</span>
<span class="keyword">end</span>  <span class="comment">// end of [instr_add_tup]
</span>
<span class="keyword">fun</span> instr_add_proj <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#236"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> tmpv<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#351"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">,</span>
  vp<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1232"><span class="stacstuse">valprim</span></a></span><span class="keyword">,</span> pos<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15585"><span class="stacstuse">int</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> ins_node <span class="keyword">=</span> INSTRproj <span class="keyword">(</span>tmpv<span class="keyword">,</span> vp<span class="keyword">,</span> pos<span class="keyword">)</span>
  <span class="keyword">val</span> ins <span class="keyword">=</span> instr_make <span class="keyword">(</span>loc<span class="keyword">,</span> ins_node<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add <span class="keyword">(</span>res<span class="keyword">,</span> ins<span class="keyword">)</span>
<span class="keyword">in</span>
<span class="keyword">end</span>  <span class="comment">// end of [instr_add_proj]
</span>
<span class="keyword">fun</span> aux_exp_ret_if <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#236"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> e_test<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#244"><span class="stacstuse">e1xp</span></a></span><span class="keyword">,</span> e_then<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#244"><span class="stacstuse">e1xp</span></a></span><span class="keyword">,</span> oe_else<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#1994"><span class="stacstuse">e1xpopt</span></a></span><span class="keyword">,</span> 
  res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">,</span> tmp_ret<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#351"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1232"><span class="stacstuse">valprim</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> v_test <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5437"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e_test<span class="keyword">,</span> res<span class="keyword">)</span>

  <span class="keyword">var</span> res_then<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span> <span class="keyword">=</span> list0_nil
  <span class="keyword">val</span> v_then <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5437"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e_then<span class="keyword">,</span> res_then<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add_move <span class="keyword">(</span>e_then<span class="keyword">.</span>e1xp_loc<span class="keyword">,</span> tmp_ret<span class="keyword">,</span> v_then<span class="keyword">,</span> res_then<span class="keyword">)</span>

  <span class="keyword">var</span> res_else<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span> <span class="keyword">=</span> list0_nil
  <span class="keyword">val</span> <span class="keyword">(</span>v_else<span class="keyword">,</span> loc_else<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> oe_else <span class="keyword">of</span>
    <span class="keyword">|</span> Some0 e_else <span class="keyword">=&gt;</span> <span class="keyword">(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5437"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e_else<span class="keyword">,</span> res_else<span class="keyword">)</span><span class="keyword">,</span> e_else<span class="keyword">.</span>e1xp_loc<span class="keyword">)</span>
    <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="comment">// val () = printf ("aux_exp_ret_if -- else is none\n", @())
</span>    <span class="keyword">in</span>
      <span class="keyword">(</span>valprim_void<span class="keyword">,</span> e_then<span class="keyword">.</span>e1xp_loc<span class="keyword">)</span>  <span class="comment">// use the location of then
</span>    <span class="keyword">end</span>
    <span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add_move <span class="keyword">(</span>loc_else<span class="keyword">,</span> tmp_ret<span class="keyword">,</span> v_else<span class="keyword">,</span> res_else<span class="keyword">)</span>
  
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add_cond <span class="keyword">(</span>loc<span class="keyword">,</span> tmp_ret<span class="keyword">,</span> v_test<span class="keyword">,</span> res_then<span class="keyword">,</span> res_else<span class="keyword">,</span> res<span class="keyword">)</span>
<span class="keyword">in</span>
  VPtmp <span class="keyword">(</span>tmp_ret<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">fun</span> aux_exp_ret_opr <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#236"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> opr<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#211"><span class="stacstuse">opr</span></a></span><span class="keyword">,</span> exps<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#1967"><span class="stacstuse">e1xplst</span></a></span><span class="keyword">,</span> 
  res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">,</span> tmp_ret<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#351"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1232"><span class="stacstuse">valprim</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> vps <span class="keyword">=</span> auxlst_exp <span class="keyword">(</span>exps<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add_opr <span class="keyword">(</span>loc<span class="keyword">,</span> tmp_ret<span class="keyword">,</span> opr<span class="keyword">,</span> vps<span class="keyword">,</span> res<span class="keyword">)</span>
<span class="keyword">in</span>
  VPtmp <span class="keyword">(</span>tmp_ret<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">fun</span> aux_exp_v1aldeclst <span class="keyword">(</span>v1aldecs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2479"><span class="stacstuse">v1aldeclst</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span>
  <span class="keyword">case+</span> v1aldecs <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>v1aldec<span class="keyword">,</span> v1aldecs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> v1ar <span class="keyword">=</span> v1aldec<span class="keyword">.</span>v1aldec_var
    <span class="keyword">val</span> vpopt <span class="keyword">=</span> v1ar_get_val <span class="keyword">(</span>v1ar<span class="keyword">)</span>
    <span class="keyword">val</span> vp <span class="keyword">=</span> 
      <span class="keyword">case+</span> vpopt <span class="keyword">of</span>
      <span class="keyword">|</span> Some0 vp <span class="keyword">=&gt;</span> 
        <span class="keyword">(</span><span class="keyword">case+</span> vp <span class="keyword">of</span>
        <span class="comment">// if exists sth. then must be funlab
</span>        <span class="keyword">|</span> VPfun fl <span class="keyword">=&gt;</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5679"><span class="dyncstuse">aux_exp_fun</span></a> <span class="keyword">(</span>v1aldec<span class="keyword">.</span>v1aldec_def<span class="keyword">,</span> fl<span class="keyword">)</span>
        <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>
          "aux_exp_v1aldeclst var has a valprim which is not VPfun\n"<span class="keyword">,</span>
          ETRACE_LEVEL_ERROR<span class="keyword">,</span>
          <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ferror_2esats.html#120"><span class="dyncstuse">abort</span></a> <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
        <span class="keyword">)</span>
      <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5543"><span class="dyncstuse">aux_exp_ret</span></a> <span class="keyword">(</span>v1aldec<span class="keyword">.</span>v1aldec_def<span class="keyword">,</span> res<span class="keyword">,</span> tmpvar_new <span class="keyword">(</span>v1ar<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> v1ar_initset_val <span class="keyword">(</span>v1ar<span class="keyword">,</span> vp<span class="keyword">)</span>  <span class="comment">// vp may be equal to VPfun fl, just let it be
</span>  <span class="keyword">in</span>
    aux_exp_v1aldeclst <span class="keyword">(</span>v1aldecs1<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>

<span class="comment">(* generating labels for all the functions *)</span>
<span class="comment">(* r1: round 1 *)</span>
<span class="keyword">fun</span> aux_exp_v1aldeclst_rec_r1 <span class="keyword">(</span>v1aldecs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2479"><span class="stacstuse">v1aldeclst</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span>
  <span class="keyword">case+</span> v1aldecs <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>v1aldec<span class="keyword">,</span> v1aldecs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> v <span class="keyword">=</span> v1aldec<span class="keyword">.</span>v1aldec_var
    <span class="keyword">val</span> e <span class="keyword">=</span> v1aldec<span class="keyword">.</span>v1aldec_def
    <span class="keyword">val</span> e_node <span class="keyword">=</span> e<span class="keyword">.</span>e1xp_node
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> 
      <span class="keyword">if</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2685"><span class="dyncstuse">e1xp_node_is_fun</span></a> <span class="keyword">(</span>e_node<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fdyn_2esats.html#4313"><span class="dyncstuse">true</span></a> <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val</span> fl <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#3777"><span class="dyncstuse">funlab_make_name</span></a> <span class="keyword">(</span>v<span class="keyword">)</span>
        <span class="keyword">val</span> vp_fun <span class="keyword">=</span> VPfun <span class="keyword">(</span>fl<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> v1ar_initset_val <span class="keyword">(</span>v<span class="keyword">,</span> vp_fun<span class="keyword">)</span>
      <span class="keyword">in</span> <span class="keyword">end</span>
  <span class="keyword">in</span>
    aux_exp_v1aldeclst_rec_r1 <span class="keyword">(</span>v1aldecs1<span class="keyword">)</span>
  <span class="keyword">end</span>  <span class="comment">// end of [cons]
</span>  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>

<span class="keyword">fun</span> aux_exp_v1aldeclst_rec <span class="keyword">(</span>v1aldecs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2479"><span class="stacstuse">v1aldeclst</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="comment">// scan for the first round
</span>  <span class="comment">// val () = printf ("aux_exp_v1aldeclst_rec\n", @())
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux_exp_v1aldeclst_rec_r1 <span class="keyword">(</span>v1aldecs<span class="keyword">)</span>
<span class="keyword">in</span>
  aux_exp_v1aldeclst <span class="keyword">(</span>v1aldecs<span class="keyword">,</span> res<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">fun</span> aux_exp_d1eclst <span class="keyword">(</span>d1ecs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2358"><span class="stacstuse">d1eclst</span></a></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span>
  <span class="keyword">case+</span> d1ecs <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>d1ec<span class="keyword">,</span> d1ecs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="comment">// val () = printf ("aux_exp_d1eclst\n", @())
</span>    <span class="keyword">val+</span> D1ECval <span class="keyword">(</span>isrec<span class="keyword">,</span> v1aldecs<span class="keyword">)</span> <span class="keyword">=</span> d1ec<span class="keyword">.</span>d1ec_node 
    <span class="comment">(* no matter it is recursive or not, I decide to treat them as the same *)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">if</span> isrec <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fdyn_2esats.html#4313"><span class="dyncstuse">true</span></a> <span class="keyword">then</span> aux_exp_v1aldeclst_rec <span class="keyword">(</span>v1aldecs<span class="keyword">,</span> res<span class="keyword">)</span>
             <span class="keyword">else</span> aux_exp_v1aldeclst_rec <span class="keyword">(</span>v1aldecs<span class="keyword">,</span> res<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">in</span>
    aux_exp_d1eclst <span class="keyword">(</span>d1ecs1<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>

<span class="keyword">fun</span> aux_exp_ret_let <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#236"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> d1ecs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2358"><span class="stacstuse">d1eclst</span></a></span><span class="keyword">,</span> e1xp<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#244"><span class="stacstuse">e1xp</span></a></span><span class="keyword">,</span> 
  res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">,</span> tmp_ret<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#351"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1232"><span class="stacstuse">valprim</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="comment">// val () = printf ("aux_exp_ret_let\n", @())
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> aux_exp_d1eclst <span class="keyword">(</span>d1ecs<span class="keyword">,</span> res<span class="keyword">)</span>
<span class="keyword">in</span>
  <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5543"><span class="dyncstuse">aux_exp_ret</span></a> <span class="keyword">(</span>e1xp<span class="keyword">,</span> res<span class="keyword">,</span> tmp_ret<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">fun</span> aux_exp_ret_proj <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#236"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> e1xp<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#244"><span class="stacstuse">e1xp</span></a></span><span class="keyword">,</span> pos<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15585"><span class="stacstuse">int</span></a></span><span class="keyword">,</span> 
  res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">,</span> tmp_ret<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#351"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1232"><span class="stacstuse">valprim</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> vp <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5437"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e1xp<span class="keyword">,</span> res<span class="keyword">)</span>

  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> 
    <span class="keyword">(</span><span class="keyword">case+</span> vp <span class="keyword">of</span> 
    <span class="keyword">|</span> VParg _ <span class="keyword">=&gt;</span> instr_add_proj <span class="keyword">(</span>loc<span class="keyword">,</span> tmp_ret<span class="keyword">,</span> vp<span class="keyword">,</span> pos<span class="keyword">,</span> res<span class="keyword">)</span>
    <span class="keyword">|</span> VPtmp _ <span class="keyword">=&gt;</span> instr_add_proj <span class="keyword">(</span>loc<span class="keyword">,</span> tmp_ret<span class="keyword">,</span> vp<span class="keyword">,</span> pos<span class="keyword">,</span> res<span class="keyword">)</span>
    <span class="keyword">|</span> VPtup _ <span class="keyword">=&gt;</span> instr_add_proj <span class="keyword">(</span>loc<span class="keyword">,</span> tmp_ret<span class="keyword">,</span> vp<span class="keyword">,</span> pos<span class="keyword">,</span> res<span class="keyword">)</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"aux_exp_ret_proj left part is not a tuple\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span>
                      <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ferror_2esats.html#120"><span class="dyncstuse">abort</span></a> <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">)</span>
<span class="keyword">in</span>
  VPtmp <span class="keyword">(</span>tmp_ret<span class="keyword">)</span>
<span class="comment">(*  // obsolete code
  case+ vp of
  | VPtup (_, vps) =&gt; let
    val vp_opt = list0_nth_opt (vps, pos)
  in
    case+ vp_opt of
    | Some0 vp =&gt; let
      val () = instr_add_move (loc, tmp_ret, vp, res)
    in
      VPtmp (tmp_ret)
    end
    | None0 () =&gt; ETRACE_MSG_OPR ("aux_exp_ret_proj proj out of bound\n", ETRACE_LEVEL_ERROR,
                    abort (ERRORCODE_FORBIDDEN))
  end
*)</span>
<span class="keyword">end</span>

<span class="keyword">fun</span> aux_exp_ret_app <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#236"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> e_fun<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#244"><span class="stacstuse">e1xp</span></a></span><span class="keyword">,</span> e_arg<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#244"><span class="stacstuse">e1xp</span></a></span><span class="keyword">,</span>
  res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">,</span> tmp_ret<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#351"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1232"><span class="stacstuse">valprim</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> vp_f <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5437"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e_fun<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">val</span> vp_arg <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5437"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e_arg<span class="keyword">,</span> res<span class="keyword">)</span>

  <span class="comment">(* treat all functioins as unary functions *)</span>
  <span class="keyword">val</span> <span class="keyword">(</span>vp_args<span class="keyword">,</span> iswrapper<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> vp_arg <span class="keyword">of</span>
              <span class="keyword">|</span> VPtup <span class="keyword">(</span>_<span class="keyword">,</span> vps<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>vps<span class="keyword">,</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fdyn_2esats.html#4369"><span class="dyncstuse">false</span></a><span class="keyword">)</span>
              <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>cons <span class="keyword">(</span>vp_arg<span class="keyword">,</span> nil<span class="keyword">)</span><span class="keyword">,</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fdyn_2esats.html#4313"><span class="dyncstuse">true</span></a><span class="keyword">)</span>
              <span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1630"><span class="stacstuse">valprimlst</span></a><span class="keyword">,</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15152"><span class="stacstuse">bool</span></a><span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add_call <span class="keyword">(</span>loc<span class="keyword">,</span> tmp_ret<span class="keyword">,</span> vp_f<span class="keyword">,</span> vp_args<span class="keyword">,</span> iswrapper<span class="keyword">,</span> res<span class="keyword">)</span>
<span class="keyword">in</span>
  VPtmp <span class="keyword">(</span>tmp_ret<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">fun</span> aux_exp_ret_tuple <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#236"><span class="stacstuse">loc</span></a></span><span class="keyword">,</span> e1xps<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#1967"><span class="stacstuse">e1xplst</span></a></span><span class="keyword">,</span>
  res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span></a></span><span class="keyword">,</span> tmp_ret<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#351"><span class="stacstuse">tmpvar</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#1232"><span class="stacstuse">valprim</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> vps <span class="keyword">=</span> auxlst_exp <span class="keyword">(</span>e1xps<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> instr_add_tup <span class="keyword">(</span>loc<span class="keyword">,</span> tmp_ret<span class="keyword">,</span> vps<span class="keyword">,</span> res<span class="keyword">)</span>
<span class="keyword">in</span>
  VPtup <span class="keyword">(</span>tmp_ret<span class="keyword">,</span> vps<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">implement</span>
<a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5543"><span class="dyncstimp">aux_exp_ret</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">,</span> ret<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> loc <span class="keyword">=</span> e<span class="keyword">.</span>e1xp_loc
  <span class="comment">// val () = ETRACE_MSG ("aux_exp_ret\n", ETRACE_LEVEL_DEBUG)
</span><span class="keyword">in</span>
  <span class="keyword">case</span> e<span class="keyword">.</span>e1xp_node <span class="keyword">of</span>
  <span class="keyword">|</span> E1XPann <span class="keyword">(</span>e<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5543"><span class="dyncstuse">aux_exp_ret</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">,</span> ret<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPapp <span class="keyword">(</span>e_fun<span class="keyword">,</span> e_arg<span class="keyword">)</span> <span class="keyword">=&gt;</span> aux_exp_ret_app <span class="keyword">(</span>loc<span class="keyword">,</span> e_fun<span class="keyword">,</span> e_arg<span class="keyword">,</span> res<span class="keyword">,</span> ret<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPbool _ <span class="keyword">=&gt;</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5437"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPfix <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"aux_exp_ret shouldn't handle E1XPfix\n"<span class="keyword">,</span> 
                    ETRACE_LEVEL_ERROR<span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ferror_2esats.html#120"><span class="dyncstuse">abort</span></a> <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">|</span> E1XPif <span class="keyword">(</span>e_test<span class="keyword">,</span> e_then<span class="keyword">,</span> oe_else<span class="keyword">)</span> <span class="keyword">=&gt;</span> 
    aux_exp_ret_if <span class="keyword">(</span>loc<span class="keyword">,</span> e_test<span class="keyword">,</span> e_then<span class="keyword">,</span> oe_else<span class="keyword">,</span> res<span class="keyword">,</span> ret<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPint _ <span class="keyword">=&gt;</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5437"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPlam <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"aux_exp_ret shouldn't handle E1XPlam\n"<span class="keyword">,</span> 
                    ETRACE_LEVEL_ERROR<span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ferror_2esats.html#120"><span class="dyncstuse">abort</span></a> <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">|</span> E1XPlet <span class="keyword">(</span>d1ecs<span class="keyword">,</span> e1xp<span class="keyword">)</span> <span class="keyword">=&gt;</span> aux_exp_ret_let <span class="keyword">(</span>loc<span class="keyword">,</span> d1ecs<span class="keyword">,</span> e1xp<span class="keyword">,</span> res<span class="keyword">,</span> ret<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPopr <span class="keyword">(</span>opr<span class="keyword">,</span> exps<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="comment">// val () = printf ("aux_opr\n", @())
</span>  <span class="keyword">in</span>
    aux_exp_ret_opr <span class="keyword">(</span>loc<span class="keyword">,</span> opr<span class="keyword">,</span> exps<span class="keyword">,</span> res<span class="keyword">,</span> ret<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> E1XPproj <span class="keyword">(</span>e1xp<span class="keyword">,</span> pos<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="comment">// val () = printf ("aux_proj\n", @())
</span>  <span class="keyword">in</span>
    aux_exp_ret_proj <span class="keyword">(</span>loc<span class="keyword">,</span> e1xp<span class="keyword">,</span> pos<span class="keyword">,</span> res<span class="keyword">,</span> ret<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> E1XPstr _ <span class="keyword">=&gt;</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5437"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPtup e1xps <span class="keyword">=&gt;</span> aux_exp_ret_tuple <span class="keyword">(</span>loc<span class="keyword">,</span> e1xps<span class="keyword">,</span> res<span class="keyword">,</span> ret<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPvar _ <span class="keyword">=&gt;</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5437"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="comment">(* extern fun aux_exp_fun (e: e1xp, fl: funlab): valprim *)</span>
<span class="comment">(* this function only handle E1XPfix and E1XPlam and E1XPann *)</span>
<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5679"><span class="dyncstimp">aux_exp_fun</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> fl<span class="keyword">)</span> <span class="keyword">=</span> 
  <span class="keyword">case+</span> e<span class="keyword">.</span>e1xp_node <span class="keyword">of</span>
  <span class="keyword">|</span> E1XPann <span class="keyword">(</span>e1<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5679"><span class="dyncstuse">aux_exp_fun</span></a> <span class="keyword">(</span>e1<span class="keyword">,</span> fl<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPfix <span class="keyword">(</span>f<span class="keyword">,</span> args<span class="keyword">,</span> body<span class="keyword">)</span> <span class="keyword">=&gt;</span> aux_exp_fix_lab <span class="keyword">(</span>f<span class="keyword">,</span> args<span class="keyword">,</span> body<span class="keyword">,</span> fl<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPlam <span class="keyword">(</span>args<span class="keyword">,</span> body<span class="keyword">)</span> <span class="keyword">=&gt;</span> aux_exp_lam_lab <span class="keyword">(</span>args<span class="keyword">,</span> body<span class="keyword">,</span> fl<span class="keyword">)</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"aux_exp_fun handle non-function\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span>
                    <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ferror_2esats.html#120"><span class="dyncstuse">abort</span></a> <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>


<span class="comment">(*
trans2_exp (e: e1xp): instrlst
*)</span>
<span class="keyword">implement</span>
<a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2702"><span class="dyncstimp">trans2_exp</span></a> <span class="keyword">(</span>e<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="comment">// val () = ETRACE_MSG ("trans2_exp\n", ETRACE_LEVEL_DEBUG)
</span>
  <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2esats.html#2410"><span class="stacstuse">instrlst</span></a></span> <span class="keyword">=</span> list0_nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">val</span> v <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#5437"><span class="dyncstuse">aux_exp</span></a> <span class="keyword">(</span>e<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="comment">(* reverse the main let *)</span>
  <span class="keyword">val</span> res <span class="keyword">=</span> instr_reverse <span class="keyword">(</span>res<span class="keyword">)</span>

  <span class="keyword">val</span> fns <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans2_2edats.html#4295"><span class="dyncstuse">funent_getall</span></a> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">(</span>res<span class="keyword">,</span> fns<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [trans2.dats] *)</span>


</pre>
</body>
</html>
