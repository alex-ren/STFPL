<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    .atsyntax {color:#E80000;background-color:#E0E0E0}
    .atsyntax span.comment {color:#787878;font-style:italic}
    .atsyntax span.extern  {color:#A52A2A}
    .atsyntax span.keyword {color:#000000;font-weight:bold}
    .atsyntax span.neuexp  {color:#800080}
    .atsyntax span.staexp  {color:#0000FF}
    .atsyntax span.dynexp  {color:#E80000}
    .atsyntax span.prfexp  {color:#009000}
    .atsyntax span.stacstdec  {text-decoration:none}
    .atsyntax span.stacstuse  {color:#0000CF;text-decoration:underline}
    .atsyntax span.dyncstdec  {text-decoration:none}
    .atsyntax span.dyncstimp  {color:#B80000;text-decoration:underline}
    .atsyntax span.dyncstuse  {color:#B80000;text-decoration:underline}
    body {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre class="atsyntax">
<span class="comment">(*
** CAS CS525, Spring 2011
** Instructor: Hongwei Xi
*)</span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//
</span><span class="comment">// A parser for STFPL (a simple typed functional programming language)
</span><span class="comment">// The code was originally written by Hongwei Xi in May 2005
</span><span class="comment">//
</span><span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anonymous*)</span> <span class="keyword">=</span> "prelude/DATS/array.dats"</span>
<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anonymous*)</span> <span class="keyword">=</span> "prelude/SATS/filebas.sats"</span> <span class="comment">// for [stdio.cats]?
</span><span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anonymous*)</span> <span class="keyword">=</span> "prelude/DATS/list.dats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"contrib/parcomb/SATS/posloc.sats"</span>
<span class="keyword">typedef</span> <span class="staexp"><a name="486"><span class="stacstdec">loc <span class="keyword">=</span> location_t</span></a></span>

<span class="keyword">staload</span> <span class="staexp">"contrib/parcomb/SATS/tokenize.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"contrib/parcomb/SATS/parcomb.sats"</span> <span class="keyword">;</span>
<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anonymous*)</span> <span class="keyword">=</span> "contrib/parcomb/DATS/parcomb.dats"</span> <span class="keyword">;</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"error.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"fixity.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"absyn.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"symbol.sats"</span>

<span class="keyword">typedef</span> <span class="staexp"><a name="797"><span class="stacstdec">sym <span class="keyword">=</span> symbol_t</span></a></span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"parser.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">macdef</span> <span class="neuexp">list0_one <span class="keyword">(</span>x<span class="keyword">)</span> <span class="keyword">=</span>
  list0_cons <span class="keyword">(</span><span class="keyword">,(</span>x<span class="keyword">)</span><span class="keyword">,</span> list0_nil<span class="keyword">)</span></span>
<span class="keyword">macdef</span> <span class="neuexp">list0_two <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">)</span> <span class="keyword">=</span>
  list0_cons <span class="keyword">(</span><span class="keyword">,(</span>x1<span class="keyword">)</span><span class="keyword">,</span> list0_cons <span class="keyword">(</span><span class="keyword">,(</span>x2<span class="keyword">)</span><span class="keyword">,</span> list0_nil<span class="keyword">)</span><span class="keyword">)</span></span>

<span class="comment">(* ****** ****** *)</span>

<span class="neuexp"><span class="keyword">infix</span> <span class="keyword">(</span>|| + 1<span class="keyword">)</span> wth</span>
<span class="neuexp"><span class="keyword">infixl</span> <span class="keyword">(</span>&amp;&amp; + 2<span class="keyword">)</span> &lt;&lt;</span><span class="keyword">;</span> <span class="neuexp"><span class="keyword">infixr</span> <span class="keyword">(</span>&amp;&amp; + 1<span class="keyword">)</span> &gt;&gt;</span>
<span class="neuexp"><span class="keyword">postfix</span> ^* ^+ ^?</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">typedef</span> <span class="staexp"><a name="1139"><span class="stacstdec">P <span class="keyword">(</span>a<span class="keyword">:</span> t@ype<span class="keyword">)</span> <span class="keyword">=</span> parser_t <span class="keyword">(</span>a<span class="keyword">,</span> token<span class="keyword">)</span></span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="1182"><span class="stacstdec">LP <span class="keyword">(</span>a<span class="keyword">:</span> t@ype<span class="keyword">)</span> <span class="keyword">=</span> lazy <span class="keyword">(</span>parser_t <span class="keyword">(</span>a<span class="keyword">,</span> token<span class="keyword">)</span><span class="keyword">)</span></span></a></span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">val</span> anytoken <span class="keyword">=</span> any_parser&lt;<span class="staexp">token</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">val</span> anyopttoken <span class="keyword">=</span> anyopt_parser&lt;<span class="staexp">token</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> litchar <span class="keyword">(</span>c0<span class="keyword">:</span> <span class="staexp">char</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">P token</span> <span class="keyword">=</span>
  anytoken <span class="keyword">\</span>sat <span class="keyword">(</span><span class="keyword">lam</span> <span class="keyword">(</span>tok<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=&lt;</span><span class="staexp">cloref</span><span class="keyword">&gt;</span>
    <span class="keyword">case+</span> tok<span class="keyword">.</span>token_node <span class="keyword">of</span> TOKsingleton c <span class="keyword">=&gt;</span> c0 <span class="keyword">=</span> c <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
  <span class="keyword">)</span>

<span class="keyword">val</span> LPAREN <span class="keyword">=</span> litchar '\('
<span class="keyword">val</span> RPAREN <span class="keyword">=</span> litchar ')'
<span class="keyword">val</span> LBRACKET <span class="keyword">=</span> litchar '\['
<span class="keyword">val</span> RBRACKET <span class="keyword">=</span> litchar ']'
<span class="keyword">val</span> LBRACE <span class="keyword">=</span> litchar '\{'
<span class="keyword">val</span> RBRACE <span class="keyword">=</span> litchar '}'

<span class="keyword">val</span> COMMA <span class="keyword">=</span> litchar ','
<span class="keyword">val</span> SEMICOLON <span class="keyword">=</span> litchar ';'

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> litident <span class="keyword">(</span>name0<span class="keyword">:</span> <span class="staexp">string</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">P token</span> <span class="keyword">=</span>
  anytoken <span class="keyword">\</span>sat <span class="keyword">(</span><span class="keyword">lam</span> <span class="keyword">(</span>tok<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=&lt;</span><span class="staexp">cloref</span><span class="keyword">&gt;</span>
    <span class="keyword">case+</span> tok<span class="keyword">.</span>token_node <span class="keyword">of</span> TOKide name <span class="keyword">=&gt;</span> name0 <span class="keyword">=</span> name <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
  <span class="keyword">)</span>
<span class="comment">// end of [litident]
</span>
<span class="comment">//
</span>
<span class="keyword">val</span> COLON <span class="keyword">=</span> litident ":"
<span class="keyword">val</span> DOT <span class="keyword">=</span> litident "."

<span class="keyword">val</span> UMINUS <span class="keyword">=</span> litident "~"

<span class="keyword">val</span> PLUS <span class="keyword">=</span> litident "+"
<span class="keyword">val</span> MINUS <span class="keyword">=</span> litident "-"
<span class="keyword">val</span> TIMES <span class="keyword">=</span> litident "*"
<span class="keyword">val</span> DIVIDE <span class="keyword">=</span> litident "/"

<span class="keyword">val</span> GTEQ <span class="keyword">=</span> litident "&gt;="
<span class="keyword">val</span> GT <span class="keyword">=</span> litident "&gt;"
<span class="keyword">val</span> LTEQ <span class="keyword">=</span> litident "&lt;="
<span class="keyword">val</span> LT <span class="keyword">=</span> litident "&lt;"

<span class="keyword">val</span> EQ <span class="keyword">=</span> litident "="
<span class="keyword">val</span> NEQ <span class="keyword">=</span> litident "&lt;&gt;"

<span class="comment">//
</span>
<span class="keyword">val</span> EQGT <span class="keyword">=</span> litident "=&gt;"

<span class="keyword">val</span> MINUSGT <span class="keyword">=</span> litident "-&gt;"

<span class="comment">//
</span>
<span class="keyword">val</span> AND   <span class="keyword">=</span> litident "and"
<span class="keyword">val</span> APP   <span class="keyword">=</span> litident "app"
<span class="keyword">val</span> ELSE  <span class="keyword">=</span> litident "else"
<span class="keyword">val</span> END   <span class="keyword">=</span> litident "end"
<span class="keyword">val</span> FALSE <span class="keyword">=</span> litident "false"
<span class="keyword">val</span> FIX   <span class="keyword">=</span> litident "fix"
<span class="keyword">val</span> FN    <span class="keyword">=</span> litident "fn"
<span class="keyword">val</span> FUN   <span class="keyword">=</span> litident "fun"
<span class="keyword">val</span> IF    <span class="keyword">=</span> litident "if"
<span class="keyword">val</span> IN    <span class="keyword">=</span> litident "in"
<span class="keyword">val</span> LAM   <span class="keyword">=</span> litident "lam"
<span class="keyword">val</span> LET   <span class="keyword">=</span> litident "let"
<span class="keyword">val</span> THEN  <span class="keyword">=</span> litident "then"
<span class="keyword">val</span> TRUE  <span class="keyword">=</span> litident "true"
<span class="keyword">val</span> VAL   <span class="keyword">=</span> litident "val"
<span class="keyword">val</span> REC   <span class="keyword">=</span> litident "rec"

<span class="keyword">val</span> PRINT <span class="keyword">=</span> litident "print"
<span class="keyword">val</span> PRINT_INT <span class="keyword">=</span> litident "print_int"

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">val</span> arrsz <span class="keyword">=</span> <span class="keyword">$arrsz</span> <span class="keyword">{</span>string<span class="keyword">}</span> <span class="keyword">(</span>
  "and"
<span class="keyword">,</span> "else"
<span class="keyword">,</span> "end"
<span class="keyword">,</span> "fix"
<span class="keyword">,</span> "fun"
<span class="keyword">,</span> "if"
<span class="keyword">,</span> "in"
<span class="keyword">,</span> "lam"
<span class="keyword">,</span> "let"
<span class="keyword">,</span> "then"
<span class="keyword">,</span> "rec"
<span class="keyword">,</span> "val"
<span class="keyword">,</span> "."<span class="keyword">,</span> ":"
<span class="keyword">,</span> "~"<span class="keyword">,</span> "+"<span class="keyword">,</span> "-"<span class="keyword">,</span> "*"<span class="keyword">,</span> "/"
<span class="keyword">,</span> "="<span class="keyword">,</span>":="
<span class="keyword">,</span> "&gt;="<span class="keyword">,</span> "&gt;"<span class="keyword">,</span> "&lt;="<span class="keyword">,</span> "&lt;"<span class="keyword">,</span> "&lt;&gt;"
<span class="keyword">,</span> "|"<span class="keyword">,</span> "&amp;"
<span class="keyword">)</span> <span class="comment">// end of [arrsz]
</span>
<span class="keyword">in</span> <span class="comment">// in of [local]
</span>
<span class="keyword">val</span> theKeywordArrSz <span class="keyword">=</span> arrsz<span class="keyword">.</span>3
<span class="keyword">val</span> theKeywordArray <span class="keyword">=</span> array_make_arrsz <span class="staexp"><span class="keyword">{</span>string<span class="keyword">}</span></span> arrsz

<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> isKeyword
  <span class="keyword">(</span>name0<span class="keyword">:</span> <span class="staexp">string</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> ans <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">var</span> i<span class="keyword">:</span> <span class="staexp">Nat</span> <span class="keyword">=</span> 0 <span class="keyword">and</span> ans<span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span> false
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">$effmask_all</span> <span class="keyword">(</span>
    <span class="keyword">while</span> <span class="keyword">(</span>i <span class="keyword">&lt;</span> theKeywordArrSz<span class="keyword">)</span> <span class="keyword">let</span>
      <span class="keyword">val</span> name <span class="keyword">=</span> theKeywordArray[<span class="prfexp">i</span><span class="keyword">]</span> <span class="keyword">in</span>
      <span class="keyword">if</span> name0 <span class="keyword">=</span> name <span class="keyword">then</span> <span class="keyword">(</span>ans := true<span class="keyword">;</span> <span class="keyword">break</span><span class="keyword">)</span><span class="keyword">;</span> i := i+1
    <span class="keyword">end</span> <span class="comment">// end of [while]
</span>  <span class="keyword">)</span> <span class="comment">// end of [val]
</span><span class="keyword">}</span> <span class="comment">(* end of [isKeyword] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">val</span> p_ident<span class="keyword">:</span> <span class="staexp">P token</span> <span class="keyword">=</span>
  anytoken <span class="keyword">\</span>sat <span class="keyword">(</span><span class="keyword">lam</span> <span class="keyword">(</span>tok<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=&lt;</span><span class="staexp"><span class="keyword">fun</span></span><span class="keyword">&gt;</span> <span class="keyword">case+</span> tok<span class="keyword">.</span>token_node <span class="keyword">of</span>
    <span class="keyword">|</span> TOKide name <span class="keyword">=&gt;</span> <span class="keyword">if</span> isKeyword name <span class="keyword">then</span> false <span class="keyword">else</span> true <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
  <span class="keyword">)</span>
<span class="comment">// end of [p_ident]
</span>
<span class="keyword">val</span> p_number<span class="keyword">:</span> <span class="staexp">P token</span> <span class="keyword">=</span>
  anytoken <span class="keyword">\</span>sat <span class="keyword">(</span><span class="keyword">lam</span> <span class="keyword">(</span>tok<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=&lt;</span><span class="staexp"><span class="keyword">fun</span></span><span class="keyword">&gt;</span>
    <span class="keyword">case+</span> tok<span class="keyword">.</span>token_node <span class="keyword">of</span> TOKint _ <span class="keyword">=&gt;</span> true <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
  <span class="keyword">)</span>
<span class="comment">// end of [p_number]
</span>
<span class="keyword">val</span> p_string<span class="keyword">:</span> <span class="staexp">P token</span> <span class="keyword">=</span>
  anytoken <span class="keyword">\</span>sat <span class="keyword">(</span><span class="keyword">lam</span> <span class="keyword">(</span>tok<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=&lt;</span><span class="staexp"><span class="keyword">fun</span></span><span class="keyword">&gt;</span>
    <span class="keyword">case+</span> tok<span class="keyword">.</span>token_node <span class="keyword">of</span> TOKstr _ <span class="keyword">=&gt;</span> true <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false
  <span class="keyword">)</span>
<span class="comment">// end of [p_string]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> symbol_make_token
  <span class="keyword">(</span>tok<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">sym</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val-</span> TOKide name <span class="keyword">=</span> tok<span class="keyword">.</span>token_node
<span class="keyword">in</span>
  <span class="keyword">$effmask_all</span> <span class="keyword">(</span>symbol_make_name name<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [symbol_make_token]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">local</span>

<span class="keyword">#define</span> <span class="neuexp">PLUS_precedence 40</span>
<span class="keyword">#define</span> <span class="neuexp">MINUS_precedence 40</span>

<span class="keyword">#define</span> <span class="neuexp">TIMES_precedence 60</span>
<span class="keyword">#define</span> <span class="neuexp">DIVIDE_precedence 60</span>

<span class="keyword">#define</span> <span class="neuexp">UMINUS_precedence 61</span>

<span class="keyword">#define</span> <span class="neuexp">EQ_precedence 20</span>
<span class="keyword">#define</span> <span class="neuexp">NEQ_precedence 20</span>

<span class="keyword">#define</span> <span class="neuexp">GTEQ_precedence 20</span>
<span class="keyword">#define</span> <span class="neuexp">GT_precedence 20</span>
<span class="keyword">#define</span> <span class="neuexp">LTEQ_precedence 20</span>
<span class="keyword">#define</span> <span class="neuexp">LT_precedence 20</span>

<span class="keyword">#define</span> <span class="neuexp">AMPAMP_precedence 9</span>
<span class="keyword">#define</span> <span class="neuexp">BARBAR_precedence 8</span>

<span class="keyword">#define</span> <span class="neuexp">PRINT_precedence 61</span>
<span class="keyword">#define</span> <span class="neuexp">PRINT_INT_precedence 61</span>

<span class="keyword">#define</span> <span class="neuexp">L LeftAssoc</span><span class="keyword">;</span> <span class="keyword">#define</span> <span class="neuexp">R RightAssoc</span><span class="keyword">;</span> <span class="keyword">#define</span> <span class="neuexp">N NonAssoc</span>

<span class="keyword">in</span> <span class="comment">// in of [local]
</span>
<span class="keyword">val</span> p_opr<span class="keyword">:</span> <span class="staexp">P <span class="keyword">(</span>fixopr e0xp<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
  PLUS wth <span class="keyword">(</span>
    <span class="keyword">lam</span> <span class="keyword">(</span>tok<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span> <span class="keyword">=&lt;</span><span class="staexp"><span class="keyword">fun</span></span><span class="keyword">&gt;</span> f_infix <span class="keyword">(</span>tok<span class="keyword">,</span> L<span class="keyword">,</span> PLUS_precedence<span class="keyword">)</span>
  <span class="keyword">)</span> ||
  MINUS wth <span class="keyword">(</span>
    <span class="keyword">lam</span> <span class="keyword">(</span>tok<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span> <span class="keyword">=&lt;</span><span class="staexp"><span class="keyword">fun</span></span><span class="keyword">&gt;</span> f_infix <span class="keyword">(</span>tok<span class="keyword">,</span> L<span class="keyword">,</span> MINUS_precedence<span class="keyword">)</span>
  <span class="keyword">)</span> ||
  TIMES wth <span class="keyword">(</span>
    <span class="keyword">lam</span> <span class="keyword">(</span>tok<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span> <span class="keyword">=&lt;</span><span class="staexp"><span class="keyword">fun</span></span><span class="keyword">&gt;</span> f_infix <span class="keyword">(</span>tok<span class="keyword">,</span> L<span class="keyword">,</span> TIMES_precedence<span class="keyword">)</span>
  <span class="keyword">)</span> ||
  DIVIDE wth <span class="keyword">(</span>
    <span class="keyword">lam</span> <span class="keyword">(</span>tok<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span> <span class="keyword">=&lt;</span><span class="staexp"><span class="keyword">fun</span></span><span class="keyword">&gt;</span> f_infix <span class="keyword">(</span>tok<span class="keyword">,</span> L<span class="keyword">,</span> DIVIDE_precedence<span class="keyword">)</span>
  <span class="keyword">)</span> ||
  GTEQ wth <span class="keyword">(</span>
    <span class="keyword">lam</span> <span class="keyword">(</span>tok<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span> <span class="keyword">=&lt;</span><span class="staexp"><span class="keyword">fun</span></span><span class="keyword">&gt;</span> f_infix <span class="keyword">(</span>tok<span class="keyword">,</span> N<span class="keyword">,</span> GTEQ_precedence<span class="keyword">)</span>
  <span class="keyword">)</span> ||
  GT wth <span class="keyword">(</span>
    <span class="keyword">lam</span> <span class="keyword">(</span>tok<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span> <span class="keyword">=&lt;</span><span class="staexp"><span class="keyword">fun</span></span><span class="keyword">&gt;</span> f_infix <span class="keyword">(</span>tok<span class="keyword">,</span> N<span class="keyword">,</span> GT_precedence<span class="keyword">)</span>
  <span class="keyword">)</span> ||
  LTEQ wth <span class="keyword">(</span>
    <span class="keyword">lam</span> <span class="keyword">(</span>tok<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span> <span class="keyword">=&lt;</span><span class="staexp"><span class="keyword">fun</span></span><span class="keyword">&gt;</span> f_infix <span class="keyword">(</span>tok<span class="keyword">,</span> N<span class="keyword">,</span> LTEQ_precedence<span class="keyword">)</span>
  <span class="keyword">)</span> ||
  LT wth <span class="keyword">(</span>
    <span class="keyword">lam</span> <span class="keyword">(</span>tok<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span> <span class="keyword">=&lt;</span><span class="staexp"><span class="keyword">fun</span></span><span class="keyword">&gt;</span> f_infix <span class="keyword">(</span>tok<span class="keyword">,</span> N<span class="keyword">,</span> LT_precedence<span class="keyword">)</span>
  <span class="keyword">)</span> ||
  EQ wth <span class="keyword">(</span>
    <span class="keyword">lam</span> <span class="keyword">(</span>tok<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span> <span class="keyword">=&lt;</span><span class="staexp"><span class="keyword">fun</span></span><span class="keyword">&gt;</span> f_infix <span class="keyword">(</span>tok<span class="keyword">,</span> N<span class="keyword">,</span> EQ_precedence<span class="keyword">)</span>
  <span class="keyword">)</span> ||
  NEQ wth <span class="keyword">(</span>
    <span class="keyword">lam</span> <span class="keyword">(</span>tok<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span> <span class="keyword">=&lt;</span><span class="staexp"><span class="keyword">fun</span></span><span class="keyword">&gt;</span> f_infix <span class="keyword">(</span>tok<span class="keyword">,</span> N<span class="keyword">,</span> NEQ_precedence<span class="keyword">)</span>
  <span class="keyword">)</span> ||
  UMINUS wth <span class="keyword">(</span>
    <span class="keyword">lam</span> <span class="keyword">(</span>tok<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span> <span class="keyword">=&lt;</span><span class="staexp"><span class="keyword">fun</span></span><span class="keyword">&gt;</span> f_prefx <span class="keyword">(</span>tok<span class="keyword">,</span> UMINUS_precedence<span class="keyword">)</span>
  <span class="keyword">)</span> ||
  PRINT wth <span class="keyword">(</span>
    <span class="keyword">lam</span> <span class="keyword">(</span>tok<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span> <span class="keyword">=&lt;</span><span class="staexp"><span class="keyword">fun</span></span><span class="keyword">&gt;</span> f_prefx <span class="keyword">(</span>tok<span class="keyword">,</span> PRINT_precedence<span class="keyword">)</span>  
  <span class="keyword">)</span> ||
  PRINT_INT wth <span class="keyword">(</span>
    <span class="keyword">lam</span> <span class="keyword">(</span>tok<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span> <span class="keyword">=&lt;</span><span class="staexp"><span class="keyword">fun</span></span><span class="keyword">&gt;</span> f_prefx <span class="keyword">(</span>tok<span class="keyword">,</span> PRINT_INT_precedence<span class="keyword">)</span>  
  <span class="keyword">)</span>
<span class="keyword">end</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fn</span> f_prefx
    <span class="keyword">(</span>tok<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">,</span> prec<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">)</span>
    <span class="keyword">:&lt;&gt;</span> <span class="staexp">fixopr e0xp</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> opr <span class="keyword">=</span> OPR <span class="keyword">(</span>symbol_make_token tok<span class="keyword">)</span>
    <span class="keyword">val</span> f <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>e<span class="keyword">:</span> <span class="staexp">e0xp</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">e0xp</span> <span class="keyword">=&lt;</span><span class="staexp">cloref</span><span class="keyword">&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> loc <span class="keyword">=</span> location_combine <span class="keyword">(</span>tok<span class="keyword">.</span>token_loc<span class="keyword">,</span> e<span class="keyword">.</span>e0xp_loc<span class="keyword">)</span>
    <span class="keyword">in</span>
      e0xp_make_opr <span class="keyword">(</span>loc<span class="keyword">,</span> opr<span class="keyword">,</span> list0_one <span class="keyword">(</span>e<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [f]
</span>  <span class="keyword">in</span>
    Prefix <span class="keyword">(</span>tok<span class="keyword">.</span>token_loc<span class="keyword">,</span> prec<span class="keyword">,</span> f<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [f_minus]
</span>  <span class="keyword">fn</span> f_infix
    <span class="keyword">(</span>tok<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">,</span> assoc<span class="keyword">:</span> <span class="staexp">assoc</span><span class="keyword">,</span> prec<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">)</span>
    <span class="keyword">:&lt;&gt;</span> <span class="staexp">fixopr e0xp</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> f <span class="keyword">=</span> <span class="keyword">lam</span>
      <span class="keyword">(</span>e1<span class="keyword">:</span> <span class="staexp">e0xp</span><span class="keyword">,</span> e2<span class="keyword">:</span> <span class="staexp">e0xp</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">e0xp</span> <span class="keyword">=&lt;</span><span class="staexp">cloref</span><span class="keyword">&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> opr <span class="keyword">=</span> OPR <span class="keyword">(</span>symbol_make_token tok<span class="keyword">)</span>
      <span class="keyword">val</span> loc <span class="keyword">=</span> location_combine <span class="keyword">(</span>e1<span class="keyword">.</span>e0xp_loc<span class="keyword">,</span> e2<span class="keyword">.</span>e0xp_loc<span class="keyword">)</span> <span class="keyword">in</span>
      e0xp_make_opr <span class="keyword">(</span>loc<span class="keyword">,</span> opr<span class="keyword">,</span> list0_two <span class="keyword">(</span>e1<span class="keyword">,</span> e2<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [f]
</span>  <span class="keyword">in</span>
    Infix <span class="keyword">(</span>tok<span class="keyword">.</span>token_loc<span class="keyword">,</span> prec<span class="keyword">,</span> assoc<span class="keyword">,</span> f<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [f_infix]
</span><span class="keyword">}</span> <span class="comment">(* end of [where] *)</span>

<span class="keyword">end</span> <span class="comment">// end of [local]
</span>  
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(*
** ty0 = sym | (ty, ..., ty); ty = ty0 | ty0 -&gt; ty
*)</span>

<span class="keyword">#define</span> <span class="neuexp">l2l list0_of_list1</span>
<span class="keyword">#define</span> <span class="neuexp">o2o option0_of_option1</span>

<span class="keyword">typedef</span> <span class="staexp"><a name="6845"><span class="stacstdec">t0yplst1 <span class="keyword">=</span> List <span class="keyword">(</span>t0yp<span class="keyword">)</span></span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="6876"><span class="stacstdec">t0ypc <span class="keyword">=</span> t0yp <span class="keyword">-&lt;</span>cloref<span class="keyword">&gt;</span> t0yp</span></a></span>

<span class="keyword">val</span>
<span class="keyword">rec</span> lp_t0yp<span class="keyword">:</span> <span class="staexp">LP <span class="keyword">(</span>t0yp<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">$delay</span> <span class="keyword">(</span>
  seq2wth_parser_fun <span class="keyword">(</span>lzeta lp_t0yp1<span class="keyword">,</span> lzeta lp_t0ypc<span class="keyword">,</span> f<span class="keyword">)</span>
<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">val</span> f <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp">t0yp</span><span class="keyword">,</span> tc<span class="keyword">:</span> <span class="staexp">t0ypc</span><span class="keyword">)</span> <span class="keyword">=&lt;</span><span class="staexp"><span class="keyword">fun</span></span><span class="keyword">&gt;</span> tc <span class="keyword">(</span>t<span class="keyword">)</span> 
<span class="keyword">}</span> <span class="comment">(* end of [lp_t0yp] *)</span>

<span class="keyword">and</span> lp_t0yplist<span class="keyword">:</span> <span class="staexp">LP t0yplst1</span> <span class="keyword">=</span> <span class="keyword">$delay</span> <span class="keyword">(</span>
  repeat0_sep_parser&lt;<span class="staexp">t0yp</span><span class="keyword">,</span><span class="staexp">token</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>lp_t0yp<span class="keyword">,</span> COMMA<span class="keyword">)</span>
<span class="keyword">)</span> <span class="comment">// end of [lp_t0yplst]
</span>
<span class="keyword">and</span> lp_t0yp1<span class="keyword">:</span> <span class="staexp">LP <span class="keyword">(</span>t0yp<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">$delay</span> <span class="keyword">(</span>
  p_ident wth f_ident ||
  seq3wth_parser_fun <span class="keyword">(</span>LPAREN<span class="keyword">,</span> lzeta lp_t0yplist<span class="keyword">,</span> RPAREN<span class="keyword">,</span> f_tup<span class="keyword">)</span>
<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">val</span> f_ident <span class="keyword">=</span> <span class="keyword">lam</span>
    <span class="keyword">(</span>tok_ide<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span> <span class="keyword">=&lt;&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> loc <span class="keyword">=</span> tok_ide<span class="keyword">.</span>token_loc<span class="keyword">;</span> <span class="keyword">val</span> sym_id <span class="keyword">=</span> symbol_make_token tok_ide
  <span class="keyword">in</span>
    t0yp_make_sym <span class="keyword">(</span>loc<span class="keyword">,</span> sym_id<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [f_ident]
</span>  <span class="keyword">val</span> f_tup <span class="keyword">=</span> <span class="keyword">lam</span>
    <span class="keyword">(</span>tok1<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">,</span> ts<span class="keyword">:</span> <span class="staexp">t0yplst1</span><span class="keyword">,</span> tok2<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span> <span class="keyword">=&lt;&gt;</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> ts <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>t<span class="keyword">,</span> list_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> t <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> loc <span class="keyword">=</span> location_combine <span class="keyword">(</span>tok1<span class="keyword">.</span>token_loc<span class="keyword">,</span> tok2<span class="keyword">.</span>token_loc<span class="keyword">)</span> <span class="keyword">in</span>
        t0yp_make_tup <span class="keyword">(</span>loc<span class="keyword">,</span> l2l <span class="keyword">(</span>ts<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [f_seq]  
</span>  <span class="keyword">end</span> <span class="comment">// end of [lam]     
</span><span class="keyword">}</span> <span class="comment">(* end of [lp_t0yp1] *)</span>

<span class="keyword">and</span> lp_t0ypc<span class="keyword">:</span> <span class="staexp">LP <span class="keyword">(</span>t0ypc<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">$delay</span> <span class="keyword">(</span>
  seq2wth_parser_fun
    <span class="keyword">(</span>MINUSGT<span class="keyword">,</span> <span class="keyword">!</span>lp_t0yp<span class="keyword">,</span> f<span class="keyword">)</span> ||
  return_parser&lt;<span class="staexp">t0ypc</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">lam</span> t <span class="keyword">=&gt;</span> t<span class="keyword">)</span> 
<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">val</span> f <span class="keyword">=</span> <span class="keyword">lam</span>
    <span class="keyword">(</span>_<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">,</span> t_res<span class="keyword">:</span> <span class="staexp">t0yp</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">t0ypc</span> <span class="keyword">=&lt;</span><span class="staexp"><span class="keyword">fun</span></span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">lam</span> t_arg <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> loc <span class="keyword">=</span> location_combine <span class="keyword">(</span>t_arg<span class="keyword">.</span>t0yp_loc<span class="keyword">,</span> t_res<span class="keyword">.</span>t0yp_loc<span class="keyword">)</span>
  <span class="keyword">in</span>
    t0yp_make_fun <span class="keyword">(</span>loc<span class="keyword">,</span> t_arg<span class="keyword">,</span> t_res<span class="keyword">)</span>
  <span class="keyword">end</span><span class="keyword">)</span> <span class="comment">// end of [val]
</span><span class="keyword">}</span> <span class="comment">(* end of [lp_t0ypc] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">typedef</span> <span class="staexp"><a name="8246"><span class="stacstdec">t0ypopt1 <span class="keyword">=</span> Option <span class="keyword">(</span>t0yp<span class="keyword">)</span></span></a></span>

<span class="keyword">val</span> lp_typann<span class="keyword">:</span> <span class="staexp">LP <span class="keyword">(</span>t0ypopt1<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">$delay</span> <span class="keyword">(</span>
  seq2wth_parser_fun <span class="keyword">(</span>COLON<span class="keyword">,</span> <span class="keyword">!</span>lp_t0yp<span class="keyword">,</span> f_some<span class="keyword">)</span> ||
  return_parser <span class="keyword">(</span>None <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">val</span> f_some <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>_<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">,</span> t<span class="keyword">:</span> <span class="staexp">t0yp</span><span class="keyword">)</span> <span class="keyword">=&lt;</span><span class="staexp"><span class="keyword">fun</span></span><span class="keyword">&gt;</span> Some <span class="keyword">(</span>t<span class="keyword">)</span>
<span class="keyword">}</span> <span class="comment">// end of [lp_annty]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">val</span> app_e0xp <span class="keyword">:</span> <span class="staexp">fixitm e0xp</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> f <span class="keyword">=</span> <span class="keyword">lam</span>
    <span class="keyword">(</span>e1<span class="keyword">:</span> <span class="staexp">e0xp</span><span class="keyword">,</span> e2<span class="keyword">:</span> <span class="staexp">e0xp</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">e0xp</span> <span class="keyword">=&lt;</span><span class="staexp">cloref</span><span class="keyword">&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> loc <span class="keyword">=</span> location_combine <span class="keyword">(</span>e1<span class="keyword">.</span>e0xp_loc<span class="keyword">,</span> e2<span class="keyword">.</span>e0xp_loc<span class="keyword">)</span>
  <span class="keyword">in</span>
    e0xp_make_app <span class="keyword">(</span>loc<span class="keyword">,</span> e1<span class="keyword">,</span> e2<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  fixitm_make_app <span class="keyword">(</span>f<span class="keyword">)</span>  
<span class="keyword">end</span> <span class="comment">(* end of [app_e0xp] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">typedef</span> <span class="staexp"><a name="8792"><span class="stacstdec">e0xplst1 <span class="keyword">=</span> List <span class="keyword">(</span>e0xp<span class="keyword">)</span></span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="8823"><span class="stacstdec">e0xpopt1 <span class="keyword">=</span> Option <span class="keyword">(</span>e0xp<span class="keyword">)</span></span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="8856"><span class="stacstdec">e0xpc <span class="keyword">=</span> e0xp <span class="keyword">-&lt;</span>cloref<span class="keyword">&gt;</span> e0xp</span></a></span>

<span class="keyword">typedef</span> <span class="staexp"><a name="8893"><span class="stacstdec">a0rglst1 <span class="keyword">=</span> List <span class="keyword">(</span>a0rg<span class="keyword">)</span></span></a></span>

<span class="keyword">typedef</span> <span class="staexp"><a name="8925"><span class="stacstdec">d0eclst1 <span class="keyword">=</span> List <span class="keyword">(</span>d0ec<span class="keyword">)</span></span></a></span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">val</span>
<span class="keyword">rec</span> lp_e0xp
  <span class="keyword">:</span> <span class="staexp">LP <span class="keyword">(</span>e0xp<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">$delay</span> <span class="keyword">(</span>
  lzeta lp_e0xp_if ||
  lzeta lp_e0xp_lam || 
  lzeta lp_e0xp_fix || 
  lzeta lp_e0xp2
<span class="keyword">)</span> <span class="comment">// end of [lp_e0xp]
</span>
<span class="keyword">and</span> lp_e0xplist<span class="keyword">:</span> <span class="staexp">LP e0xplst1</span> <span class="keyword">=</span> <span class="keyword">$delay</span> <span class="keyword">(</span>
  repeat0_sep_parser&lt;<span class="staexp">e0xp</span><span class="keyword">,</span><span class="staexp">token</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>lp_e0xp<span class="keyword">,</span> COMMA<span class="keyword">)</span>
<span class="keyword">)</span> <span class="comment">// end of [p_explst]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">and</span> lp_e0xp_if<span class="keyword">:</span> <span class="staexp">LP e0xp</span> <span class="keyword">=</span> <span class="keyword">$delay</span> <span class="keyword">(</span>seq4wth_parser_fun
  <span class="keyword">(</span>IF<span class="keyword">,</span> <span class="keyword">!</span>lp_e0xp<span class="keyword">,</span> THEN &gt;&gt; <span class="keyword">!</span>lp_e0xp<span class="keyword">,</span> <span class="keyword">(</span>ELSE &gt;&gt; <span class="keyword">!</span>lp_e0xp<span class="keyword">)</span>^?<span class="keyword">,</span> f_if<span class="keyword">)</span>
<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fn</span> f_if
    <span class="keyword">(</span>tok_if<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">,</span> e1<span class="keyword">:</span> <span class="staexp">e0xp</span><span class="keyword">,</span> e2<span class="keyword">:</span> <span class="staexp">e0xp</span><span class="keyword">,</span> oe3<span class="keyword">:</span> <span class="staexp">e0xpopt1</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">e0xp</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> loc <span class="keyword">=</span> <span class="keyword">case+</span> oe3 <span class="keyword">of</span>
      <span class="keyword">|</span> Some e3 <span class="keyword">=&gt;</span> location_combine <span class="keyword">(</span>tok_if<span class="keyword">.</span>token_loc<span class="keyword">,</span> e3<span class="keyword">.</span>e0xp_loc<span class="keyword">)</span>
      <span class="keyword">|</span> None <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> location_combine <span class="keyword">(</span>tok_if<span class="keyword">.</span>token_loc<span class="keyword">,</span> e2<span class="keyword">.</span>e0xp_loc<span class="keyword">)</span>
    <span class="comment">// end of [val]  
</span>  <span class="keyword">in</span>
    e0xp_make_if <span class="keyword">(</span>loc<span class="keyword">,</span> e1<span class="keyword">,</span> e2<span class="keyword">,</span> o2o <span class="keyword">(</span>oe3<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [f_if]
</span><span class="keyword">}</span> <span class="comment">// end of [lp_e0xp_if]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">and</span> lp_a0rg<span class="keyword">:</span> <span class="staexp">LP a0rg</span> <span class="keyword">=</span> <span class="keyword">$delay</span> <span class="keyword">(</span>
  seq2wth_parser_fun <span class="keyword">(</span>p_ident<span class="keyword">,</span> <span class="keyword">!</span>lp_typann<span class="keyword">,</span> f_a0rg<span class="keyword">)</span> 
<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fn</span> f_a0rg
    <span class="keyword">(</span>tok_ide<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">,</span> oty<span class="keyword">:</span> <span class="staexp">t0ypopt1</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">a0rg</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> sym <span class="keyword">=</span> symbol_make_token <span class="keyword">(</span>tok_ide<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">@{</span>
    a0rg_loc<span class="keyword">=</span> tok_ide<span class="keyword">.</span>token_loc<span class="keyword">,</span> a0rg_nam<span class="keyword">=</span> sym<span class="keyword">,</span> a0rg_typ<span class="keyword">=</span> o2o <span class="keyword">(</span>oty<span class="keyword">)</span>
  <span class="keyword">}</span> <span class="keyword">end</span> <span class="comment">// end of [f_a0rg]
</span><span class="keyword">}</span> <span class="comment">(* end of [lp_a0rg] *)</span>

<span class="keyword">and</span> lp_a0rglist<span class="keyword">:</span> <span class="staexp">LP a0rglst1</span> <span class="keyword">=</span> <span class="keyword">$delay</span> <span class="keyword">(</span>
  repeat0_sep_parser&lt;<span class="staexp">a0rg</span><span class="keyword">,</span><span class="staexp">token</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>lp_a0rg<span class="keyword">,</span> COMMA<span class="keyword">)</span>
<span class="keyword">)</span> <span class="comment">// end of [p_explst]
</span>
<span class="keyword">and</span> lp_e0xp_lam<span class="keyword">:</span> <span class="staexp">LP e0xp</span> <span class="keyword">=</span> <span class="keyword">$delay</span> <span class="keyword">(</span>
  seq4wth_parser_fun <span class="keyword">(</span>
    LAM<span class="keyword">,</span> LPAREN &gt;&gt; <span class="keyword">!</span>lp_a0rglist &lt;&lt; RPAREN<span class="keyword">,</span> <span class="keyword">!</span>lp_typann<span class="keyword">,</span> EQGT &gt;&gt; <span class="keyword">!</span>lp_e0xp<span class="keyword">,</span> f_lam
  <span class="keyword">)</span> <span class="comment">// end of [seq5wth]
</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fn</span> f_lam <span class="keyword">(</span>
      tok_lam<span class="keyword">:</span> <span class="staexp">token</span>
    <span class="keyword">,</span> args<span class="keyword">:</span> <span class="staexp">a0rglst1</span>
    <span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp">t0ypopt1</span>
    <span class="keyword">,</span> body<span class="keyword">:</span> <span class="staexp">e0xp</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">e0xp</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> loc <span class="keyword">=</span> location_combine <span class="keyword">(</span>tok_lam<span class="keyword">.</span>token_loc<span class="keyword">,</span> body<span class="keyword">.</span>e0xp_loc<span class="keyword">)</span>
  <span class="keyword">in</span>
    e0xp_make_lam <span class="keyword">(</span>loc<span class="keyword">,</span> l2l <span class="keyword">(</span>args<span class="keyword">)</span><span class="keyword">,</span> o2o <span class="keyword">(</span>res<span class="keyword">)</span><span class="keyword">,</span> body<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [f_lam]  
</span><span class="keyword">}</span> <span class="comment">// end of [lp_e0xp_lam]
</span>
<span class="keyword">and</span> lp_e0xp_fix<span class="keyword">:</span> <span class="staexp">LP e0xp</span> <span class="keyword">=</span> <span class="keyword">$delay</span> <span class="keyword">(</span>
  seq5wth_parser_fun <span class="keyword">(</span>
    FIX<span class="keyword">,</span>  p_ident<span class="keyword">,</span> LPAREN &gt;&gt; <span class="keyword">!</span>lp_a0rglist &lt;&lt; RPAREN<span class="keyword">,</span> <span class="keyword">!</span>lp_typann<span class="keyword">,</span> EQGT &gt;&gt; <span class="keyword">!</span>lp_e0xp<span class="keyword">,</span> f_fix
  <span class="keyword">)</span> <span class="comment">// end of [seq5wth]
</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fn</span> f_fix <span class="keyword">(</span>
      tok_fix<span class="keyword">:</span> <span class="staexp">token</span>
    <span class="keyword">,</span> tok_ide<span class="keyword">:</span> <span class="staexp">token</span>  
    <span class="keyword">,</span> args<span class="keyword">:</span> <span class="staexp">a0rglst1</span>
    <span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp">t0ypopt1</span>
    <span class="keyword">,</span> body<span class="keyword">:</span> <span class="staexp">e0xp</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">e0xp</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> loc <span class="keyword">=</span> location_combine <span class="keyword">(</span>tok_fix<span class="keyword">.</span>token_loc<span class="keyword">,</span> body<span class="keyword">.</span>e0xp_loc<span class="keyword">)</span>
    <span class="keyword">val</span> sym <span class="keyword">=</span> symbol_make_token <span class="keyword">(</span>tok_ide<span class="keyword">)</span>
  <span class="keyword">in</span>
    e0xp_make_fix <span class="keyword">(</span>loc<span class="keyword">,</span> sym<span class="keyword">,</span> l2l <span class="keyword">(</span>args<span class="keyword">)</span><span class="keyword">,</span> o2o <span class="keyword">(</span>res<span class="keyword">)</span><span class="keyword">,</span> body<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [f_lam]  
</span><span class="keyword">}</span> <span class="comment">// end of [lp_e0xp_lam]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">and</span> lp_e0xp0<span class="keyword">:</span> <span class="staexp">LP e0xp</span> <span class="keyword">=</span> <span class="keyword">$delay</span> <span class="keyword">(</span> <span class="comment">// ordering is significant!
</span>  TRUE wth f_true ||
  FALSE wth f_false ||
  p_ident wth f_var ||
  p_number wth f_number ||
  p_string wth f_string ||
  seq3wth_parser_fun
    <span class="keyword">(</span>LPAREN<span class="keyword">,</span> <span class="keyword">!</span>lp_e0xplist<span class="keyword">,</span> RPAREN<span class="keyword">,</span> f_tup<span class="keyword">)</span> ||
  <span class="comment">// end of [seq3wth_parser]
</span>  seq5wth_parser_fun
    <span class="keyword">(</span>LET<span class="keyword">,</span> lzeta lp_d0eclist<span class="keyword">,</span> IN<span class="keyword">,</span> <span class="keyword">!</span>lp_e0xp<span class="keyword">,</span> END<span class="keyword">,</span> f_let<span class="keyword">)</span>
  <span class="comment">// end of [seq5wth_parser]
</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fn</span> f_var <span class="keyword">(</span>tok<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">e0xp</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> loc <span class="keyword">=</span> tok<span class="keyword">.</span>token_loc<span class="keyword">;</span> <span class="keyword">val</span> sym <span class="keyword">=</span> symbol_make_token tok <span class="keyword">in</span>
    e0xp_make_var <span class="keyword">(</span>loc<span class="keyword">,</span> sym<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [f_string]
</span>  <span class="keyword">fn</span> f_true <span class="keyword">(</span>tok<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">e0xp</span> <span class="keyword">=</span> e0xp_make_bool <span class="keyword">(</span>tok<span class="keyword">.</span>token_loc<span class="keyword">,</span> true<span class="keyword">)</span>
  <span class="keyword">fn</span> f_false <span class="keyword">(</span>tok<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">e0xp</span> <span class="keyword">=</span> e0xp_make_bool <span class="keyword">(</span>tok<span class="keyword">.</span>token_loc<span class="keyword">,</span> false<span class="keyword">)</span>
  <span class="keyword">fn</span> f_number <span class="keyword">(</span>tok<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">e0xp</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> loc <span class="keyword">=</span> tok<span class="keyword">.</span>token_loc<span class="keyword">;</span> <span class="keyword">val-</span> TOKint int <span class="keyword">=</span> tok<span class="keyword">.</span>token_node <span class="keyword">in</span>
    e0xp_make_int <span class="keyword">(</span>loc<span class="keyword">,</span> int<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [f_string]
</span>  <span class="keyword">fn</span> f_string <span class="keyword">(</span>tok<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">e0xp</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> loc <span class="keyword">=</span> tok<span class="keyword">.</span>token_loc<span class="keyword">;</span> <span class="keyword">val-</span> TOKstr str <span class="keyword">=</span> tok<span class="keyword">.</span>token_node <span class="keyword">in</span>
    e0xp_make_str <span class="keyword">(</span>loc<span class="keyword">,</span> str<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [f_string]
</span>  <span class="keyword">fn</span> f_tup
    <span class="keyword">(</span>tok_beg<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">,</span> es<span class="keyword">:</span> <span class="staexp">e0xplst1</span><span class="keyword">,</span> tok_end<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">e0xp</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> es <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>e<span class="keyword">,</span> list_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> e <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> loc <span class="keyword">=</span> location_combine <span class="keyword">(</span>tok_beg<span class="keyword">.</span>token_loc<span class="keyword">,</span> tok_end<span class="keyword">.</span>token_loc<span class="keyword">)</span>
      <span class="keyword">in</span>
        e0xp_make_tup <span class="keyword">(</span>loc<span class="keyword">,</span> l2l <span class="keyword">(</span>es<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [_]
</span>  <span class="keyword">end</span> <span class="comment">// end of [f_seq]
</span>  <span class="keyword">fn</span> f_let <span class="keyword">(</span>
      tok_let<span class="keyword">:</span> <span class="staexp">token</span>
    <span class="keyword">,</span> ds<span class="keyword">:</span> <span class="staexp">d0eclst1</span>
    <span class="keyword">,</span> _<span class="comment">(*in*)</span>
    <span class="keyword">,</span> e<span class="keyword">:</span> <span class="staexp">e0xp</span>
    <span class="keyword">,</span> tok_end<span class="keyword">:</span> <span class="staexp">token</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">e0xp</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> loc <span class="keyword">=</span> location_combine
      <span class="keyword">(</span>tok_let<span class="keyword">.</span>token_loc<span class="keyword">,</span> tok_end<span class="keyword">.</span>token_loc<span class="keyword">)</span> <span class="keyword">in</span> e0xp_make_let <span class="keyword">(</span>loc<span class="keyword">,</span> l2l <span class="keyword">(</span>ds<span class="keyword">)</span><span class="keyword">,</span> e<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [f_let]  
</span>    
<span class="keyword">}</span> <span class="comment">// end of [lp_e0xp0]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">and</span> lp_opre0xp0<span class="keyword">:</span> <span class="staexp">LP <span class="keyword">(</span>fixitm e0xp<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">$delay</span> <span class="keyword">(</span>
  p_opr wth f_opr ||
  seq2wth_parser_fun <span class="keyword">(</span>DOT<span class="keyword">,</span> p_number<span class="keyword">,</span> f_proj<span class="keyword">)</span> ||
  <span class="keyword">!</span>lp_e0xp0 wth f_e0xp
<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fn</span> f_opr
    <span class="keyword">(</span>opr<span class="keyword">:</span> <span class="staexp">fixopr e0xp</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">fixitm e0xp</span> <span class="keyword">=</span> FIXITMopr opr
  <span class="keyword">#define</span> <span class="neuexp">DOT_precedence 80</span>
  <span class="keyword">fn</span> f_proj <span class="keyword">(</span>tok_dot<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">,</span> tok_num<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">fixitm e0xp</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> loc <span class="keyword">=</span> location_combine <span class="keyword">(</span>tok_dot<span class="keyword">.</span>token_loc<span class="keyword">,</span> tok_num<span class="keyword">.</span>token_loc<span class="keyword">)</span>
    <span class="keyword">val-</span> TOKint n <span class="keyword">=</span> tok_num<span class="keyword">.</span>token_node
    <span class="keyword">val</span> opr <span class="keyword">=</span> Postfix <span class="staexp"><span class="keyword">{</span>e0xp<span class="keyword">}</span></span> <span class="keyword">(</span>
      loc
    <span class="keyword">,</span> DOT_precedence
    <span class="keyword">,</span> <span class="keyword">lam</span> <span class="keyword">(</span>e<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> loc <span class="keyword">=</span> location_combine <span class="keyword">(</span>loc<span class="keyword">,</span> e<span class="keyword">.</span>e0xp_loc<span class="keyword">)</span>
      <span class="keyword">in</span>
        e0xp_make_proj <span class="keyword">(</span>loc<span class="keyword">,</span> e<span class="keyword">,</span> n<span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">)</span> <span class="comment">// end of [Postfix]  
</span>  <span class="keyword">in</span>
    FIXITMopr <span class="keyword">(</span>opr<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [f_proj]
</span>  <span class="keyword">fn</span> f_e0xp <span class="keyword">(</span>exp<span class="keyword">:</span> <span class="staexp">e0xp</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">fixitm e0xp</span> <span class="keyword">=</span> FIXITMatm exp
<span class="keyword">}</span> <span class="comment">// end of [lp_opre0xp0]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">and</span> lp_e0xp1<span class="keyword">:</span> <span class="staexp">LP <span class="keyword">(</span>e0xp<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">$delay</span> <span class="keyword">(</span>
  <span class="keyword">(</span>repeat1_parser <span class="keyword">!</span>lp_opre0xp0<span class="keyword">)</span> wth f
<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="13751"><span class="stacstdec">T <span class="keyword">=</span> fixitm e0xp</span></a></span>
  <span class="keyword">fn</span> err <span class="keyword">(</span>loc<span class="keyword">:</span> <span class="staexp">loc</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">e0xp</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    prerr_location loc<span class="keyword">;</span>
    prerr ": exit(STFPL)"<span class="keyword">;</span>
    prerr ": parsing failure: unresolved fixity"<span class="keyword">;</span>
    prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
    abort <span class="staexp"><span class="keyword">{</span>e0xp<span class="keyword">}</span></span> <span class="keyword">(</span>1<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end [err]
</span>
  <span class="keyword">fn</span> fixitm_loc_get
    <span class="keyword">(</span>itm<span class="keyword">:</span> <span class="staexp">fixitm e0xp</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">loc</span> <span class="keyword">=</span> <span class="keyword">case+</span> itm <span class="keyword">of</span>
    <span class="keyword">|</span> FIXITMatm exp <span class="keyword">=&gt;</span> exp<span class="keyword">.</span>e0xp_loc
    <span class="keyword">|</span> FIXITMopr opr <span class="keyword">=&gt;</span> fixopr_loc_get opr
  <span class="comment">// end of [fixitm_loc_get]
</span>
  <span class="keyword">fn</span> f <span class="keyword">(</span>itms<span class="keyword">:</span> <span class="staexp">List1 T</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">e0xp</span> <span class="keyword">=</span> <span class="keyword">let</span>
<span class="comment">(*
    val () = $effmask_all (loop (itms, 0)) where {
      val out = stderr_ref
      fun loop (itms: List T, i: int):&lt;cloref1&gt; void =
        case+ itms of
        | list_cons (itm, itms) =&gt; loop (itms, i+1) where {
            val () = if i &gt; 0 then fprint_string (out, ", ")
            val () = (case+ itm of
              | FIXITMatm exp =&gt; fprint_e0xp (out, exp)
              | FIXITMopr opr =&gt; fprint_fixopr (out, opr)
            ) : void // end of [val]  
          } // end of [list_cons]
        | list_nil () =&gt; ()
    } // end of [val]
    val () = $effmask_all (prerr_newline ())
*)</span>
    <span class="keyword">val</span> res <span class="keyword">=</span> <span class="keyword">$effmask_all</span> <span class="keyword">(</span>fixity_resolve <span class="keyword">(</span>app_e0xp<span class="keyword">,</span> itms<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> res <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Some_vt e <span class="keyword">=&gt;</span> e <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val+</span> list_cons <span class="keyword">(</span>itm0<span class="keyword">,</span> itms<span class="keyword">)</span> <span class="keyword">=</span> itms
        <span class="keyword">val</span> loc0 <span class="keyword">=</span> fixitm_loc_get <span class="keyword">(</span>itm0<span class="keyword">)</span>
        <span class="keyword">val</span> loc01 <span class="keyword">=</span> <span class="keyword">case+</span> itms <span class="keyword">of</span>
          <span class="keyword">|</span> list_cons _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
              <span class="keyword">val</span> itm1 <span class="keyword">=</span> list_last&lt;<span class="staexp">T</span><span class="keyword">&gt;</span> <span class="keyword">(</span>itms<span class="keyword">)</span>
              <span class="keyword">val</span> loc1 <span class="keyword">=</span> fixitm_loc_get itm1
            <span class="keyword">in</span>
              location_combine <span class="keyword">(</span>loc0<span class="keyword">,</span> loc1<span class="keyword">)</span>
            <span class="keyword">end</span> <span class="comment">// end of [list_cons]
</span>          <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> loc0
        <span class="comment">// end of [val]
</span>      <span class="keyword">in</span>
        <span class="keyword">$effmask_all</span> <span class="keyword">(</span>err loc01<span class="keyword">)</span> <span class="comment">// report the error right here!
</span>      <span class="keyword">end</span> <span class="comment">// end of [None_vt]
</span>  <span class="keyword">end</span> <span class="comment">// end of [f]
</span><span class="keyword">}</span> <span class="comment">// end of [lp_e0xp1]
</span>
<span class="keyword">and</span> lp_e0xp1c<span class="keyword">:</span> <span class="staexp">LP <span class="keyword">(</span>e0xpc<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">$delay</span> <span class="keyword">(</span>
  COLON &gt;&gt; <span class="keyword">!</span>lp_t0yp wth f_ann || return_parser&lt;<span class="staexp">e0xpc</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">lam</span> e <span class="keyword">=&gt;</span> e<span class="keyword">)</span>
<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fn</span> f_ann <span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp">t0yp</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">e0xpc</span> <span class="keyword">=</span> <span class="keyword">lam</span> e <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> loc <span class="keyword">=</span> location_combine <span class="keyword">(</span>e<span class="keyword">.</span>e0xp_loc<span class="keyword">,</span> t<span class="keyword">.</span>t0yp_loc<span class="keyword">)</span>
  <span class="keyword">in</span>
    e0xp_make_ann <span class="keyword">(</span>loc<span class="keyword">,</span> e<span class="keyword">,</span> t<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [f]
</span><span class="keyword">}</span> <span class="comment">// end of [lp_e0xp1c]
</span>
<span class="keyword">and</span> lp_e0xp2<span class="keyword">:</span> <span class="staexp">LP <span class="keyword">(</span>e0xp<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">$delay</span> <span class="keyword">(</span>
  seq2wth_parser_fun <span class="keyword">(</span><span class="keyword">!</span>lp_e0xp1<span class="keyword">,</span> <span class="keyword">!</span>lp_e0xp1c<span class="keyword">,</span> f<span class="keyword">)</span>
<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">val</span> f <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>e<span class="keyword">:</span> <span class="staexp">e0xp</span><span class="keyword">,</span> ec<span class="keyword">:</span> <span class="staexp">e0xpc</span><span class="keyword">)</span> <span class="keyword">=&lt;</span><span class="staexp"><span class="keyword">fun</span></span><span class="keyword">&gt;</span> ec <span class="keyword">(</span>e<span class="keyword">)</span>
<span class="keyword">}</span> <span class="comment">(* end of [lp_e0xp2] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">and</span> lp_v0aldec<span class="keyword">:</span> <span class="staexp">LP <span class="keyword">(</span>v0aldec<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">$delay</span> <span class="keyword">(</span>
  seq3wth_parser_fun <span class="keyword">(</span>p_ident<span class="keyword">,</span> <span class="keyword">!</span>lp_typann<span class="keyword">,</span> EQ &gt;&gt; <span class="keyword">!</span>lp_e0xp<span class="keyword">,</span> f_v0aldec<span class="keyword">)</span>
<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fn</span> f_v0aldec <span class="keyword">(</span>
      tok_ide<span class="keyword">:</span> <span class="staexp">token</span><span class="keyword">,</span> oty<span class="keyword">:</span> <span class="staexp">t0ypopt1</span><span class="keyword">,</span> e<span class="keyword">:</span> <span class="staexp">e0xp</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">v0aldec</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> loc <span class="keyword">=</span> location_combine <span class="keyword">(</span>tok_ide<span class="keyword">.</span>token_loc<span class="keyword">,</span> e<span class="keyword">.</span>e0xp_loc<span class="keyword">)</span>
    <span class="keyword">val</span> sym <span class="keyword">=</span> symbol_make_token <span class="keyword">(</span>tok_ide<span class="keyword">)</span>
  <span class="keyword">in</span> <span class="keyword">'{</span>
    v0aldec_loc<span class="keyword">=</span> loc<span class="keyword">,</span> v0aldec_nam<span class="keyword">=</span> sym<span class="keyword">,</span> v0aldec_ann<span class="keyword">=</span> o2o <span class="keyword">(</span>oty<span class="keyword">)</span><span class="keyword">,</span> v0aldec_def<span class="keyword">=</span> e
  <span class="keyword">}</span> <span class="keyword">end</span> <span class="comment">// end of [f_v0aldec]
</span><span class="keyword">}</span> <span class="comment">// end of [lp_v0aldec]
</span>
<span class="keyword">and</span> lp_v0aldeclist<span class="keyword">:</span> <span class="staexp">LP <span class="keyword">(</span>List1 v0aldec<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">$delay</span> <span class="keyword">(</span>
  repeat1_sep_parser&lt;<span class="staexp">v0aldec</span><span class="keyword">,</span><span class="staexp">token</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>lp_v0aldec<span class="keyword">,</span> AND<span class="keyword">)</span>
<span class="keyword">)</span> <span class="comment">// end of [lp_v0aldeclist]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">and</span> lp_d0ec<span class="keyword">:</span> <span class="staexp">LP <span class="keyword">(</span>d0ec<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">$delay</span> <span class="keyword">(</span>
  seq3wth_parser_fun <span class="keyword">(</span>VAL<span class="keyword">,</span> <span class="keyword">(</span>REC<span class="keyword">)</span>^?<span class="keyword">,</span> <span class="keyword">!</span>lp_v0aldeclist<span class="keyword">,</span> f_v0al<span class="keyword">)</span>
<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fn</span> f_v0al <span class="keyword">(</span>
      tok_val<span class="keyword">:</span> <span class="staexp">token</span>
    <span class="keyword">,</span> tokopt_rec<span class="keyword">:</span> <span class="staexp">Option token</span>
    <span class="keyword">,</span> vds<span class="keyword">:</span> <span class="staexp">List1 v0aldec</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">d0ec</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> isrec <span class="keyword">=</span> <span class="keyword">(</span>
      <span class="keyword">case+</span> tokopt_rec <span class="keyword">of</span> Some _ <span class="keyword">=&gt;</span> true <span class="keyword">|</span> None _ <span class="keyword">=&gt;</span> false
    <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">bool</span>
    <span class="keyword">val</span> vd <span class="keyword">=</span> list_last&lt;<span class="staexp">v0aldec</span><span class="keyword">&gt;</span> <span class="keyword">(</span>vds<span class="keyword">)</span>
    <span class="keyword">val</span> loc <span class="keyword">=</span> location_combine <span class="keyword">(</span>tok_val<span class="keyword">.</span>token_loc<span class="keyword">,</span> vd<span class="keyword">.</span>v0aldec_loc<span class="keyword">)</span>
  <span class="keyword">in</span>  
    d0ec_make_val <span class="keyword">(</span>loc<span class="keyword">,</span> isrec<span class="keyword">,</span> l2l <span class="keyword">(</span>vds<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [f_v0al]  
</span><span class="keyword">}</span> <span class="comment">// end of [lp_d0ec]
</span>
<span class="keyword">and</span> lp_d0eclist<span class="keyword">:</span> <span class="staexp">LP <span class="keyword">(</span>d0eclst1<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">$delay</span> <span class="keyword">(</span>repeat0_parser&lt;<span class="staexp">d0ec</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="keyword">!</span>lp_d0ec<span class="keyword">)</span><span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="17153"><span class="dyncstdec">parse_failure
  <span class="keyword">(</span>toks<span class="keyword">:</span> <span class="staexp">stream token</span><span class="keyword">,</span> ncur<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> nmax<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>

<span class="keyword">implement</span> parse_failure <span class="keyword">(</span>toks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop
    <span class="keyword">(</span>toks<span class="keyword">:</span> <span class="staexp">stream token</span><span class="keyword">,</span> n<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">Option_vt <span class="keyword">(</span>token<span class="keyword">)</span></span> <span class="keyword">=</span>
    <span class="keyword">case+</span> <span class="keyword">!</span>toks <span class="keyword">of</span>
    <span class="keyword">|</span> stream_cons <span class="keyword">(</span>tok<span class="keyword">,</span> toks<span class="keyword">)</span> <span class="keyword">=&gt;</span>
        <span class="keyword">if</span> n <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> loop <span class="keyword">(</span>toks<span class="keyword">,</span> n-1<span class="keyword">)</span> <span class="keyword">else</span> Some_vt <span class="keyword">(</span>tok<span class="keyword">)</span>
    <span class="keyword">|</span> stream_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [loop]
</span>  <span class="keyword">val</span> tokopt <span class="keyword">=</span> loop <span class="keyword">(</span>toks<span class="keyword">,</span> nmax - ncur<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> tokopt <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Some_vt tok <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr_location tok<span class="keyword">.</span>token_loc<span class="keyword">;</span>
      prerr ": exit(STFPL)"<span class="keyword">;</span>
      prerr ": parsing failure"<span class="keyword">;</span>
      prerr_newline <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Some_vt]
</span>  <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      prerr ": exit(STFPL)"<span class="keyword">;</span>
      prerr ": parsing failure at the end of the token stream."<span class="keyword">;</span>
      prerr_newline <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [None_vt]
</span><span class="keyword">end</span> <span class="comment">// end of [parse_failure]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fn</span> parse_from_charstream <span class="keyword">(</span>cs<span class="keyword">:</span> <span class="staexp">stream char</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">e0xp</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> toks0 <span class="keyword">=</span> tokenstream_make_charstream <span class="keyword">(</span>cs<span class="keyword">)</span>
  <span class="keyword">var</span> toks<span class="keyword">:</span> <span class="staexp">stream token</span> <span class="keyword">=</span> toks0
  <span class="keyword">var</span> ncur<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0 <span class="keyword">and</span> nmax<span class="keyword">:</span> <span class="staexp">int</span> <span class="keyword">=</span> 0
  <span class="keyword">val</span> r <span class="keyword">=</span> apply_parser <span class="keyword">(</span><span class="keyword">!</span>lp_e0xp<span class="keyword">,</span> toks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span>
  <span class="keyword">val</span> res <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> r <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Some_vt e <span class="keyword">=&gt;</span> e
    <span class="keyword">|</span> <span class="keyword">~</span>None_vt _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> parse_failure <span class="keyword">(</span>toks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> abort <span class="staexp"><span class="keyword">{</span>e0xp<span class="keyword">}</span></span> <span class="keyword">(</span>1<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [Fail]
</span>  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">e0xp</span> <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> otok <span class="keyword">=</span> stream_get_item&lt;<span class="staexp">token</span><span class="keyword">&gt;</span> <span class="keyword">(</span>toks<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> otok <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Some_vt tok <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        prerr_location tok<span class="keyword">.</span>token_loc<span class="keyword">;</span>
        prerr ": exit(STFPL)"<span class="keyword">;</span>
        prerr ": parsing failure: unconsumed token"<span class="keyword">;</span>
        prerr_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span>
        abort <span class="staexp"><span class="keyword">{</span>void<span class="keyword">}</span></span> <span class="keyword">(</span>1<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [Some]
</span>    <span class="comment">// there are no unconsumed tokens
</span>    <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">void</span> <span class="comment">// end of [token]
</span><span class="keyword">in</span>
  res
<span class="keyword">end</span> <span class="comment">// end of [parse_from_charstream]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span> parse_from_stdin <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> filename_push <span class="keyword">(</span>filename_stdin<span class="keyword">)</span>
  <span class="keyword">val</span> cs <span class="keyword">=</span> char_stream_make_file stdin_ref
  <span class="keyword">val</span> res <span class="keyword">=</span> parse_from_charstream <span class="keyword">(</span>cs<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> filename_pop <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">in</span>
  res
<span class="keyword">end</span> <span class="comment">// end of [parse_from_stdin]
</span>
<span class="keyword">implement</span> parse_from_file <span class="keyword">(</span>filename<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> fileref <span class="keyword">=</span> open_file_exn <span class="keyword">(</span>filename<span class="keyword">,</span> file_mode_r<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> filename_push <span class="keyword">(</span>filename<span class="keyword">)</span> <span class="keyword">where</span>
    <span class="keyword">{</span> <span class="keyword">val</span> filename <span class="keyword">=</span> filename_make_string <span class="keyword">(</span>filename<span class="keyword">)</span> <span class="keyword">}</span>
  <span class="comment">// end of [val]
</span>  <span class="keyword">val</span> cs <span class="keyword">=</span> char_stream_make_file fileref
  <span class="keyword">val</span> res<span class="keyword">:</span> <span class="staexp">e0xp</span> <span class="keyword">=</span> parse_from_charstream <span class="keyword">(</span>cs<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> filename_pop <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// ALERT: this should not be called as [fileref] may
</span>  <span class="comment">// val () = close_file (fileref) // have already been closed!!!
</span><span class="keyword">in</span>
  res
<span class="keyword">end</span> <span class="comment">// end of [parse_from_file]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [parser.dats] *)</span>
</pre>
</body>
</html>
