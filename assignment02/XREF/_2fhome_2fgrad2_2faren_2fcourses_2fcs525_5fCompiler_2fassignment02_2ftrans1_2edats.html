<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    .atsyntax {color:#E80000;background-color:#E0E0E0}
    .atsyntax span.comment {color:#787878;font-style:italic}
    .atsyntax span.extern  {color:#A52A2A}
    .atsyntax span.keyword {color:#000000;font-weight:bold}
    .atsyntax span.neuexp  {color:#800080}
    .atsyntax span.staexp  {color:#0000FF}
    .atsyntax span.dynexp  {color:#E80000}
    .atsyntax span.prfexp  {color:#009000}
    .atsyntax span.stacstdec  {text-decoration:none}
    .atsyntax span.stacstuse  {color:#0000CF;text-decoration:underline}
    .atsyntax span.dyncstdec  {text-decoration:none}
    .atsyntax span.dyncstimp  {color:#B80000;text-decoration:underline}
    .atsyntax span.dyncstuse  {color:#B80000;text-decoration:underline}
    body {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre class="atsyntax">
<span class="comment">(*
** CAS CS525, Spring 2011
** Instructor: Hongwei Xi
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"trans1.sats"</span>
<span class="keyword">typedef</span> <span class="staexp"><a name="110"><span class="stacstdec">loc <span class="keyword">=</span> $Posloc<span class="keyword">.</span>location_t</span></a></span>
<span class="keyword">macdef</span> <span class="neuexp">location_none <span class="keyword">=</span> $Posloc<span class="keyword">.</span>location_none</span>
<span class="keyword">macdef</span> <span class="neuexp">prerr_loc <span class="keyword">=</span> $Posloc<span class="keyword">.</span>prerr_location</span>
<span class="keyword">macdef</span> <span class="neuexp">fprint_location <span class="keyword">=</span> $Posloc<span class="keyword">.</span>fprint_location</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"error.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"symbol.sats"</span>
<span class="keyword">typedef</span> <span class="staexp"><a name="344"><span class="stacstdec">sym <span class="keyword">=</span> symbol_t</span></a></span>


<span class="keyword">staload</span> <span class="staexp">"absyn.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* library functions *)</span>
<span class="keyword">staload</span> <span class="staexp">"libfunctions.sats"</span>

<span class="comment">(* ****** ****** *)</span>
<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anon*)</span> <span class="keyword">=</span> "symbol.dats"</span>

<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anon*)</span> <span class="keyword">=</span> "prelude/DATS/list.dats"</span> 
<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anon*)</span> <span class="keyword">=</span> "prelude/DATS/list0.dats"</span> 
<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anon*)</span> <span class="keyword">=</span> "prelude/DATS/list_vt.dats"</span> 
<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anon*)</span> <span class="keyword">=</span> "libats/DATS/funmap_avltree.dats"</span> 

<span class="keyword">#define</span> <span class="neuexp">:: list0_cons</span>
<span class="keyword">#define</span> <span class="neuexp">cons list0_cons</span>
<span class="keyword">#define</span> <span class="neuexp">nil list0_nil</span>

<span class="keyword">#define</span> <span class="neuexp">Some0 option0_some</span>
<span class="keyword">#define</span> <span class="neuexp">None0 option0_none</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span> t1yp_bool <span class="keyword">=</span> T1YPbase symbol_BOOL
<span class="keyword">implement</span> t1yp_int <span class="keyword">=</span> T1YPbase symbol_INT
<span class="keyword">implement</span> t1yp_string <span class="keyword">=</span> T1YPbase symbol_STRING
<span class="keyword">implement</span> t1yp_unit <span class="keyword">=</span> T1YPtup <span class="keyword">(</span>list0_nil<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* fun trans1_build_err (t_act: t1yp, t_expect: t1yp): String *)</span>
<span class="keyword">implement</span> trans1_build_err <span class="keyword">(</span>t_act<span class="keyword">,</span> t_expect<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> msg <span class="keyword">=</span> "typematch failed ... expected: " +
    tostring_t1yp <span class="keyword">(</span>t_expect<span class="keyword">)</span> + " ... actual: " + 
    tostring_t1yp <span class="keyword">(</span>t_act<span class="keyword">)</span>
<span class="keyword">in</span>
  msg
<span class="keyword">end</span>
<span class="comment">(* ****** ****** *)</span>
<span class="keyword">local</span>

<span class="keyword">assume</span> <span class="staexp">t1Var <span class="keyword">=</span> <span class="keyword">'{</span>
  nam<span class="keyword">=</span> int<span class="keyword">,</span> lnk<span class="keyword">=</span> ref <span class="keyword">(</span>t1yp<span class="keyword">)</span>
<span class="keyword">}</span></span> <span class="comment">// end of [t1Var]
</span>
<span class="keyword">val</span> count <span class="keyword">=</span> ref&lt;<span class="staexp">int</span><span class="keyword">&gt;</span> <span class="keyword">(</span>0<span class="keyword">)</span>

<span class="keyword">in</span>

<span class="keyword">implement</span> t1Var_get_nam <span class="keyword">(</span>X<span class="keyword">)</span> <span class="keyword">=</span> X<span class="keyword">.</span>nam
<span class="keyword">implement</span> t1Var_get_typ <span class="keyword">(</span>X<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span><span class="keyword">(</span>X<span class="keyword">.</span>lnk<span class="keyword">)</span>
<span class="keyword">implement</span> t1Var_set_typ <span class="keyword">(</span>X<span class="keyword">,</span> t<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span><span class="keyword">(</span>X<span class="keyword">.</span>lnk<span class="keyword">)</span> := t

<span class="keyword">implement</span> t1Var_new <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">t1Var</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> n <span class="keyword">=</span> <span class="keyword">!</span>count<span class="keyword">;</span> <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>count := n+1
<span class="keyword">in</span> <span class="keyword">'{</span>
  nam<span class="keyword">=</span> n<span class="keyword">,</span> lnk<span class="keyword">=</span> ref <span class="keyword">(</span>T1YPdummy<span class="keyword">)</span>
<span class="keyword">}</span> <span class="keyword">end</span> <span class="comment">// [t1Var_new]
</span>
<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="keyword">fun</span> eq_t1Var_t1Var
  <span class="keyword">(</span>X1<span class="keyword">:</span> <span class="staexp">t1Var</span><span class="keyword">,</span> X2<span class="keyword">:</span> <span class="staexp">t1Var</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span>
  t1Var_get_nam <span class="keyword">(</span>X1<span class="keyword">)</span> <span class="keyword">=</span> t1Var_get_nam <span class="keyword">(</span>X2<span class="keyword">)</span>
<span class="neuexp"><span class="keyword">overload</span> <span class="keyword">=</span> <span class="keyword">with</span> eq_t1Var_t1Var</span>

<span class="keyword">fun</span> neq_t1Var_t1Var
  <span class="keyword">(</span>X1<span class="keyword">:</span> <span class="staexp">t1Var</span><span class="keyword">,</span> X2<span class="keyword">:</span> <span class="staexp">t1Var</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">~</span><span class="keyword">(</span>X1 <span class="keyword">=</span> X2<span class="keyword">)</span>
<span class="neuexp"><span class="keyword">overload</span> &lt;&gt; <span class="keyword">with</span> neq_t1Var_t1Var</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">abstype</span> <span class="staexp"><a name="1961"><span class="stacstdec">tyerr</span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="1975"><span class="stacstdec">tyerr_pool <span class="keyword">=</span> list0 tyerr</span></a></span>
<span class="comment">(* record all the error for future output *)</span>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="2056"><span class="dyncstdec">tyerr_pool_add <span class="keyword">(</span>pool<span class="keyword">:</span> <span class="staexp">tyerr_pool</span><span class="keyword">,</span> loc<span class="keyword">:</span> <span class="staexp">loc</span><span class="keyword">,</span> msg<span class="keyword">:</span> <span class="staexp">string</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">tyerr_pool</span></span></a>
<span class="neuexp"><span class="keyword">symintr</span></span> tyerr_pool_add_tail
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="2164"><span class="dyncstdec">tyerr_pool_add_tail_loc <span class="keyword">(</span>pool<span class="keyword">:</span> <span class="staexp">tyerr_pool</span><span class="keyword">,</span> loc<span class="keyword">:</span> <span class="staexp">loc</span><span class="keyword">,</span> msg<span class="keyword">:</span> <span class="staexp">string</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">tyerr_pool</span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="2253"><span class="dyncstdec">tyerr_pool_add_tail_noloc <span class="keyword">(</span>pool<span class="keyword">:</span> <span class="staexp">tyerr_pool</span><span class="keyword">,</span> msg<span class="keyword">:</span> <span class="staexp">string</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">tyerr_pool</span></span></a>
<span class="neuexp"><span class="keyword">overload</span> tyerr_pool_add_tail <span class="keyword">with</span> tyerr_pool_add_tail_loc</span>
<span class="neuexp"><span class="keyword">overload</span> tyerr_pool_add_tail <span class="keyword">with</span> tyerr_pool_add_tail_noloc</span>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="2452"><span class="dyncstdec">tyerr_pool_append <span class="keyword">(</span>p1<span class="keyword">:</span> <span class="staexp">tyerr_pool</span><span class="keyword">,</span> p2<span class="keyword">:</span> <span class="staexp">tyerr_pool</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">tyerr_pool</span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="2526"><span class="dyncstdec">tyerr_pool_make <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">tyerr_pool</span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="2568"><span class="dyncstdec">tyerr_pool_size <span class="keyword">(</span>pool<span class="keyword">:</span> <span class="staexp">tyerr_pool</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">int</span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="2620"><span class="dyncstdec">fprint_tyerr_pool <span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp">FILEref</span><span class="keyword">,</span> pool<span class="keyword">:</span> <span class="staexp">tyerr_pool</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="2688"><span class="dyncstdec">print_tyerr_pool <span class="keyword">(</span>pool<span class="keyword">:</span> <span class="staexp">tyerr_pool</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="2741"><span class="dyncstdec">prerr_tyerr_pool <span class="keyword">(</span>pool<span class="keyword">:</span> <span class="staexp">tyerr_pool</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="2795"><span class="dyncstdec">fprint_tyerr <span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp">FILEref</span><span class="keyword">,</span> tyerr<span class="keyword">:</span> <span class="staexp">tyerr</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="2854"><span class="dyncstdec">print_tyerr <span class="keyword">(</span>tyerr<span class="keyword">:</span> <span class="staexp">tyerr</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="2898"><span class="dyncstdec">prerr_tyerr <span class="keyword">(</span>tyerr<span class="keyword">:</span> <span class="staexp">tyerr</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>

<span class="keyword">local</span>
<span class="keyword">assume</span> <span class="staexp">tyerr <span class="keyword">=</span> <span class="keyword">'{</span>loc <span class="keyword">=</span> loc<span class="keyword">,</span> msg <span class="keyword">=</span> string<span class="keyword">}</span></span>
<span class="keyword">in</span>
<span class="keyword">implement</span> tyerr_pool_add <span class="keyword">(</span>pool<span class="keyword">,</span> loc<span class="keyword">,</span> msg<span class="keyword">)</span> <span class="keyword">=</span> 
  <span class="keyword">'{</span>loc <span class="keyword">=</span> loc<span class="keyword">,</span> msg <span class="keyword">=</span> msg<span class="keyword">}</span> :: pool

<span class="keyword">implement</span> tyerr_pool_add_tail_loc <span class="keyword">(</span>pool<span class="keyword">,</span> loc<span class="keyword">,</span> msg<span class="keyword">)</span> <span class="keyword">=</span> 
  tyerr_pool_append <span class="keyword">(</span>pool<span class="keyword">,</span> <span class="keyword">'{</span>loc <span class="keyword">=</span> loc<span class="keyword">,</span> msg <span class="keyword">=</span> msg<span class="keyword">}</span> :: nil<span class="keyword">)</span>

<span class="keyword">implement</span> tyerr_pool_add_tail_noloc <span class="keyword">(</span>pool<span class="keyword">,</span> msg<span class="keyword">)</span> <span class="keyword">=</span> 
  tyerr_pool_append <span class="keyword">(</span>pool<span class="keyword">,</span> <span class="keyword">'{</span>loc <span class="keyword">=</span> location_none<span class="keyword">,</span> msg <span class="keyword">=</span> msg<span class="keyword">}</span> :: nil<span class="keyword">)</span>

<span class="keyword">implement</span> tyerr_pool_size <span class="keyword">(</span>pool<span class="keyword">)</span> <span class="keyword">=</span>
  list0_length <span class="keyword">(</span>pool<span class="keyword">)</span>

<span class="keyword">implement</span> tyerr_pool_append <span class="keyword">(</span>p1<span class="keyword">,</span> p2<span class="keyword">)</span> <span class="keyword">=</span> list0_append <span class="keyword">(</span>p1<span class="keyword">,</span> p2<span class="keyword">)</span>

<span class="keyword">implement</span> tyerr_pool_make <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> nil

<span class="keyword">implement</span> fprint_tyerr_pool <span class="keyword">(</span>out<span class="keyword">,</span> pool<span class="keyword">)</span> <span class="keyword">=</span> aux <span class="keyword">(</span>out<span class="keyword">,</span> pool<span class="keyword">,</span> 0<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp">FILEref</span><span class="keyword">,</span> pool<span class="keyword">:</span> <span class="staexp">tyerr_pool</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span> <span class="keyword">=</span> 
    <span class="keyword">case+</span> pool <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>tyerr<span class="keyword">,</span> pool1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>
      fprint_tyerr <span class="keyword">(</span>out<span class="keyword">,</span> tyerr<span class="keyword">)</span><span class="keyword">;</span>
      <span class="comment">(*if (i &gt; 0) then*)</span> fprint <span class="keyword">(</span>out<span class="keyword">,</span> "\n"<span class="keyword">)</span><span class="keyword">;</span>
      aux <span class="keyword">(</span>out<span class="keyword">,</span> pool1<span class="keyword">,</span> i + 1<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">}</span>

<span class="keyword">implement</span> print_tyerr_pool <span class="keyword">(</span>pool<span class="keyword">)</span> <span class="keyword">=</span> fprint_tyerr_pool <span class="keyword">(</span>stdout_ref<span class="keyword">,</span> pool<span class="keyword">)</span>
<span class="keyword">implement</span> prerr_tyerr_pool <span class="keyword">(</span>pool<span class="keyword">)</span> <span class="keyword">=</span> fprint_tyerr_pool <span class="keyword">(</span>stderr_ref<span class="keyword">,</span> pool<span class="keyword">)</span>

<span class="keyword">implement</span> fprint_tyerr <span class="keyword">(</span>out<span class="keyword">,</span> tyerr<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint_location <span class="keyword">(</span>out<span class="keyword">,</span> tyerr<span class="keyword">.</span>loc<span class="keyword">)</span>
  <span class="keyword">val</span> _ <span class="keyword">=</span> fprint <span class="keyword">(</span>out<span class="keyword">,</span> "@" + tyerr<span class="keyword">.</span>msg<span class="keyword">)</span>
<span class="keyword">}</span> 

<span class="keyword">implement</span> print_tyerr <span class="keyword">(</span>tyerr<span class="keyword">:</span> <span class="staexp">tyerr</span><span class="keyword">)</span> <span class="keyword">=</span> fprint_tyerr <span class="keyword">(</span>stdout_ref<span class="keyword">,</span> tyerr<span class="keyword">)</span>
<span class="keyword">implement</span> prerr_tyerr <span class="keyword">(</span>tyerr<span class="keyword">:</span> <span class="staexp">tyerr</span><span class="keyword">)</span> <span class="keyword">=</span> fprint_tyerr <span class="keyword">(</span>stderr_ref<span class="keyword">,</span> tyerr<span class="keyword">)</span>

<span class="keyword">end</span>  <span class="comment">// end of [local]
</span>
<span class="keyword">val</span> tyerr_pool_nil <span class="keyword">=</span> tyerr_pool_make <span class="keyword">(</span><span class="keyword">)</span>  <span class="comment">// empty error pool
</span><span class="comment">(* ******** ********* *)</span>

<span class="keyword">implement</span>
trans1_typ <span class="keyword">(</span>t<span class="keyword">)</span> <span class="keyword">=</span> aux <span class="keyword">(</span>t<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span> aux <span class="keyword">(</span>t<span class="keyword">:</span> <span class="staexp">t0yp</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">t1yp</span> <span class="keyword">=</span> <span class="keyword">case+</span> t<span class="keyword">.</span>t0yp_node <span class="keyword">of</span>
    <span class="keyword">|</span> T0YPbase sym <span class="keyword">=&gt;</span> <span class="keyword">begin</span> <span class="keyword">case+</span> 0 <span class="keyword">of</span>
        <span class="keyword">|</span> _ <span class="keyword">when</span> sym <span class="keyword">=</span> symbol_UNIT <span class="keyword">=&gt;</span> t1yp_unit 
        <span class="keyword">|</span> _ <span class="keyword">when</span> sym <span class="keyword">=</span> symbol_LIST <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> t1var <span class="keyword">=</span> t1Var_new <span class="keyword">(</span><span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> t1Var_set_typ <span class="keyword">(</span>t1var<span class="keyword">,</span> T1YPvar <span class="keyword">(</span>t1Var_new <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span>
        <span class="keyword">in</span>
          T1YPlist <span class="keyword">(</span>t1var<span class="keyword">)</span> <span class="comment">// list X
</span>        <span class="keyword">end</span>
        <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> T1YPbase sym
      <span class="keyword">end</span> <span class="comment">// end of [T0YPbase]  
</span>    <span class="keyword">|</span> T0YPfun <span class="keyword">(</span>t1<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">=&gt;</span> T1YPfun <span class="keyword">(</span>ref ~1<span class="comment">(*don't know the no. of args yet*)</span><span class="keyword">,</span> 
                                   aux t1<span class="keyword">,</span> aux t2<span class="keyword">)</span>
    <span class="keyword">|</span> T0YPtup <span class="keyword">(</span>ts<span class="keyword">)</span> <span class="keyword">=&gt;</span> T1YPtup <span class="keyword">(</span>list0_map_fun <span class="keyword">(</span>ts<span class="keyword">,</span> aux<span class="keyword">)</span><span class="keyword">)</span>
  <span class="comment">// end of [aux]
</span><span class="keyword">}</span> <span class="comment">// end of [trans1_typ]   
</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">(*
fun lte_t1yp_t1yp
  (t1: t1yp, t2: t1yp): bool = case+ (t1, t2) of
    | (T1YPbase sym1, T1YPbase sym2) =&gt; sym1 = sym2
    | (T1YPfun (t11, t12), T1YPfun (t21, t22)) =&gt;
        lte_t1yp_t1yp (t21, t11) andalso lte_t1yp_t1yp (t12, t22)
      // end of [T1YPfun, T1YPfun]
    | (T1YPtup ts1, T1YPtup ts2) =&gt; lte_t1yplst_t1yplst (ts1, ts2)
    | (_, _) =&gt; false
// end of [lte_t1yp_t1yp]

and lte_t1yplst_t1yplst (ts1: t1yplst, ts2: t1yplst): bool =
  case+ (ts1, ts2) of
  | (list0_cons (t1, ts1), list0_cons (t2, ts2)) =&gt;
      lte_t1yp_t1yp (t1, t2) andalso lte_t1yplst_t1yplst (ts1, ts2)
    // end of [list0_cons, list0_cons]
  | (list0_nil (), list0_nil ()) =&gt; true
  | (_, _) =&gt; false
// end of [lte_t1yplst_t1yplst]
*)</span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">(* The result can be
1. T1YPvar with dummy inside (one level)
2. commond type
// -------------
We have three boxes: x, y, z
(x:int, ref (y:int, ref (z:int, ref dummy))) becomes
(x:int, ref (z:int, ref dummy))
(y:int, ref (z:int, ref dummy))
(z:int, ref dummy)
// -------------
returen value is (z, dummy)
*)</span>
<span class="keyword">implement</span> t1yp_normalize <span class="keyword">(</span>t<span class="keyword">)</span> <span class="keyword">=</span> 
  <span class="keyword">case+</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> T1YPvar <span class="keyword">(</span>X<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> t1 <span class="keyword">=</span> t1Var_get_typ <span class="keyword">(</span>X<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">case+</span> t1 <span class="keyword">of</span>
      <span class="keyword">|</span> T1YPdummy <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> t
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> t1 <span class="keyword">where</span> <span class="keyword">{</span>
          <span class="keyword">val</span> t1 <span class="keyword">=</span> t1yp_normalize <span class="keyword">(</span>t1<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> t1Var_set_typ <span class="keyword">(</span>X<span class="keyword">,</span> t1<span class="keyword">)</span>
          <span class="comment">// we return t1, but modify t as well
</span>          <span class="comment">// In effect, suppose we have a box (T1YPvar), if it 
</span>          <span class="comment">// contains dummy, then we do nothing and return the box.
</span>          <span class="comment">// If the box contains something else, we normalize this
</span>          <span class="comment">// content, put the new content back to the box, and return
</span>          <span class="comment">// the new content as the result of normalization of the box.
</span>        <span class="keyword">}</span> <span class="comment">// [_]
</span>    <span class="keyword">end</span> <span class="comment">// end of [T1YPvar]
</span>  <span class="keyword">|</span> T1YPlist <span class="keyword">(</span>X<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> t1 <span class="keyword">=</span> t1Var_get_typ <span class="keyword">(</span>X<span class="keyword">)</span>
  <span class="keyword">in</span>
      <span class="keyword">case+</span> t1 <span class="keyword">of</span>
      <span class="keyword">|</span> T1YPdummy <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> t
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> t <span class="keyword">where</span> <span class="keyword">{</span>
          <span class="keyword">val</span> t1 <span class="keyword">=</span> t1yp_normalize <span class="keyword">(</span>t1<span class="keyword">)</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> t1Var_set_typ <span class="keyword">(</span>X<span class="keyword">,</span> t1<span class="keyword">)</span>
        <span class="keyword">}</span> <span class="comment">// [_]
</span>  <span class="keyword">end</span>  <span class="comment">// end of [T1YPlist]
</span>    
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> t <span class="comment">// end of [_]
</span><span class="comment">// end of [t1yp_normalize]
</span>

<span class="keyword">fun</span> t1yp_lst_normalize <span class="keyword">(</span>ts<span class="keyword">:</span> <span class="staexp">t1yplst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">t1yplst</span> <span class="keyword">=</span> 
  list0_map_fun&lt;<span class="staexp">t1yp</span><span class="keyword">&gt;&lt;</span><span class="staexp">t1yp</span><span class="keyword">&gt;</span> <span class="keyword">(</span>ts<span class="keyword">,</span> t1yp_normalize<span class="keyword">)</span>

<span class="keyword">fun</span> make_t1ypvar_lst <span class="keyword">(</span>n<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">list0 t1yp</span> <span class="keyword">=</span>
  <span class="keyword">if</span> n <span class="keyword">=</span> 0 <span class="keyword">then</span> nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">else</span> cons <span class="keyword">(</span>T1YPvar <span class="keyword">(</span>t1Var_new <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> make_t1ypvar_lst <span class="keyword">(</span>n - 1<span class="keyword">)</span><span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">(* if we only use this match, then there would be
no indented T1YPvar
*)</span>
<span class="comment">(* t1: the actual type of the exp
   t2: the type it should be
*)</span>
<span class="keyword">fun</span> match_t1yp_t1yp
  <span class="keyword">(</span>t1<span class="keyword">:</span> <span class="staexp">t1yp</span><span class="keyword">,</span> t2<span class="keyword">:</span> <span class="staexp">t1yp</span><span class="keyword">,</span> tyerrs<span class="keyword">:</span> <span class="staexp">tyerr_pool</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>bool<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> t1 <span class="keyword">=</span> t1yp_normalize <span class="keyword">(</span>t1<span class="keyword">)</span>
  <span class="keyword">val</span> t2 <span class="keyword">=</span> t1yp_normalize <span class="keyword">(</span>t2<span class="keyword">)</span>
  <span class="comment">// val () = fprint (stderr_ref, "=============match_t1yp_t1yp\n")
</span><span class="keyword">in</span>
  <span class="keyword">case+</span> <span class="keyword">(</span>t1<span class="keyword">,</span> t2<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">(</span>T1YPvar X1<span class="keyword">,</span> T1YPvar X2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>true<span class="keyword">,</span> tyerrs<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> X1 &lt;&gt; X2 <span class="keyword">then</span> t1Var_set_typ <span class="keyword">(</span>X1<span class="keyword">,</span> t2<span class="keyword">)</span>
    <span class="keyword">}</span> <span class="comment">// end of [T1YPvar, T1YPvar]
</span>  <span class="keyword">|</span> <span class="keyword">(</span>T1YPvar X1<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>t1Var_set_typ <span class="keyword">(</span>X1<span class="keyword">,</span> t2<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">(</span>true<span class="keyword">,</span> tyerrs<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">|</span> <span class="keyword">(</span>_<span class="keyword">,</span> T1YPvar X2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>t1Var_set_typ <span class="keyword">(</span>X2<span class="keyword">,</span> t1<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">(</span>true<span class="keyword">,</span> tyerrs<span class="keyword">)</span><span class="keyword">)</span>
<span class="comment">//
</span>  <span class="keyword">|</span> <span class="keyword">(</span>T1YPbase sym1<span class="keyword">,</span> T1YPbase sym2<span class="keyword">)</span> <span class="keyword">=&gt;</span> 
    <span class="keyword">if</span> sym1 <span class="keyword">=</span> sym2 <span class="keyword">then</span> <span class="keyword">(</span>true<span class="keyword">,</span> tyerrs<span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">let</span>
      <span class="keyword">val</span> errmsg <span class="keyword">=</span> trans1_build_err <span class="keyword">(</span>t1<span class="keyword">,</span> t2<span class="keyword">)</span>
      <span class="keyword">val</span> tyerrs1 <span class="keyword">=</span> tyerr_pool_add_tail <span class="keyword">(</span>tyerrs<span class="keyword">,</span> errmsg<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">(</span>false<span class="keyword">,</span> tyerrs1<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">|</span> <span class="keyword">(</span>T1YPfun <span class="keyword">(</span>n1<span class="keyword">,</span> t11<span class="keyword">,</span> t12<span class="keyword">)</span><span class="keyword">,</span> T1YPfun <span class="keyword">(</span>n2<span class="keyword">,</span> t21<span class="keyword">,</span> t22<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> <span class="keyword">!</span>n1 <span class="keyword">=</span> ~1 <span class="keyword">then</span> <span class="keyword">!</span>n1 := <span class="keyword">!</span>n2
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> <span class="keyword">!</span>n2 <span class="keyword">=</span> ~1 <span class="keyword">then</span> <span class="keyword">!</span>n2 := <span class="keyword">!</span>n1
      <span class="keyword">val</span> <span class="keyword">(</span>b1<span class="keyword">,</span> tyerrs1<span class="keyword">)</span> <span class="keyword">=</span> match_t1yp_t1yp <span class="keyword">(</span>t11<span class="keyword">,</span> t21<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span>b2<span class="keyword">,</span> tyerrs2<span class="keyword">)</span> <span class="keyword">=</span> match_t1yp_t1yp <span class="keyword">(</span>t12<span class="keyword">,</span> t22<span class="keyword">,</span> tyerrs1<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">(</span><span class="keyword">(</span><span class="keyword">!</span>n1 <span class="keyword">=</span> <span class="keyword">!</span>n2<span class="keyword">)</span> &amp;&amp; b1 &amp;&amp; b2<span class="keyword">,</span> tyerrs2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [T1YPfun, T1YPfun]
</span>  <span class="keyword">|</span> <span class="keyword">(</span>T1YPtup ts1<span class="keyword">,</span> T1YPtup ts2<span class="keyword">)</span> <span class="keyword">=&gt;</span> match_t1yplst_t1yplst <span class="keyword">(</span>ts1<span class="keyword">,</span> ts2<span class="keyword">,</span> true<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
  <span class="keyword">|</span> <span class="keyword">(</span>T1YPtup_vl rfts1<span class="keyword">,</span> T1YPtup ts2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span> 
    <span class="keyword">val</span> ts1 <span class="keyword">=</span> <span class="keyword">!</span>rfts1
    <span class="keyword">val</span> len1 <span class="keyword">=</span> list0_length <span class="keyword">(</span>ts1<span class="keyword">)</span>
    <span class="keyword">val</span> len2 <span class="keyword">=</span> list0_length <span class="keyword">(</span>ts2<span class="keyword">)</span>
    <span class="keyword">val</span> ts1 <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">if</span> len1 &gt;= len2 <span class="keyword">then</span> ts1 <span class="keyword">else</span> 
      list0_append&lt;<span class="staexp">t1yp</span><span class="keyword">&gt;</span> <span class="keyword">(</span>ts1<span class="keyword">,</span> make_t1ypvar_lst <span class="keyword">(</span>len2 - len1<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">)</span>
    <span class="keyword">val</span> res <span class="keyword">=</span> match_t1yplst_t1yplst_l <span class="keyword">(</span>ts1<span class="keyword">,</span> ts2<span class="keyword">,</span> true<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
    <span class="keyword">val</span> ts1 <span class="keyword">=</span> t1yp_lst_normalize <span class="keyword">(</span>ts1<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>rfts1 := ts1
  <span class="keyword">in</span>
    res
  <span class="keyword">end</span>
  <span class="keyword">|</span> <span class="keyword">(</span>T1YPtup ts1<span class="keyword">,</span> T1YPtup_vl rfts2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span> 
    <span class="keyword">val</span> ts2 <span class="keyword">=</span> <span class="keyword">!</span>rfts2
    <span class="keyword">val</span> len1 <span class="keyword">=</span> list0_length <span class="keyword">(</span>ts1<span class="keyword">)</span>
    <span class="keyword">val</span> len2 <span class="keyword">=</span> list0_length <span class="keyword">(</span>ts2<span class="keyword">)</span>
    <span class="keyword">val</span> ts2 <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">if</span> len1 &lt;= len2 <span class="keyword">then</span> ts2 <span class="keyword">else</span> 
      list0_append&lt;<span class="staexp">t1yp</span><span class="keyword">&gt;</span> <span class="keyword">(</span>ts2<span class="keyword">,</span> make_t1ypvar_lst <span class="keyword">(</span>len1 - len2<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">)</span>
    <span class="keyword">val</span> res <span class="keyword">=</span> match_t1yplst_t1yplst <span class="keyword">(</span>ts1<span class="keyword">,</span> ts2<span class="keyword">,</span> true<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
    <span class="keyword">val</span> ts2 <span class="keyword">=</span> t1yp_lst_normalize <span class="keyword">(</span>ts2<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>rfts2 := ts2
  <span class="keyword">in</span>
    res
  <span class="keyword">end</span>
  <span class="keyword">|</span> <span class="keyword">(</span>T1YPtup_vl rfts1<span class="keyword">,</span> T1YPtup_vl rfts2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span> 
    <span class="keyword">val</span> ts1 <span class="keyword">=</span> <span class="keyword">!</span>rfts1
    <span class="keyword">val</span> ts2 <span class="keyword">=</span> <span class="keyword">!</span>rfts2
    <span class="keyword">val</span> len1 <span class="keyword">=</span> list0_length <span class="keyword">(</span>ts1<span class="keyword">)</span>
    <span class="keyword">val</span> len2 <span class="keyword">=</span> list0_length <span class="keyword">(</span>ts2<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span>ts1<span class="keyword">,</span> ts2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">if</span> len1 &lt;= len2 <span class="keyword">then</span> 
      <span class="keyword">(</span>list0_append&lt;<span class="staexp">t1yp</span><span class="keyword">&gt;</span> <span class="keyword">(</span>ts1<span class="keyword">,</span> make_t1ypvar_lst <span class="keyword">(</span>len2 - len1<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> ts2<span class="keyword">)</span>
    <span class="keyword">else</span>
      <span class="keyword">(</span>ts1<span class="keyword">,</span> list0_append&lt;<span class="staexp">t1yp</span><span class="keyword">&gt;</span> <span class="keyword">(</span>ts2<span class="keyword">,</span> make_t1ypvar_lst <span class="keyword">(</span>len1 - len2<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">)</span>
    <span class="keyword">val</span> res <span class="keyword">=</span> match_t1yplst_t1yplst <span class="keyword">(</span>ts1<span class="keyword">,</span> ts2<span class="keyword">,</span> true<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
    <span class="keyword">val</span> ts1 <span class="keyword">=</span> t1yp_lst_normalize <span class="keyword">(</span>ts1<span class="keyword">)</span>
    <span class="keyword">val</span> ts2 <span class="keyword">=</span> t1yp_lst_normalize <span class="keyword">(</span>ts2<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>rfts1 := ts1
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>rfts2 := ts2
  <span class="keyword">in</span>
    res
  <span class="keyword">end</span>
  <span class="keyword">|</span> <span class="keyword">(</span>T1YPlist X1<span class="keyword">,</span> T1YPlist X2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> t1 <span class="keyword">=</span> t1Var_get_typ <span class="keyword">(</span>X1<span class="keyword">)</span>
    <span class="keyword">val</span> t2 <span class="keyword">=</span> t1Var_get_typ <span class="keyword">(</span>X2<span class="keyword">)</span>
  <span class="keyword">in</span>
    match_t1yp_t1yp <span class="keyword">(</span>t1<span class="keyword">,</span> t2<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> <span class="keyword">(</span>T1YPlist _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> errmsg <span class="keyword">=</span> trans1_build_err <span class="keyword">(</span>t1<span class="keyword">,</span> t2<span class="keyword">)</span>
    <span class="keyword">val</span> tyerrs1 <span class="keyword">=</span> tyerr_pool_add_tail <span class="keyword">(</span>tyerrs<span class="keyword">,</span> errmsg<span class="keyword">)</span>
  <span class="keyword">in</span> <span class="keyword">(</span>false<span class="keyword">,</span> tyerrs1<span class="keyword">)</span> <span class="keyword">end</span>
  <span class="keyword">|</span> <span class="keyword">(</span>_<span class="keyword">,</span> T1YPlist _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> errmsg <span class="keyword">=</span> trans1_build_err <span class="keyword">(</span>t1<span class="keyword">,</span> t2<span class="keyword">)</span>
    <span class="keyword">val</span> tyerrs1 <span class="keyword">=</span> tyerr_pool_add_tail <span class="keyword">(</span>tyerrs<span class="keyword">,</span> errmsg<span class="keyword">)</span>
  <span class="keyword">in</span> <span class="keyword">(</span>false<span class="keyword">,</span> tyerrs1<span class="keyword">)</span> <span class="keyword">end</span>
  <span class="keyword">|</span> <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> errmsg <span class="keyword">=</span> trans1_build_err <span class="keyword">(</span>t1<span class="keyword">,</span> t2<span class="keyword">)</span>
    <span class="keyword">val</span> tyerrs1 <span class="keyword">=</span> tyerr_pool_add_tail <span class="keyword">(</span>tyerrs<span class="keyword">,</span> errmsg<span class="keyword">)</span>
  <span class="keyword">in</span> <span class="keyword">(</span>false<span class="keyword">,</span> tyerrs1<span class="keyword">)</span> <span class="keyword">end</span>
<span class="keyword">end</span> <span class="comment">// end of [match_t1yp_t1yp]
</span>
<span class="keyword">and</span> match_t1yplst_t1yplst <span class="keyword">(</span>
  ts1<span class="keyword">:</span> <span class="staexp">t1yplst</span><span class="keyword">,</span> ts2<span class="keyword">:</span> <span class="staexp">t1yplst</span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp">bool</span><span class="keyword">,</span> tyerrs<span class="keyword">:</span> <span class="staexp">tyerr_pool</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>bool<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span> <span class="keyword">=</span>
  <span class="keyword">case+</span> <span class="keyword">(</span>ts1<span class="keyword">,</span> ts2<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">(</span>list0_cons <span class="keyword">(</span>t1<span class="keyword">,</span> ts1<span class="keyword">)</span><span class="keyword">,</span>
     list0_cons <span class="keyword">(</span>t2<span class="keyword">,</span> ts2<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span>res1<span class="keyword">,</span> tyerrs1<span class="keyword">)</span> <span class="keyword">=</span> match_t1yp_t1yp <span class="keyword">(</span>t1<span class="keyword">,</span> t2<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
      <span class="keyword">val</span> res <span class="keyword">=</span> <span class="keyword">(</span>
        <span class="keyword">if</span> res1 <span class="keyword">then</span> res <span class="keyword">else</span> false
      <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">bool</span>
    <span class="keyword">in</span>
      match_t1yplst_t1yplst <span class="keyword">(</span>ts1<span class="keyword">,</span> ts2<span class="keyword">,</span> res<span class="keyword">,</span> tyerrs1<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [list0_cons, list0_cons]
</span>  <span class="keyword">|</span> <span class="keyword">(</span>list0_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> list0_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>res<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
  <span class="keyword">|</span> <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> errmsg <span class="keyword">=</span> "two type lists are not of the size length"
    <span class="keyword">val</span> tyerrs1 <span class="keyword">=</span> tyerr_pool_add_tail <span class="keyword">(</span>tyerrs<span class="keyword">,</span> errmsg<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span>false<span class="keyword">,</span> tyerrs1<span class="keyword">)</span>
  <span class="keyword">end</span>
<span class="comment">// end of [lte_t1yplst_t1yplst]
</span>
<span class="comment">(* it's O.K. if the left is longer than the right *)</span> 
<span class="keyword">and</span> match_t1yplst_t1yplst_l <span class="keyword">(</span>
  ts1<span class="keyword">:</span> <span class="staexp">t1yplst</span><span class="keyword">,</span> ts2<span class="keyword">:</span> <span class="staexp">t1yplst</span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp">bool</span><span class="keyword">,</span> tyerrs<span class="keyword">:</span> <span class="staexp">tyerr_pool</span>
<span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>bool<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span> <span class="keyword">=</span>
  <span class="keyword">case+</span> <span class="keyword">(</span>ts1<span class="keyword">,</span> ts2<span class="keyword">)</span> <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">(</span>list0_cons <span class="keyword">(</span>t1<span class="keyword">,</span> ts1<span class="keyword">)</span><span class="keyword">,</span>
     list0_cons <span class="keyword">(</span>t2<span class="keyword">,</span> ts2<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span>res1<span class="keyword">,</span> tyerrs1<span class="keyword">)</span> <span class="keyword">=</span> match_t1yp_t1yp <span class="keyword">(</span>t1<span class="keyword">,</span> t2<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
      <span class="keyword">val</span> res <span class="keyword">=</span> <span class="keyword">(</span>
        <span class="keyword">if</span> res1 <span class="keyword">then</span> res <span class="keyword">else</span> false
      <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">bool</span>
    <span class="keyword">in</span>
      match_t1yplst_t1yplst_l <span class="keyword">(</span>ts1<span class="keyword">,</span> ts2<span class="keyword">,</span> res<span class="keyword">,</span> tyerrs1<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [list0_cons, list0_cons]
</span>  <span class="keyword">|</span> <span class="keyword">(</span>_<span class="keyword">,</span> list0_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>res<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
  <span class="keyword">|</span> <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> errmsg <span class="keyword">=</span> "expecting longer list"
    <span class="keyword">val</span> tyerrs1 <span class="keyword">=</span> tyerr_pool_add_tail <span class="keyword">(</span>tyerrs<span class="keyword">,</span> errmsg<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span>false<span class="keyword">,</span> tyerrs1<span class="keyword">)</span>
  <span class="keyword">end</span>
<span class="comment">// end of [lte_t1yplst_t1yplst]
</span>
<span class="comment">(* ****** ****** *)</span>
<span class="keyword">implement</span>
v1ar_make <span class="keyword">(</span>loc<span class="keyword">,</span> sym<span class="keyword">,</span> t<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  v1ar_loc<span class="keyword">=</span> loc<span class="keyword">,</span> v1ar_nam<span class="keyword">=</span> sym<span class="keyword">,</span> v1ar_typ<span class="keyword">=</span> t<span class="keyword">,</span> 
  v1ar_def<span class="keyword">=</span> None0<span class="keyword">,</span> v1ar_val <span class="keyword">=</span> ref&lt;<span class="staexp">option0 valprim_t</span><span class="keyword">&gt;</span><span class="keyword">(</span>None0<span class="keyword">)</span>
<span class="keyword">}</span> <span class="comment">// end of [v1ar_make]
</span>
<span class="keyword">implement</span>
e1xp_make_ann <span class="keyword">(</span>loc<span class="keyword">,</span> e<span class="keyword">,</span> t<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  e1xp_loc<span class="keyword">=</span> loc<span class="keyword">,</span> e1xp_node <span class="keyword">=</span> E1XPann <span class="keyword">(</span>e<span class="keyword">,</span> t<span class="keyword">)</span><span class="keyword">,</span> e1xp_typ<span class="keyword">=</span> t
<span class="keyword">}</span> <span class="comment">// end of [e1xp_make_ann]
</span>
<span class="keyword">implement</span>
e1xp_make_app <span class="keyword">(</span>loc<span class="keyword">,</span> e1<span class="keyword">,</span> e2<span class="keyword">,</span> t<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  e1xp_loc<span class="keyword">=</span> loc<span class="keyword">,</span> e1xp_node <span class="keyword">=</span> E1XPapp <span class="keyword">(</span>e1<span class="keyword">,</span> e2<span class="keyword">)</span><span class="keyword">,</span> e1xp_typ<span class="keyword">=</span> t
<span class="keyword">}</span> <span class="comment">// end of [e1xp_make_app]
</span>
<span class="keyword">implement</span>
e1xp_make_bool <span class="keyword">(</span>loc<span class="keyword">,</span> b<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  e1xp_loc<span class="keyword">=</span> loc<span class="keyword">,</span> e1xp_node <span class="keyword">=</span> E1XPbool b<span class="keyword">,</span> e1xp_typ<span class="keyword">=</span> t1yp_bool
<span class="keyword">}</span> <span class="comment">// end of [e1xp_make_bool]
</span>
<span class="keyword">implement</span>
e1xp_make_fix <span class="keyword">(</span>loc<span class="keyword">,</span> f<span class="keyword">,</span> xs<span class="keyword">,</span> body<span class="keyword">,</span> t_fun<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  e1xp_loc<span class="keyword">=</span> loc<span class="keyword">,</span> e1xp_node <span class="keyword">=</span> E1XPfix <span class="keyword">(</span>f<span class="keyword">,</span> xs<span class="keyword">,</span> body<span class="keyword">)</span><span class="keyword">,</span> e1xp_typ<span class="keyword">=</span> t_fun
<span class="keyword">}</span> <span class="comment">// end of [e1xp_make_fix]
</span>
<span class="keyword">implement</span>
e1xp_make_if <span class="keyword">(</span>loc<span class="keyword">,</span> e1<span class="keyword">,</span> e2<span class="keyword">,</span> oe3<span class="keyword">,</span> t<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  e1xp_loc<span class="keyword">=</span> loc<span class="keyword">,</span> e1xp_node <span class="keyword">=</span> E1XPif <span class="keyword">(</span>e1<span class="keyword">,</span> e2<span class="keyword">,</span> oe3<span class="keyword">)</span><span class="keyword">,</span> e1xp_typ<span class="keyword">=</span> t
<span class="keyword">}</span> <span class="comment">// end of [e1xp_make_if]
</span>
<span class="keyword">implement</span>
e1xp_make_int <span class="keyword">(</span>loc<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  e1xp_loc<span class="keyword">=</span> loc<span class="keyword">,</span> e1xp_node <span class="keyword">=</span> E1XPint i<span class="keyword">,</span> e1xp_typ<span class="keyword">=</span> t1yp_int
<span class="keyword">}</span> <span class="comment">// end of [e1xp_make_int]
</span>
<span class="keyword">implement</span>
e1xp_make_lam <span class="keyword">(</span>loc<span class="keyword">,</span> xs<span class="keyword">,</span> body<span class="keyword">,</span> t_fun<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  e1xp_loc<span class="keyword">=</span> loc<span class="keyword">,</span> e1xp_node <span class="keyword">=</span> E1XPlam <span class="keyword">(</span>xs<span class="keyword">,</span> body<span class="keyword">)</span><span class="keyword">,</span> e1xp_typ<span class="keyword">=</span> t_fun
<span class="keyword">}</span> <span class="comment">// end of [e1xp_make_lam]
</span>
<span class="keyword">implement</span>
e1xp_make_let <span class="keyword">(</span>loc<span class="keyword">,</span> decs<span class="keyword">,</span> body<span class="keyword">,</span> t_let<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  e1xp_loc<span class="keyword">=</span> loc<span class="keyword">,</span> e1xp_node<span class="keyword">=</span> E1XPlet <span class="keyword">(</span>decs<span class="keyword">,</span> body<span class="keyword">)</span><span class="keyword">,</span> e1xp_typ<span class="keyword">=</span> t_let
<span class="keyword">}</span> <span class="comment">// end of [e1xp_make_let]
</span>
<span class="keyword">implement</span>
e1xp_make_opr <span class="keyword">(</span>loc<span class="keyword">,</span> opr<span class="keyword">,</span> es<span class="keyword">,</span> t_res<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  e1xp_loc<span class="keyword">=</span> loc<span class="keyword">,</span> e1xp_node<span class="keyword">=</span> E1XPopr <span class="keyword">(</span>opr<span class="keyword">,</span> es<span class="keyword">)</span><span class="keyword">,</span> e1xp_typ<span class="keyword">=</span> t_res
<span class="keyword">}</span> <span class="comment">// end of [e1xp_make_opr]
</span>
<span class="keyword">implement</span>
e1xp_make_proj <span class="keyword">(</span>loc<span class="keyword">,</span> e<span class="keyword">,</span> i<span class="keyword">,</span> t_proj<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  e1xp_loc<span class="keyword">=</span> loc<span class="keyword">,</span> e1xp_node<span class="keyword">=</span> E1XPproj <span class="keyword">(</span>e<span class="keyword">,</span> i<span class="keyword">)</span><span class="keyword">,</span> e1xp_typ<span class="keyword">=</span> t_proj
<span class="keyword">}</span> <span class="comment">// end of [e1xp_make_proj]
</span>
<span class="keyword">implement</span>
e1xp_make_str <span class="keyword">(</span>loc<span class="keyword">,</span> s<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  e1xp_loc<span class="keyword">=</span> loc<span class="keyword">,</span> e1xp_node <span class="keyword">=</span> E1XPstr s<span class="keyword">,</span> e1xp_typ<span class="keyword">=</span> t1yp_string
<span class="keyword">}</span> <span class="comment">// end of [e1xp_make_str]
</span>
<span class="keyword">implement</span>
e1xp_make_tup <span class="keyword">(</span>loc<span class="keyword">,</span> es<span class="keyword">,</span> t_tup<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  e1xp_loc<span class="keyword">=</span> loc<span class="keyword">,</span> e1xp_node <span class="keyword">=</span> E1XPtup es<span class="keyword">,</span> e1xp_typ<span class="keyword">=</span> t_tup
<span class="keyword">}</span> <span class="comment">// end of [e1xp_make_tup]
</span>
<span class="keyword">implement</span>
e1xp_make_var <span class="keyword">(</span>loc<span class="keyword">,</span> x<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  e1xp_loc<span class="keyword">=</span> loc<span class="keyword">,</span> e1xp_node <span class="keyword">=</span> E1XPvar x<span class="keyword">,</span> e1xp_typ<span class="keyword">=</span> x<span class="keyword">.</span>v1ar_typ
<span class="keyword">}</span> <span class="comment">// end of [e1xp_make_var]
</span>
<span class="keyword">implement</span>
v1aldec_make <span class="keyword">(</span>loc<span class="keyword">,</span> x<span class="keyword">,</span> def<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  v1aldec_loc<span class="keyword">=</span> loc<span class="keyword">,</span> v1aldec_var<span class="keyword">=</span> x<span class="keyword">,</span> v1aldec_def<span class="keyword">=</span> def
<span class="keyword">}</span> <span class="comment">// end of [v1aldec_make]
</span>
<span class="keyword">implement</span>
d1ec_make_val <span class="keyword">(</span>loc<span class="keyword">,</span> isrec<span class="keyword">,</span> vds<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">'{</span>
  d1ec_loc<span class="keyword">=</span> loc<span class="keyword">,</span> d1ec_node<span class="keyword">=</span> D1ECval <span class="keyword">(</span>isrec<span class="keyword">,</span> vds<span class="keyword">)</span>
<span class="keyword">}</span> <span class="comment">// end of [d1ec_make_val]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">// v1ar is defined in trans1.sats
</span><span class="keyword">extern</span> <span class="keyword">typedef</span> <span class="staexp">"v1ar_t" <span class="keyword">=</span> v1ar</span>

<span class="comment">(* can be deleted? *)</span>
<span class="extern">%{$

ats_bool_type
eq_v1ar_v1ar (v1ar_t x1, v1ar_t x2) {
  return (x1 == x2 ? ats_true_bool : ats_false_bool) ;
} /* end of [eq_v1ar_v1ar] */

ats_void_type
v1ar_set_def (
  ats_ptr_type x
, ats_ptr_type oe
) {
  ((v1ar_t)x)-&gt;atslab_v1ar_def = oe ;  return ;
} /* end of [v1ar_set_def] */

%}</span> <span class="comment">// end of [%{$]
</span><span class="comment">(* ****** ****** *)</span>

<span class="keyword">typedef</span> <span class="staexp"><a name="14659"><span class="stacstdec">ctx <span class="keyword">=</span> symenv_t <span class="keyword">(</span>v1ar<span class="keyword">)</span></span></a></span>
<span class="keyword">val</span> ctx_nil <span class="keyword">=</span> symenv_make <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// empty context
</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">// exception TypeError of (loc, String)
</span>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="14801"><span class="dyncstdec">oftype <span class="keyword">(</span>Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> e0<span class="keyword">:</span> <span class="staexp">e0xp</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>e1xp<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="14863"><span class="dyncstdec">typcheck <span class="keyword">(</span>Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> e0<span class="keyword">:</span> <span class="staexp">e0xp</span><span class="keyword">,</span> t1<span class="keyword">:</span> <span class="staexp">t1yp</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>e1xp<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span></span></a>

<span class="keyword">fun</span> oftype_ann <span class="keyword">(</span>Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> loc<span class="keyword">:</span> <span class="staexp">loc</span><span class="keyword">,</span> e0<span class="keyword">:</span> <span class="staexp">e0xp</span><span class="keyword">,</span> t0<span class="keyword">:</span> <span class="staexp">t0yp</span><span class="keyword">)</span><span class="keyword">:</span> 
  <span class="staexp"><span class="keyword">(</span>e1xp<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> t1 <span class="keyword">=</span> trans1_typ <span class="keyword">(</span>t0<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span>e1<span class="keyword">,</span> tyerrs<span class="keyword">)</span> <span class="keyword">=</span> typcheck <span class="keyword">(</span>Gamma<span class="keyword">,</span> e0<span class="keyword">,</span> t1<span class="keyword">)</span>
  <span class="keyword">val</span> e1a <span class="keyword">=</span> e1xp_make_ann <span class="keyword">(</span>loc<span class="keyword">,</span> e1<span class="keyword">,</span> t1<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">(</span>e1a<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">fun</span> oftype_if <span class="keyword">(</span>Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> loc<span class="keyword">:</span> <span class="staexp">loc</span><span class="keyword">,</span> 
  e0_if<span class="keyword">:</span> <span class="staexp">e0xp</span><span class="keyword">,</span> e0_then<span class="keyword">:</span> <span class="staexp">e0xp</span><span class="keyword">,</span> e0opt_else<span class="keyword">:</span> <span class="staexp">e0xpopt</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>e1xp<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span>e1_if<span class="keyword">,</span> tyerrs1<span class="keyword">)</span> <span class="keyword">=</span> typcheck <span class="keyword">(</span>Gamma<span class="keyword">,</span> e0_if<span class="keyword">,</span> t1yp_bool<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> e0opt_else <span class="keyword">of</span>
  <span class="keyword">|</span> Some0 e0_else <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span>e1_then<span class="keyword">,</span> tyerrs2<span class="keyword">)</span> <span class="keyword">=</span> oftype <span class="keyword">(</span>Gamma<span class="keyword">,</span> e0_then<span class="keyword">)</span>
    <span class="keyword">val</span> tyerrs <span class="keyword">=</span> tyerr_pool_append <span class="keyword">(</span>tyerrs1<span class="keyword">,</span> tyerrs2<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span>e1_else<span class="keyword">,</span> tyerrs3<span class="keyword">)</span> <span class="keyword">=</span> typcheck <span class="keyword">(</span>Gamma<span class="keyword">,</span> e0_else<span class="keyword">,</span> e1_then<span class="keyword">.</span>e1xp_typ<span class="keyword">)</span>
    <span class="keyword">val</span> tyerrs <span class="keyword">=</span> tyerr_pool_append <span class="keyword">(</span>tyerrs<span class="keyword">,</span> tyerrs3<span class="keyword">)</span>
    <span class="comment">(* assume the type of if statement = the then branch *)</span>
    <span class="keyword">val</span> e1 <span class="keyword">=</span> e1xp_make_if <span class="keyword">(</span>loc<span class="keyword">,</span> e1_if<span class="keyword">,</span> e1_then<span class="keyword">,</span> Some0 e1_else<span class="keyword">,</span> e1_then<span class="keyword">.</span>e1xp_typ<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span>e1<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span>e1_then<span class="keyword">,</span> tyerrs2<span class="keyword">)</span> <span class="keyword">=</span> typcheck <span class="keyword">(</span>Gamma<span class="keyword">,</span> e0_then<span class="keyword">,</span> t1yp_unit<span class="keyword">)</span>
    <span class="keyword">val</span> tyerrs <span class="keyword">=</span> tyerr_pool_append <span class="keyword">(</span>tyerrs1<span class="keyword">,</span> tyerrs2<span class="keyword">)</span>
    <span class="comment">(* assume the type of if statement t1yp_unit *)</span>
    <span class="keyword">val</span> e1 <span class="keyword">=</span> e1xp_make_if <span class="keyword">(</span>loc<span class="keyword">,</span> e1_if<span class="keyword">,</span> e1_then<span class="keyword">,</span> None0<span class="keyword">,</span> t1yp_unit<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span>e1<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
    
<span class="comment">(* fill the environment and do the transformation *)</span>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="16136"><span class="dyncstdec">oftype_declst <span class="keyword">(</span>Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> decs<span class="keyword">:</span> <span class="staexp">d0eclst</span><span class="keyword">)</span><span class="keyword">:</span> 
  <span class="staexp"><span class="keyword">(</span>ctx<span class="keyword">,</span> d1eclst<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="16221"><span class="dyncstdec">oftype_dec <span class="keyword">(</span>Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> dec<span class="keyword">:</span> <span class="staexp">d0ec</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>ctx<span class="keyword">,</span> d1ec<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="16293"><span class="dyncstdec">oftype_valdeclst <span class="keyword">(</span>Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> v0aldecs<span class="keyword">:</span> <span class="staexp">v0aldeclst</span><span class="keyword">)</span><span class="keyword">:</span>
  <span class="staexp"><span class="keyword">(</span>ctx<span class="keyword">,</span> v1aldeclst<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="16390"><span class="dyncstdec">oftype_valdeclst_rec <span class="keyword">(</span>Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> v0aldecs<span class="keyword">:</span> <span class="staexp">v0aldeclst</span><span class="keyword">)</span><span class="keyword">:</span>
  <span class="staexp"><span class="keyword">(</span>ctx<span class="keyword">,</span> v1aldeclst<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="16491"><span class="dyncstdec">oftype_valdec <span class="keyword">(</span>Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> v0aldec<span class="keyword">:</span> <span class="staexp">v0aldec</span><span class="keyword">)</span><span class="keyword">:</span>
  <span class="staexp"><span class="keyword">(</span>ctx<span class="keyword">,</span> v1aldec<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="16578"><span class="dyncstdec">oftype_valdec_rec <span class="keyword">(</span>Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> v0aldec<span class="keyword">:</span> <span class="staexp">v0aldec</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>v1aldec<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span></span></a>

<span class="keyword">implement</span> oftype_declst <span class="keyword">(</span>Gamma<span class="keyword">,</span> decs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> helper <span class="keyword">(</span>init<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>ctx<span class="keyword">,</span> d1eclst<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span><span class="keyword">,</span> dec<span class="keyword">:</span> <span class="staexp">d0ec</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span>
    <span class="staexp"><span class="keyword">(</span>ctx<span class="keyword">,</span> d1eclst<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span>gamma<span class="keyword">,</span> d1ec<span class="keyword">,</span> tyerrs<span class="keyword">)</span> <span class="keyword">=</span> oftype_dec <span class="keyword">(</span>init<span class="keyword">.</span>0<span class="keyword">,</span> dec<span class="keyword">)</span>
    <span class="keyword">val</span> d1ecs <span class="keyword">=</span> d1ec :: init<span class="keyword">.</span>1
    <span class="keyword">val</span> tyerrs <span class="keyword">=</span> tyerr_pool_append <span class="keyword">(</span>init<span class="keyword">.</span>2<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span>gamma<span class="keyword">,</span> d1ecs<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">val</span> <span class="keyword">(</span>gamma<span class="keyword">,</span> d1ecs<span class="keyword">,</span> tyerrs<span class="keyword">)</span> <span class="keyword">=</span> list0_fold_left <span class="keyword">(</span>helper<span class="keyword">,</span> <span class="keyword">(</span>Gamma<span class="keyword">,</span> nil<span class="keyword">,</span> tyerr_pool_nil<span class="keyword">)</span><span class="keyword">,</span> decs<span class="keyword">)</span>
  <span class="keyword">val</span> d1ecs <span class="keyword">=</span> list0_reverse <span class="keyword">(</span>d1ecs<span class="keyword">)</span>  <span class="comment">// maintain the order
</span><span class="keyword">in</span>
  <span class="keyword">(</span>gamma<span class="keyword">,</span> d1ecs<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="comment">(* extern fun oftype_dec (Gamma: ctx, dec: d0ec): (ctx, d1ec, tyerr_pool) *)</span>
<span class="keyword">implement</span> oftype_dec <span class="keyword">(</span>Gamma<span class="keyword">,</span> dec<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> d0ec_loc <span class="keyword">=</span> dec<span class="keyword">.</span>d0ec_loc
  <span class="keyword">val</span> d0ec_node <span class="keyword">=</span> dec<span class="keyword">.</span>d0ec_node
  <span class="keyword">val+</span> D0ECval <span class="keyword">(</span>isrec<span class="keyword">,</span> v0aldecs<span class="keyword">)</span> <span class="keyword">=</span> d0ec_node
  <span class="keyword">val</span> <span class="keyword">(</span>Gamma1<span class="keyword">,</span> v1aldecs<span class="keyword">,</span> tyerrs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> isrec <span class="keyword">=</span> true <span class="keyword">then</span> 
      oftype_valdeclst_rec <span class="keyword">(</span>Gamma<span class="keyword">,</span> v0aldecs<span class="keyword">)</span>
    <span class="keyword">else</span> oftype_valdeclst <span class="keyword">(</span>Gamma<span class="keyword">,</span> v0aldecs<span class="keyword">)</span>
  <span class="keyword">val</span> d1ec <span class="keyword">=</span> <span class="keyword">'{</span>d1ec_loc <span class="keyword">=</span> d0ec_loc<span class="keyword">,</span> d1ec_node <span class="keyword">=</span> D1ECval <span class="keyword">(</span>isrec<span class="keyword">,</span> v1aldecs<span class="keyword">)</span><span class="keyword">}</span>
<span class="keyword">in</span>
  <span class="keyword">(</span>Gamma1<span class="keyword">,</span> d1ec<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">implement</span> oftype_valdeclst <span class="keyword">(</span>Gamma<span class="keyword">,</span> v0aldecs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> helper <span class="keyword">(</span>init<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>ctx<span class="keyword">,</span> v1aldeclst<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span><span class="keyword">,</span> v0aldec<span class="keyword">:</span> <span class="staexp">v0aldec</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span>
    <span class="staexp"><span class="keyword">(</span>ctx<span class="keyword">,</span> v1aldeclst<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span>gamma<span class="keyword">,</span> v1aldec<span class="keyword">,</span> tyerrs<span class="keyword">)</span> <span class="keyword">=</span> oftype_valdec <span class="keyword">(</span>init<span class="keyword">.</span>0<span class="keyword">,</span> v0aldec<span class="keyword">)</span>
    <span class="keyword">val</span> v1aldecs <span class="keyword">=</span> v1aldec :: init<span class="keyword">.</span>1
    <span class="keyword">val</span> tyerrs <span class="keyword">=</span> tyerr_pool_append <span class="keyword">(</span>init<span class="keyword">.</span>2<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span>gamma<span class="keyword">,</span> v1aldecs<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">val</span> <span class="keyword">(</span>gamma<span class="keyword">,</span> v1aldecs<span class="keyword">,</span> tyerrs<span class="keyword">)</span> <span class="keyword">=</span> 
        list0_fold_left <span class="keyword">(</span>helper<span class="keyword">,</span> <span class="keyword">(</span>Gamma<span class="keyword">,</span> nil<span class="keyword">,</span> tyerr_pool_nil<span class="keyword">)</span><span class="keyword">,</span> v0aldecs<span class="keyword">)</span>
  <span class="keyword">val</span> v1aldecs <span class="keyword">=</span> list0_reverse <span class="keyword">(</span>v1aldecs<span class="keyword">)</span>  <span class="comment">// maintain the order
</span><span class="keyword">in</span>
  <span class="keyword">(</span>gamma<span class="keyword">,</span> v1aldecs<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">implement</span> oftype_valdeclst_rec <span class="keyword">(</span>Gamma<span class="keyword">,</span> v0aldecs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> fillin_env <span class="keyword">(</span>Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> valdecs<span class="keyword">:</span> <span class="staexp">v0aldeclst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>ctx<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span> <span class="keyword">=</span>
    <span class="keyword">case+</span> valdecs <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>valdec<span class="keyword">,</span> valdecs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> loc <span class="keyword">=</span> valdec<span class="keyword">.</span>v0aldec_loc
      <span class="keyword">val</span> nam <span class="keyword">=</span> valdec<span class="keyword">.</span>v0aldec_nam
      <span class="keyword">val</span> def <span class="keyword">=</span> valdec<span class="keyword">.</span>v0aldec_def
      <span class="keyword">val</span> tyerrs1 <span class="keyword">=</span> tyerr_pool_nil

      <span class="keyword">val</span> <span class="keyword">(</span>t1yp<span class="keyword">,</span> tyerrs1<span class="keyword">)</span> <span class="keyword">=</span> <span class="comment">// peak the definition
</span>        <span class="keyword">case+</span> e0xp_node_is_fun <span class="keyword">(</span>def<span class="keyword">.</span>e0xp_node<span class="keyword">)</span> <span class="keyword">of</span>
        <span class="keyword">|</span> Some0 fnt1yp <span class="keyword">=&gt;</span> 
          <span class="keyword">(</span><span class="keyword">case+</span> valdec<span class="keyword">.</span>v0aldec_ann <span class="keyword">of</span>
          <span class="keyword">|</span> Some0 t0yp <span class="keyword">=&gt;</span> <span class="keyword">let</span>
            <span class="keyword">val</span> ann_t1yp <span class="keyword">=</span> trans1_typ <span class="keyword">(</span>t0yp<span class="keyword">)</span>
            <span class="keyword">val</span> <span class="keyword">(</span>bmatch<span class="keyword">,</span> tyerrs1<span class="keyword">)</span> <span class="keyword">=</span> match_t1yp_t1yp <span class="keyword">(</span>fnt1yp<span class="keyword">,</span> ann_t1yp<span class="keyword">,</span> tyerrs1<span class="keyword">)</span>
            <span class="keyword">val</span> tyerrs1 <span class="keyword">=</span> <span class="keyword">if</span> bmatch &lt;&gt; true <span class="keyword">then</span> <span class="keyword">let</span>
              <span class="keyword">val</span> errmsg <span class="keyword">=</span> trans1_build_err <span class="keyword">(</span>fnt1yp<span class="keyword">,</span> ann_t1yp<span class="keyword">)</span>
            <span class="keyword">in</span> 
              tyerr_pool_add_tail <span class="keyword">(</span>tyerrs1<span class="keyword">,</span> loc<span class="keyword">,</span> errmsg<span class="keyword">)</span>
            <span class="keyword">end</span> <span class="keyword">else</span> tyerrs1
          <span class="keyword">in</span>
            <span class="keyword">(</span>fnt1yp<span class="keyword">,</span> tyerrs1<span class="keyword">)</span>
          <span class="keyword">end</span>
          <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fnt1yp<span class="keyword">,</span> tyerrs1<span class="keyword">)</span>
          <span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>t1yp<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span>
        <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span>  <span class="comment">// not a function
</span>          <span class="keyword">(</span><span class="keyword">case+</span> valdec<span class="keyword">.</span>v0aldec_ann <span class="keyword">of</span>
          <span class="keyword">|</span> Some0 t0yp <span class="keyword">=&gt;</span> <span class="keyword">(</span>trans1_typ <span class="keyword">(</span>t0yp<span class="keyword">)</span><span class="keyword">,</span> tyerrs1<span class="keyword">)</span>
          <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>T1YPvar <span class="keyword">(</span>t1Var_new <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> tyerrs1<span class="keyword">)</span>
          <span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>t1yp<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span>

      <span class="keyword">val</span> Gamma1 <span class="keyword">=</span> symenv_insert <span class="keyword">(</span>Gamma<span class="keyword">,</span> nam<span class="keyword">,</span> v1ar_make <span class="keyword">(</span>loc<span class="keyword">,</span> nam<span class="keyword">,</span> t1yp<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span>Gamma2<span class="keyword">,</span> tyerrs2<span class="keyword">)</span> <span class="keyword">=</span> fillin_env <span class="keyword">(</span>Gamma1<span class="keyword">,</span> valdecs1<span class="keyword">)</span>
      <span class="keyword">val</span> tyerrs <span class="keyword">=</span> tyerr_pool_append <span class="keyword">(</span>tyerrs1<span class="keyword">,</span> tyerrs2<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">(</span>Gamma2<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
    <span class="keyword">end</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>Gamma<span class="keyword">,</span> tyerr_pool_nil<span class="keyword">)</span>

  <span class="keyword">val</span> <span class="keyword">(</span>Gamma1<span class="keyword">,</span> tyerrs1<span class="keyword">)</span> <span class="keyword">=</span> fillin_env <span class="keyword">(</span>Gamma<span class="keyword">,</span> v0aldecs<span class="keyword">)</span>

  <span class="keyword">fun</span> helper <span class="keyword">(</span>init<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>v1aldeclst<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span><span class="keyword">,</span> v0aldec<span class="keyword">:</span> <span class="staexp">v0aldec</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span>
    <span class="staexp"><span class="keyword">(</span>v1aldeclst<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span>v1aldec<span class="keyword">,</span> tyerrs<span class="keyword">)</span> <span class="keyword">=</span> oftype_valdec_rec <span class="keyword">(</span>Gamma1<span class="keyword">,</span> v0aldec<span class="keyword">)</span>
    <span class="keyword">val</span> v1aldecs <span class="keyword">=</span> v1aldec :: init<span class="keyword">.</span>0
    <span class="keyword">val</span> tyerrs <span class="keyword">=</span> tyerr_pool_append <span class="keyword">(</span>init<span class="keyword">.</span>1<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span>v1aldecs<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
  <span class="keyword">end</span>

  <span class="keyword">val</span> <span class="keyword">(</span>v1aldecs<span class="keyword">,</span> tyerrs<span class="keyword">)</span> <span class="keyword">=</span> list0_fold_left <span class="keyword">(</span>helper<span class="keyword">,</span> <span class="keyword">(</span>nil<span class="keyword">,</span> nil<span class="keyword">)</span><span class="keyword">,</span> v0aldecs<span class="keyword">)</span>
  <span class="keyword">val</span> v1aldecs <span class="keyword">=</span> list0_reverse <span class="keyword">(</span>v1aldecs<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">(</span>Gamma1<span class="keyword">,</span> v1aldecs<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
<span class="keyword">end</span>
  
<span class="keyword">implement</span> oftype_valdec <span class="keyword">(</span>Gamma<span class="keyword">,</span> v0aldec<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> loc <span class="keyword">=</span> v0aldec<span class="keyword">.</span>v0aldec_loc
  <span class="keyword">val</span> nam <span class="keyword">=</span> v0aldec<span class="keyword">.</span>v0aldec_nam
  <span class="keyword">val</span> t0ypopt <span class="keyword">=</span> v0aldec<span class="keyword">.</span>v0aldec_ann
  <span class="keyword">val</span> def <span class="keyword">=</span> v0aldec<span class="keyword">.</span>v0aldec_def
<span class="keyword">in</span>
  <span class="keyword">case+</span> t0ypopt <span class="keyword">of</span>
  <span class="keyword">|</span> Some0 t0yp <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> t1yp <span class="keyword">=</span> trans1_typ <span class="keyword">(</span>t0yp<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span>e1xp<span class="keyword">,</span> tyerrs<span class="keyword">)</span> <span class="keyword">=</span> typcheck <span class="keyword">(</span>Gamma<span class="keyword">,</span> def<span class="keyword">,</span> t1yp<span class="keyword">)</span>
    <span class="comment">(* maybe not match, use the annotated one *)</span>
    <span class="keyword">val</span> v1ar <span class="keyword">=</span> v1ar_make <span class="keyword">(</span>loc<span class="keyword">,</span> nam<span class="keyword">,</span> t1yp<span class="keyword">)</span>
    <span class="keyword">val</span> v1aldec <span class="keyword">=</span> <span class="keyword">'{</span>v1aldec_loc <span class="keyword">=</span> loc<span class="keyword">,</span> v1aldec_var <span class="keyword">=</span> v1ar<span class="keyword">,</span> v1aldec_def <span class="keyword">=</span> e1xp<span class="keyword">}</span>
    <span class="keyword">val</span> Gamma1 <span class="keyword">=</span> symenv_insert <span class="keyword">(</span>Gamma<span class="keyword">,</span> nam<span class="keyword">,</span> v1ar<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span>Gamma1<span class="keyword">,</span> v1aldec<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span>e1xp<span class="keyword">,</span> tyerrs<span class="keyword">)</span> <span class="keyword">=</span> oftype <span class="keyword">(</span>Gamma<span class="keyword">,</span> def<span class="keyword">)</span>
    <span class="keyword">val</span> v1ar <span class="keyword">=</span> v1ar_make <span class="keyword">(</span>loc<span class="keyword">,</span> nam<span class="keyword">,</span> e1xp<span class="keyword">.</span>e1xp_typ<span class="keyword">)</span>
    <span class="keyword">val</span> v1aldec <span class="keyword">=</span> <span class="keyword">'{</span>v1aldec_loc <span class="keyword">=</span> loc<span class="keyword">,</span> v1aldec_var <span class="keyword">=</span> v1ar<span class="keyword">,</span> v1aldec_def <span class="keyword">=</span> e1xp<span class="keyword">}</span>
    <span class="keyword">val</span> Gamma1 <span class="keyword">=</span> symenv_insert <span class="keyword">(</span>Gamma<span class="keyword">,</span> nam<span class="keyword">,</span> v1ar<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span>Gamma1<span class="keyword">,</span> v1aldec<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>  <span class="comment">// end of [oftype_valdec]
</span>  
<span class="comment">(* extern fun oftype_valdec_rec (Gamma: ctx, v0aldec: v0aldec): (v1aldec, tyerr_pool) *)</span>
<span class="keyword">implement</span> oftype_valdec_rec <span class="keyword">(</span>Gamma<span class="keyword">,</span> v0aldec<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> nam <span class="keyword">=</span> v0aldec<span class="keyword">.</span>v0aldec_nam
  <span class="keyword">val</span> loc <span class="keyword">=</span> v0aldec<span class="keyword">.</span>v0aldec_loc
  <span class="keyword">val</span> v1aropt <span class="keyword">=</span> symenv_lookup&lt;<span class="staexp">v1ar</span><span class="keyword">&gt;</span> <span class="keyword">(</span>Gamma<span class="keyword">,</span> nam<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> v1aropt <span class="keyword">of</span>
  <span class="keyword">|</span> Some0 v1ar <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span>def<span class="keyword">,</span> tyerrs<span class="keyword">)</span> <span class="keyword">=</span> typcheck <span class="keyword">(</span>Gamma<span class="keyword">,</span> v0aldec<span class="keyword">.</span>v0aldec_def<span class="keyword">,</span> v1ar<span class="keyword">.</span>v1ar_typ<span class="keyword">)</span>
    <span class="keyword">val</span> v1aldec <span class="keyword">=</span> <span class="keyword">'{</span>v1aldec_loc <span class="keyword">=</span> loc<span class="keyword">,</span> v1aldec_var <span class="keyword">=</span> v1ar<span class="keyword">,</span> v1aldec_def <span class="keyword">=</span> def<span class="keyword">}</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span>v1aldec<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"oftyp_valdec_rec var not found\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span>
                    abort <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">fun</span> oftype_let <span class="keyword">(</span>Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> loc<span class="keyword">:</span> <span class="staexp">loc</span><span class="keyword">,</span> decs<span class="keyword">:</span> <span class="staexp">d0eclst</span><span class="keyword">,</span> e0_body<span class="keyword">:</span> <span class="staexp">e0xp</span><span class="keyword">)</span><span class="keyword">:</span>
  <span class="staexp"><span class="keyword">(</span>e1xp<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span>Gamma1<span class="keyword">,</span> d1ecs<span class="keyword">,</span> tyerrs1<span class="keyword">)</span> <span class="keyword">=</span> oftype_declst <span class="keyword">(</span>Gamma<span class="keyword">,</span> decs<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span>e1<span class="keyword">,</span> tyerrs2<span class="keyword">)</span> <span class="keyword">=</span> oftype <span class="keyword">(</span>Gamma1<span class="keyword">,</span> e0_body<span class="keyword">)</span>
  <span class="keyword">val</span> tyerrs <span class="keyword">=</span> tyerr_pool_append <span class="keyword">(</span>tyerrs1<span class="keyword">,</span> tyerrs2<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">(</span>e1xp_make_let <span class="keyword">(</span>loc<span class="keyword">,</span> d1ecs<span class="keyword">,</span> e1<span class="keyword">,</span> e1<span class="keyword">.</span>e1xp_typ<span class="keyword">)</span><span class="keyword">,</span> tyerrs<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="22065"><span class="dyncstdec">oftyp_arglst <span class="keyword">(</span>Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> a0rgs<span class="keyword">:</span> <span class="staexp">a0rglst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>ctx<span class="keyword">,</span> v1arlst<span class="keyword">,</span> t1yplst<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="22156"><span class="dyncstdec">oftyp_arg <span class="keyword">(</span>Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> a0rg<span class="keyword">:</span> <span class="staexp">a0rg</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>ctx<span class="keyword">,</span> v1ar<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span></span></a>

<span class="keyword">implement</span> oftyp_arglst <span class="keyword">(</span>Gamma<span class="keyword">,</span> a0rgs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> helper <span class="keyword">(</span>init<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>ctx<span class="keyword">,</span> v1arlst<span class="keyword">,</span> t1yplst<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span><span class="keyword">,</span> a0rg<span class="keyword">:</span> <span class="staexp">a0rg</span><span class="keyword">)</span>
    <span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">(</span>ctx<span class="keyword">,</span> v1arlst<span class="keyword">,</span> t1yplst<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span>gamma<span class="keyword">,</span> v1ar<span class="keyword">,</span> tyerrs<span class="keyword">)</span> <span class="keyword">=</span> oftyp_arg <span class="keyword">(</span>init<span class="keyword">.</span>0<span class="keyword">,</span> a0rg<span class="keyword">)</span>
    <span class="keyword">val</span> v1ars <span class="keyword">=</span> v1ar :: init<span class="keyword">.</span>1
    <span class="keyword">val</span> t1yps <span class="keyword">=</span> v1ar<span class="keyword">.</span>v1ar_typ :: init<span class="keyword">.</span>2
    <span class="keyword">val</span> tyerrs <span class="keyword">=</span> tyerr_pool_append <span class="keyword">(</span>init<span class="keyword">.</span>3<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span>gamma<span class="keyword">,</span> v1ars<span class="keyword">,</span> t1yps<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">val</span> <span class="keyword">(</span>gamma<span class="keyword">,</span> v1ars<span class="keyword">,</span> t1yps<span class="keyword">,</span> tyerrs<span class="keyword">)</span> <span class="keyword">=</span> 
      list0_fold_left <span class="keyword">(</span>helper<span class="keyword">,</span> <span class="keyword">(</span>Gamma<span class="keyword">,</span> nil<span class="keyword">,</span> nil<span class="keyword">,</span> tyerr_pool_nil<span class="keyword">)</span><span class="keyword">,</span> a0rgs<span class="keyword">)</span>
  <span class="keyword">val</span> v1ars <span class="keyword">=</span> list0_reverse <span class="keyword">(</span>v1ars<span class="keyword">)</span>
  <span class="keyword">val</span> t1yps <span class="keyword">=</span> list0_reverse <span class="keyword">(</span>t1yps<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">(</span>gamma<span class="keyword">,</span> v1ars<span class="keyword">,</span> t1yps<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">implement</span> oftyp_arg <span class="keyword">(</span>Gamma<span class="keyword">,</span> a0rg<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> loc <span class="keyword">=</span> a0rg<span class="keyword">.</span>a0rg_loc
  <span class="keyword">val</span> t0ypopt <span class="keyword">=</span> a0rg<span class="keyword">.</span>a0rg_typ
  <span class="keyword">val</span> nam <span class="keyword">=</span> a0rg<span class="keyword">.</span>a0rg_nam
<span class="keyword">in</span>
  <span class="keyword">case+</span> t0ypopt <span class="keyword">of</span>
  <span class="keyword">|</span> Some0 t0yp <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> t1yp <span class="keyword">=</span> trans1_typ <span class="keyword">(</span>t0yp<span class="keyword">)</span>
    <span class="keyword">val</span> v1ar <span class="keyword">=</span> v1ar_make <span class="keyword">(</span>loc<span class="keyword">,</span> nam<span class="keyword">,</span> t1yp<span class="keyword">)</span>
    <span class="keyword">val</span> Gamma1 <span class="keyword">=</span> symenv_insert <span class="keyword">(</span>Gamma<span class="keyword">,</span> nam<span class="keyword">,</span> v1ar<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span>Gamma1<span class="keyword">,</span> v1ar<span class="keyword">,</span> tyerr_pool_nil<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> v1ar <span class="keyword">=</span> v1ar_make <span class="keyword">(</span>loc<span class="keyword">,</span> nam<span class="keyword">,</span> T1YPvar <span class="keyword">(</span>t1Var_new <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">val</span> Gamma1 <span class="keyword">=</span> symenv_insert <span class="keyword">(</span>Gamma<span class="keyword">,</span> nam<span class="keyword">,</span> v1ar<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span>Gamma1<span class="keyword">,</span> v1ar<span class="keyword">,</span> tyerr_pool_nil<span class="keyword">)</span>
  <span class="keyword">end</span>
    <span class="comment">(*let  serve as comment
    val () = prerr_loc (loc)
    val () = prerr ": arg must have type"
    val () = prerr_newline ()
    val errmsg = "arg must have type"

    (* assume the type is int *)
    val v1ar = v1ar_make (loc, nam, t1yp_int)
    val Gamma1 = symenv_insert (Gamma, nam, v1ar)
  in
    (Gamma1, v1ar, tyerr_pool_add (tyerr_pool_nil, loc, errmsg))
  end *)</span>
<span class="keyword">end</span>

<span class="keyword">fun</span> oftype_lam <span class="keyword">(</span>Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> loc<span class="keyword">:</span> <span class="staexp">loc</span><span class="keyword">,</span> a0rgs<span class="keyword">:</span> <span class="staexp">a0rglst</span><span class="keyword">,</span> t0ypopt<span class="keyword">:</span> <span class="staexp">t0ypopt</span><span class="keyword">,</span> e0xp<span class="keyword">:</span> <span class="staexp">e0xp</span><span class="keyword">)</span><span class="keyword">:</span>
  <span class="staexp"><span class="keyword">(</span>e1xp<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span>Gamma1<span class="keyword">,</span> v1ars<span class="keyword">,</span> t1yps<span class="keyword">,</span> tyerrs1<span class="keyword">)</span> <span class="keyword">=</span> oftyp_arglst <span class="keyword">(</span>Gamma<span class="keyword">,</span> a0rgs<span class="keyword">)</span>
  <span class="keyword">val</span> args <span class="keyword">=</span> list0_length <span class="keyword">(</span>t1yps<span class="keyword">)</span>
  <span class="comment">(* If there is only one argument, then the input type is not a tuple. *)</span>
  <span class="keyword">val</span> t1yp_args <span class="keyword">=</span> <span class="keyword">if</span> args <span class="keyword">=</span> 1 <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">val-</span> cons <span class="keyword">(</span>t1yp_arg<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=</span> t1yps <span class="keyword">in</span> t1yp_arg <span class="keyword">end</span>
    <span class="keyword">else</span> T1YPtup <span class="keyword">(</span>t1yps<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> t0ypopt <span class="keyword">of</span>
  <span class="keyword">|</span> Some0 t0yp <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> t1yp <span class="keyword">=</span> trans1_typ <span class="keyword">(</span>t0yp<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span>e1xp_body<span class="keyword">,</span> tyerrs2<span class="keyword">)</span> <span class="keyword">=</span> typcheck <span class="keyword">(</span>Gamma1<span class="keyword">,</span> e0xp<span class="keyword">,</span> t1yp<span class="keyword">)</span>
    <span class="keyword">val</span> e1xp_lam <span class="keyword">=</span> e1xp_make_lam <span class="keyword">(</span>loc<span class="keyword">,</span> v1ars<span class="keyword">,</span> e1xp_body<span class="keyword">,</span> 
             T1YPfun <span class="keyword">(</span>ref_make_elt&lt;<span class="staexp">int</span><span class="keyword">&gt;</span> <span class="keyword">(</span>args<span class="keyword">)</span><span class="keyword">,</span> t1yp_args<span class="keyword">,</span> t1yp<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">val</span> tyerrs <span class="keyword">=</span> tyerr_pool_append <span class="keyword">(</span>tyerrs1<span class="keyword">,</span> tyerrs2<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span>e1xp_lam<span class="keyword">,</span> tyerrs2<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span>e1xp_body<span class="keyword">,</span> tyerrs2<span class="keyword">)</span> <span class="keyword">=</span> oftype <span class="keyword">(</span>Gamma1<span class="keyword">,</span> e0xp<span class="keyword">)</span>
    <span class="keyword">val</span> e1xp_lam <span class="keyword">=</span> e1xp_make_lam <span class="keyword">(</span>loc<span class="keyword">,</span> v1ars<span class="keyword">,</span> e1xp_body<span class="keyword">,</span> 
         T1YPfun <span class="keyword">(</span>ref_make_elt&lt;<span class="staexp">int</span><span class="keyword">&gt;</span> <span class="keyword">(</span>args<span class="keyword">)</span><span class="keyword">,</span> t1yp_args<span class="keyword">,</span> e1xp_body<span class="keyword">.</span>e1xp_typ<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">val</span> tyerrs <span class="keyword">=</span> tyerr_pool_append <span class="keyword">(</span>tyerrs1<span class="keyword">,</span> tyerrs2<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span>e1xp_lam<span class="keyword">,</span> tyerrs2<span class="keyword">)</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">fun</span> oftype_opr <span class="keyword">(</span>Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> loc<span class="keyword">:</span> <span class="staexp">loc</span><span class="keyword">,</span> opr<span class="keyword">:</span> <span class="staexp">opr</span><span class="keyword">,</span> e0xps<span class="keyword">:</span> <span class="staexp">e0xplst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>e1xp<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> t1yp_opt <span class="keyword">=</span> libOprTypFind <span class="keyword">(</span>opr<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> t1yp_opt <span class="keyword">of</span>
  <span class="keyword">|</span> Some0 t1yp_opr <span class="keyword">=&gt;</span> <span class="keyword">(</span>
    <span class="keyword">case+</span> t1yp_opr <span class="keyword">of</span>
    <span class="keyword">|</span> T1YPfun <span class="keyword">(</span>_<span class="keyword">,</span> t1yp_args<span class="keyword">,</span> t1yp_ret<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> e0xp_tup <span class="keyword">=</span> <span class="keyword">'{</span>e0xp_loc <span class="keyword">=</span> loc<span class="keyword">,</span> e0xp_node <span class="keyword">=</span> E0XPtup <span class="keyword">(</span>e0xps<span class="keyword">)</span><span class="keyword">}</span>
      <span class="keyword">val</span> <span class="keyword">(</span>e1xp_tup<span class="keyword">,</span> tyerrs<span class="keyword">)</span> <span class="keyword">=</span> typcheck <span class="keyword">(</span>Gamma<span class="keyword">,</span> e0xp_tup<span class="keyword">,</span> t1yp_args<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">case+</span> e1xp_tup<span class="keyword">.</span>e1xp_node <span class="keyword">of</span>
      <span class="keyword">|</span> E1XPtup <span class="keyword">(</span>e1xps<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> e1xp <span class="keyword">=</span> e1xp_make_opr <span class="keyword">(</span>loc<span class="keyword">,</span> opr<span class="keyword">,</span> e1xps<span class="keyword">,</span> t1yp_ret<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="keyword">(</span>e1xp<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
      <span class="keyword">end</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"oftype_opr: should not happen\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span>
               abort <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"oftype_opr: opr should have function type\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span>
               abort <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">)</span>
  <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>
      "oftype_opr: (no such operator should not happen\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span>
      abort <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">fun</span> oftype_proj <span class="keyword">(</span>Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> loc<span class="keyword">:</span> <span class="staexp">loc</span><span class="keyword">,</span> e0xp<span class="keyword">:</span> <span class="staexp">e0xp</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>e1xp<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span>e1xp<span class="keyword">,</span> tyerrs<span class="keyword">)</span> <span class="keyword">=</span> oftype <span class="keyword">(</span>Gamma<span class="keyword">,</span> e0xp<span class="keyword">)</span>
  <span class="comment">(* normalize first *)</span>
  <span class="keyword">val</span> t <span class="keyword">=</span> t1yp_normalize <span class="keyword">(</span>e1xp<span class="keyword">.</span>e1xp_typ<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> t <span class="keyword">of</span>
  <span class="keyword">|</span> T1YPtup <span class="keyword">(</span>t1yps<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> t1ypopt <span class="keyword">=</span> list0_nth_opt&lt;<span class="staexp">t1yp</span><span class="keyword">&gt;</span> <span class="keyword">(</span>t1yps<span class="keyword">,</span> i<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> t1ypopt <span class="keyword">of</span>
    <span class="keyword">|</span> Some0 t1ypitem <span class="keyword">=&gt;</span> <span class="keyword">(</span>e1xp_make_proj <span class="keyword">(</span>loc<span class="keyword">,</span> e1xp<span class="keyword">,</span> i<span class="keyword">,</span> t1ypitem<span class="keyword">)</span><span class="keyword">,</span> tyerrs<span class="keyword">)</span>
    <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="comment">(* out of bound: use int as the type *)</span>
      <span class="keyword">val</span> e1xp_proj <span class="keyword">=</span> e1xp_make_proj <span class="keyword">(</span>loc<span class="keyword">,</span> e1xp<span class="keyword">,</span> i<span class="keyword">,</span> t1yp_int<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_loc <span class="keyword">(</span>loc<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr ": projection out of bound"
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr_newline <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">val</span> errmsg <span class="keyword">=</span> "projection out of bound"
    <span class="keyword">in</span>
      <span class="keyword">(</span>e1xp_proj<span class="keyword">,</span> tyerr_pool_add <span class="keyword">(</span>tyerr_pool_nil<span class="keyword">,</span> loc<span class="keyword">,</span> errmsg<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> T1YPvar <span class="keyword">(</span>t1var<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> t1varlst <span class="keyword">=</span> make_t1ypvar_lst <span class="keyword">(</span>i + 1<span class="keyword">)</span>
    <span class="keyword">val-</span> Some0 <span class="keyword">(</span>t1ypitem<span class="keyword">)</span> <span class="keyword">=</span> list0_nth_opt <span class="keyword">(</span>t1varlst<span class="keyword">,</span> i<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> t1Var_set_typ <span class="keyword">(</span>t1var<span class="keyword">,</span> T1YPtup_vl <span class="keyword">(</span>ref&lt;<span class="staexp">t1yplst</span><span class="keyword">&gt;</span> <span class="keyword">(</span>t1varlst<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span>e1xp_make_proj <span class="keyword">(</span>loc<span class="keyword">,</span> e1xp<span class="keyword">,</span> i<span class="keyword">,</span> t1ypitem<span class="keyword">)</span><span class="keyword">,</span> tyerr_pool_nil<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> T1YPtup_vl <span class="keyword">(</span>rft1yps<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> t1yps <span class="keyword">=</span> <span class="keyword">!</span>rft1yps
    <span class="keyword">val</span> len <span class="keyword">=</span> list0_length <span class="keyword">(</span>t1yps<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">if</span> len <span class="keyword">&gt;</span> i <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">val-</span> Some0 <span class="keyword">(</span>t1ypitem<span class="keyword">)</span> <span class="keyword">=</span> list0_nth_opt <span class="keyword">(</span>t1yps<span class="keyword">,</span> i<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">(</span>e1xp_make_proj <span class="keyword">(</span>loc<span class="keyword">,</span> e1xp<span class="keyword">,</span> i<span class="keyword">,</span> t1ypitem<span class="keyword">)</span><span class="keyword">,</span> tyerr_pool_nil<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">let</span>
      <span class="keyword">val</span> t1varlst <span class="keyword">=</span> make_t1ypvar_lst <span class="keyword">(</span>i + 1 - len<span class="keyword">)</span>
      <span class="comment">(* get the last one *)</span>
      <span class="keyword">val-</span> Some0 <span class="keyword">(</span>t1ypitem<span class="keyword">)</span> <span class="keyword">=</span> list0_nth_opt <span class="keyword">(</span>t1varlst<span class="keyword">,</span> i - len<span class="keyword">)</span>
      <span class="keyword">val</span> t1yps <span class="keyword">=</span> list0_append <span class="keyword">(</span>t1yps<span class="keyword">,</span> t1varlst<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>rft1yps := t1yps
    <span class="keyword">in</span>
      <span class="keyword">(</span>e1xp_make_proj <span class="keyword">(</span>loc<span class="keyword">,</span> e1xp<span class="keyword">,</span> i<span class="keyword">,</span> t1ypitem<span class="keyword">)</span><span class="keyword">,</span> tyerr_pool_nil<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="comment">(* not tuple: use whatever type it has *)</span>
    <span class="keyword">val</span> e1xp_proj <span class="keyword">=</span> e1xp_make_proj <span class="keyword">(</span>loc<span class="keyword">,</span> e1xp<span class="keyword">,</span> i<span class="keyword">,</span> e1xp<span class="keyword">.</span>e1xp_typ<span class="keyword">)</span>
    <span class="comment">// val () = prerr_loc (loc)
</span>    <span class="comment">// val () = prerr ": projection on non-tuple type"
</span>    <span class="comment">// val () = prerr_newline ()
</span>    <span class="keyword">val</span> errmsg <span class="keyword">=</span> "projection on non-tuple type"
  <span class="keyword">in</span>
    <span class="keyword">(</span>e1xp_proj<span class="keyword">,</span> tyerr_pool_add <span class="keyword">(</span>tyerr_pool_nil<span class="keyword">,</span> loc<span class="keyword">,</span> errmsg<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">fun</span> oftype_tup <span class="keyword">(</span>Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> loc<span class="keyword">:</span> <span class="staexp">loc</span><span class="keyword">,</span> e0xps<span class="keyword">:</span> <span class="staexp">e0xplst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>e1xp<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> helper <span class="keyword">(</span>init<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>e1xplst<span class="keyword">,</span> t1yplst<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span><span class="keyword">,</span> e0xp<span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span>
    <span class="staexp"><span class="keyword">(</span>e1xplst<span class="keyword">,</span> t1yplst<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span>e1xp<span class="keyword">,</span> tyerrs<span class="keyword">)</span> <span class="keyword">=</span> oftype <span class="keyword">(</span>Gamma<span class="keyword">,</span> e0xp<span class="keyword">)</span>
    <span class="keyword">val</span> e1xps <span class="keyword">=</span> e1xp :: init<span class="keyword">.</span>0
    <span class="keyword">val</span> t1yps <span class="keyword">=</span> e1xp<span class="keyword">.</span>e1xp_typ :: init<span class="keyword">.</span>1
    <span class="keyword">val</span> tyerrs <span class="keyword">=</span> tyerr_pool_append <span class="keyword">(</span>init<span class="keyword">.</span>2<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span>e1xps<span class="keyword">,</span> t1yps<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">val</span> <span class="keyword">(</span>e1xps<span class="keyword">,</span> t1yps<span class="keyword">,</span> tyerrs<span class="keyword">)</span> <span class="keyword">=</span> list0_fold_left <span class="keyword">(</span>helper<span class="keyword">,</span> <span class="keyword">(</span>nil<span class="keyword">,</span> nil<span class="keyword">,</span> tyerr_pool_nil<span class="keyword">)</span><span class="keyword">,</span> e0xps<span class="keyword">)</span>
  <span class="keyword">val</span> e1xps <span class="keyword">=</span> list0_reverse <span class="keyword">(</span>e1xps<span class="keyword">)</span>
  <span class="keyword">val</span> t1yps <span class="keyword">=</span> list0_reverse <span class="keyword">(</span>t1yps<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">(</span>e1xp_make_tup <span class="keyword">(</span>loc<span class="keyword">,</span> e1xps<span class="keyword">,</span> T1YPtup <span class="keyword">(</span>t1yps<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> tyerrs<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">fun</span> oftype_var <span class="keyword">(</span>Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> loc<span class="keyword">:</span> <span class="staexp">loc</span><span class="keyword">,</span> nam<span class="keyword">:</span> <span class="staexp">symbol_t</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>e1xp<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="comment">// current environment
</span>  <span class="keyword">val</span> v1aropt <span class="keyword">=</span> symenv_lookup&lt;<span class="staexp">v1ar</span><span class="keyword">&gt;</span> <span class="keyword">(</span>Gamma<span class="keyword">,</span> nam<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> v1aropt <span class="keyword">of</span>
  <span class="keyword">|</span> Some0 v1ar <span class="keyword">=&gt;</span> <span class="keyword">(</span>e1xp_make_var <span class="keyword">(</span>loc<span class="keyword">,</span> v1ar<span class="keyword">)</span><span class="keyword">,</span> tyerr_pool_nil<span class="keyword">)</span>
  <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="comment">// library function / operator
</span>    <span class="keyword">val</span> t1yp_opt <span class="keyword">=</span> libSymTypFind <span class="keyword">(</span>nam<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> t1yp_opt <span class="keyword">of</span>
    <span class="keyword">|</span> Some0 t1yp <span class="keyword">=&gt;</span> <span class="keyword">(</span>e1xp_make_var <span class="keyword">(</span>loc<span class="keyword">,</span> v1ar_make <span class="keyword">(</span>loc<span class="keyword">,</span> nam<span class="keyword">,</span> t1yp<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> 
                     tyerr_pool_nil<span class="keyword">)</span>
    <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="comment">// val () = prerr_loc (loc)
</span>      <span class="comment">// val () = prerr ": no such var"
</span>      <span class="comment">// val () = prerr_newline ()
</span>      <span class="keyword">val</span> errmsg <span class="keyword">=</span> "oftype_var: no such var, assuming its type is int"
      <span class="comment">(* no such var, assume it is int *)</span>
      <span class="keyword">val</span> v1ar <span class="keyword">=</span> v1ar_make <span class="keyword">(</span>loc<span class="keyword">,</span> nam<span class="keyword">,</span> t1yp_int<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">(</span>e1xp_make_var <span class="keyword">(</span>loc<span class="keyword">,</span> v1ar<span class="keyword">)</span><span class="keyword">,</span> tyerr_pool_add <span class="keyword">(</span>tyerr_pool_nil<span class="keyword">,</span> loc<span class="keyword">,</span> errmsg<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">fun</span> oftype_fix <span class="keyword">(</span>Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> loc<span class="keyword">:</span> <span class="staexp">loc</span><span class="keyword">,</span> 
  nam<span class="keyword">:</span> <span class="staexp">symbol_t</span><span class="keyword">,</span> paras<span class="keyword">:</span> <span class="staexp">a0rglst</span><span class="keyword">,</span> retopt<span class="keyword">:</span> <span class="staexp">t0ypopt</span><span class="keyword">,</span> body<span class="keyword">:</span> <span class="staexp">e0xp</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>e1xp<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span>Gamma1<span class="keyword">,</span> args<span class="keyword">,</span> t1yps<span class="keyword">,</span> tyerrs1<span class="keyword">)</span> <span class="keyword">=</span> oftyp_arglst <span class="keyword">(</span>Gamma<span class="keyword">,</span> paras<span class="keyword">)</span>
  <span class="keyword">val</span> nargs <span class="keyword">=</span> list0_length <span class="keyword">(</span>t1yps<span class="keyword">)</span>
  <span class="comment">(* If there is only one argument, then the input type is not a tuple. *)</span>
  <span class="keyword">val</span> t1yp_args <span class="keyword">=</span> <span class="keyword">if</span> nargs <span class="keyword">=</span> 1 <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">val-</span> cons <span class="keyword">(</span>t1yp_arg<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=</span> t1yps <span class="keyword">in</span> t1yp_arg <span class="keyword">end</span>
    <span class="keyword">else</span> T1YPtup <span class="keyword">(</span>t1yps<span class="keyword">)</span>
  
  <span class="keyword">val</span> <span class="keyword">(</span>fixtyp<span class="keyword">,</span> retty<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> retopt <span class="keyword">of</span>
    <span class="keyword">|</span> Some0 retty <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> retty <span class="keyword">=</span> trans1_typ <span class="keyword">(</span>retty<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">(</span>T1YPfun <span class="keyword">(</span>ref_make_elt&lt;<span class="staexp">int</span><span class="keyword">&gt;</span> <span class="keyword">(</span>nargs<span class="keyword">)</span><span class="keyword">,</span> t1yp_args<span class="keyword">,</span> retty<span class="keyword">)</span><span class="keyword">,</span> retty<span class="keyword">)</span>
    <span class="keyword">end</span>
    <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> retty <span class="keyword">=</span> T1YPvar <span class="keyword">(</span>t1Var_new <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">(</span>T1YPfun <span class="keyword">(</span>ref_make_elt&lt;<span class="staexp">int</span><span class="keyword">&gt;</span> <span class="keyword">(</span>nargs<span class="keyword">)</span><span class="keyword">,</span> t1yp_args<span class="keyword">,</span> retty<span class="keyword">)</span><span class="keyword">,</span> retty<span class="keyword">)</span>
    <span class="keyword">end</span>
    <span class="comment">(*let
      val () = prerr_loc (loc)
      val () = prerr ": oftype_fix, return type not specified, int assumed"
      val () = prerr_newline ()
      val errmsg = "oftype_fix, return type not specified, int assumed"    
      val retty = t1yp_int
    in
      (* no such var, assume it is int *)
      (T1YPfun (t1yp_args, retty), retty)
    end*)</span>
    
  <span class="keyword">)</span>

  <span class="keyword">val</span> f_v1ar <span class="keyword">=</span> v1ar_make <span class="keyword">(</span>loc<span class="keyword">,</span> nam<span class="keyword">,</span> fixtyp<span class="keyword">)</span>
  <span class="keyword">val</span> Gamma2 <span class="keyword">=</span> symenv_insert <span class="keyword">(</span>Gamma1<span class="keyword">,</span> nam<span class="keyword">,</span> f_v1ar<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span>e1xp_body<span class="keyword">,</span> tyerrs2<span class="keyword">)</span> <span class="keyword">=</span> typcheck <span class="keyword">(</span>Gamma2<span class="keyword">,</span> body<span class="keyword">,</span> retty<span class="keyword">)</span>

  <span class="keyword">val</span> e1xpfix <span class="keyword">=</span> e1xp_make_fix <span class="keyword">(</span>loc<span class="keyword">,</span> f_v1ar<span class="keyword">,</span> args<span class="keyword">,</span> e1xp_body<span class="keyword">,</span> fixtyp<span class="keyword">)</span>
  <span class="keyword">val</span> tyerrs <span class="keyword">=</span> tyerr_pool_append <span class="keyword">(</span>tyerrs1<span class="keyword">,</span> tyerrs2<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">(</span>e1xpfix<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">fun</span> oftype_app <span class="keyword">(</span>Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> loc<span class="keyword">:</span> <span class="staexp">loc</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">e0xp</span><span class="keyword">,</span> args<span class="keyword">:</span> <span class="staexp">e0xp</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>e1xp<span class="keyword">,</span> tyerr_pool<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span>f<span class="keyword">,</span> tyerrs_f<span class="keyword">)</span> <span class="keyword">=</span> oftype <span class="keyword">(</span>Gamma<span class="keyword">,</span> f<span class="keyword">)</span>
  <span class="comment">(* do the normalization first *)</span>
  <span class="keyword">val</span> e1xp_fun <span class="keyword">=</span> t1yp_normalize <span class="keyword">(</span>f<span class="keyword">.</span>e1xp_typ<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> e1xp_fun <span class="keyword">of</span>
  <span class="keyword">|</span> T1YPfun <span class="keyword">(</span>_<span class="keyword">,</span> paras_typ<span class="keyword">,</span> ret_typ<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span>args<span class="keyword">,</span> tyerrs_args<span class="keyword">)</span> <span class="keyword">=</span> typcheck <span class="keyword">(</span>Gamma<span class="keyword">,</span> args<span class="keyword">,</span> paras_typ<span class="keyword">)</span>
    <span class="keyword">val</span> tyerrs <span class="keyword">=</span> tyerr_pool_append <span class="keyword">(</span>tyerrs_f<span class="keyword">,</span> tyerrs_args<span class="keyword">)</span>
    <span class="keyword">val</span> e1xp <span class="keyword">=</span> e1xp_make_app <span class="keyword">(</span>loc<span class="keyword">,</span> f<span class="keyword">,</span> args<span class="keyword">,</span> ret_typ<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span>e1xp<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> T1YPvar <span class="keyword">(</span>t1var<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr ": ============================\n"
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> prerr ": You should not see me.\n"
    <span class="keyword">val</span> <span class="keyword">(</span>args<span class="keyword">,</span> tyerrs_args<span class="keyword">)</span> <span class="keyword">=</span> oftype <span class="keyword">(</span>Gamma<span class="keyword">,</span> args<span class="keyword">)</span>
    <span class="keyword">val</span> tyerrs <span class="keyword">=</span> tyerr_pool_append <span class="keyword">(</span>tyerrs_f<span class="keyword">,</span> tyerrs_args<span class="keyword">)</span>
    <span class="keyword">val</span> ret_typ <span class="keyword">=</span> T1YPvar <span class="keyword">(</span>t1Var_new <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">val</span> ty_fun <span class="keyword">=</span> T1YPfun <span class="keyword">(</span>ref_make_elt&lt;<span class="staexp">int</span><span class="keyword">&gt;</span> <span class="keyword">(</span>~1<span class="keyword">)</span><span class="keyword">,</span> args<span class="keyword">.</span>e1xp_typ<span class="keyword">,</span> ret_typ<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> t1Var_set_typ <span class="keyword">(</span>t1var<span class="keyword">,</span> ty_fun<span class="keyword">)</span>
    <span class="keyword">val</span> e1xp <span class="keyword">=</span> e1xp_make_app <span class="keyword">(</span>loc<span class="keyword">,</span> f<span class="keyword">,</span> args<span class="keyword">,</span> ret_typ<span class="keyword">)</span>
    <span class="comment">// val _ = t1yp_normalize (f.e1xp_typ)  unnecessary, let others do this
</span>  <span class="keyword">in</span>
    <span class="keyword">(</span>e1xp<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="comment">// val () = prerr_loc (loc)
</span>    <span class="comment">// val () = prerr ": error(type) ... expected a function type"
</span>    <span class="comment">// val () = prerr " ... actual: "
</span>    <span class="comment">// val () = fprint_t1yp (stderr_ref, f.e1xp_typ)
</span>    <span class="comment">// val () = prerr_newline ()
</span>    <span class="keyword">val</span> errmsg <span class="keyword">=</span> "function type needed" + <span class="keyword">(</span>"... actual is "<span class="keyword">:</span> <span class="staexp">string</span><span class="keyword">)</span>
    <span class="keyword">val</span> errmsg <span class="keyword">=</span> errmsg + <span class="keyword">(</span>tostring_t1yp e1xp_fun<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="comment">(* return f as the result as app *)</span>
    <span class="keyword">(</span>f<span class="keyword">,</span> tyerr_pool_add_tail <span class="keyword">(</span>tyerrs_f<span class="keyword">,</span> loc<span class="keyword">,</span> errmsg<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
  
<span class="keyword">implement</span> oftype <span class="keyword">(</span>Gamma<span class="keyword">,</span> e0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> e0_node <span class="keyword">=</span> e0<span class="keyword">.</span>e0xp_node
  <span class="keyword">val</span> e0_loc <span class="keyword">=</span> e0<span class="keyword">.</span>e0xp_loc
<span class="keyword">in</span>
  <span class="keyword">case+</span> e0_node <span class="keyword">of</span>
  <span class="keyword">|</span> E0XPann <span class="keyword">(</span>e0a<span class="keyword">,</span> t0a<span class="keyword">)</span> <span class="keyword">=&gt;</span> oftype_ann <span class="keyword">(</span>Gamma<span class="keyword">,</span> e0_loc<span class="keyword">,</span> e0a<span class="keyword">,</span> t0a<span class="keyword">)</span>
  <span class="keyword">|</span> E0XPapp <span class="keyword">(</span>e0fun<span class="keyword">,</span> e0args<span class="keyword">)</span> <span class="keyword">=&gt;</span> oftype_app <span class="keyword">(</span>Gamma<span class="keyword">,</span> e0_loc<span class="keyword">,</span> e0fun<span class="keyword">,</span> e0args<span class="keyword">)</span>
  <span class="keyword">|</span> E0XPbool <span class="keyword">(</span>b<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>e1xp_make_bool <span class="keyword">(</span>e0_loc<span class="keyword">,</span> b<span class="keyword">)</span><span class="keyword">,</span> tyerr_pool_nil<span class="keyword">)</span>
  <span class="keyword">|</span> E0XPfix <span class="keyword">(</span>f<span class="keyword">,</span> paras<span class="keyword">,</span> t0ypopt<span class="keyword">,</span> body<span class="keyword">)</span> <span class="keyword">=&gt;</span> oftype_fix <span class="keyword">(</span>Gamma<span class="keyword">,</span> e0_loc<span class="keyword">,</span> f<span class="keyword">,</span> paras<span class="keyword">,</span> t0ypopt<span class="keyword">,</span> body<span class="keyword">)</span>
  <span class="keyword">|</span> E0XPif <span class="keyword">(</span>e0_if<span class="keyword">,</span> e0_then<span class="keyword">,</span> e0opt_else<span class="keyword">)</span> <span class="keyword">=&gt;</span> 
    oftype_if <span class="keyword">(</span>Gamma<span class="keyword">,</span> e0_loc<span class="keyword">,</span> e0_if<span class="keyword">,</span> e0_then<span class="keyword">,</span> e0opt_else<span class="keyword">)</span>
  <span class="keyword">|</span> E0XPint <span class="keyword">(</span>i<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>e1xp_make_int <span class="keyword">(</span>e0_loc<span class="keyword">,</span> i<span class="keyword">)</span><span class="keyword">,</span> tyerr_pool_nil<span class="keyword">)</span>
  <span class="keyword">|</span> E0XPlam <span class="keyword">(</span>a0rgs<span class="keyword">,</span> t0ypopt<span class="keyword">,</span> e0xp<span class="keyword">)</span> <span class="keyword">=&gt;</span> oftype_lam <span class="keyword">(</span>Gamma<span class="keyword">,</span> e0_loc<span class="keyword">,</span> a0rgs<span class="keyword">,</span> t0ypopt<span class="keyword">,</span> e0xp<span class="keyword">)</span>
  <span class="keyword">|</span> E0XPlet <span class="keyword">(</span>d0eclst_local<span class="keyword">,</span> e0_body<span class="keyword">)</span> <span class="keyword">=&gt;</span> 
    oftype_let <span class="keyword">(</span>Gamma<span class="keyword">,</span> e0_loc<span class="keyword">,</span> d0eclst_local<span class="keyword">,</span> e0_body<span class="keyword">)</span>
  <span class="keyword">|</span> E0XPopr <span class="keyword">(</span>opr<span class="keyword">,</span> e0xps<span class="keyword">)</span> <span class="keyword">=&gt;</span> oftype_opr <span class="keyword">(</span>Gamma<span class="keyword">,</span> e0_loc<span class="keyword">,</span> opr<span class="keyword">,</span> e0xps<span class="keyword">)</span>
  <span class="keyword">|</span> E0XPproj <span class="keyword">(</span>e0xp<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">=&gt;</span> oftype_proj <span class="keyword">(</span>Gamma<span class="keyword">,</span> e0_loc<span class="keyword">,</span> e0xp<span class="keyword">,</span> i<span class="keyword">)</span>
  <span class="keyword">|</span> E0XPstr <span class="keyword">(</span>str<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>e1xp_make_str <span class="keyword">(</span>e0_loc<span class="keyword">,</span> str<span class="keyword">)</span><span class="keyword">,</span> tyerr_pool_nil<span class="keyword">)</span>
  <span class="keyword">|</span> E0XPtup <span class="keyword">(</span>e0xps<span class="keyword">)</span> <span class="keyword">=&gt;</span> oftype_tup <span class="keyword">(</span>Gamma<span class="keyword">,</span> e0_loc<span class="keyword">,</span> e0xps<span class="keyword">)</span>
  <span class="keyword">|</span> E0XPvar <span class="keyword">(</span>nam<span class="keyword">)</span> <span class="keyword">=&gt;</span> oftype_var <span class="keyword">(</span>Gamma<span class="keyword">,</span> e0_loc<span class="keyword">,</span> nam<span class="keyword">)</span>
  <span class="comment">// | _ =&gt; ETRACE_MSG_OPR ("oftype: error unexpected\n", ETRACE_LEVEL_ERROR, 
</span>  <span class="comment">//           abort (ERRORCODE_FORBIDDEN))
</span><span class="keyword">end</span>

<span class="comment">(* fun e0xp_node_is_fun (e_node: e0xp_node): option0 t1yp *)</span>
<span class="comment">(* take the type from the function definition *)</span>
<span class="keyword">implement</span> e0xp_node_is_fun <span class="keyword">(</span>e_node<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> e_node <span class="keyword">of</span>
  <span class="keyword">|</span> E0XPann <span class="keyword">(</span>e1<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> e0xp_node_is_fun <span class="keyword">(</span>e1<span class="keyword">.</span>e0xp_node<span class="keyword">)</span>
  <span class="keyword">|</span> E0XPfix <span class="keyword">(</span>_<span class="keyword">,</span> a0rgs<span class="keyword">,</span> t0ypopt<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> args <span class="keyword">=</span> list0_length <span class="keyword">(</span>a0rgs<span class="keyword">)</span>
    
    <span class="comment">// (ctx, v1arlst, t1yplst, tyerr_pool)
</span>    <span class="keyword">val</span> <span class="keyword">(</span>ctx<span class="keyword">,</span> _<span class="keyword">,</span> t1yps<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=</span> oftyp_arglst <span class="keyword">(</span>ctx_nil<span class="keyword">,</span> a0rgs<span class="keyword">)</span>  
    <span class="keyword">val</span> argst1yp <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">if</span> args <span class="keyword">=</span> 1 <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val-</span> cons <span class="keyword">(</span>t1yp<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=</span> t1yps <span class="keyword">in</span> t1yp <span class="keyword">end</span>
      <span class="keyword">else</span> T1YPtup t1yps<span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">t1yp</span>
      
    <span class="keyword">val</span> rett1yp <span class="keyword">=</span> <span class="keyword">case+</span> t0ypopt <span class="keyword">of</span>
    <span class="keyword">|</span> Some0 t0yp <span class="keyword">=&gt;</span> trans1_typ <span class="keyword">(</span>t0yp<span class="keyword">)</span>
    <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> T1YPvar <span class="keyword">(</span>t1Var_new <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">val</span> fixt1yp <span class="keyword">=</span> T1YPfun <span class="keyword">(</span>ref_make_elt&lt;<span class="staexp">int</span><span class="keyword">&gt;</span> <span class="keyword">(</span>args<span class="keyword">)</span><span class="keyword">,</span> argst1yp<span class="keyword">,</span> rett1yp<span class="keyword">)</span>
  <span class="keyword">in</span>
    Some0 fixt1yp
  <span class="keyword">end</span>
  <span class="keyword">|</span> E0XPlam <span class="keyword">(</span>a0rgs<span class="keyword">,</span> t0ypopt<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> args <span class="keyword">=</span> list0_length <span class="keyword">(</span>a0rgs<span class="keyword">)</span>
    
    <span class="comment">// (ctx, v1arlst, t1yplst, tyerr_pool)
</span>    <span class="keyword">val</span> <span class="keyword">(</span>ctx<span class="keyword">,</span> _<span class="keyword">,</span> t1yps<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=</span> oftyp_arglst <span class="keyword">(</span>ctx_nil<span class="keyword">,</span> a0rgs<span class="keyword">)</span>  
    <span class="keyword">val</span> argst1yp <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">if</span> args <span class="keyword">=</span> 1 <span class="keyword">then</span> <span class="keyword">let</span>
        <span class="keyword">val-</span> cons <span class="keyword">(</span>t1yp<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=</span> t1yps <span class="keyword">in</span> t1yp <span class="keyword">end</span>
      <span class="keyword">else</span> T1YPtup t1yps<span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">t1yp</span>
      
    <span class="keyword">val</span> rett1yp <span class="keyword">=</span> <span class="keyword">case+</span> t0ypopt <span class="keyword">of</span>
    <span class="keyword">|</span> Some0 t0yp <span class="keyword">=&gt;</span> trans1_typ <span class="keyword">(</span>t0yp<span class="keyword">)</span>
    <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> T1YPvar <span class="keyword">(</span>t1Var_new <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">val</span> lamt1yp <span class="keyword">=</span> T1YPfun <span class="keyword">(</span>ref_make_elt&lt;<span class="staexp">int</span><span class="keyword">&gt;</span> <span class="keyword">(</span>args<span class="keyword">)</span><span class="keyword">,</span> argst1yp<span class="keyword">,</span> rett1yp<span class="keyword">)</span>
  <span class="keyword">in</span>
    Some0 lamt1yp
  <span class="keyword">end</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> None0

<span class="comment">(* fun e1xp_node_is_fun (e_node: e1xp_node): bool *)</span>
<span class="keyword">implement</span> e1xp_node_is_fun <span class="keyword">(</span>e_node<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> e_node <span class="keyword">of</span>
  <span class="keyword">|</span> E1XPann <span class="keyword">(</span>e1<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> e1xp_node_is_fun <span class="keyword">(</span>e1<span class="keyword">.</span>e1xp_node<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPfix <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> true
  <span class="keyword">|</span> E1XPlam <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> true
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> false

<span class="keyword">implement</span> typcheck <span class="keyword">(</span>Gamma<span class="keyword">,</span> e0<span class="keyword">,</span> t1<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span>e1<span class="keyword">,</span> tyerrs<span class="keyword">)</span> <span class="keyword">=</span> oftype <span class="keyword">(</span>Gamma<span class="keyword">,</span> e0<span class="keyword">)</span>

  <span class="comment">// val () = fprint (stderr_ref, "=============typcheck@")
</span>  <span class="comment">// val () = prerr_loc (e1.e1xp_loc)
</span>  <span class="comment">// val () = prerr " ... expected: "
</span>  <span class="comment">// val () = fprint_t1yp (stderr_ref, t1)
</span>  <span class="comment">// val () = prerr " ... actual: "
</span>  <span class="comment">// val () = fprint_t1yp (stderr_ref, e1.e1xp_typ)
</span>  <span class="comment">// val () = prerr_newline ()
</span>  
  <span class="keyword">val</span> <span class="keyword">(</span>ty_cmp<span class="keyword">,</span> tyerrs<span class="keyword">)</span> <span class="keyword">=</span> match_t1yp_t1yp <span class="keyword">(</span>e1<span class="keyword">.</span>e1xp_typ<span class="keyword">,</span> t1<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">if</span> ty_cmp <span class="keyword">=</span> true <span class="keyword">then</span> <span class="keyword">(</span>e1<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
  <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="comment">// val () = prerr_loc (e1.e1xp_loc)
</span>    <span class="comment">// val () = prerr ": error(type) ... expected: "
</span>    <span class="comment">// val () = fprint_t1yp (stderr_ref, t1)
</span>    <span class="comment">// val () = prerr " ... actual: "
</span>    <span class="comment">// val () = fprint_t1yp (stderr_ref, e1.e1xp_typ)
</span>    <span class="comment">// val () = prerr_newline ()
</span>    <span class="keyword">val</span> errmsg <span class="keyword">=</span> trans1_build_err <span class="keyword">(</span>e1<span class="keyword">.</span>e1xp_typ<span class="keyword">,</span> t1<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span>e1<span class="keyword">,</span> tyerr_pool_add_tail <span class="keyword">(</span>tyerrs<span class="keyword">,</span> e1<span class="keyword">.</span>e1xp_loc<span class="keyword">,</span> errmsg<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">implement</span> trans1_exp <span class="keyword">(</span>e0xp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span>e1xp<span class="keyword">,</span> tyerrs<span class="keyword">)</span> <span class="keyword">=</span> oftype <span class="keyword">(</span>ctx_nil<span class="keyword">,</span> e0xp<span class="keyword">)</span>
  <span class="keyword">val</span> sz <span class="keyword">=</span> tyerr_pool_size <span class="keyword">(</span>tyerrs<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint_tyerr_pool <span class="keyword">(</span>stderr_ref<span class="keyword">,</span> tyerrs<span class="keyword">)</span>
  <span class="comment">// todo check whether there is error
</span><span class="keyword">in</span>
  e1xp
<span class="keyword">end</span>


</pre>
</body>
</html>
