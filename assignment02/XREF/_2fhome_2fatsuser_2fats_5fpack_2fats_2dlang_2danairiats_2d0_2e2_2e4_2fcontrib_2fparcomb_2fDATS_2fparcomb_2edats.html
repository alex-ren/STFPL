<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    .atsyntax {color:#E80000;background-color:#E0E0E0}
    .atsyntax span.comment {color:#787878;font-style:italic}
    .atsyntax span.extern  {color:#A52A2A}
    .atsyntax span.keyword {color:#000000;font-weight:bold}
    .atsyntax span.neuexp  {color:#800080}
    .atsyntax span.staexp  {color:#0000FF}
    .atsyntax span.dynexp  {color:#E80000}
    .atsyntax span.prfexp  {color:#009000}
    .atsyntax span.stacstdec  {text-decoration:none}
    .atsyntax span.stacstuse  {color:#0000CF;text-decoration:underline}
    .atsyntax span.dyncstdec  {text-decoration:none}
    .atsyntax span.dyncstimp  {color:#B80000;text-decoration:underline}
    .atsyntax span.dyncstuse  {color:#B80000;text-decoration:underline}
    body {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre class="atsyntax">
<span class="comment">(***********************************************************************)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                         Applied Type System                         *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                              Hongwei Xi                             *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(***********************************************************************)</span>

<span class="comment">(*
** ATS - Unleashing the Potential of Types!
**
** Copyright (C) 2002-2008 Hongwei Xi, Boston University
**
** All rights reserved
**
** ATS is free software;  you can  redistribute it and/or modify it under
** the terms of the GNU LESSER GENERAL PUBLIC LICENSE as published by the
** Free Software Foundation; either version 2.1, or (at your option)  any
** later version.
** 
** ATS is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without  even  the  implied  warranty  of MERCHANTABILITY or
** FITNESS FOR A PARTICULAR PURPOSE.  See the  GNU General Public License
** for more details.
** 
** You  should  have  received  a  copy of the GNU General Public License
** along  with  ATS;  see the  file COPYING.  If not, please write to the
** Free Software Foundation,  51 Franklin Street, Fifth Floor, Boston, MA
** 02110-1301, USA.
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* author: Hongwei Xi (hwxi AT cs DOT bu DOT edu) *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"contrib/parcomb/SATS/parcomb.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">Okay Some_vt</span>
<span class="keyword">#define</span> <span class="neuexp">Fail None_vt</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
stream_get_item <span class="keyword">(</span>tks<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> <span class="keyword">!</span>tks <span class="keyword">of</span>
  <span class="keyword">|</span> stream_cons <span class="keyword">(</span>tk1<span class="keyword">,</span> tks1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>tks := tks1<span class="keyword">;</span> Some_vt tk1<span class="keyword">)</span>
  <span class="keyword">|</span> stream_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">// end of [stream_get_item]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">assume</span> <span class="staexp">parser_t <span class="keyword">=</span> <span class="comment">// no [ref] effect!
</span>  <span class="keyword">lam</span> <span class="keyword">(</span>a<span class="keyword">:</span>t@ype<span class="keyword">,</span> t<span class="keyword">:</span>t@ype<span class="keyword">)</span> <span class="keyword">=&gt;</span>
    <span class="keyword">(</span><span class="keyword">&amp;</span>stream t<span class="keyword">,</span> <span class="keyword">&amp;</span>int<span class="keyword">,</span> <span class="keyword">&amp;</span>int<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">,</span><span class="keyword">!</span>laz<span class="keyword">&gt;</span> Option_vt a</span>
<span class="comment">// end of [parser_t]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
apply_parser <span class="keyword">(</span>p<span class="keyword">,</span> tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=</span> p <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span>
lzeta <span class="keyword">(</span>p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">!</span>p <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
return_parser <span class="keyword">(</span>x<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> Okay <span class="keyword">(</span>x<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
alt_parser_parser
  <span class="keyword">(</span>p1<span class="keyword">,</span> p2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> tks0 <span class="keyword">=</span> tks
  <span class="keyword">val</span> ncur0 <span class="keyword">=</span> ncur
  <span class="keyword">val</span> r1 <span class="keyword">=</span> p1 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> r1 <span class="keyword">of</span>
  <span class="keyword">|</span> Okay _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r1<span class="keyword">;</span> r1<span class="keyword">)</span> <span class="keyword">|</span> <span class="keyword">~</span>Fail _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> tks := tks0 <span class="keyword">and</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ncur := ncur0
    <span class="keyword">in</span>
      p2 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">(* end of [Fail] *)</span>
<span class="keyword">end</span> <span class="comment">// end of [alt_parser_parser]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
seq_parser_parser
  <span class="keyword">(</span>p1<span class="keyword">,</span> p2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> r1 <span class="keyword">=</span> p1 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r1 <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Okay v1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> r2 <span class="keyword">=</span> p2 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r2 <span class="keyword">of</span>
      <span class="keyword">|</span> <span class="keyword">~</span>Okay v2 <span class="keyword">=&gt;</span> Okay <span class="keyword">@(</span>v1<span class="keyword">,</span> v2<span class="keyword">)</span> <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r2<span class="keyword">;</span> r2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>  <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r1<span class="keyword">;</span> r1<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [seq_parser_parser]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">,</span><span class="staexp">b</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
seq1wth_parser_fun
  <span class="keyword">(</span>p<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> r <span class="keyword">=</span> p <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Okay v <span class="keyword">=&gt;</span> Okay <span class="keyword">(</span>f v<span class="keyword">)</span> <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r<span class="keyword">;</span> r<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [seq1wth_parser_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">,</span><span class="staexp">b</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
seq1wth_parser_cloref
  <span class="keyword">(</span>p<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> r <span class="keyword">=</span> p <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Okay v <span class="keyword">=&gt;</span> Okay <span class="keyword">(</span>f v<span class="keyword">)</span> <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r<span class="keyword">;</span> r<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [seq1wth_parser_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">,</span><span class="staexp">b</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
seq2wth_parser_fun
  <span class="keyword">(</span>p1<span class="keyword">,</span> p2<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> r1 <span class="keyword">=</span> p1 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r1 <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Okay v1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> r2 <span class="keyword">=</span> p2 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r2 <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Okay v2 <span class="keyword">=&gt;</span> Okay <span class="keyword">(</span>f <span class="keyword">(</span>v1<span class="keyword">,</span> v2<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r2<span class="keyword">;</span> r2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>  <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r1<span class="keyword">;</span> r1<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [seq2wth_parser_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">,</span><span class="staexp">b</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
seq2wth_parser_cloref
  <span class="keyword">(</span>p1<span class="keyword">,</span> p2<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> r1 <span class="keyword">=</span> p1 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r1 <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Okay v1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> r2 <span class="keyword">=</span> p2 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r2 <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Okay v2 <span class="keyword">=&gt;</span> Okay <span class="keyword">(</span>f <span class="keyword">(</span>v1<span class="keyword">,</span> v2<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r2<span class="keyword">;</span> r2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>  <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r1<span class="keyword">;</span> r1<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [seq2wth_parser_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">,</span><span class="staexp">a3</span><span class="keyword">,</span><span class="staexp">b</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
seq3wth_parser_fun
  <span class="keyword">(</span>p1<span class="keyword">,</span> p2<span class="keyword">,</span> p3<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> r1 <span class="keyword">=</span> p1 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r1 <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Okay v1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> r2 <span class="keyword">=</span> p2 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r2 <span class="keyword">of</span>
      <span class="keyword">|</span> <span class="keyword">~</span>Okay v2 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> r3 <span class="keyword">=</span> p3 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r3 <span class="keyword">of</span>
          <span class="keyword">|</span> <span class="keyword">~</span>Okay v3 <span class="keyword">=&gt;</span> Okay <span class="keyword">(</span>f <span class="keyword">(</span>v1<span class="keyword">,</span> v2<span class="keyword">,</span> v3<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r3<span class="keyword">;</span> r3<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>      <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r2<span class="keyword">;</span> r2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>  <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r1<span class="keyword">;</span> r1<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [seq3wth_parser_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">,</span><span class="staexp">a3</span><span class="keyword">,</span><span class="staexp">b</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
seq3wth_parser_cloref
  <span class="keyword">(</span>p1<span class="keyword">,</span> p2<span class="keyword">,</span> p3<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> r1 <span class="keyword">=</span> p1 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r1 <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Okay v1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> r2 <span class="keyword">=</span> p2 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r2 <span class="keyword">of</span>
      <span class="keyword">|</span> <span class="keyword">~</span>Okay v2 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> r3 <span class="keyword">=</span> p3 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r3 <span class="keyword">of</span>
          <span class="keyword">|</span> <span class="keyword">~</span>Okay v3 <span class="keyword">=&gt;</span> Okay <span class="keyword">(</span>f <span class="keyword">(</span>v1<span class="keyword">,</span> v2<span class="keyword">,</span> v3<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r3<span class="keyword">;</span> r3<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>      <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r2<span class="keyword">;</span> r2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>  <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r1<span class="keyword">;</span> r1<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [seq3wth_parser_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">,</span><span class="staexp">a3</span><span class="keyword">,</span><span class="staexp">a4</span><span class="keyword">,</span><span class="staexp">b</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
seq4wth_parser_fun
  <span class="keyword">(</span>p1<span class="keyword">,</span> p2<span class="keyword">,</span> p3<span class="keyword">,</span> p4<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> r1 <span class="keyword">=</span> p1 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r1 <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Okay v1 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r2 <span class="keyword">=</span> p2 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r2 <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Okay v2 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r3 <span class="keyword">=</span> p3 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r3 <span class="keyword">of</span>
      <span class="keyword">|</span> <span class="keyword">~</span>Okay v3 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r4 <span class="keyword">=</span> p4 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r4 <span class="keyword">of</span>
        <span class="keyword">|</span> <span class="keyword">~</span>Okay v4 <span class="keyword">=&gt;</span> Okay <span class="keyword">(</span>f <span class="keyword">(</span>v1<span class="keyword">,</span> v2<span class="keyword">,</span> v3<span class="keyword">,</span> v4<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r4<span class="keyword">;</span> r4<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>      <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r3<span class="keyword">;</span> r3<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>    <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r2<span class="keyword">;</span> r2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>  <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r1<span class="keyword">;</span> r1<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [seq4wth_parser_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">,</span><span class="staexp">a3</span><span class="keyword">,</span><span class="staexp">a4</span><span class="keyword">,</span><span class="staexp">b</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
seq4wth_parser_cloref
  <span class="keyword">(</span>p1<span class="keyword">,</span> p2<span class="keyword">,</span> p3<span class="keyword">,</span> p4<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> r1 <span class="keyword">=</span> p1 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r1 <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Okay v1 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r2 <span class="keyword">=</span> p2 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r2 <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Okay v2 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r3 <span class="keyword">=</span> p3 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r3 <span class="keyword">of</span>
      <span class="keyword">|</span> <span class="keyword">~</span>Okay v3 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r4 <span class="keyword">=</span> p4 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r4 <span class="keyword">of</span>
        <span class="keyword">|</span> <span class="keyword">~</span>Okay v4 <span class="keyword">=&gt;</span> Okay <span class="keyword">(</span>f <span class="keyword">(</span>v1<span class="keyword">,</span> v2<span class="keyword">,</span> v3<span class="keyword">,</span> v4<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r4<span class="keyword">;</span> r4<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>      <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r3<span class="keyword">;</span> r3<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>    <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r2<span class="keyword">;</span> r2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>  <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r1<span class="keyword">;</span> r1<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [seq4wth_parser_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">,</span><span class="staexp">a3</span><span class="keyword">,</span><span class="staexp">a4</span><span class="keyword">,</span><span class="staexp">a5</span><span class="keyword">,</span><span class="staexp">b</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
seq5wth_parser_fun
  <span class="keyword">(</span>p1<span class="keyword">,</span> p2<span class="keyword">,</span> p3<span class="keyword">,</span> p4<span class="keyword">,</span> p5<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> r1 <span class="keyword">=</span> p1 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r1 <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Okay v1 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r2 <span class="keyword">=</span> p2 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r2 <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Okay v2 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r3 <span class="keyword">=</span> p3 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r3 <span class="keyword">of</span>
      <span class="keyword">|</span> <span class="keyword">~</span>Okay v3 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r4 <span class="keyword">=</span> p4 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r4 <span class="keyword">of</span>
        <span class="keyword">|</span> <span class="keyword">~</span>Okay v4 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r5 <span class="keyword">=</span> p5 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r5 <span class="keyword">of</span>
          <span class="keyword">|</span> <span class="keyword">~</span>Okay v5 <span class="keyword">=&gt;</span> Okay <span class="keyword">(</span>f <span class="keyword">(</span>v1<span class="keyword">,</span> v2<span class="keyword">,</span> v3<span class="keyword">,</span> v4<span class="keyword">,</span> v5<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r5<span class="keyword">;</span> r5<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>        <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r4<span class="keyword">;</span> r4<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>      <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r3<span class="keyword">;</span> r3<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>    <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r2<span class="keyword">;</span> r2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>  <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r1<span class="keyword">;</span> r1<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [seq5wth_parser_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">,</span><span class="staexp">a3</span><span class="keyword">,</span><span class="staexp">a4</span><span class="keyword">,</span><span class="staexp">a5</span><span class="keyword">,</span><span class="staexp">b</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
seq5wth_parser_cloref
  <span class="keyword">(</span>p1<span class="keyword">,</span> p2<span class="keyword">,</span> p3<span class="keyword">,</span> p4<span class="keyword">,</span> p5<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> r1 <span class="keyword">=</span> p1 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r1 <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Okay v1 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r2 <span class="keyword">=</span> p2 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r2 <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Okay v2 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r3 <span class="keyword">=</span> p3 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r3 <span class="keyword">of</span>
      <span class="keyword">|</span> <span class="keyword">~</span>Okay v3 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r4 <span class="keyword">=</span> p4 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r4 <span class="keyword">of</span>
        <span class="keyword">|</span> <span class="keyword">~</span>Okay v4 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r5 <span class="keyword">=</span> p5 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r5 <span class="keyword">of</span>
          <span class="keyword">|</span> <span class="keyword">~</span>Okay v5 <span class="keyword">=&gt;</span> Okay <span class="keyword">(</span>f <span class="keyword">(</span>v1<span class="keyword">,</span> v2<span class="keyword">,</span> v3<span class="keyword">,</span> v4<span class="keyword">,</span> v5<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r5<span class="keyword">;</span> r5<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>        <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r4<span class="keyword">;</span> r4<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>      <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r3<span class="keyword">;</span> r3<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>    <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r2<span class="keyword">;</span> r2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>  <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r1<span class="keyword">;</span> r1<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [seq5wth_parser_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">,</span><span class="staexp">a3</span><span class="keyword">,</span><span class="staexp">a4</span><span class="keyword">,</span><span class="staexp">a5</span><span class="keyword">,</span><span class="staexp">a6</span><span class="keyword">,</span><span class="staexp">b</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
seq6wth_parser_fun
  <span class="keyword">(</span>p1<span class="keyword">,</span> p2<span class="keyword">,</span> p3<span class="keyword">,</span> p4<span class="keyword">,</span> p5<span class="keyword">,</span> p6<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> r1 <span class="keyword">=</span> p1 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r1 <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Okay v1 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r2 <span class="keyword">=</span> p2 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r2 <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Okay v2 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r3 <span class="keyword">=</span> p3 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r3 <span class="keyword">of</span>
      <span class="keyword">|</span> <span class="keyword">~</span>Okay v3 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r4 <span class="keyword">=</span> p4 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r4 <span class="keyword">of</span>
        <span class="keyword">|</span> <span class="keyword">~</span>Okay v4 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r5 <span class="keyword">=</span> p5 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r5 <span class="keyword">of</span>
          <span class="keyword">|</span> <span class="keyword">~</span>Okay v5 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r6 <span class="keyword">=</span> p6 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r6 <span class="keyword">of</span>
            <span class="keyword">|</span> <span class="keyword">~</span>Okay v6 <span class="keyword">=&gt;</span> Okay <span class="keyword">(</span>f <span class="keyword">(</span>v1<span class="keyword">,</span> v2<span class="keyword">,</span> v3<span class="keyword">,</span> v4<span class="keyword">,</span> v5<span class="keyword">,</span> v6<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r6<span class="keyword">;</span> r6<span class="keyword">)</span>
            <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>          <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r5<span class="keyword">;</span> r5<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>        <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r4<span class="keyword">;</span> r4<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>      <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r3<span class="keyword">;</span> r3<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>    <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r2<span class="keyword">;</span> r2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>  <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r1<span class="keyword">;</span> r1<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [seq6wth_parser_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">,</span><span class="staexp">a3</span><span class="keyword">,</span><span class="staexp">a4</span><span class="keyword">,</span><span class="staexp">a5</span><span class="keyword">,</span><span class="staexp">a6</span><span class="keyword">,</span><span class="staexp">b</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
seq6wth_parser_cloref
  <span class="keyword">(</span>p1<span class="keyword">,</span> p2<span class="keyword">,</span> p3<span class="keyword">,</span> p4<span class="keyword">,</span> p5<span class="keyword">,</span> p6<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> r1 <span class="keyword">=</span> p1 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r1 <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Okay v1 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r2 <span class="keyword">=</span> p2 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r2 <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Okay v2 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r3 <span class="keyword">=</span> p3 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r3 <span class="keyword">of</span>
      <span class="keyword">|</span> <span class="keyword">~</span>Okay v3 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r4 <span class="keyword">=</span> p4 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r4 <span class="keyword">of</span>
        <span class="keyword">|</span> <span class="keyword">~</span>Okay v4 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r5 <span class="keyword">=</span> p5 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r5 <span class="keyword">of</span>
          <span class="keyword">|</span> <span class="keyword">~</span>Okay v5 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r6 <span class="keyword">=</span> p6 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r6 <span class="keyword">of</span>
            <span class="keyword">|</span> <span class="keyword">~</span>Okay v6 <span class="keyword">=&gt;</span> Okay <span class="keyword">(</span>f <span class="keyword">(</span>v1<span class="keyword">,</span> v2<span class="keyword">,</span> v3<span class="keyword">,</span> v4<span class="keyword">,</span> v5<span class="keyword">,</span> v6<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r6<span class="keyword">;</span> r6<span class="keyword">)</span>
            <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>          <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r5<span class="keyword">;</span> r5<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>        <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r4<span class="keyword">;</span> r4<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>      <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r3<span class="keyword">;</span> r3<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>    <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r2<span class="keyword">;</span> r2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>  <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r1<span class="keyword">;</span> r1<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [seq6wth_parser_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">,</span><span class="staexp">a3</span><span class="keyword">,</span><span class="staexp">a4</span><span class="keyword">,</span><span class="staexp">a5</span><span class="keyword">,</span><span class="staexp">a6</span><span class="keyword">,</span><span class="staexp">a7</span><span class="keyword">,</span><span class="staexp">b</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
seq7wth_parser_fun
  <span class="keyword">(</span>p1<span class="keyword">,</span> p2<span class="keyword">,</span> p3<span class="keyword">,</span> p4<span class="keyword">,</span> p5<span class="keyword">,</span> p6<span class="keyword">,</span> p7<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> r1 <span class="keyword">=</span> p1 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r1 <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Okay v1 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r2 <span class="keyword">=</span> p2 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r2 <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Okay v2 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r3 <span class="keyword">=</span> p3 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r3 <span class="keyword">of</span>
      <span class="keyword">|</span> <span class="keyword">~</span>Okay v3 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r4 <span class="keyword">=</span> p4 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r4 <span class="keyword">of</span>
        <span class="keyword">|</span> <span class="keyword">~</span>Okay v4 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r5 <span class="keyword">=</span> p5 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r5 <span class="keyword">of</span>
          <span class="keyword">|</span> <span class="keyword">~</span>Okay v5 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r6 <span class="keyword">=</span> p6 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r6 <span class="keyword">of</span>
            <span class="keyword">|</span> <span class="keyword">~</span>Okay v6 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r7 <span class="keyword">=</span> p7 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r7 <span class="keyword">of</span>
               <span class="keyword">|</span> <span class="keyword">~</span>Okay v7 <span class="keyword">=&gt;</span> Okay <span class="keyword">(</span>f <span class="keyword">(</span>v1<span class="keyword">,</span> v2<span class="keyword">,</span> v3<span class="keyword">,</span> v4<span class="keyword">,</span> v5<span class="keyword">,</span> v6<span class="keyword">,</span> v7<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r7<span class="keyword">;</span> r7<span class="keyword">)</span>
               <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>            <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r6<span class="keyword">;</span> r6<span class="keyword">)</span>
            <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>          <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r5<span class="keyword">;</span> r5<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>        <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r4<span class="keyword">;</span> r4<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>      <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r3<span class="keyword">;</span> r3<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>    <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r2<span class="keyword">;</span> r2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>  <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r1<span class="keyword">;</span> r1<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [seq7wth_parser_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">,</span><span class="staexp">a3</span><span class="keyword">,</span><span class="staexp">a4</span><span class="keyword">,</span><span class="staexp">a5</span><span class="keyword">,</span><span class="staexp">a6</span><span class="keyword">,</span><span class="staexp">a7</span><span class="keyword">,</span><span class="staexp">b</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
seq7wth_parser_cloref
  <span class="keyword">(</span>p1<span class="keyword">,</span> p2<span class="keyword">,</span> p3<span class="keyword">,</span> p4<span class="keyword">,</span> p5<span class="keyword">,</span> p6<span class="keyword">,</span> p7<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> r1 <span class="keyword">=</span> p1 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r1 <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Okay v1 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r2 <span class="keyword">=</span> p2 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r2 <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Okay v2 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r3 <span class="keyword">=</span> p3 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r3 <span class="keyword">of</span>
      <span class="keyword">|</span> <span class="keyword">~</span>Okay v3 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r4 <span class="keyword">=</span> p4 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r4 <span class="keyword">of</span>
        <span class="keyword">|</span> <span class="keyword">~</span>Okay v4 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r5 <span class="keyword">=</span> p5 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r5 <span class="keyword">of</span>
          <span class="keyword">|</span> <span class="keyword">~</span>Okay v5 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r6 <span class="keyword">=</span> p6 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r6 <span class="keyword">of</span>
            <span class="keyword">|</span> <span class="keyword">~</span>Okay v6 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r7 <span class="keyword">=</span> p7 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r7 <span class="keyword">of</span>
               <span class="keyword">|</span> <span class="keyword">~</span>Okay v7 <span class="keyword">=&gt;</span> Okay <span class="keyword">(</span>f <span class="keyword">(</span>v1<span class="keyword">,</span> v2<span class="keyword">,</span> v3<span class="keyword">,</span> v4<span class="keyword">,</span> v5<span class="keyword">,</span> v6<span class="keyword">,</span> v7<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r7<span class="keyword">;</span> r7<span class="keyword">)</span>
               <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>            <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r6<span class="keyword">;</span> r6<span class="keyword">)</span>
            <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>          <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r5<span class="keyword">;</span> r5<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>        <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r4<span class="keyword">;</span> r4<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>      <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r3<span class="keyword">;</span> r3<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>    <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r2<span class="keyword">;</span> r2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>  <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r1<span class="keyword">;</span> r1<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [seq7wth_parser_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">,</span><span class="staexp">a3</span><span class="keyword">,</span><span class="staexp">a4</span><span class="keyword">,</span><span class="staexp">a5</span><span class="keyword">,</span><span class="staexp">a6</span><span class="keyword">,</span><span class="staexp">a7</span><span class="keyword">,</span><span class="staexp">a8</span><span class="keyword">,</span><span class="staexp">b</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
seq8wth_parser_fun
  <span class="keyword">(</span>p1<span class="keyword">,</span> p2<span class="keyword">,</span> p3<span class="keyword">,</span> p4<span class="keyword">,</span> p5<span class="keyword">,</span> p6<span class="keyword">,</span> p7<span class="keyword">,</span> p8<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> r1 <span class="keyword">=</span> p1 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r1 <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Okay v1 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r2 <span class="keyword">=</span> p2 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r2 <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Okay v2 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r3 <span class="keyword">=</span> p3 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r3 <span class="keyword">of</span>
      <span class="keyword">|</span> <span class="keyword">~</span>Okay v3 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r4 <span class="keyword">=</span> p4 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r4 <span class="keyword">of</span>
        <span class="keyword">|</span> <span class="keyword">~</span>Okay v4 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r5 <span class="keyword">=</span> p5 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r5 <span class="keyword">of</span>
          <span class="keyword">|</span> <span class="keyword">~</span>Okay v5 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r6 <span class="keyword">=</span> p6 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r6 <span class="keyword">of</span>
            <span class="keyword">|</span> <span class="keyword">~</span>Okay v6 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r7 <span class="keyword">=</span> p7 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r7 <span class="keyword">of</span>
               <span class="keyword">|</span> <span class="keyword">~</span>Okay v7 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r8 <span class="keyword">=</span> p8 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r8 <span class="keyword">of</span>
                 <span class="keyword">|</span> <span class="keyword">~</span>Okay v8 <span class="keyword">=&gt;</span> Okay <span class="keyword">(</span>f <span class="keyword">(</span>v1<span class="keyword">,</span> v2<span class="keyword">,</span> v3<span class="keyword">,</span> v4<span class="keyword">,</span> v5<span class="keyword">,</span> v6<span class="keyword">,</span> v7<span class="keyword">,</span> v8<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r8<span class="keyword">;</span> r8<span class="keyword">)</span>
                 <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>               <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r7<span class="keyword">;</span> r7<span class="keyword">)</span>
               <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>            <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r6<span class="keyword">;</span> r6<span class="keyword">)</span>
            <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>          <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r5<span class="keyword">;</span> r5<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>        <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r4<span class="keyword">;</span> r4<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>      <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r3<span class="keyword">;</span> r3<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>    <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r2<span class="keyword">;</span> r2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>  <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r1<span class="keyword">;</span> r1<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [seq8wth_parser_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">,</span><span class="staexp">a3</span><span class="keyword">,</span><span class="staexp">a4</span><span class="keyword">,</span><span class="staexp">a5</span><span class="keyword">,</span><span class="staexp">a6</span><span class="keyword">,</span><span class="staexp">a7</span><span class="keyword">,</span><span class="staexp">a8</span><span class="keyword">,</span><span class="staexp">b</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
seq8wth_parser_cloref
  <span class="keyword">(</span>p1<span class="keyword">,</span> p2<span class="keyword">,</span> p3<span class="keyword">,</span> p4<span class="keyword">,</span> p5<span class="keyword">,</span> p6<span class="keyword">,</span> p7<span class="keyword">,</span> p8<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> r1 <span class="keyword">=</span> p1 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r1 <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Okay v1 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r2 <span class="keyword">=</span> p2 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r2 <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Okay v2 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r3 <span class="keyword">=</span> p3 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r3 <span class="keyword">of</span>
      <span class="keyword">|</span> <span class="keyword">~</span>Okay v3 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r4 <span class="keyword">=</span> p4 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r4 <span class="keyword">of</span>
        <span class="keyword">|</span> <span class="keyword">~</span>Okay v4 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r5 <span class="keyword">=</span> p5 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r5 <span class="keyword">of</span>
          <span class="keyword">|</span> <span class="keyword">~</span>Okay v5 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r6 <span class="keyword">=</span> p6 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r6 <span class="keyword">of</span>
            <span class="keyword">|</span> <span class="keyword">~</span>Okay v6 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r7 <span class="keyword">=</span> p7 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r7 <span class="keyword">of</span>
               <span class="keyword">|</span> <span class="keyword">~</span>Okay v7 <span class="keyword">=&gt;</span> <span class="keyword">let</span> <span class="keyword">val</span> r8 <span class="keyword">=</span> p8 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r8 <span class="keyword">of</span>
                 <span class="keyword">|</span> <span class="keyword">~</span>Okay v8 <span class="keyword">=&gt;</span> Okay <span class="keyword">(</span>f <span class="keyword">(</span>v1<span class="keyword">,</span> v2<span class="keyword">,</span> v3<span class="keyword">,</span> v4<span class="keyword">,</span> v5<span class="keyword">,</span> v6<span class="keyword">,</span> v7<span class="keyword">,</span> v8<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r8<span class="keyword">;</span> r8<span class="keyword">)</span>
                 <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>               <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r7<span class="keyword">;</span> r7<span class="keyword">)</span>
               <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>            <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r6<span class="keyword">;</span> r6<span class="keyword">)</span>
            <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>          <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r5<span class="keyword">;</span> r5<span class="keyword">)</span>
          <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>        <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r4<span class="keyword">;</span> r4<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>      <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r3<span class="keyword">;</span> r3<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>    <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r2<span class="keyword">;</span> r2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>  <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r1<span class="keyword">;</span> r1<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [seq8wth_parser_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
proj1_parser_parser
  <span class="keyword">(</span>p1<span class="keyword">,</span> p2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> r1 <span class="keyword">=</span> p1 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> r1 <span class="keyword">of</span>
  <span class="keyword">|</span> Okay _<span class="comment">(*v1*)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span> 
      <span class="keyword">val</span> r2 <span class="keyword">=</span> p2 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r2 <span class="keyword">of</span>
      <span class="keyword">|</span> <span class="keyword">~</span>Okay _<span class="comment">(*v2*)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r1<span class="keyword">;</span> r1<span class="keyword">)</span>
      <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>free@ <span class="keyword">{</span>a1<span class="keyword">}</span> r1<span class="keyword">;</span> fold@ r2<span class="keyword">;</span> r2<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>  <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r1<span class="keyword">;</span> r1<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [proj1_parser_parser]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
proj2_parser_parser
  <span class="keyword">(</span>p1<span class="keyword">,</span> p2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> r1 <span class="keyword">=</span> p1 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r1 <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Okay _<span class="comment">(*v1*)</span> <span class="keyword">=&gt;</span> p2 <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r1<span class="keyword">;</span> r1<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [proj2_parser_parser]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
sat_parser_fun
  <span class="keyword">(</span>p<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> tks0 <span class="keyword">=</span> tks <span class="keyword">and</span> ncur0 <span class="keyword">=</span> ncur
  <span class="keyword">val</span> r <span class="keyword">=</span> p <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r <span class="keyword">of</span>
  <span class="keyword">|</span> Okay v <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">if</span> f v <span class="keyword">then</span> <span class="keyword">(</span>fold@ r<span class="keyword">;</span> r<span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">begin</span>
        tks := tks0<span class="keyword">;</span> ncur := ncur0<span class="keyword">;</span> free@ <span class="keyword">{</span>a<span class="keyword">}</span> <span class="keyword">(</span>r<span class="keyword">)</span><span class="keyword">;</span> Fail <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="comment">(* end of [Okay] *)</span>
  <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r<span class="keyword">;</span> r<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [sat_parser_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
sat_parser_cloref
  <span class="keyword">(</span>p<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> tks0 <span class="keyword">=</span> tks <span class="keyword">and</span> ncur0 <span class="keyword">=</span> ncur
  <span class="keyword">val</span> r <span class="keyword">=</span> p <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r <span class="keyword">of</span>
  <span class="keyword">|</span> Okay v <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      <span class="keyword">if</span> f v <span class="keyword">then</span> <span class="keyword">(</span>fold@ r<span class="keyword">;</span> r<span class="keyword">)</span> <span class="keyword">else</span> <span class="keyword">begin</span>
        tks := tks0<span class="keyword">;</span> ncur := ncur0<span class="keyword">;</span> free@ <span class="keyword">{</span>a<span class="keyword">}</span> <span class="keyword">(</span>r<span class="keyword">)</span><span class="keyword">;</span> Fail <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [if]
</span>    <span class="keyword">end</span> <span class="comment">(* end of [Okay] *)</span>
  <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r<span class="keyword">;</span> r<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [sat_parser_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
any_parser <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> stream_get_item&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> tks <span class="keyword">in</span> <span class="keyword">case+</span> ans <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Some_vt v <span class="keyword">=&gt;</span> Okay v <span class="keyword">where</span> <span class="keyword">{</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ncur := ncur + 1
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> ncur <span class="keyword">&gt;</span> nmax <span class="keyword">then</span> nmax := ncur
    <span class="keyword">}</span> <span class="comment">// end of [Some_vt]
</span>  <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> Fail <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [any_parser]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
anyopt_parser <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> stream_get_item&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> tks <span class="keyword">in</span> <span class="keyword">case+</span> ans <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Some_vt v <span class="keyword">=&gt;</span> Okay <span class="keyword">(</span>Some v<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ncur := ncur + 1
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> ncur <span class="keyword">&gt;</span> nmax <span class="keyword">then</span> nmax := ncur
    <span class="keyword">}</span> <span class="comment">// end of [Some]
</span>  <span class="keyword">|</span> <span class="keyword">~</span>None_vt <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> Okay <span class="keyword">(</span>None <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [anyopt_parser]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span>
fail_parser <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> Fail <span class="keyword">(</span><span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//
</span><span class="comment">// HX: it is difficult to know where the failure occurs!
</span><span class="comment">//
</span><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
neg_parser <span class="keyword">(</span>p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> tks0 <span class="keyword">=</span> tks <span class="keyword">and</span> ncur0 <span class="keyword">=</span> ncur
  <span class="keyword">val</span> r <span class="keyword">=</span> p <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> tks := tks0 <span class="keyword">and</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ncur := ncur0 <span class="keyword">in</span>
  <span class="keyword">case+</span> r <span class="keyword">of</span> <span class="keyword">~</span>Okay _ <span class="keyword">=&gt;</span> Fail <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">|</span> <span class="keyword">~</span>Fail _ <span class="keyword">=&gt;</span> Okay <span class="keyword">(</span>unit<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [neg_parser]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
optional_parser <span class="keyword">(</span>p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> tks0 <span class="keyword">=</span> tks <span class="keyword">and</span> ncur0 <span class="keyword">=</span> ncur<span class="keyword">;</span> <span class="keyword">val</span> r <span class="keyword">=</span> p <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> r <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Okay v <span class="keyword">=&gt;</span> Okay <span class="keyword">(</span>Some v<span class="keyword">)</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Fail _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
      tks := tks0<span class="keyword">;</span> ncur := ncur0<span class="keyword">;</span> Okay <span class="keyword">(</span>None <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="comment">// no token is consumed
</span>    <span class="keyword">end</span> <span class="comment">// end of [Fail]
</span><span class="keyword">end</span> <span class="comment">// end of [optional_parser]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
repeat0_parser
  <span class="keyword">(</span>p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="17764"><span class="stacstdec">T <span class="keyword">=</span> List a</span></a></span>
  <span class="keyword">fun</span> loop <span class="keyword">(</span>
    tks<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>stream t</span><span class="keyword">,</span> ncur<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span><span class="keyword">,</span> nmax<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp">parser_t <span class="keyword">(</span>a<span class="keyword">,</span> t<span class="keyword">)</span></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>T? &gt;&gt; T</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="keyword">!</span><span class="staexp">laz</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> tks0 <span class="keyword">=</span> tks <span class="keyword">and</span> ncur0 <span class="keyword">=</span> ncur<span class="keyword">;</span> <span class="keyword">val</span> r <span class="keyword">=</span> p <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> r <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Okay v <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> res := list_cons <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span>v<span class="keyword">,</span> ?<span class="keyword">)</span>
        <span class="keyword">val</span> list_cons <span class="keyword">(</span>_<span class="keyword">,</span> <span class="keyword">!</span>p_res_nxt<span class="keyword">)</span> <span class="keyword">=</span> res
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> loop <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">,</span> p<span class="keyword">,</span> <span class="keyword">!</span>p_res_nxt<span class="keyword">)</span>
      <span class="keyword">in</span>
        fold@ res
      <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>    <span class="keyword">|</span> <span class="keyword">~</span>Fail _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        tks := tks0<span class="keyword">;</span> ncur := ncur0<span class="keyword">;</span> res:= list_nil <span class="keyword">(</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [Fail]
</span>  <span class="keyword">end</span> <span class="comment">// end of [loop]
</span>  <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp">T</span> <span class="comment">// uninitialized
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> loop <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">,</span> p<span class="keyword">,</span> res<span class="keyword">)</span>
<span class="keyword">in</span>
  Okay <span class="keyword">(</span>res<span class="keyword">)</span> <span class="comment">// this parser never fails
</span><span class="keyword">end</span> <span class="comment">// end of [repeat0_parser]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
repeat1_parser
  <span class="keyword">(</span>p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> r <span class="keyword">=</span> p <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Okay v <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val-</span> <span class="keyword">~</span>Okay <span class="keyword">(</span>vs<span class="keyword">)</span> <span class="keyword">=</span> repeat0_parser <span class="keyword">(</span>p<span class="keyword">)</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span>
    <span class="keyword">in</span>
      Okay <span class="keyword">(</span>list_cons <span class="keyword">(</span>v<span class="keyword">,</span> vs<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>  <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r<span class="keyword">;</span> r<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [repeat1_parser]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">,</span><span class="staexp">b</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
repeat0_sep_parser
  <span class="keyword">(</span>p<span class="keyword">,</span> sep<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> tks0 <span class="keyword">=</span> tks <span class="keyword">and</span> ncur0 <span class="keyword">=</span> ncur
  <span class="keyword">val</span> r <span class="keyword">=</span> repeat1_sep_parser&lt;<span class="staexp">a</span><span class="keyword">,</span><span class="staexp">b</span><span class="keyword">&gt;</span> <span class="keyword">(</span>p<span class="keyword">,</span> sep<span class="keyword">)</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span>
  <span class="keyword">case+</span> r <span class="keyword">of</span>
  <span class="keyword">|</span> Okay _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r<span class="keyword">;</span> r<span class="keyword">)</span> <span class="keyword">|</span> <span class="keyword">~</span>Fail _ <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> tks := tks0 <span class="keyword">and</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ncur := ncur0 <span class="keyword">in</span> Okay <span class="keyword">(</span>list_nil<span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Fail]
</span><span class="keyword">end</span> <span class="comment">// end of [repeat0_sep_parser]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">,</span><span class="staexp">b</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
repeat1_sep_parser
  <span class="keyword">(</span>p<span class="keyword">,</span> sep<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> r <span class="keyword">=</span> p <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Okay v0 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp">List a</span> <span class="comment">// uninitialized
</span>      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> loop <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">,</span> res<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
        <span class="keyword">fun</span> loop <span class="keyword">(</span>
            tks<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>stream t</span><span class="keyword">,</span> ncur<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span><span class="keyword">,</span> nmax<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span>
          <span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><span class="keyword">(</span>List a?<span class="keyword">)</span> &gt;&gt; List a</span>
          <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">cloref</span><span class="keyword">,</span><span class="keyword">!</span><span class="staexp">laz</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
          <span class="keyword">val</span> tks0 <span class="keyword">=</span> tks <span class="keyword">and</span> ncur0 <span class="keyword">=</span> ncur <span class="keyword">in</span>
          <span class="keyword">case+</span> sep <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">of</span>
          <span class="keyword">|</span> <span class="keyword">~</span>Okay v_sep <span class="keyword">=&gt;</span> <span class="keyword">let</span>
              <span class="keyword">val</span> r <span class="keyword">=</span> p <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r <span class="keyword">of</span>
              <span class="keyword">|</span> <span class="keyword">~</span>Okay v <span class="keyword">=&gt;</span> <span class="keyword">let</span>
                  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> res := list_cons <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span>v<span class="keyword">,</span> ?<span class="keyword">)</span>
                  <span class="keyword">val</span> list_cons <span class="keyword">(</span>_<span class="keyword">,</span> <span class="keyword">!</span>p_res_next<span class="keyword">)</span> <span class="keyword">=</span> res
                  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> loop <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">,</span> <span class="keyword">!</span>p_res_next<span class="keyword">)</span>
                <span class="keyword">in</span>
                  fold@ res
                <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>              <span class="keyword">|</span> <span class="keyword">~</span>Fail _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
                  tks := tks0<span class="keyword">;</span> ncur := ncur0<span class="keyword">;</span> res := list_nil <span class="keyword">(</span><span class="keyword">)</span>
                <span class="keyword">end</span> <span class="comment">// end of [Fail]
</span>            <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>          <span class="keyword">|</span> <span class="keyword">~</span>Fail _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
              tks := tks0<span class="keyword">;</span> ncur := ncur0<span class="keyword">;</span> res := list_nil <span class="keyword">(</span><span class="keyword">)</span>
            <span class="keyword">end</span> <span class="comment">// end of [Fail]
</span>        <span class="keyword">end</span> <span class="comment">// end of [loop]
</span>      <span class="keyword">}</span> <span class="comment">// end of [val]
</span>    <span class="keyword">in</span>
      Okay <span class="keyword">(</span>list_cons <span class="keyword">(</span>v0<span class="keyword">,</span> res<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">// end of [Okay]
</span>  <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r<span class="keyword">;</span> r<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [repeat1_sep_parser]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
discard_one_parser
  <span class="keyword">(</span>p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">val</span> r <span class="keyword">=</span> p <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span> <span class="keyword">case+</span> r <span class="keyword">of</span>
  <span class="keyword">|</span> <span class="keyword">~</span>Okay v <span class="keyword">=&gt;</span> Okay unit <span class="keyword">|</span> Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>fold@ r<span class="keyword">;</span> r<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [discard_parser]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">t</span><span class="keyword">}</span>
discard_many_parser
  <span class="keyword">(</span>p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">lam</span> <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="keyword">(</span>
    tks<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>stream t</span><span class="keyword">,</span> ncur<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span><span class="keyword">,</span> nmax<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>int</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp">parser_t <span class="keyword">(</span>a<span class="keyword">,</span> t<span class="keyword">)</span></span>
  <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="keyword">!</span><span class="staexp">laz</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> tks0 <span class="keyword">=</span> tks <span class="keyword">and</span> ncur0 <span class="keyword">=</span> ncur <span class="keyword">val</span> r <span class="keyword">=</span> p <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">)</span> <span class="keyword">in</span>
    <span class="keyword">case+</span> r <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Okay v <span class="keyword">=&gt;</span> loop <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">,</span> p<span class="keyword">)</span>
    <span class="keyword">|</span> <span class="keyword">~</span>Fail _ <span class="keyword">=&gt;</span> <span class="keyword">(</span>tks := tks0<span class="keyword">;</span> ncur := ncur0<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [loop]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> loop <span class="keyword">(</span>tks<span class="keyword">,</span> ncur<span class="keyword">,</span> nmax<span class="keyword">,</span> p<span class="keyword">)</span>
<span class="keyword">in</span>
  Okay <span class="keyword">(</span>unit<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [discard_many_parser]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [parcomb.dats] *)</span>
</pre>
</body>
</html>
