<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    .atsyntax {color:#E80000;background-color:#E0E0E0}
    .atsyntax span.comment {color:#787878;font-style:italic}
    .atsyntax span.extern  {color:#A52A2A}
    .atsyntax span.keyword {color:#000000;font-weight:bold}
    .atsyntax span.neuexp  {color:#800080}
    .atsyntax span.staexp  {color:#0000FF}
    .atsyntax span.dynexp  {color:#E80000}
    .atsyntax span.prfexp  {color:#009000}
    .atsyntax span.stacstdec  {text-decoration:none}
    .atsyntax span.stacstuse  {color:#0000CF;text-decoration:underline}
    .atsyntax span.dyncstdec  {text-decoration:none}
    .atsyntax span.dyncstimp  {color:#B80000;text-decoration:underline}
    .atsyntax span.dyncstuse  {color:#B80000;text-decoration:underline}
    body {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre class="atsyntax">
<span class="comment">(***********************************************************************)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                         Applied Type System                         *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(*                              Hongwei Xi                             *)</span>
<span class="comment">(*                                                                     *)</span>
<span class="comment">(***********************************************************************)</span>

<span class="comment">(*
** ATS - Unleashing the Potential of Types!
**
** Copyright (C) 2002-2008 Hongwei Xi, Boston University
**
** All rights reserved
**
** ATS is free software;  you can  redistribute it and/or modify it under
** the terms of the GNU LESSER GENERAL PUBLIC LICENSE as published by the
** Free Software Foundation; either version 2.1, or (at your option)  any
** later version.
** 
** ATS is distributed in the hope that it will be useful, but WITHOUT ANY
** WARRANTY; without  even  the  implied  warranty  of MERCHANTABILITY or
** FITNESS FOR A PARTICULAR PURPOSE.  See the  GNU General Public License
** for more details.
** 
** You  should  have  received  a  copy of the GNU General Public License
** along  with  ATS;  see the  file COPYING.  If not, please write to the
** Free Software Foundation,  51 Franklin Street, Fifth Floor, Boston, MA
** 02110-1301, USA.
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* author: Hongwei Xi (hwxi AT cs DOT bu DOT edu) *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(*
#define ATS_STALOADFLAG 0 // ...
*)</span>
<span class="keyword">#define</span> <span class="neuexp">ATS_DYNLOADFLAG 0</span> <span class="comment">// loaded by [ats_main_prelude]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"prelude/SATS/list.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">// list implementation
</span>
<span class="keyword">#define</span> <span class="neuexp">nil list_nil</span>
<span class="keyword">#define</span> <span class="neuexp">cons list_cons</span>
<span class="keyword">#define</span> <span class="neuexp">:: list_cons</span>

<span class="comment">(* ****** ****** *)</span>
<span class="comment">//
</span><span class="comment">// this is a proof function
</span><span class="comment">//
</span><span class="keyword">implement</span>
list_length_is_nonnegative <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> xs <span class="keyword">of</span> list_cons _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
<span class="comment">// end of [list_length_is_nonnegative]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">// this is a casting function
</span><span class="keyword">implement</span>
list_of_list_vt <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> aux <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">castfn</span> aux <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">list_vt <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span> <span class="keyword">=</span>
    <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">~</span>list_vt_cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=&gt;</span> list_cons <span class="keyword">(</span>x<span class="keyword">,</span> aux xs<span class="keyword">)</span>
    <span class="keyword">|</span> <span class="keyword">~</span>list_vt_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> list_nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [aux]
</span><span class="keyword">}</span> <span class="comment">// end of [list_of_list_vt]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_app_funenv
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="2374"><span class="stacstdec">fun_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span>
    <span class="keyword">|</span> xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">fun_t</span>
    <span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> x :: xs <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">in</span> loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [::]
</span>    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_app_funenv]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_app_fun <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> f <span class="keyword">=</span> coerce <span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">extern</span> <span class="keyword">castfn</span> <a name="2841"><span class="dyncstdec">coerce <span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp">a <span class="keyword">-&lt;</span>f<span class="keyword">&gt;</span> void</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>unit_v <span class="keyword">|</span> a<span class="keyword">,</span> <span class="keyword">!</span>ptr<span class="keyword">)</span> <span class="keyword">-&lt;</span>f<span class="keyword">&gt;</span> void</span></span></a>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> list_app_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">,</span> null<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_app_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_app_clo <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="3136"><span class="stacstdec">clo_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">stavar</span> <span class="staexp">l_f<span class="keyword">:</span> addr</span><span class="keyword">;</span> <span class="keyword">val</span> p_f<span class="keyword">:</span> <span class="staexp">ptr l_f</span> <span class="keyword">=</span> <span class="keyword">&amp;</span>f
  <span class="keyword">viewdef</span> <span class="staexp"><a name="3219"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>v<span class="keyword">,</span> clo_t @ l_f<span class="keyword">)</span></span></a></span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">(</span>pf1<span class="keyword">,</span> view@ f<span class="keyword">)</span></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> p_f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ptr l_f</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p_f <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> x<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    <span class="comment">// nothing
</span>  <span class="keyword">end</span> <span class="comment">// end of [app]
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> list_app_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr l_f<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> app<span class="keyword">,</span> p_f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf1 := pf<span class="keyword">.</span>0</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> view@ f := pf<span class="keyword">.</span>1</span>
<span class="keyword">in</span>
  <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_app_clo]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_app_cloptr
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>view<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="3688"><span class="stacstdec">cloptr_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloptr<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloptr_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x<span class="keyword">)</span>
<span class="keyword">in</span>
  list_app_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloptr_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> app<span class="keyword">,</span> f<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_app_cloptr]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_app_cloref <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="3937"><span class="stacstdec">cloref_t <span class="keyword">=</span> a <span class="keyword">-&lt;</span>cloref<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>unit_v</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloref_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> f <span class="keyword">(</span>x<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> list_app_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloref_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> app<span class="keyword">,</span> f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_app_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_app2_funenv
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>view<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">:</span>viewtype<span class="keyword">}</span></span>
  <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span>
    <span class="keyword">|</span> xs1<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a1<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> xs2<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a2<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a1<span class="keyword">,</span> a2<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span>
    <span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">case+</span> <span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">)</span> <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">(</span>x1 :: xs1<span class="keyword">,</span> x2 :: xs2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x1<span class="keyword">,</span> x2<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">;</span> loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [::, ::]
</span>    <span class="keyword">|</span> <span class="keyword">(</span>nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_app2_funenv]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_app2_fun <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> f <span class="keyword">=</span> coerce <span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span> <span class="keyword">extern</span> <span class="keyword">castfn</span>
    <a name="4840"><span class="dyncstdec">coerce <span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>a1<span class="keyword">,</span> a2<span class="keyword">)</span> <span class="keyword">-&lt;</span>f<span class="keyword">&gt;</span> void</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>unit_v <span class="keyword">|</span> a1<span class="keyword">,</span> a2<span class="keyword">,</span> <span class="keyword">!</span>ptr<span class="keyword">)</span> <span class="keyword">-&lt;</span>f<span class="keyword">&gt;</span> void</span></span></a>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> list_app2_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> f<span class="keyword">,</span> null<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [list_app2_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_app2_clo
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="5178"><span class="stacstdec">clo_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a1<span class="keyword">,</span> a2<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">stavar</span> <span class="staexp">l_f<span class="keyword">:</span> addr</span><span class="keyword">;</span> <span class="keyword">val</span> p_f<span class="keyword">:</span> <span class="staexp">ptr l_f</span> <span class="keyword">=</span> <span class="keyword">&amp;</span>f
  <span class="keyword">viewdef</span> <span class="staexp"><a name="5266"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>v<span class="keyword">,</span> clo_t @ l_f<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> x1<span class="keyword">:</span> <span class="staexp">a1</span><span class="keyword">,</span> x2<span class="keyword">:</span> <span class="staexp">a2</span><span class="keyword">,</span> p_f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ptr l_f</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p_f <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> x1<span class="keyword">,</span> x2<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    <span class="comment">// nothing
</span>  <span class="keyword">end</span> <span class="comment">// end of [app]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">(</span>pf1<span class="keyword">,</span> view@ f<span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> list_app2_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr l_f<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> app<span class="keyword">,</span> p_f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf1 := pf<span class="keyword">.</span>0</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> view@ f := pf<span class="keyword">.</span>1</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [list_app2_clo]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_app2_cloptr
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="5778"><span class="stacstdec">cloptr_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a1<span class="keyword">,</span> a2<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloptr<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> x1<span class="keyword">:</span> <span class="staexp">a1</span><span class="keyword">,</span> x2<span class="keyword">:</span> <span class="staexp">a2</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloptr_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x1<span class="keyword">,</span> x2<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    list_app2_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloptr_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> app<span class="keyword">,</span> f<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span>  <span class="comment">// end of [list_app2_cloptr]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_app2_cloref <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="6127"><span class="stacstdec">cloref_t <span class="keyword">=</span> <span class="keyword">(</span>a1<span class="keyword">,</span> a2<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>unit_v</span></span> <span class="keyword">|</span> x1<span class="keyword">:</span> <span class="staexp">a1</span><span class="keyword">,</span> x2<span class="keyword">:</span> <span class="staexp">a2</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloref_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> f <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    list_app2_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloref_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> app<span class="keyword">,</span> f<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span>  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span>  <span class="comment">// end of [list_app2_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>
<span class="comment">//
</span><span class="comment">// HX: a tail-recursive implementation of list-append
</span><span class="comment">//
</span><span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_append <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp">List a</span> <span class="comment">// uninitialized
</span>  <span class="keyword">fun</span> loop
    <span class="staexp"><span class="keyword">{</span>n1<span class="keyword">,</span>n2<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n1<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
    xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n1<span class="keyword">)</span></span>
  <span class="keyword">,</span> ys<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n2<span class="keyword">)</span></span>
  <span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><span class="keyword">(</span>List a<span class="keyword">)</span>? &gt;&gt; list <span class="keyword">(</span>a<span class="keyword">,</span> n1+n2<span class="keyword">)</span></span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> x :: xs <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>res := cons <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span>x<span class="keyword">,</span> ?<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">val+</span> cons <span class="keyword">(</span>_<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span> <span class="keyword">=</span> res
      <span class="keyword">in</span>
        loop <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span><span class="keyword">;</span> fold@ res
      <span class="keyword">end</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>res := ys<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">,</span> res<span class="keyword">)</span><span class="keyword">;</span> res
<span class="keyword">end</span> <span class="comment">// end of [list_append]
</span>
<span class="comment">(*
//
// HX: this is a standard non-tail-recursive implementation
// of list_append:
//
implement{a}
list_append {i,j} (xs, ys) = let
  fun aux {n1,n2:nat} .&lt;n1&gt;.
    (xs: list (a, n1), ys: list (a, n2)):&lt;&gt; list (a, n1+n2) =
    case+ xs of x :: xs =&gt; x :: aux (xs, ys) | nil () =&gt; ys
in
  aux (xs, ys)
end // end of [list_append]
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_append1_vt <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">extern</span> <span class="keyword">castfn</span> <a name="7424"><span class="dyncstdec">__cast <span class="staexp"><span class="keyword">{</span>j<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>ys<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> j<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">list_vt <span class="keyword">(</span>a<span class="keyword">,</span> j<span class="keyword">)</span></span></span></a>
<span class="keyword">in</span>
  list_of_list_vt <span class="keyword">(</span>list_vt_append <span class="keyword">(</span>xs<span class="keyword">,</span> __cast <span class="keyword">(</span>ys<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_append1_vt]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_append2_vt <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp">List_vt a</span> <span class="comment">// uninitialized
</span>  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n1<span class="keyword">,</span>n2<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n1<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
    xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n1<span class="keyword">)</span></span>
  <span class="keyword">,</span> ys<span class="keyword">:</span> <span class="staexp">list_vt <span class="keyword">(</span>a<span class="keyword">,</span> n2<span class="keyword">)</span></span>
  <span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><span class="keyword">(</span>List_vt a<span class="keyword">)</span>? &gt;&gt; list_vt <span class="keyword">(</span>a<span class="keyword">,</span> n1+n2<span class="keyword">)</span></span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> x :: xs <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>res := list_vt_cons <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span>x<span class="keyword">,</span> ?<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">val+</span> list_vt_cons <span class="keyword">(</span>_<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span> <span class="keyword">=</span> res
      <span class="keyword">in</span>
        loop <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span><span class="keyword">;</span> fold@ res
      <span class="keyword">end</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>res := ys<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">,</span> res<span class="keyword">)</span><span class="keyword">;</span> res
<span class="keyword">end</span> <span class="comment">// end of [list_append_vt]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_assoc_funenv
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>eq<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xys<span class="keyword">,</span> eq<span class="keyword">,</span> x0<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span>
    <span class="keyword">|</span> xys<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span><span class="keyword">@(</span>a1<span class="keyword">,</span> a2<span class="keyword">)</span><span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> eq<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a1<span class="keyword">,</span> a1<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">,</span>eq<span class="keyword">&gt;</span> bool</span>
    <span class="keyword">,</span> x0<span class="keyword">:</span> <span class="staexp">a1</span>
    <span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">eq</span><span class="keyword">&gt;</span> <span class="staexp">Option_vt a2</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> xys <span class="keyword">of</span>
    <span class="keyword">|</span> xy :: xys <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
         <span class="keyword">if</span> eq <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x0<span class="keyword">,</span> xy<span class="keyword">.</span>0<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">then</span> Some_vt <span class="keyword">(</span>xy<span class="keyword">.</span>1<span class="keyword">)</span> <span class="keyword">else</span> loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xys<span class="keyword">,</span> eq<span class="keyword">,</span> x0<span class="keyword">,</span> env<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [::]
</span>    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">in</span>
  loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xys<span class="keyword">,</span> eq<span class="keyword">,</span> x0<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_assoc_funenv]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_assoc_fun
  <span class="staexp"><span class="keyword">{</span>eq<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xys<span class="keyword">,</span> eq<span class="keyword">,</span> x0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> eq <span class="keyword">=</span> coerce <span class="keyword">(</span>eq<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span> <span class="keyword">extern</span> <span class="keyword">castfn</span>
    <a name="8718"><span class="dyncstdec">coerce <span class="keyword">(</span>eq<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>a1<span class="keyword">,</span> a1<span class="keyword">)</span> <span class="keyword">-&lt;</span>eq<span class="keyword">&gt;</span> bool</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>unit_v <span class="keyword">|</span> a1<span class="keyword">,</span> a1<span class="keyword">,</span> <span class="keyword">!</span>ptr<span class="keyword">)</span> <span class="keyword">-&lt;</span>eq<span class="keyword">&gt;</span> bool</span></span></a>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_assoc_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xys<span class="keyword">,</span> eq<span class="keyword">,</span> x0<span class="keyword">,</span> null<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_assoc_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_assoc_clo
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>view<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>eq<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> xys<span class="keyword">,</span> eq<span class="keyword">,</span> x0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="9060"><span class="stacstdec">clo_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a1<span class="keyword">,</span> a1<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">,</span>eq<span class="keyword">&gt;</span> bool</span></a></span>
  <span class="keyword">stavar</span> <span class="staexp">l_eq<span class="keyword">:</span> addr</span><span class="keyword">;</span> <span class="keyword">val</span> p_eq<span class="keyword">:</span> <span class="staexp">ptr l_eq</span> <span class="keyword">=</span> <span class="keyword">&amp;</span>eq
  <span class="keyword">viewdef</span> <span class="staexp"><a name="9153"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>v<span class="keyword">,</span> clo_t @ l_eq<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a1</span><span class="keyword">,</span> y<span class="keyword">:</span> <span class="staexp">a1</span><span class="keyword">,</span> p_eq<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ptr l_eq</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">eq</span><span class="keyword">&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val</span> ans <span class="keyword">=</span> <span class="keyword">!</span>p_eq <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> x<span class="keyword">,</span> y<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    ans
  <span class="keyword">end</span> <span class="comment">// end of [app]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">(</span>pf1<span class="keyword">,</span> view@ eq<span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_assoc_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr l_eq<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xys<span class="keyword">,</span> app<span class="keyword">,</span> x0<span class="keyword">,</span> p_eq<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf1 := pf<span class="keyword">.</span>0</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> view@ eq := pf<span class="keyword">.</span>1</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_assoc_clo]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_assoc_cloptr
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>eq<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xys<span class="keyword">,</span> eq<span class="keyword">,</span> x0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="9659"><span class="stacstdec">cloptr_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a1<span class="keyword">,</span> a1<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloptr<span class="keyword">,</span>eq<span class="keyword">&gt;</span> bool</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a1</span><span class="keyword">,</span> y<span class="keyword">:</span> <span class="staexp">a1</span><span class="keyword">,</span> eq<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloptr_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">eq</span><span class="keyword">&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> eq <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x<span class="keyword">,</span> y<span class="keyword">)</span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_assoc_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloptr_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xys<span class="keyword">,</span> app<span class="keyword">,</span> x0<span class="keyword">,</span> eq<span class="keyword">)</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_assoc_cloptr]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_assoc_cloref
  <span class="staexp"><span class="keyword">{</span>eq<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xys<span class="keyword">,</span> eq<span class="keyword">,</span> x0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="9973"><span class="stacstdec">cloref_t <span class="keyword">=</span> <span class="keyword">(</span>a1<span class="keyword">,</span> a1<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">,</span>eq<span class="keyword">&gt;</span> bool</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span>
    <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>unit_v</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a1</span><span class="keyword">,</span> y<span class="keyword">:</span> <span class="staexp">a1</span><span class="keyword">,</span> eq<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloref_t</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">eq</span><span class="keyword">&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> eq <span class="keyword">(</span>x<span class="keyword">,</span> y<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_assoc_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloref_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xys<span class="keyword">,</span> app<span class="keyword">,</span> x0<span class="keyword">,</span> eq<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_assoc_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_concat <span class="keyword">(</span>xss<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> aux <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
    xs0<span class="keyword">:</span> <span class="staexp">List a</span><span class="keyword">,</span> xss<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>List a<span class="keyword">,</span> n<span class="keyword">)</span></span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">List_vt a</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> xss <span class="keyword">of</span>
    <span class="keyword">|</span> xs :: xss <span class="keyword">=&gt;</span> list_append2_vt <span class="keyword">(</span>xs0<span class="keyword">,</span> aux <span class="keyword">(</span>xs<span class="keyword">,</span> xss<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> list_append2_vt <span class="keyword">(</span>xs0<span class="keyword">,</span> list_vt_nil<span class="keyword">)</span>
  <span class="comment">// end of [aux]
</span><span class="keyword">in</span>
  <span class="keyword">case+</span> xss <span class="keyword">of</span> xs :: xss <span class="keyword">=&gt;</span> aux <span class="keyword">(</span>xs<span class="keyword">,</span> xss<span class="keyword">)</span> <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> list_vt_nil <span class="keyword">(</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_concat]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_drop <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">=</span> loop <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">,</span>i<span class="keyword">:</span>nat <span class="keyword">|</span> i &lt;= n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>i<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int i</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n-i<span class="keyword">)</span></span> <span class="keyword">=</span>
    <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span> <span class="keyword">val+</span> _ :: xs <span class="keyword">=</span> xs <span class="keyword">in</span> loop <span class="keyword">(</span>xs<span class="keyword">,</span> i-1<span class="keyword">)</span> <span class="keyword">end</span>
    <span class="keyword">else</span> xs
<span class="keyword">}</span> <span class="comment">// end of [list_drop]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_drop_exn <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">=</span> loop <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">,</span>i<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>i<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int i</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">[</span>i &lt;= n<span class="keyword">]</span> list <span class="keyword">(</span>a<span class="keyword">,</span> n-i<span class="keyword">)</span></span> <span class="keyword">=</span>
    <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
      <span class="keyword">|</span> list_cons <span class="keyword">(</span>_<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=&gt;</span> loop <span class="keyword">(</span>xs<span class="keyword">,</span> i-1<span class="keyword">)</span>
      <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">$raise</span> ListSubscriptException <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="keyword">else</span> xs
<span class="keyword">}</span> <span class="comment">// end of [list_drop_exn]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_exists_funenv
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> p<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span>
    <span class="keyword">|</span> xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">,</span>p<span class="keyword">&gt;</span> bool</span>
    <span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">p</span><span class="keyword">&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> x :: xs <span class="keyword">=&gt;</span> <span class="keyword">if</span> p <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">then</span> true <span class="keyword">else</span> loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> p<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> false
  <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> p<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_exists_funenv]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_exists_fun <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">,</span> p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> p <span class="keyword">=</span> coerce <span class="keyword">(</span>p<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">extern</span> <span class="keyword">castfn</span> <a name="11756"><span class="dyncstdec">coerce <span class="keyword">(</span>p<span class="keyword">:</span> <span class="staexp">a <span class="keyword">-&lt;</span>p<span class="keyword">&gt;</span> bool</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>unit_v <span class="keyword">|</span> a<span class="keyword">,</span> <span class="keyword">!</span>ptr<span class="keyword">)</span> <span class="keyword">-&lt;</span>p<span class="keyword">&gt;</span> bool</span></span></a>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_exists_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> p<span class="keyword">,</span> null<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_exists_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_exists_clo
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="12060"><span class="stacstdec">clo_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">,</span>p<span class="keyword">&gt;</span> bool</span></a></span>
  <span class="keyword">stavar</span> <span class="staexp">l_f<span class="keyword">:</span> addr</span><span class="keyword">;</span> <span class="keyword">val</span> p_f<span class="keyword">:</span> <span class="staexp">ptr l_f</span> <span class="keyword">=</span> <span class="keyword">&amp;</span>f
  <span class="keyword">viewdef</span> <span class="staexp"><a name="12143"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>v<span class="keyword">,</span> clo_t @ l_f<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> p_f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ptr l_f</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">p</span><span class="keyword">&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val</span> ans <span class="keyword">=</span> <span class="keyword">!</span>p_f <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> x<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    ans
  <span class="keyword">end</span> <span class="comment">// end of [app]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">(</span>pf1<span class="keyword">,</span> view@ f<span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_exists_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr l_f<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> app<span class="keyword">,</span> p_f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf1 := pf<span class="keyword">.</span>0</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> view@ f := pf<span class="keyword">.</span>1</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_exists_clo]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_exists_cloptr
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="12612"><span class="stacstdec">cloptr_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloptr<span class="keyword">,</span>p<span class="keyword">&gt;</span> bool</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloptr_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">p</span><span class="keyword">&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> p <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x<span class="keyword">)</span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_exists_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloptr_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> app<span class="keyword">,</span> p<span class="keyword">)</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_exists_cloptr]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_exists_cloref <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">,</span> p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="12886"><span class="stacstdec">cloref_t <span class="keyword">=</span> a <span class="keyword">-&lt;</span>cloref<span class="keyword">,</span>p<span class="keyword">&gt;</span> bool</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>unit_v</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloref_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">p</span><span class="keyword">&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> p <span class="keyword">(</span>x<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_exists_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloref_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> app<span class="keyword">,</span> p<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_exists_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_exists2_funenv
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> p<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span>
    <span class="keyword">|</span> xs1<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a1<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> xs2<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a2<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a1<span class="keyword">,</span> a2<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">,</span>p<span class="keyword">&gt;</span> bool</span>
    <span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">p</span><span class="keyword">&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> xs1 <span class="keyword">of</span>
    <span class="keyword">|</span> x1 :: xs1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val+</span> x2 :: xs2 <span class="keyword">=</span> xs2 <span class="keyword">in</span>
        <span class="keyword">if</span> p <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x1<span class="keyword">,</span> x2<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">then</span> true <span class="keyword">else</span> loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> p<span class="keyword">,</span> env<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">(* end of [::] *)</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> false
  <span class="keyword">end</span> <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> p<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_exists2_funenv]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_exists2_fun <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> p <span class="keyword">=</span> coerce <span class="keyword">(</span>p<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span> <span class="keyword">extern</span> <span class="keyword">castfn</span>
    <a name="13821"><span class="dyncstdec">coerce <span class="keyword">(</span>p<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>a1<span class="keyword">,</span> a2<span class="keyword">)</span> <span class="keyword">-&lt;</span>p<span class="keyword">&gt;</span> bool</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>unit_v <span class="keyword">|</span> a1<span class="keyword">,</span> a2<span class="keyword">,</span> <span class="keyword">!</span>ptr<span class="keyword">)</span> <span class="keyword">-&lt;</span>p<span class="keyword">&gt;</span> bool</span></span></a>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_exists2_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> p<span class="keyword">,</span> null<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_exists2_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_exists2_clo
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="14164"><span class="stacstdec">clo_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a1<span class="keyword">,</span> a2<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">,</span>p<span class="keyword">&gt;</span> bool</span></a></span>
  <span class="keyword">stavar</span> <span class="staexp">l_f<span class="keyword">:</span> addr</span><span class="keyword">;</span> <span class="keyword">val</span> p_f<span class="keyword">:</span> <span class="staexp">ptr l_f</span> <span class="keyword">=</span> <span class="keyword">&amp;</span>f
  <span class="keyword">viewdef</span> <span class="staexp"><a name="14252"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>v<span class="keyword">,</span> clo_t @ l_f<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> x1<span class="keyword">:</span> <span class="staexp">a1</span><span class="keyword">,</span> x2<span class="keyword">:</span> <span class="staexp">a2</span><span class="keyword">,</span> p_f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ptr l_f</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">p</span><span class="keyword">&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val</span> ans <span class="keyword">=</span> <span class="keyword">!</span>p_f <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> x1<span class="keyword">,</span> x2<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    ans
  <span class="keyword">end</span> <span class="comment">// end of [app]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">(</span>pf1<span class="keyword">,</span> view@ f<span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_exists2_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr l_f<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> app<span class="keyword">,</span> p_f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf1 := pf<span class="keyword">.</span>0</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> view@ f := pf<span class="keyword">.</span>1</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_exists2_clo]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_exists2_cloptr
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="14763"><span class="stacstdec">cloptr_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a1<span class="keyword">,</span> a2<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloptr<span class="keyword">,</span>p<span class="keyword">&gt;</span> bool</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> x1<span class="keyword">:</span> <span class="staexp">a1</span><span class="keyword">,</span> x2<span class="keyword">:</span> <span class="staexp">a2</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloptr_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">p</span><span class="keyword">&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> p <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x1<span class="keyword">,</span> x2<span class="keyword">)</span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_exists2_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloptr_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> app<span class="keyword">,</span> p<span class="keyword">)</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_exists2_cloptr]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_exists2_cloref <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="15088"><span class="stacstdec">cloref_t <span class="keyword">=</span> <span class="keyword">(</span>a1<span class="keyword">,</span> a2<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">,</span>p<span class="keyword">&gt;</span> bool</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>unit_v</span></span> <span class="keyword">|</span> x1<span class="keyword">:</span> <span class="staexp">a1</span><span class="keyword">,</span> x2<span class="keyword">:</span> <span class="staexp">a2</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloref_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">p</span><span class="keyword">&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> p <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_exists2_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloref_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> app<span class="keyword">,</span> p<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_exists2_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_extend <span class="keyword">(</span>xs<span class="keyword">,</span> y<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp">List_vt a</span> <span class="comment">// uninitialized
</span>  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> y<span class="keyword">:</span> <span class="staexp">a</span>
    <span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><span class="keyword">(</span>List_vt a<span class="keyword">)</span>? &gt;&gt; list_vt <span class="keyword">(</span>a<span class="keyword">,</span> n+1<span class="keyword">)</span></span>
    <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> x :: xs <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>res := list_vt_cons <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span>x<span class="keyword">,</span> ?<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">val</span> list_vt_cons <span class="keyword">(</span>_<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span> <span class="keyword">=</span> res
      <span class="keyword">in</span>
        loop <span class="keyword">(</span>xs<span class="keyword">,</span> y<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span><span class="keyword">;</span> fold@ res
      <span class="keyword">end</span> <span class="comment">// end of [::]
</span>    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>res := list_vt_cons <span class="keyword">(</span>y<span class="keyword">,</span> list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span>xs<span class="keyword">,</span> y<span class="keyword">,</span> res<span class="keyword">)</span><span class="keyword">;</span> res
<span class="keyword">end</span> <span class="comment">// end of [list_extend]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_filter_funenv
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> p<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span>
    <span class="keyword">|</span> xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">,</span>p<span class="keyword">&gt;</span> bool</span>
    <span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><span class="keyword">(</span>List_vt a<span class="keyword">)</span>? &gt;&gt; list_vt <span class="keyword">(</span>a<span class="keyword">,</span> n1<span class="keyword">)</span></span>
    <span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">p</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">#[</span>n1<span class="keyword">:</span>nat <span class="keyword">|</span> n1 &lt;= n<span class="keyword">]</span> void</span> <span class="keyword">=</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> x :: xs <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> p <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">let</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> res := list_vt_cons <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span>x<span class="keyword">,</span> ?<span class="keyword">)</span>
          <span class="keyword">val+</span> list_vt_cons <span class="keyword">(</span>_<span class="keyword">,</span> <span class="keyword">!</span>p_res<span class="keyword">)</span> <span class="keyword">=</span> res
        <span class="keyword">in</span>
          loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> p<span class="keyword">,</span> <span class="keyword">!</span>p_res<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">;</span> fold@ res
        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
          loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> p<span class="keyword">,</span> res<span class="keyword">,</span> env<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="comment">(* end of [::] *)</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>res := list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
  <span class="comment">// end of [loop]
</span>  <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp">List_vt a</span> <span class="comment">// uninitialized
</span>  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> p<span class="keyword">,</span> res<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="keyword">in</span>
  res
<span class="keyword">end</span> <span class="comment">// end of [list_filter_funenv]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_filter_fun <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> f <span class="keyword">=</span> coerce <span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span> <span class="keyword">extern</span> <span class="keyword">castfn</span>
    <a name="16857"><span class="dyncstdec">coerce <span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp">a <span class="keyword">-&lt;</span>p<span class="keyword">&gt;</span> bool</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>unit_v <span class="keyword">|</span> a<span class="keyword">,</span> <span class="keyword">!</span>ptr<span class="keyword">)</span> <span class="keyword">-&lt;</span>p<span class="keyword">&gt;</span> bool</span></span></a>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_filter_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">,</span> null<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_filter_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_filter_clo
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="17165"><span class="stacstdec">clo_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">,</span>p<span class="keyword">&gt;</span> bool</span></a></span>
  <span class="keyword">stavar</span> <span class="staexp">l_f<span class="keyword">:</span> addr</span><span class="keyword">;</span> <span class="keyword">val</span> p_f<span class="keyword">:</span> <span class="staexp">ptr l_f</span> <span class="keyword">=</span> <span class="keyword">&amp;</span>f
  <span class="keyword">viewdef</span> <span class="staexp"><a name="17248"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>v<span class="keyword">,</span> clo_t @ l_f<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> p_f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ptr l_f</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">p</span><span class="keyword">&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> pf</span><span class="keyword">;</span> <span class="keyword">val</span> ans <span class="keyword">=</span> <span class="keyword">!</span>p_f <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> x<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    ans
  <span class="keyword">end</span> <span class="comment">// end of [app]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">(</span>pf1<span class="keyword">,</span> view@ f<span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_filter_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr l_f<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> app<span class="keyword">,</span> p_f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf1 := pf<span class="keyword">.</span>0</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> view@ f := pf<span class="keyword">.</span>1</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_filter_clo]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_filter_cloptr
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="17715"><span class="stacstdec">cloptr_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloptr<span class="keyword">,</span>p<span class="keyword">&gt;</span> bool</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloptr_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">p</span><span class="keyword">&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> p <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x<span class="keyword">)</span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_filter_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloptr_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> app<span class="keyword">,</span> p<span class="keyword">)</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_filter_cloptr]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_filter_cloref <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">,</span> p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="17993"><span class="stacstdec">cloref_t <span class="keyword">=</span> a <span class="keyword">-&lt;</span>cloref<span class="keyword">,</span>p<span class="keyword">&gt;</span> bool</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>unit_v</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloref_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">p</span><span class="keyword">&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> p <span class="keyword">(</span>x<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_filter_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloref_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> app<span class="keyword">,</span> p<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_filter_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_find_funenv <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> p<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span>
    <span class="keyword">|</span> xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">,</span>p<span class="keyword">&gt;</span> bool</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">p</span><span class="keyword">&gt;</span> <span class="staexp">Option_vt a</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> x :: xs <span class="keyword">=&gt;</span> <span class="keyword">if</span> p <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">then</span> Some_vt <span class="keyword">(</span>x<span class="keyword">)</span> <span class="keyword">else</span> loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> p<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> p<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_find_funenv]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_find_fun <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> f <span class="keyword">=</span> coerce <span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span> <span class="keyword">extern</span> <span class="keyword">castfn</span>
    <a name="18770"><span class="dyncstdec">coerce <span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp">a <span class="keyword">-&lt;</span>p<span class="keyword">&gt;</span> bool</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>unit_v <span class="keyword">|</span> a<span class="keyword">,</span> <span class="keyword">!</span>ptr<span class="keyword">)</span> <span class="keyword">-&lt;</span>p<span class="keyword">&gt;</span> bool</span></span></a>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_find_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">,</span> null<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_find_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_find_clo
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="19068"><span class="stacstdec">clo_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">,</span>p<span class="keyword">&gt;</span> bool</span></a></span>
  <span class="keyword">stavar</span> <span class="staexp">l_f<span class="keyword">:</span> addr</span><span class="keyword">;</span> <span class="keyword">val</span> p_f<span class="keyword">:</span> <span class="staexp">ptr l_f</span> <span class="keyword">=</span> <span class="keyword">&amp;</span>f
  <span class="keyword">viewdef</span> <span class="staexp"><a name="19151"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>v<span class="keyword">,</span> clo_t @ l_f<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> p_f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ptr l_f</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">p</span><span class="keyword">&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> pf</span><span class="keyword">;</span> <span class="keyword">val</span> ans <span class="keyword">=</span> <span class="keyword">!</span>p_f <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> x<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    ans
  <span class="keyword">end</span> <span class="comment">// end of [app]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">(</span>pf1<span class="keyword">,</span> view@ f<span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_find_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr l_f<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> app<span class="keyword">,</span> p_f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf1 := pf<span class="keyword">.</span>0</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> view@ f := pf<span class="keyword">.</span>1</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_find_clo]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_find_cloptr
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="19608"><span class="stacstdec">cloptr_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloptr<span class="keyword">,</span>p<span class="keyword">&gt;</span> bool</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloptr_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">p</span><span class="keyword">&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> p <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x<span class="keyword">)</span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_find_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloptr_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> app<span class="keyword">,</span> p<span class="keyword">)</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_find_cloptr]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_find_cloref <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">,</span> p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="19876"><span class="stacstdec">cloref_t <span class="keyword">=</span> a <span class="keyword">-&lt;</span>cloref<span class="keyword">,</span>p<span class="keyword">&gt;</span> bool</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>unit_v</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloref_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">p</span><span class="keyword">&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> p <span class="keyword">(</span>x<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_find_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloref_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> app<span class="keyword">,</span> p<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_find_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(*
// HX: this one does not work out
macrodef list_fold_left_mac (list_fold_left, f, res, xs) = `(
  case+ ,(xs) of
  | x :: xs =&gt; ,(list_fold_left) (,(f), ,(f) (,(res), x), xs)
  | nil () =&gt; ,(res)
)
*)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">init</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_fold_left_funenv
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> f<span class="keyword">,</span> res<span class="keyword">,</span> xs<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span>
    <span class="keyword">|</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> init<span class="keyword">,</span> a<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">,</span>f<span class="keyword">&gt;</span> init</span>
    <span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp">init</span>
    <span class="keyword">,</span> xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">init</span> <span class="keyword">=</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> x :: xs <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> res <span class="keyword">=</span> f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> res<span class="keyword">,</span> x<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">in</span> loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> f<span class="keyword">,</span> res<span class="keyword">,</span> xs<span class="keyword">,</span> env<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [::]
</span>    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> res
  <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> f<span class="keyword">,</span> res<span class="keyword">,</span> xs<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_fold_left_funenv]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">init</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_fold_left_fun <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>f<span class="keyword">,</span> res<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> f <span class="keyword">=</span> coerce <span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span> <span class="keyword">extern</span> <span class="keyword">castfn</span>
    <a name="20944"><span class="dyncstdec">coerce <span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>init<span class="keyword">,</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>f<span class="keyword">&gt;</span> init</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>unit_v <span class="keyword">|</span> init<span class="keyword">,</span> a<span class="keyword">,</span> <span class="keyword">!</span>ptr<span class="keyword">)</span> <span class="keyword">-&lt;</span>f<span class="keyword">&gt;</span> init</span></span></a>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_fold_left_funenv&lt;<span class="staexp">init</span><span class="keyword">&gt;&lt;</span><span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> f<span class="keyword">,</span> res<span class="keyword">,</span> xs<span class="keyword">,</span> null<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_fold_left_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">init</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_fold_left_clo
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>view<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> f<span class="keyword">,</span> res<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="21302"><span class="stacstdec">clo_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> init<span class="keyword">,</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">,</span>f<span class="keyword">&gt;</span> init</span></a></span>
  <span class="keyword">stavar</span> <span class="staexp">l_f<span class="keyword">:</span> addr</span><span class="keyword">;</span> <span class="keyword">val</span> p_f<span class="keyword">:</span> <span class="staexp">ptr l_f</span> <span class="keyword">=</span> <span class="keyword">&amp;</span>f
  <span class="keyword">viewdef</span> <span class="staexp"><a name="21391"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>v<span class="keyword">,</span> clo_t @ l_f<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> res<span class="keyword">:</span> <span class="staexp">init</span><span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> p_f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ptr l_f</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">init</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> pf</span><span class="keyword">;</span> <span class="keyword">val</span> ans <span class="keyword">=</span> <span class="keyword">!</span>p_f <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> res<span class="keyword">,</span> x<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    ans
  <span class="keyword">end</span> <span class="comment">// end of [app]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">(</span>pf1<span class="keyword">,</span> view@ f<span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_fold_left_funenv&lt;<span class="staexp">init</span><span class="keyword">&gt;&lt;</span><span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr l_f<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> app<span class="keyword">,</span> res<span class="keyword">,</span> xs<span class="keyword">,</span> p_f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf1 := pf<span class="keyword">.</span>0</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> view@ f := pf<span class="keyword">.</span>1</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_fold_left_clo]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">init</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_fold_left_cloptr
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>view<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> f<span class="keyword">,</span> res<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="21906"><span class="stacstdec">cloptr_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> init<span class="keyword">,</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloptr<span class="keyword">,</span>f<span class="keyword">&gt;</span> init</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> res<span class="keyword">:</span> <span class="staexp">init</span><span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloptr_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">init</span> <span class="keyword">=</span> f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> res<span class="keyword">,</span> x<span class="keyword">)</span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_fold_left_funenv&lt;<span class="staexp">init</span><span class="keyword">&gt;&lt;</span><span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloptr_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> app<span class="keyword">,</span> res<span class="keyword">,</span> xs<span class="keyword">,</span> f<span class="keyword">)</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_fold_left_cloptr]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">init</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_fold_left_cloref <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>f<span class="keyword">,</span> res<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="22233"><span class="stacstdec">cloref_t <span class="keyword">=</span> <span class="keyword">(</span>init<span class="keyword">,</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">,</span>f<span class="keyword">&gt;</span> init</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>unit_v</span></span> <span class="keyword">|</span> res<span class="keyword">:</span> <span class="staexp">init</span><span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloref_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">init</span> <span class="keyword">=</span> f <span class="keyword">(</span>res<span class="keyword">,</span> x<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_fold_left_funenv&lt;<span class="staexp">init</span><span class="keyword">&gt;&lt;</span><span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloref_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> app<span class="keyword">,</span> res<span class="keyword">,</span> xs<span class="keyword">,</span> f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_fold_left_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">init</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_fold2_left_funenv
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> f<span class="keyword">,</span> res<span class="keyword">,</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span>
    <span class="keyword">|</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> init<span class="keyword">,</span> a1<span class="keyword">,</span> a2<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">,</span>f<span class="keyword">&gt;</span> init</span>
    <span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp">init</span>
    <span class="keyword">,</span> xs1<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a1<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> xs2<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a2<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">init</span> <span class="keyword">=</span> <span class="keyword">case+</span> xs1 <span class="keyword">of</span>
    <span class="keyword">|</span> x1 :: xs1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val+</span> x2 :: xs2 <span class="keyword">=</span> xs2<span class="keyword">;</span> <span class="keyword">val</span> res <span class="keyword">=</span> f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> res<span class="keyword">,</span> x1<span class="keyword">,</span> x2<span class="keyword">,</span> env<span class="keyword">)</span>
      <span class="keyword">in</span>
        loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> f<span class="keyword">,</span> res<span class="keyword">,</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> env<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [::]
</span>    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> res
  <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> f<span class="keyword">,</span> res<span class="keyword">,</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_fold2_left_funenv]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">init</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_fold2_left_cloptr
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> f<span class="keyword">,</span> res<span class="keyword">,</span> xs1<span class="keyword">,</span> xs2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="23243"><span class="stacstdec">cloptr_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> init<span class="keyword">,</span> a1<span class="keyword">,</span> a2<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloptr<span class="keyword">,</span>f<span class="keyword">&gt;</span> init</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> res<span class="keyword">:</span> <span class="staexp">init</span><span class="keyword">,</span> x1<span class="keyword">:</span> <span class="staexp">a1</span><span class="keyword">,</span> x2<span class="keyword">:</span> <span class="staexp">a2</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloptr_t</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">init</span> <span class="keyword">=</span> f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> res<span class="keyword">,</span> x1<span class="keyword">,</span> x2<span class="keyword">)</span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_fold2_left_funenv&lt;<span class="staexp">init</span><span class="keyword">&gt;&lt;</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloptr_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> app<span class="keyword">,</span> res<span class="keyword">,</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> f<span class="keyword">)</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_fold2_left_cloptr]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">init</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_fold2_left_cloref <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>f<span class="keyword">,</span> res<span class="keyword">,</span> xs1<span class="keyword">,</span> xs2<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="23630"><span class="stacstdec">cloref_t <span class="keyword">=</span> <span class="keyword">(</span>init<span class="keyword">,</span> a1<span class="keyword">,</span> a2<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">,</span>f<span class="keyword">&gt;</span> init</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>unit_v</span></span> <span class="keyword">|</span> res<span class="keyword">:</span> <span class="staexp">init</span><span class="keyword">,</span> x1<span class="keyword">:</span> <span class="staexp">a1</span><span class="keyword">,</span> x2<span class="keyword">:</span> <span class="staexp">a2</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloref_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">init</span> <span class="keyword">=</span> f <span class="keyword">(</span>res<span class="keyword">,</span> x1<span class="keyword">,</span> x2<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_fold2_left_funenv&lt;<span class="staexp">init</span><span class="keyword">&gt;&lt;</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloref_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> app<span class="keyword">,</span> res<span class="keyword">,</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_fold2_left_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">sink</span><span class="keyword">}</span>
list_fold_right_funenv
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> f<span class="keyword">,</span> xs<span class="keyword">,</span> res<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span>
    <span class="keyword">|</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">,</span> sink<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">,</span>f<span class="keyword">&gt;</span> sink</span>
    <span class="keyword">,</span> xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp">sink</span>
    <span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">sink</span> <span class="keyword">=</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> x :: xs <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> res <span class="keyword">=</span> loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> f<span class="keyword">,</span> xs<span class="keyword">,</span> res<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">in</span> f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x<span class="keyword">,</span> res<span class="keyword">,</span> env<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [::]
</span>    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> res
  <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> f<span class="keyword">,</span> xs<span class="keyword">,</span> res<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_fold_right_funenv]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">sink</span><span class="keyword">}</span>
list_fold_right_fun <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>f<span class="keyword">,</span> xs<span class="keyword">,</span> res<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> f <span class="keyword">=</span> coerce <span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span> <span class="keyword">extern</span>
    <span class="keyword">castfn</span> <a name="24575"><span class="dyncstdec">coerce <span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>a<span class="keyword">,</span> sink<span class="keyword">)</span> <span class="keyword">-&lt;</span>f<span class="keyword">&gt;</span> sink</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>unit_v <span class="keyword">|</span> a<span class="keyword">,</span> sink<span class="keyword">,</span> <span class="keyword">!</span>ptr<span class="keyword">)</span> <span class="keyword">-&lt;</span>f<span class="keyword">&gt;</span> sink</span></span></a>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_fold_right_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;&lt;</span><span class="staexp">sink</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> f<span class="keyword">,</span> xs<span class="keyword">,</span> res<span class="keyword">,</span> null<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_fold_right_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">sink</span><span class="keyword">}</span>
list_fold_right_clo
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>view<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> f<span class="keyword">,</span> xs<span class="keyword">,</span> res<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="24936"><span class="stacstdec">clo_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">,</span> sink<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">,</span>f<span class="keyword">&gt;</span> sink</span></a></span>
  <span class="keyword">stavar</span> <span class="staexp">l_f<span class="keyword">:</span> addr</span><span class="keyword">;</span> <span class="keyword">val</span> p_f<span class="keyword">:</span> <span class="staexp">ptr l_f</span> <span class="keyword">=</span> <span class="keyword">&amp;</span>f
  <span class="keyword">viewdef</span> <span class="staexp"><a name="25025"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>v<span class="keyword">,</span> clo_t @ l_f<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp">sink</span><span class="keyword">,</span> p_f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ptr l_f</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">sink</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> pf</span><span class="keyword">;</span> <span class="keyword">val</span> ans <span class="keyword">=</span> <span class="keyword">!</span>p_f <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> x<span class="keyword">,</span> res<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    ans
  <span class="keyword">end</span> <span class="comment">// end of [app]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">(</span>pf1<span class="keyword">,</span> view@ f<span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_fold_right_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;&lt;</span><span class="staexp">sink</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr l_f<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> app<span class="keyword">,</span> xs<span class="keyword">,</span> res<span class="keyword">,</span> p_f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf1 := pf<span class="keyword">.</span>0</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> view@ f := pf<span class="keyword">.</span>1</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_fold_right_clo]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">sink</span><span class="keyword">}</span>
list_fold_right_cloptr
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>view<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> f<span class="keyword">,</span> xs<span class="keyword">,</span> res<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="25543"><span class="stacstdec">cloptr_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">,</span> sink<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloptr<span class="keyword">,</span>f<span class="keyword">&gt;</span> sink</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp">sink</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloptr_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">sink</span> <span class="keyword">=</span> f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_fold_right_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;&lt;</span><span class="staexp">sink</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloptr_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> app<span class="keyword">,</span> xs<span class="keyword">,</span> res<span class="keyword">,</span> f<span class="keyword">)</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_fold_right_cloptr]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">sink</span><span class="keyword">}</span>
list_fold_right_cloref <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>f<span class="keyword">,</span> xs<span class="keyword">,</span> res<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="25873"><span class="stacstdec">cloref_t <span class="keyword">=</span> <span class="keyword">(</span>a<span class="keyword">,</span>sink<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">,</span>f<span class="keyword">&gt;</span> sink</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>unit_v</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp">sink</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloref_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">sink</span> <span class="keyword">=</span> f <span class="keyword">(</span>x<span class="keyword">,</span> res<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_fold_right_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;&lt;</span><span class="staexp">sink</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloref_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> app<span class="keyword">,</span> xs<span class="keyword">,</span> res<span class="keyword">,</span> f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_fold_right_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">sink</span><span class="keyword">}</span>
list_fold2_right_funenv
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> f<span class="keyword">,</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> res<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span>
    <span class="keyword">|</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a1<span class="keyword">,</span> a2<span class="keyword">,</span> sink<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">,</span>f<span class="keyword">&gt;</span> sink</span>
    <span class="keyword">,</span> xs1<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a1<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> xs2<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a2<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp">sink</span>
    <span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">sink</span> <span class="keyword">=</span> <span class="keyword">case+</span> xs1 <span class="keyword">of</span>
    <span class="keyword">|</span> x1 :: xs1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val+</span> x2 :: xs2 <span class="keyword">=</span> xs2<span class="keyword">;</span> <span class="keyword">val</span> res <span class="keyword">=</span> loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> f<span class="keyword">,</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> res<span class="keyword">,</span> env<span class="keyword">)</span>
      <span class="keyword">in</span>
        f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x1<span class="keyword">,</span> x2<span class="keyword">,</span> res<span class="keyword">,</span> env<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [::]
</span>    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> res
  <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> f<span class="keyword">,</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> res<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_fold2_right_funenv]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_forall_funenv <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> p<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span>
    <span class="keyword">|</span> xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">,</span>p<span class="keyword">&gt;</span> bool</span>
    <span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">p</span><span class="keyword">&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> x :: xs <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> p <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">then</span> loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> p<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">else</span> false
      <span class="keyword">end</span> <span class="comment">// end of [::]
</span>    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> true
  <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> p<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_forall_funenv]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_forall_fun <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">,</span> p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> p <span class="keyword">=</span> coerce <span class="keyword">(</span>p<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">extern</span> <span class="keyword">castfn</span> <a name="27331"><span class="dyncstdec">coerce <span class="keyword">(</span>p<span class="keyword">:</span> <span class="staexp">a <span class="keyword">-&lt;</span>p<span class="keyword">&gt;</span> bool</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>unit_v <span class="keyword">|</span> a<span class="keyword">,</span> <span class="keyword">!</span>ptr<span class="keyword">)</span> <span class="keyword">-&lt;</span>p<span class="keyword">&gt;</span> bool</span></span></a>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_forall_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> p<span class="keyword">,</span> null<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_forall_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_forall_clo
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="27635"><span class="stacstdec">clo_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">,</span>p<span class="keyword">&gt;</span> bool</span></a></span>
  <span class="keyword">stavar</span> <span class="staexp">l_f<span class="keyword">:</span> addr</span><span class="keyword">;</span> <span class="keyword">val</span> p_f<span class="keyword">:</span> <span class="staexp">ptr l_f</span> <span class="keyword">=</span> <span class="keyword">&amp;</span>f
  <span class="keyword">viewdef</span> <span class="staexp"><a name="27718"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>v<span class="keyword">,</span> clo_t @ l_f<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> p_f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ptr l_f</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">p</span><span class="keyword">&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val</span> ans <span class="keyword">=</span> <span class="keyword">!</span>p_f <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> x<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    ans
  <span class="keyword">end</span> <span class="comment">// end of [app]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">(</span>pf1<span class="keyword">,</span> view@ f<span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_forall_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr l_f<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> app<span class="keyword">,</span> p_f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf1 := pf<span class="keyword">.</span>0</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> view@ f := pf<span class="keyword">.</span>1</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_forall_clo]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_forall_cloptr
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="28187"><span class="stacstdec">cloptr_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloptr<span class="keyword">,</span>p<span class="keyword">&gt;</span> bool</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloptr_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">p</span><span class="keyword">&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> p <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x<span class="keyword">)</span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_forall_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloptr_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> app<span class="keyword">,</span> p<span class="keyword">)</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_forall_cloptr]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_forall_cloref <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">,</span> p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="28461"><span class="stacstdec">cloref_t <span class="keyword">=</span> a <span class="keyword">-&lt;</span>cloref<span class="keyword">,</span>p<span class="keyword">&gt;</span> bool</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>unit_v</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloref_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">p</span><span class="keyword">&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> p <span class="keyword">(</span>x<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_forall_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloref_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> app<span class="keyword">,</span> p<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_forall_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_forall2_funenv
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> p<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span>
    <span class="keyword">|</span> xs1<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a1<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> xs2<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a2<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a1<span class="keyword">,</span> a2<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">,</span>p<span class="keyword">&gt;</span> bool</span>
    <span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">p</span><span class="keyword">&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> xs1 <span class="keyword">of</span>
    <span class="keyword">|</span> x1 :: xs1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val+</span> x2 :: xs2 <span class="keyword">=</span> xs2
      <span class="keyword">in</span>
        <span class="keyword">if</span> p <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x1<span class="keyword">,</span> x2<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">then</span> loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> p<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">else</span> false
      <span class="keyword">end</span> <span class="comment">// end of [::]
</span>    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> true
  <span class="keyword">end</span> <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> p<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_forall2_funenv]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_forall2_fun <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> p <span class="keyword">=</span> coerce <span class="keyword">(</span>p<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span> <span class="keyword">extern</span> <span class="keyword">castfn</span>
    <a name="29399"><span class="dyncstdec">coerce <span class="keyword">(</span>p<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>a1<span class="keyword">,</span> a2<span class="keyword">)</span> <span class="keyword">-&lt;</span>p<span class="keyword">&gt;</span> bool</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>unit_v <span class="keyword">|</span> a1<span class="keyword">,</span> a2<span class="keyword">,</span> <span class="keyword">!</span>ptr<span class="keyword">)</span> <span class="keyword">-&lt;</span>p<span class="keyword">&gt;</span> bool</span></span></a>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_forall2_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> p<span class="keyword">,</span> null<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_forall2_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_forall2_clo
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="29742"><span class="stacstdec">clo_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a1<span class="keyword">,</span> a2<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">,</span>p<span class="keyword">&gt;</span> bool</span></a></span>
  <span class="keyword">stavar</span> <span class="staexp">l_f<span class="keyword">:</span> addr</span><span class="keyword">;</span> <span class="keyword">val</span> p_f<span class="keyword">:</span> <span class="staexp">ptr l_f</span> <span class="keyword">=</span> <span class="keyword">&amp;</span>f
  <span class="keyword">viewdef</span> <span class="staexp"><a name="29830"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>v<span class="keyword">,</span> clo_t @ l_f<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> x1<span class="keyword">:</span> <span class="staexp">a1</span><span class="keyword">,</span> x2<span class="keyword">:</span> <span class="staexp">a2</span><span class="keyword">,</span> p_f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ptr l_f</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">p</span><span class="keyword">&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> pf</span><span class="keyword">;</span> <span class="keyword">val</span> ans <span class="keyword">=</span> <span class="keyword">!</span>p_f <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> x1<span class="keyword">,</span> x2<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    ans
  <span class="keyword">end</span> <span class="comment">// end of [app]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">(</span>pf1<span class="keyword">,</span> view@ f<span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_forall2_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr l_f<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> app<span class="keyword">,</span> p_f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf1 := pf<span class="keyword">.</span>0</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> view@ f := pf<span class="keyword">.</span>1</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_forall2_clo]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_forall2_cloptr
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="30335"><span class="stacstdec">clo_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a1<span class="keyword">,</span> a2<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloptr<span class="keyword">,</span>p<span class="keyword">&gt;</span> bool</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> x1<span class="keyword">:</span> <span class="staexp">a1</span><span class="keyword">,</span> x2<span class="keyword">:</span> <span class="staexp">a2</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>clo_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">p</span><span class="keyword">&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> p <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x1<span class="keyword">,</span> x2<span class="keyword">)</span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_forall2_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>clo_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> app<span class="keyword">,</span> p<span class="keyword">)</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_forall2_cloptr]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_forall2_cloref <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>p<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> p<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="30651"><span class="stacstdec">clo_t <span class="keyword">=</span> <span class="keyword">(</span>a1<span class="keyword">,</span> a2<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">,</span>p<span class="keyword">&gt;</span> bool</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>unit_v</span></span> <span class="keyword">|</span> x1<span class="keyword">:</span> <span class="staexp">a1</span><span class="keyword">,</span> x2<span class="keyword">:</span> <span class="staexp">a2</span><span class="keyword">,</span> p<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>clo_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">p</span><span class="keyword">&gt;</span> <span class="staexp">bool</span> <span class="keyword">=</span> p <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_forall2_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>clo_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> app<span class="keyword">,</span> p<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_forall2_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_foreach_funenv
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span>
    <span class="keyword">|</span> xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span>
    <span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> x :: xs <span class="keyword">=&gt;</span> <span class="keyword">(</span>f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">;</span> loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_foreach]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_foreach_fun <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> f <span class="keyword">=</span> coerce <span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span> <span class="keyword">extern</span> <span class="keyword">castfn</span>
    <a name="31425"><span class="dyncstdec">coerce <span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>a<span class="keyword">)</span> <span class="keyword">-&lt;</span>f<span class="keyword">&gt;</span> void</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>unit_v <span class="keyword">|</span> a<span class="keyword">,</span> <span class="keyword">!</span>ptr<span class="keyword">)</span> <span class="keyword">-&lt;</span>f<span class="keyword">&gt;</span> void</span></span></a>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> list_foreach_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">,</span> null<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [list_foreach_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_foreach_clo <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="31740"><span class="stacstdec">clo_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">stavar</span> <span class="staexp">l_f<span class="keyword">:</span> addr</span><span class="keyword">;</span> <span class="keyword">val</span> p_f<span class="keyword">:</span> <span class="staexp">ptr l_f</span> <span class="keyword">=</span> <span class="keyword">&amp;</span>f
  <span class="keyword">viewdef</span> <span class="staexp"><a name="31823"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>v<span class="keyword">,</span> clo_t @ l_f<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> p_f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ptr l_f</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p_f <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> x<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">}</span> <span class="comment">// end of [val]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">(</span>pf1<span class="keyword">,</span> view@ f<span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_foreach_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr l_f<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> app<span class="keyword">,</span> p_f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf1 := pf<span class="keyword">.</span>0 <span class="keyword">and</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> view@ f := pf<span class="keyword">.</span>1</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_foreach_clo]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_foreach_cloptr
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="32282"><span class="stacstdec">cloptr_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloptr<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloptr_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> list_foreach_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloptr_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> app<span class="keyword">,</span> f<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [list_foreach_cloptr]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_foreach_cloref <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="32563"><span class="stacstdec">cloref_t <span class="keyword">=</span> <span class="keyword">(</span>a<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>unit_v</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloref_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> f <span class="keyword">(</span>x<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> list_foreach_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloref_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> app<span class="keyword">,</span> f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [list_foreach_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_foreach2_funenv
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span>
    <span class="keyword">|</span> xs1<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a1<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> xs2<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a2<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a1<span class="keyword">,</span> a2<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span>
    <span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">case+</span> xs1 <span class="keyword">of</span>
    <span class="keyword">|</span> x1 :: xs1 <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> x2 :: xs2 <span class="keyword">=</span> xs2
      <span class="keyword">in</span>
        f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x1<span class="keyword">,</span> x2<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">;</span> loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_foreach2_funenv]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_foreach2_fun <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> f <span class="keyword">=</span> coerce <span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span> <span class="keyword">extern</span> <span class="keyword">castfn</span>
    <a name="33460"><span class="dyncstdec">coerce <span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>a1<span class="keyword">,</span> a2<span class="keyword">)</span> <span class="keyword">-&lt;</span>f<span class="keyword">&gt;</span> void</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>unit_v <span class="keyword">|</span> a1<span class="keyword">,</span> a2<span class="keyword">,</span> <span class="keyword">!</span>ptr<span class="keyword">)</span> <span class="keyword">-&lt;</span>f<span class="keyword">&gt;</span> void</span></span></a>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> list_foreach2_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> ys<span class="keyword">,</span> f<span class="keyword">,</span> null<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [list_foreach2_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_foreach2_clo
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="33808"><span class="stacstdec">clo_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a1<span class="keyword">,</span> a2<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">stavar</span> <span class="staexp">l_f<span class="keyword">:</span> addr</span><span class="keyword">;</span> <span class="keyword">val</span> p_f<span class="keyword">:</span> <span class="staexp">ptr l_f</span> <span class="keyword">=</span> <span class="keyword">&amp;</span>f
  <span class="keyword">viewdef</span> <span class="staexp"><a name="33896"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>v<span class="keyword">,</span> clo_t @ l_f<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> x1<span class="keyword">:</span> <span class="staexp">a1</span><span class="keyword">,</span> x2<span class="keyword">:</span> <span class="staexp">a2</span><span class="keyword">,</span> p_f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ptr l_f</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p_f <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> x1<span class="keyword">,</span> x2<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">}</span> <span class="comment">// end of [val]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">(</span>pf1<span class="keyword">,</span> view@ f<span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> list_foreach2_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr l_f<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> app<span class="keyword">,</span> p_f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf1 := pf<span class="keyword">.</span>0 <span class="keyword">and</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> view@ f := pf<span class="keyword">.</span>1</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [list_foreach2_clo]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_foreach2_cloptr
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="34401"><span class="stacstdec">cloptr_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a1<span class="keyword">,</span> a2<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloptr<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> x1<span class="keyword">:</span> <span class="staexp">a1</span><span class="keyword">,</span> x2<span class="keyword">:</span> <span class="staexp">a2</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloptr_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span>
    f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x1<span class="keyword">,</span> x2<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    list_foreach2_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloptr_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> app<span class="keyword">,</span> f<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [list_foreach2_cloptr]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_foreach2_cloref <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="34765"><span class="stacstdec">cloref_t <span class="keyword">=</span> <span class="keyword">(</span>a1<span class="keyword">,</span> a2<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>unit_v</span></span> <span class="keyword">|</span> x1<span class="keyword">:</span> <span class="staexp">a1</span><span class="keyword">,</span> x2<span class="keyword">:</span> <span class="staexp">a2</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloref_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span>
    f <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    list_foreach2_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloref_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> app<span class="keyword">,</span> f<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span>  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [list_foreach2_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_iforeach_funenv
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="35211"><span class="stacstdec">cloptr_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> natLt n<span class="keyword">,</span> a<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>i<span class="keyword">,</span>j<span class="keyword">:</span>nat <span class="keyword">|</span> i+j==n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>j<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span>
    <span class="keyword">|</span> i<span class="keyword">:</span> <span class="staexp">int i</span>
    <span class="keyword">,</span> xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> j<span class="keyword">)</span></span>
    <span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloptr_t</span>
    <span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> x :: xs <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> i<span class="keyword">,</span> x<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">;</span> loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> i+1<span class="keyword">,</span> xs<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [::]
</span>    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> 0<span class="keyword">,</span> xs<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_iforeach_funenv]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_iforeach_fun <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> f <span class="keyword">=</span> coerce <span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span> <span class="keyword">extern</span> <span class="keyword">castfn</span>
    <a name="35736"><span class="dyncstdec">coerce <span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>natLt n<span class="keyword">,</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>f<span class="keyword">&gt;</span> void</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>unit_v <span class="keyword">|</span> natLt n<span class="keyword">,</span> a<span class="keyword">,</span> <span class="keyword">!</span>ptr<span class="keyword">)</span> <span class="keyword">-&lt;</span>f<span class="keyword">&gt;</span> void</span></span></a>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> list_iforeach_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">,</span> null<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [list_iforeach_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_iforeach_clo <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="36076"><span class="stacstdec">clo_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> natLt n<span class="keyword">,</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">stavar</span> <span class="staexp">l_f<span class="keyword">:</span> addr</span><span class="keyword">;</span> <span class="keyword">val</span> p_f<span class="keyword">:</span> <span class="staexp">ptr l_f</span> <span class="keyword">=</span> <span class="keyword">&amp;</span>f
  <span class="keyword">viewdef</span> <span class="staexp"><a name="36168"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>v<span class="keyword">,</span> clo_t @ l_f<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> i<span class="keyword">:</span> <span class="staexp">natLt n</span><span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> p_f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ptr l_f</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p_f <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> i<span class="keyword">,</span> x<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">}</span> <span class="comment">// end of [val]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">(</span>pf1<span class="keyword">,</span> view@ f<span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> list_iforeach_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr l_f<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> app<span class="keyword">,</span> p_f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf1 := pf<span class="keyword">.</span>0 <span class="keyword">and</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> view@ f := pf<span class="keyword">.</span>1</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [list_iforeach_clo]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_iforeach_cloptr
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="36674"><span class="stacstdec">cloptr_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> natLt n<span class="keyword">,</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloptr<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> i<span class="keyword">:</span> <span class="staexp">natLt n</span><span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloptr_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> i<span class="keyword">,</span> x<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> list_iforeach_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloptr_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> app<span class="keyword">,</span> f<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [list_iforeach_cloptr]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_iforeach_cloref <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="37007"><span class="stacstdec">cloref_t <span class="keyword">=</span> <span class="keyword">(</span>natLt n<span class="keyword">,</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>unit_v</span></span> <span class="keyword">|</span> i<span class="keyword">:</span> <span class="staexp">natLt n</span><span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloref_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> f <span class="keyword">(</span>i<span class="keyword">,</span> x<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> list_iforeach_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloref_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> app<span class="keyword">,</span> f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [list_iforeach_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_iforeach2_funenv
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="37422"><span class="stacstdec">cloptr_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> natLt n<span class="keyword">,</span> a1<span class="keyword">,</span> a2<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>i<span class="keyword">,</span>j<span class="keyword">:</span>nat <span class="keyword">|</span> i+j==n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>j<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span>
    <span class="keyword">|</span> i<span class="keyword">:</span> <span class="staexp">int i</span><span class="keyword">,</span> xs1<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a1<span class="keyword">,</span> j<span class="keyword">)</span></span><span class="keyword">,</span> xs2<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a2<span class="keyword">,</span> j<span class="keyword">)</span></span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloptr_t</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> <span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">)</span> <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">(</span>x1 :: xs1<span class="keyword">,</span> x2 :: xs2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> i<span class="keyword">,</span> x1<span class="keyword">,</span> x2<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">;</span> loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> i+1<span class="keyword">,</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [::, ::]
</span>    <span class="keyword">|</span> <span class="keyword">(</span>nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> 0<span class="keyword">,</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_iforeach2_funenv]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_iforeach2_fun <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> f <span class="keyword">=</span> coerce <span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span> <span class="keyword">extern</span> <span class="keyword">castfn</span>
    <a name="38018"><span class="dyncstdec">coerce <span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>natLt n<span class="keyword">,</span> a1<span class="keyword">,</span> a2<span class="keyword">)</span> <span class="keyword">-&lt;</span>f<span class="keyword">&gt;</span> void</span><span class="keyword">)</span>
      <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>unit_v <span class="keyword">|</span> natLt n<span class="keyword">,</span> a1<span class="keyword">,</span> a2<span class="keyword">,</span> <span class="keyword">!</span>ptr<span class="keyword">)</span> <span class="keyword">-&lt;</span>f<span class="keyword">&gt;</span> void</span></span></a>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> list_iforeach2_funenv <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> ys<span class="keyword">,</span> f<span class="keyword">,</span> null<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [list_foreach2_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_iforeach2_clo
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="38390"><span class="stacstdec">clo_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> natLt n<span class="keyword">,</span> a1<span class="keyword">,</span> a2<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">stavar</span> <span class="staexp">l_f<span class="keyword">:</span> addr</span><span class="keyword">;</span> <span class="keyword">val</span> p_f<span class="keyword">:</span> <span class="staexp">ptr l_f</span> <span class="keyword">=</span> <span class="keyword">&amp;</span>f
  <span class="keyword">viewdef</span> <span class="staexp"><a name="38487"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>v<span class="keyword">,</span> clo_t @ l_f<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> i<span class="keyword">:</span> <span class="staexp">natLt n</span><span class="keyword">,</span> x1<span class="keyword">:</span> <span class="staexp">a1</span><span class="keyword">,</span> x2<span class="keyword">:</span> <span class="staexp">a2</span><span class="keyword">,</span> p_f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ptr l_f</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>p_f <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> i<span class="keyword">,</span> x1<span class="keyword">,</span> x2<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">}</span> <span class="comment">// end of [val]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">(</span>pf1<span class="keyword">,</span> view@ f<span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_iforeach2_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr l_f<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> app<span class="keyword">,</span> p_f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf1 := pf<span class="keyword">.</span>0 <span class="keyword">and</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> view@ f := pf<span class="keyword">.</span>1</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_iforeach2_clo]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_iforeach2_cloptr
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="39006"><span class="stacstdec">cloptr_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> natLt n<span class="keyword">,</span> a1<span class="keyword">,</span> a2<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloptr<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> i<span class="keyword">:</span> <span class="staexp">natLt n</span><span class="keyword">,</span> x1<span class="keyword">:</span> <span class="staexp">a1</span><span class="keyword">,</span> x2<span class="keyword">:</span> <span class="staexp">a2</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloptr_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span>
    f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> i<span class="keyword">,</span> x1<span class="keyword">,</span> x2<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    list_iforeach2_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloptr_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> app<span class="keyword">,</span> f<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [list_iforeach2_cloptr]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_iforeach2_cloref <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="39401"><span class="stacstdec">cloref_t <span class="keyword">=</span> <span class="keyword">(</span>natLt n<span class="keyword">,</span> a1<span class="keyword">,</span> a2<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">,</span>f<span class="keyword">&gt;</span> void</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>unit_v</span></span> <span class="keyword">|</span> i<span class="keyword">:</span> <span class="staexp">natLt n</span><span class="keyword">,</span> x1<span class="keyword">:</span> <span class="staexp">a1</span><span class="keyword">,</span> x2<span class="keyword">:</span> <span class="staexp">a2</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloref_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span>
    f <span class="keyword">(</span>i<span class="keyword">,</span> x1<span class="keyword">,</span> x2<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
    list_iforeach2_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloref_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> app<span class="keyword">,</span> f<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span>  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  <span class="comment">// empty
</span><span class="keyword">end</span> <span class="comment">// end of [list_iforeach2_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_get_elt_at <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">,</span>i<span class="keyword">:</span>nat <span class="keyword">|</span> i <span class="keyword">&lt;</span> n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int i</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">a</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> x :: xs <span class="keyword">=</span> xs
  <span class="keyword">in</span>
    <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> loop <span class="keyword">(</span>xs<span class="keyword">,</span> i - 1<span class="keyword">)</span> <span class="keyword">else</span> x
  <span class="keyword">end</span> <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_get_elt_at]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_nth <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">=</span> list_get_elt_at&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_get_elt_at_exn <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">,</span>i<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> 
    <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int i</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="keyword">!</span><span class="staexp">exn</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">[</span>n<span class="keyword">&gt;</span>0<span class="keyword">]</span> a</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> x :: xs <span class="keyword">=&gt;</span> <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> loop <span class="keyword">(</span>xs<span class="keyword">,</span> i - 1<span class="keyword">)</span> <span class="keyword">else</span> x
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">$raise</span> ListSubscriptException <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_get_elt_at_exn]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_nth_exn <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">=</span> list_get_elt_at_exn&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_get_elt_at_opt <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">,</span>i<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int i</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">Option_vt a</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> x :: xs <span class="keyword">=&gt;</span> <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> loop <span class="keyword">(</span>xs<span class="keyword">,</span> i - 1<span class="keyword">)</span> <span class="keyword">else</span> Some_vt x
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_get_elt_at_opt]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_nth_opt <span class="keyword">(</span>xs<span class="keyword">,</span> n<span class="keyword">)</span> <span class="keyword">=</span> list_get_elt_at_opt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>xs<span class="keyword">,</span> n<span class="keyword">)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_head <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span> <span class="keyword">val</span> x :: _ <span class="keyword">=</span> xs <span class="keyword">in</span> x <span class="keyword">end</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_head_exn <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case</span> xs <span class="keyword">of</span>
  <span class="keyword">|</span> x :: _ <span class="keyword">=&gt;</span> x <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">$raise</span> ListSubscriptException
<span class="comment">// end of [list_hean_exn]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span>
list_is_empty <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> xs <span class="keyword">of</span> cons _ <span class="keyword">=&gt;</span> false <span class="keyword">|</span> nil _ <span class="keyword">=&gt;</span> true
<span class="keyword">end</span> <span class="comment">// end of [list_is_empty]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="keyword">}</span>
list_isnot_empty <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> xs <span class="keyword">of</span> _ :: _ <span class="keyword">=&gt;</span> true <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> false
<span class="keyword">end</span> <span class="comment">// end of [list_is_not_empty]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_last <span class="keyword">(</span>xs0<span class="keyword">)</span> <span class="keyword">=</span>
  loop <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span>x0<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">a</span> <span class="keyword">=</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> list_cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=&gt;</span> loop <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> x0
  <span class="comment">// end of [loop]
</span>  <span class="keyword">val+</span> list_cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=</span> xs0
<span class="keyword">}</span> <span class="comment">// end of [list_last]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_last_exn <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> xs <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons _ <span class="keyword">=&gt;</span> list_last <span class="keyword">(</span>xs<span class="keyword">)</span>
  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">$raise</span> ListSubscriptException
<span class="comment">// end of [list_last_exn]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_last_opt <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
  <span class="keyword">|</span> list_cons _ <span class="keyword">=&gt;</span> Some_vt <span class="keyword">(</span>list_last <span class="keyword">(</span>xs<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None_vt
<span class="comment">// end of [list_last_opt]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_length <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>i<span class="keyword">,</span>j<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>i<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> i<span class="keyword">)</span></span><span class="keyword">,</span> j<span class="keyword">:</span> <span class="staexp">int j</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">int <span class="keyword">(</span>i+j<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> xs <span class="keyword">of</span>  _ :: xs <span class="keyword">=&gt;</span> loop <span class="keyword">(</span>xs<span class="keyword">,</span> isucc j<span class="keyword">)</span> <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> j
  <span class="keyword">end</span> <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span>xs<span class="keyword">,</span> 0<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_length]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">b</span><span class="keyword">}</span>
list_map_funenv
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="42300"><span class="stacstdec">fun_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">,</span>f<span class="keyword">&gt;</span> b</span></a></span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span>
    <span class="keyword">|</span> xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp">fun_t</span>
    <span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><span class="keyword">(</span>List_vt b<span class="keyword">)</span>? &gt;&gt; list_vt <span class="keyword">(</span>b<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> x :: xs <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> y <span class="keyword">=</span> f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x<span class="keyword">,</span> env<span class="keyword">)</span>
        <span class="keyword">val+</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>res := list_vt_cons <span class="staexp"><span class="keyword">{</span>b<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span>y<span class="keyword">,</span> ?<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">val+</span> list_vt_cons <span class="keyword">(</span>_<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span> <span class="keyword">=</span> res
      <span class="keyword">in</span>
        loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">;</span> fold@ res
      <span class="keyword">end</span> <span class="comment">// end of [::]
</span>    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>res := list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [loop]
</span>  <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp">List_vt b</span> <span class="comment">// uninitialized
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">,</span> res<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">;</span> res
<span class="keyword">end</span> <span class="comment">// end of [list_map_funenv]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">b</span><span class="keyword">}</span>
list_map_fun <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> f <span class="keyword">=</span> coerce <span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
    <span class="keyword">extern</span> <span class="keyword">castfn</span> <a name="43003"><span class="dyncstdec">coerce <span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp">a <span class="keyword">-&lt;</span>f<span class="keyword">&gt;</span> b</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>unit_v <span class="keyword">|</span> a<span class="keyword">,</span> <span class="keyword">!</span>ptr<span class="keyword">)</span> <span class="keyword">-&lt;</span>f<span class="keyword">&gt;</span> b</span></span></a>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> ys <span class="keyword">=</span> list_map_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;&lt;</span><span class="staexp">b</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">,</span> null<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  ys
<span class="keyword">end</span> <span class="comment">// end of [list_map_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">b</span><span class="keyword">}</span>
list_map_clo
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="43308"><span class="stacstdec">clo_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">,</span>f<span class="keyword">&gt;</span> b</span></a></span>
  <span class="keyword">stavar</span> <span class="staexp">l_f<span class="keyword">:</span> addr</span><span class="keyword">;</span> <span class="keyword">val</span> p_f<span class="keyword">:</span> <span class="staexp">ptr l_f</span> <span class="keyword">=</span> <span class="keyword">&amp;</span>f
  <span class="keyword">viewdef</span> <span class="staexp"><a name="43388"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>v<span class="keyword">,</span> clo_t @ l_f<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> p_f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ptr l_f</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">b</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val</span> ans <span class="keyword">=</span> <span class="keyword">!</span>p_f <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> x<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    ans
  <span class="keyword">end</span> <span class="comment">// end of [app]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">(</span>pf1<span class="keyword">,</span> view@ f<span class="keyword">)</span></span>
  <span class="keyword">val</span> ys <span class="keyword">=</span> list_map_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;&lt;</span><span class="staexp">b</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr l_f<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> app<span class="keyword">,</span> p_f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf1 := pf<span class="keyword">.</span>0</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> view@ f := pf<span class="keyword">.</span>1</span>
<span class="keyword">in</span>
  ys
<span class="keyword">end</span> <span class="comment">// end of [list_map_clo]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">b</span><span class="keyword">}</span>
list_map_cloptr
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="43857"><span class="stacstdec">cloptr_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloptr<span class="keyword">,</span>f<span class="keyword">&gt;</span> b</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloptr_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">b</span> <span class="keyword">=</span> f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x<span class="keyword">)</span>
  <span class="keyword">val</span> ys <span class="keyword">=</span> list_map_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;&lt;</span><span class="staexp">b</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloptr_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> app<span class="keyword">,</span> f<span class="keyword">)</span>
<span class="keyword">in</span>
  ys
<span class="keyword">end</span> <span class="comment">// end of [list_map_cloptr]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">b</span><span class="keyword">}</span>
list_map_cloref <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>int<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="44128"><span class="stacstdec">cloref_t <span class="keyword">=</span> a <span class="keyword">-&lt;</span>cloref<span class="keyword">,</span>f<span class="keyword">&gt;</span> b</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>unit_v</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloref_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">b</span> <span class="keyword">=</span> f <span class="keyword">(</span>x<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> ys <span class="keyword">=</span> list_map_funenv&lt;<span class="staexp">a</span><span class="keyword">&gt;&lt;</span><span class="staexp">b</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloref_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> app<span class="keyword">,</span> f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  ys
<span class="keyword">end</span> <span class="comment">// end of [list_map_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">b</span><span class="keyword">}</span>
list_map2_funenv
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">:</span>view<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>vt<span class="keyword">:</span>viewtype<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> ys<span class="keyword">,</span> f<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp">List_vt b?</span> <span class="comment">// uninitialized
</span>  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      <span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span>
    <span class="keyword">|</span> xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a1<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> ys<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a2<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a1<span class="keyword">,</span> a2<span class="keyword">,</span> <span class="keyword">!</span>vt<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">,</span>f<span class="keyword">&gt;</span> b</span>
    <span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><span class="keyword">(</span>List_vt b<span class="keyword">)</span>? &gt;&gt; list_vt <span class="keyword">(</span>b<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>vt</span>
  <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">)</span> <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">(</span>x :: xs<span class="keyword">,</span> y :: ys<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> z <span class="keyword">=</span> f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x<span class="keyword">,</span> y<span class="keyword">,</span> env<span class="keyword">)</span>
        <span class="keyword">val+</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>res := list_vt_cons <span class="staexp"><span class="keyword">{</span>b<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span>z<span class="keyword">,</span> ?<span class="keyword">)</span><span class="keyword">)</span>
        <span class="keyword">val+</span> list_vt_cons <span class="keyword">(</span>_<span class="keyword">,</span> <span class="keyword">!</span>p_res1<span class="keyword">)</span> <span class="keyword">=</span> res
      <span class="keyword">in</span>
        loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> ys<span class="keyword">,</span> f<span class="keyword">,</span> <span class="keyword">!</span>p_res1<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">;</span> fold@ res
      <span class="keyword">end</span>
    <span class="keyword">|</span> <span class="keyword">(</span>nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>res := list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> ys<span class="keyword">,</span> f<span class="keyword">,</span> res<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">;</span> res
<span class="keyword">end</span> <span class="comment">// end of [list_map2_funenv]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">b</span><span class="keyword">}</span>
list_map2_fun <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> f <span class="keyword">=</span> coerce <span class="keyword">(</span>f<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span> <span class="keyword">extern</span> <span class="keyword">castfn</span>
    <a name="45257"><span class="dyncstdec">coerce <span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>a1<span class="keyword">,</span> a2<span class="keyword">)</span> <span class="keyword">-&lt;</span>f<span class="keyword">&gt;</span> b</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">(</span><span class="keyword">!</span>unit_v <span class="keyword">|</span> a1<span class="keyword">,</span> a2<span class="keyword">,</span> <span class="keyword">!</span>ptr<span class="keyword">)</span> <span class="keyword">-&lt;</span>f<span class="keyword">&gt;</span> b</span></span></a>
  <span class="keyword">}</span> <span class="comment">// end of [where]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> zs <span class="keyword">=</span> list_map2_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;&lt;</span><span class="staexp">b</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span><span class="keyword">..</span><span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> ys<span class="keyword">,</span> f<span class="keyword">,</span> null<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  zs
<span class="keyword">end</span> <span class="comment">// end of [list_map2_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">b</span><span class="keyword">}</span>
list_map2_clo
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="45587"><span class="stacstdec">clo_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a1<span class="keyword">,</span> a2<span class="keyword">)</span> <span class="keyword">-&lt;</span>clo<span class="keyword">,</span>f<span class="keyword">&gt;</span> b</span></a></span>
  <span class="keyword">stavar</span> <span class="staexp">l_f<span class="keyword">:</span> addr</span><span class="keyword">;</span> <span class="keyword">val</span> p_f<span class="keyword">:</span> <span class="staexp">ptr l_f</span> <span class="keyword">=</span> <span class="keyword">&amp;</span>f
  <span class="keyword">viewdef</span> <span class="staexp"><a name="45672"><span class="stacstdec">V <span class="keyword">=</span> <span class="keyword">(</span>v<span class="keyword">,</span> clo_t @ l_f<span class="keyword">)</span></span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>V</span></span> <span class="keyword">|</span> x1<span class="keyword">:</span> <span class="staexp">a1</span><span class="keyword">,</span> x2<span class="keyword">:</span> <span class="staexp">a2</span><span class="keyword">,</span> p_f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>ptr l_f</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">b</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span> <span class="keyword">=</span> pf</span>
    <span class="keyword">val</span> ans <span class="keyword">=</span> <span class="keyword">!</span>p_f <span class="keyword">(</span><span class="prfexp">pf1</span> <span class="keyword">|</span> x1<span class="keyword">,</span> x2<span class="keyword">)</span>
    <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf := <span class="keyword">(</span>pf1<span class="keyword">,</span> pf2<span class="keyword">)</span></span>
  <span class="keyword">in</span>
    ans
  <span class="keyword">end</span> <span class="comment">// end of [app]
</span>  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> <span class="keyword">(</span>pf1<span class="keyword">,</span> view@ f<span class="keyword">)</span></span>
  <span class="keyword">val</span> ans <span class="keyword">=</span> list_map2_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;&lt;</span><span class="staexp">b</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>V<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>ptr l_f<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> app<span class="keyword">,</span> p_f<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf1 := pf<span class="keyword">.</span>0</span>
  <span class="keyword">prval</span> <span class="prfexp"><span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> view@ f := pf<span class="keyword">.</span>1</span>
<span class="keyword">in</span>
  ans
<span class="keyword">end</span> <span class="comment">// end of [list_map2_clo]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">b</span><span class="keyword">}</span>
list_map2_cloptr
  <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> ys<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">viewtypedef</span> <span class="staexp"><a name="46175"><span class="stacstdec">cloptr_t <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">!</span>v <span class="keyword">|</span> a1<span class="keyword">,</span> a2<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloptr<span class="keyword">,</span>f<span class="keyword">&gt;</span> b</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>v</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a1</span><span class="keyword">,</span> y<span class="keyword">:</span> <span class="staexp">a2</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloptr_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">b</span> <span class="keyword">=</span> f <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> x<span class="keyword">,</span> y<span class="keyword">)</span>
  <span class="keyword">val</span> zs <span class="keyword">=</span> <span class="keyword">begin</span>
    list_map2_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;&lt;</span><span class="staexp">b</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloptr_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> ys<span class="keyword">,</span> app<span class="keyword">,</span> f<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span><span class="keyword">in</span>
  zs
<span class="keyword">end</span>  <span class="comment">// end of [list_map2_cloptr]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">b</span><span class="keyword">}</span>
list_map2_cloref <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="46510"><span class="stacstdec">cloref_t <span class="keyword">=</span> <span class="keyword">(</span>a1<span class="keyword">,</span> a2<span class="keyword">)</span> <span class="keyword">-&lt;</span>cloref<span class="keyword">,</span>f<span class="keyword">&gt;</span> b</span></a></span>
  <span class="keyword">fn</span> app <span class="keyword">(</span><span class="prfexp">pf<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>unit_v</span></span> <span class="keyword">|</span> x<span class="keyword">:</span> <span class="staexp">a1</span><span class="keyword">,</span> y<span class="keyword">:</span> <span class="staexp">a2</span><span class="keyword">,</span> f<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>cloref_t</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">b</span> <span class="keyword">=</span> f <span class="keyword">(</span>x<span class="keyword">,</span> y<span class="keyword">)</span>
  <span class="keyword">prval</span> <span class="prfexp">pf <span class="keyword">=</span> unit_v <span class="keyword">(</span><span class="keyword">)</span></span>
  <span class="keyword">val</span> zs <span class="keyword">=</span> <span class="keyword">begin</span>
    list_map2_funenv&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;&lt;</span><span class="staexp">b</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">{</span>unit_v<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>cloref_t<span class="keyword">}</span></span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> ys<span class="keyword">,</span> app<span class="keyword">,</span> f<span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [val]
</span>  <span class="keyword">prval</span> <span class="prfexp">unit_v <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> pf</span>
<span class="keyword">in</span>
  zs
<span class="keyword">end</span>  <span class="comment">// end of [list_map2_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_reverse_append <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n1<span class="keyword">,</span>n2<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n1<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n1<span class="keyword">)</span></span><span class="keyword">,</span> ys<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n2<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n1+n2<span class="keyword">)</span></span> <span class="keyword">=</span>
    <span class="keyword">case+</span> xs <span class="keyword">of</span> x :: xs <span class="keyword">=&gt;</span> loop <span class="keyword">(</span>xs<span class="keyword">,</span> x :: ys<span class="keyword">)</span> <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ys
<span class="keyword">in</span>
  loop <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_reverse_append]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_reverse_append1_vt <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">extern</span> <span class="keyword">castfn</span> <a name="47181"><span class="dyncstdec">__cast <span class="staexp"><span class="keyword">{</span>j<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="keyword">(</span>ys<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> j<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">list_vt <span class="keyword">(</span>a<span class="keyword">,</span> j<span class="keyword">)</span></span></span></a>
<span class="keyword">in</span>
  list_of_list_vt <span class="keyword">(</span>list_vt_reverse_append <span class="keyword">(</span>xs<span class="keyword">,</span> __cast <span class="keyword">(</span>ys<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_reverse_append1_vt]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_reverse_append2_vt <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n1<span class="keyword">,</span>n2<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n1<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n1<span class="keyword">)</span></span><span class="keyword">,</span> ys<span class="keyword">:</span> <span class="staexp">list_vt <span class="keyword">(</span>a<span class="keyword">,</span> n2<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">list_vt <span class="keyword">(</span>a<span class="keyword">,</span> n1+n2<span class="keyword">)</span></span> <span class="keyword">=</span>
    <span class="keyword">case+</span> xs <span class="keyword">of</span> x :: xs <span class="keyword">=&gt;</span> loop <span class="keyword">(</span>xs<span class="keyword">,</span> list_vt_cons <span class="keyword">(</span>x<span class="keyword">,</span> ys<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ys
<span class="keyword">in</span>
  loop <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_reverse_append2_vt]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_reverse <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span>
  list_reverse_append2_vt&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>xs<span class="keyword">,</span> list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="comment">// end of [list_reverse]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_set_elt_at <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">,</span> x0<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp">List a</span> <span class="comment">// uninitialized
</span>  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">,</span>i<span class="keyword">:</span>nat <span class="keyword">|</span> i <span class="keyword">&lt;</span> n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int i</span><span class="keyword">,</span> x0<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><span class="keyword">(</span>List a<span class="keyword">)</span>? &gt;&gt; list <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">)</span>
    <span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> x :: xs <span class="keyword">=</span> xs <span class="keyword">in</span>
    <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>res := cons <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span>x<span class="keyword">,</span> ?<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">val+</span> cons <span class="keyword">(</span>_<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span> <span class="keyword">=</span> res
    <span class="keyword">in</span>
      loop <span class="keyword">(</span>xs<span class="keyword">,</span> i-1<span class="keyword">,</span> x0<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span><span class="keyword">;</span> fold@ res
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
      res := cons <span class="keyword">(</span>x0<span class="keyword">,</span> xs<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span> <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">,</span> x0<span class="keyword">,</span> res<span class="keyword">)</span><span class="keyword">;</span> res
<span class="keyword">end</span> <span class="comment">// end of [list_set_elt_at]
</span>
<span class="keyword">local</span>

<span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> aux_test <span class="staexp"><span class="keyword">{</span>n<span class="keyword">,</span>i<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
  <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int i</span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">bool <span class="keyword">(</span>i <span class="keyword">&lt;</span> n<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
  <span class="keyword">case+</span> xs <span class="keyword">of</span>
  <span class="keyword">|</span> x :: xs <span class="keyword">=&gt;</span> <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> aux_test <span class="keyword">(</span>xs<span class="keyword">,</span> i-1<span class="keyword">)</span> <span class="keyword">else</span> true
  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> false
<span class="keyword">end</span> <span class="comment">// end of [aux_test]
</span>
<span class="keyword">in</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_set_elt_at_exn <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">,</span> x0<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">if</span> aux_test&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">then</span> list_set_elt_at <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">,</span> x0<span class="keyword">)</span>
  <span class="keyword">else</span> <span class="keyword">$raise</span> ListSubscriptException

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_set_elt_at_opt <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">,</span> x0<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">if</span> aux_test&lt;<span class="staexp">a</span><span class="keyword">&gt;</span> <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">then</span> Some_vt <span class="keyword">(</span>list_set_elt_at <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">,</span> x0<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">else</span> None_vt <span class="keyword">(</span><span class="keyword">)</span>

<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_split_at <span class="staexp"><span class="keyword">{</span>n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>i<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> fsts<span class="keyword">:</span> <span class="staexp">List_vt a?</span> <span class="comment">// uninitialized
</span>  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>j<span class="keyword">:</span>nat <span class="keyword">|</span> j &lt;= i<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>i-j<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n-j<span class="keyword">)</span></span><span class="keyword">,</span> ij<span class="keyword">:</span> <span class="staexp">int <span class="keyword">(</span>i-j<span class="keyword">)</span></span><span class="keyword">,</span> fsts<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><span class="keyword">(</span>List_vt a<span class="keyword">)</span>? &gt;&gt; list_vt <span class="keyword">(</span>a<span class="keyword">,</span> i-j<span class="keyword">)</span></span><span class="keyword">)</span>
    <span class="keyword">:&lt;&gt;</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n-i<span class="keyword">)</span></span> <span class="keyword">=</span>
    <span class="keyword">if</span> ij <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">val+</span> x :: xs <span class="keyword">=</span> xs
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>fsts := list_vt_cons <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span>x<span class="keyword">,</span> ?<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">val+</span> list_vt_cons <span class="keyword">(</span>_<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span> <span class="keyword">=</span> fsts
      <span class="keyword">val</span> snds <span class="keyword">=</span> loop <span class="staexp"><span class="keyword">{</span>j+1<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">,</span> ij - 1<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span>
    <span class="keyword">in</span>
      fold@ fsts<span class="keyword">;</span> snds
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
      fsts := list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> xs
    <span class="keyword">end</span>
  <span class="keyword">val</span> snds <span class="keyword">=</span> loop <span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">,</span> fsts<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">(</span>fsts<span class="keyword">,</span> snds<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_split_at]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_tail <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span> <span class="keyword">val</span> _ :: xs <span class="keyword">=</span> xs <span class="keyword">in</span> xs <span class="keyword">end</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_tail_exn <span class="keyword">(</span>xs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
  <span class="keyword">|</span> _ :: xs <span class="keyword">=&gt;</span> xs <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">$raise</span> ListSubscriptException

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_take <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp">List_vt a</span> <span class="comment">// uninitialized
</span>  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">,</span>i<span class="keyword">:</span>nat <span class="keyword">|</span> i &lt;= n<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>i<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int i</span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><span class="keyword">(</span>List_vt a<span class="keyword">)</span>? &gt;&gt; list_vt <span class="keyword">(</span>a<span class="keyword">,</span> i<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span>
    <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">let</span>
      <span class="keyword">val</span> x :: xs <span class="keyword">=</span> xs
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>res := list_vt_cons <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span>x<span class="keyword">,</span> ?<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">val+</span> list_vt_cons <span class="keyword">(</span>_<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span> <span class="keyword">=</span> res
    <span class="keyword">in</span>
      loop <span class="keyword">(</span>xs<span class="keyword">,</span> i-1<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span><span class="keyword">;</span> fold@ res
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
      res := list_vt_nil <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="comment">(* end of [loop] *)</span>
  <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">,</span> res<span class="keyword">)</span><span class="keyword">;</span> res
<span class="keyword">end</span> <span class="comment">// end of [list_take]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_take_exn <span class="staexp"><span class="keyword">{</span>n<span class="keyword">,</span>i<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">,</span>i<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>i<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int i</span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span>List_vt a? &gt;&gt; list_vt <span class="keyword">(</span>a<span class="keyword">,</span> j<span class="keyword">)</span></span><span class="keyword">)</span>
    <span class="keyword">:&lt;&gt;</span> <span class="staexp"><span class="keyword">#[</span>j<span class="keyword">:</span>nat <span class="keyword">|</span> <span class="keyword">(</span>i &lt;= n &amp;&amp; i == j<span class="keyword">)</span> || <span class="keyword">(</span>n <span class="keyword">&lt;</span> i &amp;&amp; n == j<span class="keyword">)</span><span class="keyword">]</span> bool <span class="keyword">(</span>n <span class="keyword">&lt;</span> i<span class="keyword">)</span></span>  <span class="keyword">=</span>
    <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> <span class="keyword">begin</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
      <span class="keyword">|</span> list_cons <span class="keyword">(</span>x<span class="keyword">,</span> xs<span class="keyword">)</span> <span class="keyword">=&gt;</span>
          <span class="keyword">(</span>fold@ res<span class="keyword">;</span> ans<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
          <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> res := list_vt_cons <span class="staexp"><span class="keyword">{</span>a<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span>x<span class="keyword">,</span> ?<span class="keyword">)</span>
          <span class="keyword">val+</span> list_vt_cons <span class="keyword">(</span>_<span class="keyword">,</span> <span class="keyword">!</span>p_res1<span class="keyword">)</span> <span class="keyword">=</span> res
          <span class="keyword">val</span> ans <span class="keyword">=</span> loop <span class="keyword">(</span>xs<span class="keyword">,</span> i-1<span class="keyword">,</span> <span class="keyword">!</span>p_res1<span class="keyword">)</span>
        <span class="keyword">}</span> <span class="comment">// end of [list_cons]
</span>      <span class="keyword">|</span> list_nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>res := list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> true<span class="comment">(*err*)</span><span class="keyword">)</span>
    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
      res := list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> false<span class="comment">(*err*)</span>
    <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
  <span class="comment">// end of [loop]    
</span>  <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp">List_vt a?</span> <span class="comment">// uninitialized
</span>  <span class="keyword">val</span> err <span class="keyword">=</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">,</span>i<span class="keyword">}</span></span> <span class="keyword">(</span>xs<span class="keyword">,</span> i<span class="keyword">,</span> res<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">if</span> err <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> list_vt_free res <span class="keyword">in</span> <span class="keyword">$raise</span> ListSubscriptException <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
    res <span class="comment">// i &lt;= n &amp;&amp; length (res) == i
</span>  <span class="keyword">end</span> <span class="comment">(* end of [if] *)</span>
<span class="keyword">end</span> <span class="comment">(* end of [list_take_exn] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">,</span><span class="staexp">b</span><span class="keyword">}</span>
list_zip <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">typedef</span> <span class="staexp"><a name="51151"><span class="stacstdec">ab <span class="keyword">=</span> <span class="keyword">@(</span>a<span class="keyword">,</span> b<span class="keyword">)</span></span></a></span>
  <span class="keyword">var</span> res<span class="keyword">:</span> <span class="staexp">List_vt ab</span> <span class="comment">// uninitialized
</span>  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>i<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>i<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span>xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> i<span class="keyword">)</span></span><span class="keyword">,</span> ys<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>b<span class="keyword">,</span> i<span class="keyword">)</span></span><span class="keyword">,</span> res<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><span class="keyword">(</span>List_vt ab<span class="keyword">)</span>? &gt;&gt; list_vt <span class="keyword">(</span>ab<span class="keyword">,</span> i<span class="keyword">)</span></span><span class="keyword">)</span><span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">)</span> <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">(</span>x :: xs<span class="keyword">,</span> y :: ys<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>res := list_vt_cons <span class="staexp"><span class="keyword">{</span>ab<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span><span class="keyword">@(</span>x<span class="keyword">,</span> y<span class="keyword">)</span><span class="keyword">,</span> ?<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">val+</span> list_vt_cons <span class="keyword">(</span>_<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span> <span class="keyword">=</span> res
      <span class="keyword">in</span>
        loop <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">,</span> <span class="keyword">!</span>p<span class="keyword">)</span><span class="keyword">;</span> fold@ res
      <span class="keyword">end</span> <span class="comment">// end of [::, ::]
</span>    <span class="keyword">|</span> <span class="keyword">(</span>nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>res := list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">in</span>
  loop <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">,</span> res<span class="keyword">)</span><span class="keyword">;</span> res
<span class="keyword">end</span> <span class="comment">// end of [list_zip]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">b</span><span class="keyword">}</span>
list_zipwth_fun
  <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> list_map2_fun&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;&lt;</span><span class="staexp">b</span><span class="keyword">&gt;</span> <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">,</span> f<span class="keyword">)</span>
<span class="comment">// end of [list_zipwth_fun]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">b</span><span class="keyword">}</span>
list_zipwth_clo
  <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> ys<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> list_map2_clo&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;&lt;</span><span class="staexp">b</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> ys<span class="keyword">,</span> f<span class="keyword">)</span>
<span class="comment">// end of [list_zipwth_clo]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">b</span><span class="keyword">}</span>
list_zipwth_cloptr
  <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> ys<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> list_map2_cloptr&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;&lt;</span><span class="staexp">b</span><span class="keyword">&gt;</span> <span class="keyword">(</span><span class="prfexp">pf</span> <span class="keyword">|</span> xs<span class="keyword">,</span> ys<span class="keyword">,</span> f<span class="keyword">)</span>
<span class="comment">// end of [list_zipwth_cloptr]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span><span class="keyword">{</span><span class="staexp">b</span><span class="keyword">}</span>
list_zipwth_cloref
  <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">,</span> f<span class="keyword">)</span> <span class="keyword">=</span> list_map2_cloref&lt;<span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">&gt;&lt;</span><span class="staexp">b</span><span class="keyword">&gt;</span> <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">,</span> f<span class="keyword">)</span>
<span class="comment">// end of [list_zipwth_cloref]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a1</span><span class="keyword">,</span><span class="staexp">a2</span><span class="keyword">}</span>
list_unzip xys <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">var</span> res1<span class="keyword">:</span> <span class="staexp">List_vt a1</span> <span class="keyword">and</span> res2<span class="keyword">:</span> <span class="staexp">List_vt a2</span> <span class="comment">// uninitialized
</span>  <span class="keyword">fun</span> loop <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      xys<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span><span class="keyword">@(</span>a1<span class="keyword">,</span> a2<span class="keyword">)</span><span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> res1<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><span class="keyword">(</span>List_vt a1<span class="keyword">)</span>? &gt;&gt; list_vt <span class="keyword">(</span>a1<span class="keyword">,</span> n<span class="keyword">)</span></span>
    <span class="keyword">,</span> res2<span class="keyword">:</span> <span class="staexp"><span class="keyword">&amp;</span><span class="keyword">(</span>List_vt a2<span class="keyword">)</span>? &gt;&gt; list_vt <span class="keyword">(</span>a2<span class="keyword">,</span> n<span class="keyword">)</span></span>
  <span class="keyword">)</span> <span class="keyword">:&lt;&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> xys <span class="keyword">of</span>
    <span class="keyword">|</span> xy :: xys <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>res1 := list_vt_cons <span class="staexp"><span class="keyword">{</span>a1<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span>xy<span class="keyword">.</span>0<span class="keyword">,</span> ?<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">val+</span> list_vt_cons <span class="keyword">(</span>_<span class="keyword">,</span> <span class="keyword">!</span>p1<span class="keyword">)</span> <span class="keyword">=</span> res1
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>res2 := list_vt_cons <span class="staexp"><span class="keyword">{</span>a2<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>0<span class="keyword">}</span></span> <span class="keyword">(</span>xy<span class="keyword">.</span>1<span class="keyword">,</span> ?<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">val+</span> list_vt_cons <span class="keyword">(</span>_<span class="keyword">,</span> <span class="keyword">!</span>p2<span class="keyword">)</span> <span class="keyword">=</span> res2
      <span class="keyword">in</span>
        loop <span class="keyword">(</span>xys<span class="keyword">,</span> <span class="keyword">!</span>p1<span class="keyword">,</span> <span class="keyword">!</span>p2<span class="keyword">)</span><span class="keyword">;</span> fold@ res1<span class="keyword">;</span> fold@ res2
      <span class="keyword">end</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>res1 := list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">;</span> res2 := list_vt_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [loop]
</span><span class="keyword">in</span>
  loop <span class="keyword">(</span>xys<span class="keyword">,</span> res1<span class="keyword">,</span> res2<span class="keyword">)</span><span class="keyword">;</span> <span class="keyword">(</span>res1<span class="keyword">,</span> res2<span class="keyword">)</span>
<span class="keyword">end</span> <span class="comment">// end of [list_unzip]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">//
</span><span class="comment">// HX: implementing merge sort
</span><span class="comment">//
</span>
<span class="comment">(*
**
** llist(a, i, n): a list of lists such that
**   1. the sum of the lengths of lists in the list of lists is i, and
**   2. the length of the list is n.
**
*)</span>

<span class="keyword">local</span>
<span class="comment">//
</span><span class="comment">// HX: this is not an efficient implementation but it is guaranteed to be O(n*log(n))
</span><span class="comment">//
</span>  <span class="keyword">datatype</span> <span class="staexp"><a name="53251"><span class="stacstdec">llist <span class="keyword">(</span>a<span class="keyword">:</span>t@ype+<span class="keyword">,</span> int<span class="keyword">,</span> int<span class="keyword">)</span></span></a></span> <span class="keyword">=</span>
    <span class="keyword">|</span> <span class="keyword">{</span><span class="staexp">i<span class="keyword">,</span>j<span class="keyword">,</span>n<span class="keyword">:</span>nat</span><span class="keyword">}</span> lcons <span class="staexp"><span class="keyword">(</span>a<span class="keyword">,</span> i+j<span class="keyword">,</span> n+1<span class="keyword">)</span></span> <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>list <span class="keyword">(</span>a<span class="keyword">,</span> i<span class="keyword">)</span><span class="keyword">,</span> llist <span class="keyword">(</span>a<span class="keyword">,</span> j<span class="keyword">,</span> n<span class="keyword">)</span><span class="keyword">)</span></span>
    <span class="keyword">|</span> lnil <span class="staexp"><span class="keyword">(</span>a<span class="keyword">,</span> 0<span class="keyword">,</span> 0<span class="keyword">)</span></span>

  <span class="keyword">typedef</span> <span class="staexp"><a name="53384"><span class="stacstdec">lte <span class="keyword">(</span>a<span class="keyword">:</span>t@ype<span class="keyword">,</span> env<span class="keyword">:</span> viewtype<span class="keyword">,</span> f<span class="keyword">:</span>eff<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>a<span class="keyword">,</span> a<span class="keyword">,</span> <span class="keyword">!</span>env<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">,</span>f<span class="keyword">&gt;</span> bool</span></a></span>

  <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> aux1
    <span class="staexp"><span class="keyword">{</span>env<span class="keyword">:</span>viewtype<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>i<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>i<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span>lte<span class="keyword">:</span> <span class="staexp">lte <span class="keyword">(</span>a<span class="keyword">,</span> env<span class="keyword">,</span> f<span class="keyword">)</span></span><span class="keyword">,</span> xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> i<span class="keyword">)</span></span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>env</span><span class="keyword">)</span>
    <span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">[</span>n<span class="keyword">:</span>nat<span class="keyword">]</span> llist <span class="keyword">(</span>a<span class="keyword">,</span> i<span class="keyword">,</span> n<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">case+</span> xs <span class="keyword">of</span>
    <span class="keyword">|</span> x1 :: x2 :: xs <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> l <span class="keyword">=</span> <span class="keyword">(</span>
          <span class="keyword">if</span> lte <span class="keyword">(</span>x1<span class="keyword">,</span> x2<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">then</span> x1 :: x2 :: nil <span class="keyword">else</span> x2 :: x1 :: nil
        <span class="keyword">)</span> <span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> 2<span class="keyword">)</span></span>
      <span class="keyword">in</span>
         lcons <span class="keyword">(</span>l<span class="keyword">,</span> aux1 <span class="keyword">(</span>lte<span class="keyword">,</span> xs<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">|</span> l <span class="keyword">as</span> list_cons <span class="keyword">(</span>x<span class="keyword">,</span> list_nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> lcons <span class="keyword">(</span>l<span class="keyword">,</span> lnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> lnil
  <span class="comment">// end of [aux1]
</span>
  <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> aux2
    <span class="staexp"><span class="keyword">{</span>env<span class="keyword">:</span>viewtype<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>i<span class="keyword">,</span>j<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>i+j<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      lte<span class="keyword">:</span> <span class="staexp">lte <span class="keyword">(</span>a<span class="keyword">,</span> env<span class="keyword">,</span> f<span class="keyword">)</span></span><span class="keyword">,</span> xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> i<span class="keyword">)</span></span><span class="keyword">,</span> ys<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> j<span class="keyword">)</span></span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>env</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> i+j<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> <span class="keyword">(</span>xs<span class="keyword">,</span> ys<span class="keyword">)</span> <span class="keyword">of</span>
    <span class="keyword">|</span> <span class="keyword">(</span>xs <span class="keyword">as</span> x :: xs'<span class="keyword">,</span> ys <span class="keyword">as</span> y :: ys'<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> lte <span class="keyword">(</span>x<span class="keyword">,</span> y<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">begin</span>
          x :: aux2 <span class="keyword">(</span>lte<span class="keyword">,</span> xs'<span class="keyword">,</span> ys<span class="keyword">,</span> env<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
          y :: aux2 <span class="keyword">(</span>lte<span class="keyword">,</span> xs<span class="keyword">,</span> ys'<span class="keyword">,</span> env<span class="keyword">)</span>
        <span class="keyword">end</span>
      <span class="keyword">end</span> <span class="comment">// end of [::, ::]
</span>    <span class="keyword">|</span> <span class="keyword">(</span>xs<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> xs
    <span class="keyword">|</span> <span class="keyword">(</span>nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> ys<span class="keyword">)</span> <span class="keyword">=&gt;</span> ys
  <span class="keyword">end</span> <span class="comment">// end of [aux2]
</span>  <span class="comment">// end of [aux2]
</span>
  <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> aux3
    <span class="staexp"><span class="keyword">{</span>env<span class="keyword">:</span>viewtype<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>i<span class="keyword">,</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span>lte<span class="keyword">:</span> <span class="staexp">lte <span class="keyword">(</span>a<span class="keyword">,</span> env<span class="keyword">,</span> f<span class="keyword">)</span></span><span class="keyword">,</span> xss<span class="keyword">:</span> <span class="staexp">llist <span class="keyword">(</span>a<span class="keyword">,</span> i<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>env</span><span class="keyword">)</span>
    <span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp"><span class="keyword">[</span>n1<span class="keyword">:</span>nat <span class="keyword">|</span> <span class="keyword">(</span>n <span class="keyword">&lt;</span> 2 &amp;&amp; n1 == n<span class="keyword">)</span> || n1 <span class="keyword">&lt;</span> n<span class="keyword">]</span> llist <span class="keyword">(</span>a<span class="keyword">,</span> i<span class="keyword">,</span> n1<span class="keyword">)</span></span> <span class="keyword">=</span>
    <span class="keyword">case+</span> xss <span class="keyword">of</span>
    <span class="keyword">|</span> lcons <span class="keyword">(</span>xs1<span class="keyword">,</span> lcons <span class="keyword">(</span>xs2<span class="keyword">,</span> xss<span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        lcons <span class="keyword">(</span>aux2 <span class="keyword">(</span>lte<span class="keyword">,</span> xs1<span class="keyword">,</span> xs2<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">,</span> aux3 <span class="keyword">(</span>lte<span class="keyword">,</span> xss<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;&gt;</span> xss
  <span class="comment">// end of [aux3]
</span>
  <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span> aux4
    <span class="staexp"><span class="keyword">{</span>env<span class="keyword">:</span>viewtype<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>i<span class="keyword">,</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span>lte<span class="keyword">:</span> <span class="staexp">lte <span class="keyword">(</span>a<span class="keyword">,</span> env<span class="keyword">,</span> f<span class="keyword">)</span></span><span class="keyword">,</span> xss<span class="keyword">:</span> <span class="staexp">llist <span class="keyword">(</span>a<span class="keyword">,</span> i<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>env</span><span class="keyword">)</span>
    <span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> i<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span> <span class="keyword">case+</span> xss <span class="keyword">of</span>
    <span class="keyword">|</span> lnil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> nil <span class="keyword">(</span><span class="keyword">)</span>
    <span class="keyword">|</span> lcons <span class="keyword">(</span>xs<span class="keyword">,</span> lnil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> xs
    <span class="keyword">|</span> _ <span class="keyword">=&gt;&gt;</span> <span class="keyword">begin</span>
        aux4 <span class="keyword">(</span>lte<span class="keyword">,</span> aux3 <span class="keyword">(</span>lte<span class="keyword">,</span> xss<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">,</span> env<span class="keyword">)</span>
      <span class="keyword">end</span>
  <span class="keyword">end</span> <span class="comment">// end of [aux4]
</span>
<span class="keyword">in</span> <span class="comment">// in of [local]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_mergesort <span class="keyword">(</span>xs<span class="keyword">,</span> lte<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> aux4 <span class="keyword">(</span>lte<span class="keyword">,</span> aux1 <span class="keyword">(</span>lte<span class="keyword">,</span> xs<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">,</span> env<span class="keyword">)</span>

<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">//
</span><span class="comment">// HX: implementing quick sort
</span><span class="comment">//
</span>
<span class="keyword">local</span>
<span class="comment">//
</span><span class="comment">// this may not be a practical implementation as it can easily be O(n*n)
</span><span class="comment">//
</span>  <span class="keyword">typedef</span> <span class="staexp"><a name="55396"><span class="stacstdec">lte <span class="keyword">(</span>a<span class="keyword">:</span>t@ype<span class="keyword">,</span> env<span class="keyword">:</span> viewtype<span class="keyword">,</span> f<span class="keyword">:</span>eff<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">(</span>a<span class="keyword">,</span> a<span class="keyword">,</span> <span class="keyword">!</span>env<span class="keyword">)</span> <span class="keyword">-&lt;</span><span class="keyword">fun</span><span class="keyword">,</span>f<span class="keyword">&gt;</span> bool</span></a></span>

  <span class="keyword">fun</span><span class="keyword">{</span><span class="staexp">a<span class="keyword">:</span>t@ype</span><span class="keyword">}</span>
  qsrt <span class="staexp"><span class="keyword">{</span>env<span class="keyword">:</span>viewtype<span class="keyword">}</span></span>
    <span class="staexp"><span class="keyword">{</span>n<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>n<span class="keyword">,</span>0<span class="keyword">&gt;.</span></span>
    <span class="keyword">(</span>lte<span class="keyword">:</span> <span class="staexp">lte <span class="keyword">(</span>a<span class="keyword">,</span> env<span class="keyword">,</span> f<span class="keyword">)</span></span><span class="keyword">,</span> xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>env</span><span class="keyword">)</span>
    <span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> n<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> xs <span class="keyword">of</span> <span class="comment">// [case+]: exhaustive pattern matching
</span>    <span class="keyword">|</span> x' :: xs' <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        part <span class="staexp"><span class="keyword">{</span>env<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>n-1<span class="keyword">,</span>0<span class="keyword">,</span>0<span class="keyword">}</span></span> <span class="keyword">(</span>lte<span class="keyword">,</span> x'<span class="keyword">,</span> xs'<span class="keyword">,</span> nil<span class="keyword">,</span> nil<span class="keyword">,</span> env<span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [::]
</span>    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> nil <span class="keyword">(</span><span class="keyword">)</span>
  <span class="keyword">end</span> <span class="comment">// end of [qsrt]
</span>
  <span class="keyword">and</span> part <span class="staexp"><span class="keyword">{</span>env<span class="keyword">:</span>viewtype<span class="keyword">}</span></span>
    <span class="staexp"><span class="keyword">{</span>p<span class="keyword">,</span>l<span class="keyword">,</span>r<span class="keyword">:</span>nat<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>f<span class="keyword">:</span>eff<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">.&lt;</span>p+l+r<span class="keyword">,</span>p+1<span class="keyword">&gt;.</span></span> <span class="keyword">(</span>
      lte<span class="keyword">:</span> <span class="staexp">lte <span class="keyword">(</span>a<span class="keyword">,</span> env<span class="keyword">,</span> f<span class="keyword">)</span></span>
    <span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp">a</span><span class="keyword">,</span> xs<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> p<span class="keyword">)</span></span>
    <span class="keyword">,</span> l<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> l<span class="keyword">)</span></span><span class="keyword">,</span> r<span class="keyword">:</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> r<span class="keyword">)</span></span>
    <span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp"><span class="keyword">!</span>env</span>
    <span class="keyword">)</span> <span class="keyword">:&lt;</span><span class="staexp">f</span><span class="keyword">&gt;</span> <span class="staexp">list <span class="keyword">(</span>a<span class="keyword">,</span> p+l+r+1<span class="keyword">)</span></span> <span class="keyword">=</span> <span class="keyword">begin</span>
    <span class="keyword">case+</span> xs <span class="keyword">of</span> <span class="comment">// case+ mandates exhaustive pattern matching
</span>    <span class="keyword">|</span> x' :: xs' <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        <span class="keyword">if</span> lte <span class="keyword">(</span>x'<span class="keyword">,</span> x<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">begin</span>
          part <span class="staexp"><span class="keyword">{</span>env<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>p-1<span class="keyword">,</span>l+1<span class="keyword">,</span>r<span class="keyword">}</span></span> <span class="keyword">(</span>lte<span class="keyword">,</span> x<span class="keyword">,</span> xs'<span class="keyword">,</span> x' :: l<span class="keyword">,</span> r<span class="keyword">,</span> env<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span>
          part <span class="staexp"><span class="keyword">{</span>env<span class="keyword">}</span></span> <span class="staexp"><span class="keyword">{</span>p-1<span class="keyword">,</span>l<span class="keyword">,</span>r+1<span class="keyword">}</span></span> <span class="keyword">(</span>lte<span class="keyword">,</span> x<span class="keyword">,</span> xs'<span class="keyword">,</span> l<span class="keyword">,</span> x' :: r<span class="keyword">,</span> env<span class="keyword">)</span>
        <span class="keyword">end</span> <span class="comment">// end of [if]
</span>      <span class="keyword">end</span> <span class="comment">(* end of [::] *)</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
        list_append <span class="keyword">(</span>qsrt <span class="keyword">(</span>lte<span class="keyword">,</span> l<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">,</span> x :: qsrt <span class="keyword">(</span>lte<span class="keyword">,</span> r<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span> <span class="comment">// end of [nil]
</span>  <span class="keyword">end</span> <span class="comment">// end of [part]
</span>
<span class="keyword">in</span> <span class="comment">// in of [local]
</span>
<span class="keyword">implement</span><span class="keyword">{</span><span class="staexp">a</span><span class="keyword">}</span>
list_quicksort <span class="keyword">(</span>xs<span class="keyword">,</span> lte<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> qsrt <span class="keyword">(</span>lte<span class="keyword">,</span> xs<span class="keyword">,</span> env<span class="keyword">)</span>

<span class="keyword">end</span> <span class="comment">// end of [local]
</span>
<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [list.dats] *)</span>
</pre>
</body>
</html>
