<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    .atsyntax {color:#E80000;background-color:#E0E0E0}
    .atsyntax span.comment {color:#787878;font-style:italic}
    .atsyntax span.extern  {color:#A52A2A}
    .atsyntax span.keyword {color:#000000;font-weight:bold}
    .atsyntax span.neuexp  {color:#800080}
    .atsyntax span.staexp  {color:#0000FF}
    .atsyntax span.dynexp  {color:#E80000}
    .atsyntax span.prfexp  {color:#009000}
    .atsyntax span.stacstdec  {text-decoration:none}
    .atsyntax span.stacstuse  {color:#0000CF;text-decoration:underline}
    .atsyntax span.dyncstdec  {text-decoration:none}
    .atsyntax span.dyncstimp  {color:#B80000;text-decoration:underline}
    .atsyntax span.dyncstuse  {color:#B80000;text-decoration:underline}
    body {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre class="atsyntax">
<span class="comment">(*
** CAS CS525, Spring 2011
** Instructor: Hongwei Xi
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">"interp0.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"error.sats"</span>
<span class="keyword">staload</span> <span class="staexp">_ <span class="keyword">=</span> "symbol.dats"</span>

<span class="keyword">staload</span> <span class="staexp">_ <span class="keyword">=</span> "prelude/DATS/list.dats"</span>
<span class="keyword">staload</span> <span class="staexp">_ <span class="keyword">=</span> "prelude/DATS/list0.dats"</span>

<span class="keyword">typedef</span> <span class="staexp"><a name="235"><span class="stacstdec">e0xp    <span class="keyword">=</span> $Absyn<span class="keyword">.</span>e0xp</span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="265"><span class="stacstdec">e0xplst <span class="keyword">=</span> $Absyn<span class="keyword">.</span>e0xplst</span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="298"><span class="stacstdec">e0xpopt <span class="keyword">=</span> $Absyn<span class="keyword">.</span>e0xpopt</span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="331"><span class="stacstdec">e0xpopt <span class="keyword">=</span> $Absyn<span class="keyword">.</span>e0xpopt</span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="364"><span class="stacstdec">a0rglst <span class="keyword">=</span> $Absyn<span class="keyword">.</span>a0rglst</span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="397"><span class="stacstdec">d0ec <span class="keyword">=</span> $Absyn<span class="keyword">.</span>d0ec</span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="424"><span class="stacstdec">d0eclst <span class="keyword">=</span> $Absyn<span class="keyword">.</span>d0eclst</span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="457"><span class="stacstdec">v0aldeclst <span class="keyword">=</span> $Absyn<span class="keyword">.</span>v0aldeclst</span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="496"><span class="stacstdec">v0aldec <span class="keyword">=</span> $Absyn<span class="keyword">.</span>v0aldec</span></a></span>

<span class="keyword">typedef</span> <span class="staexp"><a name="530"><span class="stacstdec">opr <span class="keyword">=</span> $Absyn<span class="keyword">.</span>opr</span></a></span>


<span class="keyword">typedef</span> <span class="staexp"><a name="557"><span class="stacstdec">sym <span class="keyword">=</span> $Symbol<span class="keyword">.</span>symbol_t</span></a></span>
<span class="keyword">val</span> symenv_make <span class="keyword">=</span> $Symbol<span class="keyword">.</span>symenv_make

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(*
** please implement as follows the function interfaces declared
** in [interp0.sats]
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">#define</span> <span class="neuexp">nil list0_nil</span>
<span class="keyword">#define</span> <span class="neuexp">cons list0_cons</span>
<span class="keyword">#define</span> <span class="neuexp">:: list0_cons</span>


<span class="keyword">#define</span> <span class="neuexp">Some0 option0_some</span>
<span class="keyword">#define</span> <span class="neuexp">None0 option0_none</span>

<span class="comment">// implement
</span><span class="comment">// interp0_exp (e) = let
</span><span class="comment">//   // val () = println! ("interp0_exp: yet to be implemented!")
</span><span class="comment">//   // val () = assertloc (false)
</span><span class="comment">// in
</span><span class="comment">//   V0ALint (3)
</span><span class="comment">//   // exit (1)
</span><span class="comment">// end // end of [interp0_exp]
</span>


<span class="keyword">implement</span> fprint_v0al <span class="keyword">(</span>out<span class="keyword">,</span> v<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">macdef</span> <span class="neuexp">prtval <span class="keyword">(</span>v<span class="keyword">)</span> <span class="keyword">=</span> fprint_v0al <span class="keyword">(</span>out<span class="keyword">,</span> <span class="keyword">,(</span>v<span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="keyword">macdef</span> <span class="neuexp">prele <span class="keyword">(</span>e<span class="keyword">)</span> <span class="keyword">=</span> fprint <span class="keyword">(</span>out<span class="keyword">,</span> <span class="keyword">,(</span>e<span class="keyword">)</span><span class="keyword">)</span></span>
  <span class="keyword">macdef</span> <span class="neuexp">prstr <span class="keyword">(</span>s<span class="keyword">)</span> <span class="keyword">=</span> fprint_string <span class="keyword">(</span>out<span class="keyword">,</span> <span class="keyword">,(</span>s<span class="keyword">)</span><span class="keyword">)</span></span>
<span class="keyword">in</span>
  <span class="keyword">case</span> v <span class="keyword">of</span>
  <span class="keyword">|</span> V0ALbool <span class="keyword">(</span>b<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
    prstr "V0ALbool("<span class="keyword">;</span> prele b<span class="keyword">;</span> prstr ")"
    <span class="keyword">end</span>  <span class="comment">// end of [V0ALbool]
</span>  <span class="keyword">|</span> V0ALint <span class="keyword">(</span>n<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
    prstr "V0ALint("<span class="keyword">;</span> prele n<span class="keyword">;</span> prstr ")"
    <span class="keyword">end</span>  <span class="comment">// end of [V0ALint]
</span>  <span class="keyword">|</span> V0ALstr <span class="keyword">(</span>str<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
    prstr "V0ALstr("<span class="keyword">;</span> prele str<span class="keyword">;</span> prstr ")"
    <span class="keyword">end</span>  <span class="comment">// end of [V0ALstr]
</span>  <span class="keyword">|</span> V0ALtup <span class="keyword">(</span>vs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
    prstr "V0ALtup("<span class="keyword">;</span> fprint_v0allst <span class="keyword">(</span>out<span class="keyword">,</span> vs<span class="keyword">)</span><span class="keyword">;</span> prstr ")"
    <span class="keyword">end</span>  <span class="comment">// end of [V0ALtup]
</span>  <span class="keyword">|</span> V0ALclo <span class="keyword">(</span>env<span class="keyword">,</span> e<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
    prstr "V0ALclo(...)"
    <span class="keyword">end</span>  <span class="comment">// end of [V0ALclo]
</span>  <span class="keyword">|</span> V0ALfix <span class="keyword">(</span>env<span class="keyword">,</span> e<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
    prstr "V0ALfix(...)"
    <span class="keyword">end</span>  <span class="comment">// end of [V0ALfix]
</span>  <span class="keyword">|</span> V0ALref _ <span class="keyword">=&gt;</span> <span class="keyword">begin</span>
    prstr "V0ALref(...)"
  <span class="keyword">end</span>
<span class="keyword">end</span>  <span class="comment">// end of [fprint_v0al]
</span>
<span class="keyword">implement</span> fprint_v0allst <span class="keyword">(</span>out<span class="keyword">,</span> vs<span class="keyword">)</span> <span class="keyword">=</span> loop <span class="keyword">(</span>vs<span class="keyword">,</span> 0<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
  <span class="keyword">fun</span> loop <span class="keyword">(</span>vs<span class="keyword">:</span> <span class="staexp">v0allst</span><span class="keyword">,</span> i<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">)</span>
    <span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp">void</span> <span class="keyword">=</span> <span class="keyword">case+</span> vs <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>v<span class="keyword">,</span> vs<span class="keyword">)</span> <span class="keyword">=&gt;</span> loop <span class="keyword">(</span>vs<span class="keyword">,</span> i+1<span class="keyword">)</span> <span class="keyword">where</span> <span class="keyword">{</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">if</span> i <span class="keyword">&gt;</span> 0 <span class="keyword">then</span> fprint_string <span class="keyword">(</span>out<span class="keyword">,</span> ", "<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> fprint_v0al <span class="keyword">(</span>out<span class="keyword">,</span> v<span class="keyword">)</span>
      <span class="keyword">}</span> <span class="comment">// end of [cons]
</span>    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>
  <span class="comment">// end of [loop]  
</span><span class="keyword">}</span>  <span class="comment">(* end of [fprint_v0allst] *)</span>


<span class="keyword">implement</span> print_v0al <span class="keyword">(</span>v<span class="keyword">)</span> <span class="keyword">=</span> fprint_v0al <span class="keyword">(</span>stdout_ref<span class="keyword">,</span> v<span class="keyword">)</span>

<span class="keyword">implement</span> prerr_v0al <span class="keyword">(</span>v<span class="keyword">)</span> <span class="keyword">=</span> fprint_v0al <span class="keyword">(</span>stderr_ref<span class="keyword">,</span> v<span class="keyword">)</span>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="2421"><span class="dyncstdec">eval <span class="keyword">(</span>env<span class="keyword">:</span> <span class="staexp">env</span><span class="keyword">,</span> e<span class="keyword">:</span> <span class="staexp">e0xp</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">v0al</span></span></a>

<span class="keyword">fun</span> evallst <span class="keyword">(</span>env<span class="keyword">:</span> <span class="staexp">env</span><span class="keyword">,</span> explst<span class="keyword">:</span> <span class="staexp">e0xplst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">v0allst</span> <span class="keyword">=</span> 
  list0_map_cloref <span class="keyword">(</span>explst<span class="keyword">,</span> <span class="keyword">lam</span> e <span class="keyword">=&gt;</span> eval <span class="keyword">(</span>env<span class="keyword">,</span> e<span class="keyword">)</span><span class="keyword">)</span>

<span class="keyword">val</span> v0al_void <span class="keyword">=</span> V0ALtup <span class="keyword">(</span>nil<span class="keyword">)</span>

<span class="keyword">fun</span> evalopt <span class="keyword">(</span>env<span class="keyword">:</span> <span class="staexp">env</span><span class="keyword">,</span> eo<span class="keyword">:</span> <span class="staexp">e0xpopt</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">v0al</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> eo <span class="keyword">of</span>
  <span class="keyword">|</span> Some0 e <span class="keyword">=&gt;</span> eval <span class="keyword">(</span>env<span class="keyword">,</span> e<span class="keyword">)</span>
  <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> v0al_void

<span class="keyword">fun</span> eval_if <span class="keyword">(</span>env<span class="keyword">:</span> <span class="staexp">env</span><span class="keyword">,</span> e_test<span class="keyword">:</span> <span class="staexp">e0xp</span><span class="keyword">,</span> e_then<span class="keyword">:</span> <span class="staexp">e0xp</span><span class="keyword">,</span> e_else<span class="keyword">:</span> <span class="staexp">e0xpopt</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">v0al</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> v_test <span class="keyword">=</span> eval <span class="keyword">(</span>env<span class="keyword">,</span> e_test<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> v_test <span class="keyword">of</span> 
    <span class="keyword">|</span> V0ALbool tf <span class="keyword">=&gt;</span> 
      <span class="keyword">if</span> tf <span class="keyword">=</span> true <span class="keyword">then</span> eval <span class="keyword">(</span>env<span class="keyword">,</span> e_then<span class="keyword">)</span>
      <span class="keyword">else</span> evalopt <span class="keyword">(</span>env<span class="keyword">,</span> e_else<span class="keyword">)</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"eval if type error\n"<span class="keyword">,</span> ETRACE_LEVEL_INFO<span class="keyword">,</span> 
                      abort <span class="keyword">(</span>ERRORCODE_TYPE_ERROR<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">end</span>


<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="3085"><span class="dyncstdec">fill_args <span class="keyword">(</span>arglst<span class="keyword">:</span> <span class="staexp">a0rglst</span><span class="keyword">,</span> v<span class="keyword">:</span> <span class="staexp">v0al</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">option0 <span class="keyword">(</span>list0 <span class="keyword">@(</span>sym<span class="keyword">,</span> v0al<span class="keyword">)</span><span class="keyword">)</span></span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="3164"><span class="dyncstdec">eval_d0eclst <span class="keyword">(</span>env<span class="keyword">:</span> <span class="staexp">env</span><span class="keyword">,</span> decs<span class="keyword">:</span> <span class="staexp">d0eclst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">env</span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="3220"><span class="dyncstdec">eval_d0ec <span class="keyword">(</span>env<span class="keyword">:</span> <span class="staexp">env</span><span class="keyword">,</span> dec<span class="keyword">:</span> <span class="staexp">d0ec</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">env</span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="3269"><span class="dyncstdec">eval_v0aldeclst <span class="keyword">(</span>env<span class="keyword">:</span> <span class="staexp">env</span><span class="keyword">,</span> valdecs<span class="keyword">:</span> <span class="staexp">v0aldeclst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">env</span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="3333"><span class="dyncstdec">eval_v0aldeclst_rec <span class="keyword">(</span>env<span class="keyword">:</span> <span class="staexp">env</span><span class="keyword">,</span> valdecs<span class="keyword">:</span> <span class="staexp">v0aldeclst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">env</span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="3402"><span class="dyncstdec">eval_v0aldec <span class="keyword">(</span>env<span class="keyword">:</span> <span class="staexp">env</span><span class="keyword">,</span> valdec<span class="keyword">:</span> <span class="staexp">v0aldec</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">env</span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="3459"><span class="dyncstdec">eval_v0aldec_rec <span class="keyword">(</span>env<span class="keyword">:</span> <span class="staexp">env</span><span class="keyword">,</span> valdec<span class="keyword">:</span> <span class="staexp">v0aldec</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">env</span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="3521"><span class="dyncstdec">eval_opr <span class="keyword">(</span>opr<span class="keyword">:</span> <span class="staexp">opr</span><span class="keyword">,</span> vs<span class="keyword">:</span> <span class="staexp">v0allst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">v0al</span></span></a>

<span class="keyword">implement</span> interp0_exp <span class="keyword">(</span>e<span class="keyword">)</span> <span class="keyword">=</span> eval <span class="keyword">(</span>symenv_make <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">,</span> e<span class="keyword">)</span>
  
<span class="comment">(* extern fun eval (env: env, e: e0xp): v0al *)</span>
<span class="keyword">implement</span> eval <span class="keyword">(</span>env<span class="keyword">,</span> e<span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">v0al</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> e<span class="keyword">.</span>e0xp_node <span class="keyword">of</span>
  <span class="keyword">|</span> $Absyn<span class="keyword">.</span>E0XPann <span class="keyword">(</span>e<span class="keyword">,</span> t<span class="keyword">)</span> <span class="keyword">=&gt;</span> eval <span class="keyword">(</span>env<span class="keyword">,</span> e<span class="keyword">)</span>
  <span class="keyword">|</span> $Absyn<span class="keyword">.</span>E0XPapp <span class="keyword">(</span>e1<span class="keyword">,</span> e2<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ETRACE_MSG <span class="keyword">(</span>"======== eval :: E0XPapp\n"<span class="keyword">,</span> ETRACE_LEVEL_DEBUG<span class="keyword">)</span>
    <span class="keyword">val</span> v1 <span class="keyword">=</span> eval <span class="keyword">(</span>env<span class="keyword">,</span> e1<span class="keyword">)</span>
    <span class="keyword">val</span> v2 <span class="keyword">=</span> eval <span class="keyword">(</span>env<span class="keyword">,</span> e2<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> v1 <span class="keyword">of</span>
    <span class="keyword">|</span> V0ALclo <span class="keyword">(</span>env1<span class="keyword">,</span> e1'<span class="keyword">)</span> <span class="keyword">=&gt;</span>
      <span class="keyword">(</span><span class="keyword">case+</span> e1'<span class="keyword">.</span>e0xp_node <span class="keyword">of</span>
      <span class="keyword">|</span> $Absyn<span class="keyword">.</span>E0XPlam <span class="keyword">(</span>arglst<span class="keyword">,</span> tyret<span class="keyword">,</span> ebody<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> opt_ps <span class="keyword">=</span> fill_args <span class="keyword">(</span>arglst<span class="keyword">,</span> v2<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="keyword">case+</span> opt_ps <span class="keyword">of</span>
        <span class="keyword">|</span> Some0 ps <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> env2 <span class="keyword">=</span> $Symbol<span class="keyword">.</span>symenv_inserts <span class="keyword">(</span>env1<span class="keyword">,</span> ps<span class="keyword">)</span>
        <span class="keyword">in</span>
          eval <span class="keyword">(</span>env2<span class="keyword">,</span> ebody<span class="keyword">)</span>
        <span class="keyword">end</span>
        <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"eval wrong args\n"<span class="keyword">,</span> ETRACE_LEVEL_INFO<span class="keyword">,</span> 
                      abort <span class="keyword">(</span>ERRORCODE_TYPE_ERROR<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"eval app type clo error\n"<span class="keyword">,</span> ETRACE_LEVEL_INFO<span class="keyword">,</span> 
                      abort <span class="keyword">(</span>ERRORCODE_TYPE_ERROR<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">)</span>
    <span class="keyword">|</span> V0ALfix <span class="keyword">(</span>env1<span class="keyword">,</span> e1'<span class="keyword">)</span> <span class="keyword">=&gt;</span> 
      <span class="keyword">(</span><span class="keyword">case+</span> e1'<span class="keyword">.</span>e0xp_node <span class="keyword">of</span>
      <span class="keyword">|</span> $Absyn<span class="keyword">.</span>E0XPfix <span class="keyword">(</span>f<span class="keyword">,</span> arglst<span class="keyword">,</span> tyret<span class="keyword">,</span> ebody<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> opt_ps <span class="keyword">=</span> fill_args <span class="keyword">(</span>arglst<span class="keyword">,</span> v2<span class="keyword">)</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ETRACE_MSG <span class="keyword">(</span>"======== eval $V0ALfix \n"<span class="keyword">,</span> ETRACE_LEVEL_DEBUG<span class="keyword">)</span>
      <span class="keyword">in</span>
        <span class="keyword">case+</span> opt_ps <span class="keyword">of</span>
        <span class="keyword">|</span> Some0 ps <span class="keyword">=&gt;</span> <span class="keyword">let</span>
          <span class="keyword">val</span> env2 <span class="keyword">=</span> $Symbol<span class="keyword">.</span>symenv_insert <span class="keyword">(</span>
            $Symbol<span class="keyword">.</span>symenv_inserts <span class="keyword">(</span>env1<span class="keyword">,</span> ps<span class="keyword">)</span><span class="keyword">,</span> f<span class="keyword">,</span> v1<span class="keyword">)</span>
        <span class="keyword">in</span>
          eval <span class="keyword">(</span>env2<span class="keyword">,</span> ebody<span class="keyword">)</span>
        <span class="keyword">end</span>
        <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"eval wrong args\n"<span class="keyword">,</span> ETRACE_LEVEL_INFO<span class="keyword">,</span> 
                      abort <span class="keyword">(</span>ERRORCODE_TYPE_ERROR<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">end</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"eval app type fix error\n"<span class="keyword">,</span> ETRACE_LEVEL_INFO<span class="keyword">,</span> 
                      abort <span class="keyword">(</span>ERRORCODE_TYPE_ERROR<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">)</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"eval app type error\n"<span class="keyword">,</span> ETRACE_LEVEL_INFO<span class="keyword">,</span> 
                      abort <span class="keyword">(</span>ERRORCODE_TYPE_ERROR<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> $Absyn<span class="keyword">.</span>E0XPbool b <span class="keyword">=&gt;</span> V0ALbool b
  <span class="keyword">|</span> $Absyn<span class="keyword">.</span>E0XPfix <span class="keyword">(</span>_<span class="keyword">)</span> <span class="keyword">=&gt;</span> V0ALfix <span class="keyword">(</span>env<span class="keyword">,</span> e<span class="keyword">)</span>
  <span class="keyword">|</span> $Absyn<span class="keyword">.</span>E0XPif <span class="keyword">(</span>e1<span class="keyword">,</span> et<span class="keyword">,</span> efo<span class="keyword">)</span> <span class="keyword">=&gt;</span> eval_if <span class="keyword">(</span>env<span class="keyword">,</span> e1<span class="keyword">,</span> et<span class="keyword">,</span> efo<span class="keyword">)</span>

  <span class="keyword">|</span> $Absyn<span class="keyword">.</span>E0XPint <span class="keyword">(</span>n<span class="keyword">)</span> <span class="keyword">=&gt;</span> V0ALint <span class="keyword">(</span>n<span class="keyword">)</span>
  <span class="keyword">|</span> $Absyn<span class="keyword">.</span>E0XPlam <span class="keyword">(</span>_<span class="keyword">)</span> <span class="keyword">=&gt;</span> V0ALclo <span class="keyword">(</span>env<span class="keyword">,</span> e<span class="keyword">)</span>
  <span class="keyword">|</span> $Absyn<span class="keyword">.</span>E0XPlet <span class="keyword">(</span>declst<span class="keyword">,</span> e1<span class="keyword">)</span> <span class="keyword">=&gt;</span>  <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ETRACE_MSG <span class="keyword">(</span>"======== eval :: E0XPlet\n"<span class="keyword">,</span> ETRACE_LEVEL_DEBUG<span class="keyword">)</span>
    <span class="keyword">val</span> env' <span class="keyword">=</span> eval_d0eclst <span class="keyword">(</span>env<span class="keyword">,</span> declst<span class="keyword">)</span>
  <span class="keyword">in</span>
    eval <span class="keyword">(</span>env'<span class="keyword">,</span> e1<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> $Absyn<span class="keyword">.</span>E0XPopr <span class="keyword">(</span>opr<span class="keyword">,</span> explst<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> vs <span class="keyword">=</span> evallst <span class="keyword">(</span>env<span class="keyword">,</span> explst<span class="keyword">)</span>
  <span class="keyword">in</span>
    eval_opr <span class="keyword">(</span>opr<span class="keyword">,</span> vs<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> $Absyn<span class="keyword">.</span>E0XPproj <span class="keyword">(</span>e1<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> v1 <span class="keyword">=</span> eval <span class="keyword">(</span>env<span class="keyword">,</span> e1<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> v1 <span class="keyword">of</span>
    <span class="keyword">|</span> V0ALtup <span class="keyword">(</span>vs<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> vo <span class="keyword">=</span>  list0_nth_opt&lt;<span class="staexp">v0al</span><span class="keyword">&gt;</span> <span class="keyword">(</span>vs<span class="keyword">,</span> i<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">case+</span> vo <span class="keyword">of</span>
      <span class="keyword">|</span> Some0 v2 <span class="keyword">=&gt;</span> v2
      <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"eval proj out of bound\n"<span class="keyword">,</span> ETRACE_LEVEL_INFO<span class="keyword">,</span> 
                      abort <span class="keyword">(</span>ERRORCODE_TYPE_ERROR<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"eval proj not tuple\n"<span class="keyword">,</span> ETRACE_LEVEL_INFO<span class="keyword">,</span> 
                      abort <span class="keyword">(</span>ERRORCODE_TYPE_ERROR<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> $Absyn<span class="keyword">.</span>E0XPstr <span class="keyword">(</span>str<span class="keyword">)</span> <span class="keyword">=&gt;</span> V0ALstr <span class="keyword">(</span>str<span class="keyword">)</span>
  <span class="keyword">|</span> $Absyn<span class="keyword">.</span>E0XPtup <span class="keyword">(</span>explst<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ETRACE_MSG <span class="keyword">(</span>"======== eval tup\n"<span class="keyword">,</span> ETRACE_LEVEL_DEBUG<span class="keyword">)</span>
  <span class="keyword">in</span>
    V0ALtup <span class="keyword">(</span>evallst <span class="keyword">(</span>env<span class="keyword">,</span> explst<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> $Absyn<span class="keyword">.</span>E0XPvar sym <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> v_opt <span class="keyword">=</span> $Symbol<span class="keyword">.</span>symenv_lookup <span class="keyword">(</span>env<span class="keyword">,</span> sym<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> v_opt <span class="keyword">of</span>
    <span class="keyword">|</span> Some0 v <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ETRACE_MSG <span class="keyword">(</span>"======== evallst :: E0XPvar :: Some0 found "<span class="keyword">,</span> 
        ETRACE_LEVEL_DEBUG<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ETRACE_OPR <span class="keyword">(</span>$Symbol<span class="keyword">.</span>print_symbol sym<span class="keyword">,</span> ETRACE_LEVEL_DEBUG<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ETRACE_MSG <span class="keyword">(</span>" -&gt; "<span class="keyword">,</span> ETRACE_LEVEL_DEBUG<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ETRACE_OPR <span class="keyword">(</span><span class="keyword">(</span>print_v0al <span class="keyword">(</span>v<span class="keyword">)</span><span class="keyword">;</span> print_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> ETRACE_LEVEL_DEBUG<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">case+</span> v <span class="keyword">of</span>
      <span class="keyword">|</span> V0ALref valref <span class="keyword">=&gt;</span> <span class="keyword">!</span>valref
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> v
    <span class="keyword">end</span>
    <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ETRACE_MSG <span class="keyword">(</span>"======== evallst :: E0XPvar :: None0 needs "<span class="keyword">,</span> 
        ETRACE_LEVEL_DEBUG<span class="keyword">)</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ETRACE_OPR <span class="keyword">(</span><span class="keyword">(</span>$Symbol<span class="keyword">.</span>print_symbol sym<span class="keyword">;</span> print_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> ETRACE_LEVEL_DEBUG<span class="keyword">)</span>
    <span class="keyword">in</span>
      abort <span class="keyword">(</span>ERRORCODE_TYPE_ERROR<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>
  <span class="comment">(* | _ =&gt; abort (ERRORCODE_TYPE_ERROR) *)</span>
  <span class="comment">(* end of [eval] *)</span>

<span class="comment">(* returning None0 means error *)</span>
<span class="comment">(* extern fun fill_args (arglst: $Absyn.a0rglst, v: v0al): option0 (list0 @(sym, v0al)) *)</span>
<span class="keyword">implement</span> fill_args <span class="keyword">(</span>arglst<span class="keyword">,</span> v<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> args_len <span class="keyword">=</span> list0_length <span class="keyword">(</span>arglst<span class="keyword">)</span>
  <span class="keyword">val</span> ret <span class="keyword">=</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">list0 <span class="keyword">@(</span>sym<span class="keyword">,</span> v0al<span class="keyword">)</span></span>
<span class="keyword">in</span>
  <span class="keyword">if</span> args_len <span class="keyword">=</span> 1 <span class="keyword">then</span> <span class="keyword">let</span>
    <span class="keyword">val-</span> cons <span class="keyword">(</span>arg<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=</span> arglst
  <span class="keyword">in</span>
    Some0 <span class="keyword">(</span>cons <span class="keyword">(</span><span class="keyword">@(</span>arg<span class="keyword">.</span>a0rg_nam<span class="keyword">,</span> v<span class="keyword">)</span><span class="keyword">,</span> ret<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">else</span> <span class="keyword">if</span> args_len <span class="keyword">=</span> 0 <span class="keyword">then</span> <span class="keyword">case+</span> v <span class="keyword">of</span>
  <span class="keyword">|</span> V0ALtup <span class="keyword">(</span>nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> Some0 <span class="keyword">(</span>ret<span class="keyword">)</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> None0
  <span class="keyword">else</span> <span class="keyword">case+</span> v <span class="keyword">of</span>
  <span class="keyword">|</span> V0ALtup vs <span class="keyword">=&gt;</span> <span class="keyword">if</span> args_len &lt;&gt; list0_length <span class="keyword">(</span>vs<span class="keyword">)</span> <span class="keyword">then</span> None0 <span class="keyword">else</span> <span class="keyword">let</span>
    <span class="keyword">val</span> syms_vs <span class="keyword">=</span> list0_map2_fun&lt;<span class="staexp">$Absyn<span class="keyword">.</span>a0rg</span><span class="keyword">,</span> <span class="staexp">v0al</span><span class="keyword">&gt;</span> <span class="keyword">(</span>
        arglst<span class="keyword">,</span> vs<span class="keyword">,</span> <span class="keyword">lam</span> <span class="keyword">(</span>arg<span class="keyword">,</span> v<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">@(</span>arg<span class="keyword">.</span>a0rg_nam<span class="keyword">,</span> v<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">in</span>
    Some0 <span class="keyword">(</span>syms_vs<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> None0
<span class="keyword">end</span>

<span class="comment">(* extern fun eval_d0eclst (env: env, decs: $Absyn.d0eclst): env *)</span>
<span class="keyword">implement</span> eval_d0eclst <span class="keyword">(</span>env<span class="keyword">,</span> decs<span class="keyword">)</span> <span class="keyword">=</span> list0_fold_left <span class="keyword">(</span>
  <span class="keyword">lam</span> <span class="keyword">(</span>x<span class="keyword">,</span>y<span class="keyword">)</span> <span class="keyword">=&gt;</span> eval_d0ec <span class="keyword">(</span>x<span class="keyword">,</span> y<span class="keyword">)</span><span class="keyword">,</span> env<span class="keyword">,</span> decs<span class="keyword">)</span>

<span class="comment">(* extern fun eval_d0ec (env: env, dec: $Absyn.d0ec): env *)</span>
<span class="keyword">implement</span> eval_d0ec <span class="keyword">(</span>env<span class="keyword">,</span> dec<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val+</span> $Absyn<span class="keyword">.</span>D0ECval <span class="keyword">(</span>isrec<span class="keyword">,</span> valdecs<span class="keyword">)</span> <span class="keyword">=</span> dec<span class="keyword">.</span>d0ec_node
<span class="keyword">in</span>
  <span class="keyword">if</span> isrec <span class="keyword">=</span> false <span class="keyword">then</span> eval_v0aldeclst <span class="keyword">(</span>env<span class="keyword">,</span> valdecs<span class="keyword">)</span>
  <span class="keyword">else</span> eval_v0aldeclst_rec <span class="keyword">(</span>env<span class="keyword">,</span> valdecs<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="comment">(* extern fun eval_v0aldeclst (env: env, valdecs: $Absyn.v0aldeclst): env *)</span>
<span class="keyword">implement</span> eval_v0aldeclst <span class="keyword">(</span>env<span class="keyword">,</span> valdecs<span class="keyword">)</span> <span class="keyword">=</span> list0_fold_left <span class="keyword">(</span>
  <span class="keyword">lam</span> <span class="keyword">(</span>x<span class="keyword">,</span>y<span class="keyword">)</span> <span class="keyword">=&gt;</span> eval_v0aldec <span class="keyword">(</span>x<span class="keyword">,</span> y<span class="keyword">)</span><span class="keyword">,</span> env<span class="keyword">,</span> valdecs<span class="keyword">)</span>

<span class="comment">(* extern fun eval_v0aldeclst_rec (env: env, valdecs: $Absyn.v0aldeclst): env *)</span>
<span class="keyword">implement</span> eval_v0aldeclst_rec <span class="keyword">(</span>env<span class="keyword">,</span> valdecs<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> fillin_env <span class="keyword">(</span>env<span class="keyword">:</span> <span class="staexp">env</span><span class="keyword">,</span> valdecs<span class="keyword">:</span> <span class="staexp">$Absyn<span class="keyword">.</span>v0aldeclst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">env</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> valdecs <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>valdec<span class="keyword">,</span> valdecs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> env' <span class="keyword">=</span> $Symbol<span class="keyword">.</span>symenv_insert <span class="keyword">(</span>
        env<span class="keyword">,</span> valdec<span class="keyword">.</span>v0aldec_nam<span class="keyword">,</span> V0ALref <span class="keyword">(</span>ref_make_elt&lt;<span class="staexp">v0al</span><span class="keyword">&gt;</span> <span class="keyword">(</span>V0ALint 825<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">in</span>
      fillin_env <span class="keyword">(</span>env'<span class="keyword">,</span> valdecs1<span class="keyword">)</span>
    <span class="keyword">end</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> env

  <span class="keyword">val</span> env1 <span class="keyword">=</span> fillin_env <span class="keyword">(</span>env<span class="keyword">,</span> valdecs<span class="keyword">)</span>
<span class="keyword">in</span>
 list0_fold_left <span class="keyword">(</span>
   <span class="keyword">lam</span> <span class="keyword">(</span>x<span class="keyword">,</span>y<span class="keyword">)</span> <span class="keyword">=&gt;</span> eval_v0aldec_rec <span class="keyword">(</span>x<span class="keyword">,</span> y<span class="keyword">)</span><span class="keyword">,</span> env1<span class="keyword">,</span> valdecs<span class="keyword">)</span>
<span class="keyword">end</span>


<span class="comment">(* extern fun eval_v0aldec (env: env, valdec: $Absyn.v0aldec): env *)</span>
<span class="keyword">implement</span> eval_v0aldec <span class="keyword">(</span>env<span class="keyword">,</span> valdec<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ETRACE_MSG <span class="keyword">(</span>"======== eval_v0aldec "<span class="keyword">,</span> ETRACE_LEVEL_DEBUG<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ETRACE_OPR <span class="keyword">(</span><span class="keyword">(</span>$Symbol<span class="keyword">.</span>print_symbol valdec<span class="keyword">.</span>v0aldec_nam<span class="keyword">;</span> print_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> 
    ETRACE_LEVEL_DEBUG<span class="keyword">)</span>
  <span class="keyword">val</span> v <span class="keyword">=</span> eval <span class="keyword">(</span>env<span class="keyword">,</span> valdec<span class="keyword">.</span>v0aldec_def<span class="keyword">)</span>
<span class="keyword">in</span>
  $Symbol<span class="keyword">.</span>symenv_insert <span class="keyword">(</span>env<span class="keyword">,</span> valdec<span class="keyword">.</span>v0aldec_nam<span class="keyword">,</span> v<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="comment">(* extern fun eval_v0aldec_rec (env: env, valdec: $Absyn.v0aldec): env *)</span>
<span class="keyword">implement</span> eval_v0aldec_rec <span class="keyword">(</span>env<span class="keyword">,</span> valdec<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ETRACE_MSG <span class="keyword">(</span>"======== eval_v0aldec_rec "<span class="keyword">,</span> ETRACE_LEVEL_DEBUG<span class="keyword">)</span>
  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> ETRACE_OPR <span class="keyword">(</span><span class="keyword">(</span>$Symbol<span class="keyword">.</span>print_symbol valdec<span class="keyword">.</span>v0aldec_nam<span class="keyword">;</span> print_newline <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> 
    ETRACE_LEVEL_DEBUG<span class="keyword">)</span>
  <span class="keyword">val</span> v <span class="keyword">=</span> eval <span class="keyword">(</span>env<span class="keyword">,</span> valdec<span class="keyword">.</span>v0aldec_def<span class="keyword">)</span>
  <span class="keyword">val</span> val_opt <span class="keyword">=</span> $Symbol<span class="keyword">.</span>symenv_lookup <span class="keyword">(</span>env<span class="keyword">,</span> valdec<span class="keyword">.</span>v0aldec_nam<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">case+</span> val_opt <span class="keyword">of</span>
  <span class="keyword">|</span> Some0 value <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">case+</span> value <span class="keyword">of</span>
    <span class="keyword">|</span> V0ALref <span class="keyword">(</span>valref<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>valref := v
    <span class="keyword">in</span>
      env
    <span class="keyword">end</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"preplaced symbol not of type V0ALref\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span>
           abort <span class="keyword">(</span>ERRORCODE_TYPE_ERROR<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">)</span>
  <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"rec symbol is not preplaced\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span>
           abort <span class="keyword">(</span>ERRORCODE_TYPE_ERROR<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span>

<span class="comment">(* extern fun eval_opr (opr: $Absyn.opr, vs: v0allst): v0al *)</span>
<span class="keyword">implement</span> eval_opr <span class="keyword">(</span>opr<span class="keyword">,</span> vs<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> opr <span class="keyword">of</span>
  <span class="keyword">|</span> $Absyn<span class="keyword">.</span>OPR sym <span class="keyword">=&gt;</span> 
    <span class="keyword">if</span> $Symbol<span class="keyword">.</span>eq_symbol_symbol <span class="keyword">(</span>sym<span class="keyword">,</span> $Symbol<span class="keyword">.</span>symbol_PLUS<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">case+</span> vs <span class="keyword">of</span>
      <span class="keyword">|</span> cons <span class="keyword">(</span>V0ALint i1<span class="keyword">,</span> cons <span class="keyword">(</span>V0ALint i2<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> V0ALint <span class="keyword">(</span>i1 + i2<span class="keyword">)</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"eval_opr + error\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span> 
             abort <span class="keyword">(</span>ERRORCODE_TYPE_ERROR<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">else</span> <span class="keyword">if</span> $Symbol<span class="keyword">.</span>eq_symbol_symbol <span class="keyword">(</span>sym<span class="keyword">,</span> $Symbol<span class="keyword">.</span>symbol_MINUS<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">case+</span> vs <span class="keyword">of</span>
      <span class="keyword">|</span> cons <span class="keyword">(</span>V0ALint i1<span class="keyword">,</span> cons <span class="keyword">(</span>V0ALint i2<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> V0ALint <span class="keyword">(</span>i1 - i2<span class="keyword">)</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"eval_opr - error\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span> 
             abort <span class="keyword">(</span>ERRORCODE_TYPE_ERROR<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">else</span> <span class="keyword">if</span> $Symbol<span class="keyword">.</span>eq_symbol_symbol <span class="keyword">(</span>sym<span class="keyword">,</span> $Symbol<span class="keyword">.</span>symbol_TIMES<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">case+</span> vs <span class="keyword">of</span>
      <span class="keyword">|</span> cons <span class="keyword">(</span>V0ALint i1<span class="keyword">,</span> cons <span class="keyword">(</span>V0ALint i2<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> V0ALint <span class="keyword">(</span>i1 * i2<span class="keyword">)</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"eval_opr * error\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span> 
             abort <span class="keyword">(</span>ERRORCODE_TYPE_ERROR<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">else</span> <span class="keyword">if</span> $Symbol<span class="keyword">.</span>eq_symbol_symbol <span class="keyword">(</span>sym<span class="keyword">,</span> $Symbol<span class="keyword">.</span>symbol_SLASH<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">case+</span> vs <span class="keyword">of</span>
      <span class="keyword">|</span> cons <span class="keyword">(</span>V0ALint i1<span class="keyword">,</span> cons <span class="keyword">(</span>V0ALint i2<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> V0ALint <span class="keyword">(</span>i1 / i2<span class="keyword">)</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"eval_opr / error\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span> 
             abort <span class="keyword">(</span>ERRORCODE_TYPE_ERROR<span class="keyword">)</span><span class="keyword">)</span>

    <span class="keyword">else</span> <span class="keyword">if</span> $Symbol<span class="keyword">.</span>eq_symbol_symbol <span class="keyword">(</span>sym<span class="keyword">,</span> $Symbol<span class="keyword">.</span>symbol_UMINUS<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">case+</span> vs <span class="keyword">of</span>
      <span class="keyword">|</span> cons <span class="keyword">(</span>V0ALint i1<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> V0ALint <span class="keyword">(</span>0 - i1<span class="keyword">)</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"eval_opr ~ error\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span> 
             abort <span class="keyword">(</span>ERRORCODE_TYPE_ERROR<span class="keyword">)</span><span class="keyword">)</span>

    <span class="keyword">else</span> <span class="keyword">if</span> $Symbol<span class="keyword">.</span>eq_symbol_symbol <span class="keyword">(</span>sym<span class="keyword">,</span> $Symbol<span class="keyword">.</span>symbol_GT<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">case+</span> vs <span class="keyword">of</span>
      <span class="keyword">|</span> cons <span class="keyword">(</span>V0ALint i1<span class="keyword">,</span> cons <span class="keyword">(</span>V0ALint i2<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> V0ALbool <span class="keyword">(</span>i1 <span class="keyword">&gt;</span> i2<span class="keyword">)</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"eval_opr &gt; error\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span> 
             abort <span class="keyword">(</span>ERRORCODE_TYPE_ERROR<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">else</span> <span class="keyword">if</span> $Symbol<span class="keyword">.</span>eq_symbol_symbol <span class="keyword">(</span>sym<span class="keyword">,</span> $Symbol<span class="keyword">.</span>symbol_GTE<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">case+</span> vs <span class="keyword">of</span>
      <span class="keyword">|</span> cons <span class="keyword">(</span>V0ALint i1<span class="keyword">,</span> cons <span class="keyword">(</span>V0ALint i2<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> V0ALbool <span class="keyword">(</span>i1 &gt;= i2<span class="keyword">)</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"eval_opr &gt;= error\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span> 
             abort <span class="keyword">(</span>ERRORCODE_TYPE_ERROR<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">else</span> <span class="keyword">if</span> $Symbol<span class="keyword">.</span>eq_symbol_symbol <span class="keyword">(</span>sym<span class="keyword">,</span> $Symbol<span class="keyword">.</span>symbol_LT<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">case+</span> vs <span class="keyword">of</span>
      <span class="keyword">|</span> cons <span class="keyword">(</span>V0ALint i1<span class="keyword">,</span> cons <span class="keyword">(</span>V0ALint i2<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> V0ALbool <span class="keyword">(</span>i1 <span class="keyword">&lt;</span> i2<span class="keyword">)</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"eval_opr &lt; error\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span> 
             abort <span class="keyword">(</span>ERRORCODE_TYPE_ERROR<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">else</span> <span class="keyword">if</span> $Symbol<span class="keyword">.</span>eq_symbol_symbol <span class="keyword">(</span>sym<span class="keyword">,</span> $Symbol<span class="keyword">.</span>symbol_LTE<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">case+</span> vs <span class="keyword">of</span>
      <span class="keyword">|</span> cons <span class="keyword">(</span>V0ALint i1<span class="keyword">,</span> cons <span class="keyword">(</span>V0ALint i2<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> V0ALbool <span class="keyword">(</span>i1 &lt;= i2<span class="keyword">)</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"eval_opr &lt;= error\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span> 
             abort <span class="keyword">(</span>ERRORCODE_TYPE_ERROR<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">else</span> <span class="keyword">if</span> $Symbol<span class="keyword">.</span>eq_symbol_symbol <span class="keyword">(</span>sym<span class="keyword">,</span> $Symbol<span class="keyword">.</span>symbol_EQ<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">case+</span> vs <span class="keyword">of</span>
      <span class="keyword">|</span> cons <span class="keyword">(</span>V0ALint i1<span class="keyword">,</span> cons <span class="keyword">(</span>V0ALint i2<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> V0ALbool <span class="keyword">(</span>i1 <span class="keyword">=</span> i2<span class="keyword">)</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"eval_opr = error\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span> 
             abort <span class="keyword">(</span>ERRORCODE_TYPE_ERROR<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">else</span> <span class="keyword">if</span> $Symbol<span class="keyword">.</span>eq_symbol_symbol <span class="keyword">(</span>sym<span class="keyword">,</span> $Symbol<span class="keyword">.</span>symbol_NEQ<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">case+</span> vs <span class="keyword">of</span>
      <span class="keyword">|</span> cons <span class="keyword">(</span>V0ALint i1<span class="keyword">,</span> cons <span class="keyword">(</span>V0ALint i2<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> V0ALbool <span class="keyword">(</span>i1 &lt;&gt; i2<span class="keyword">)</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"eval_opr &lt;&gt; error\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span> 
             abort <span class="keyword">(</span>ERRORCODE_TYPE_ERROR<span class="keyword">)</span><span class="keyword">)</span>

    <span class="keyword">else</span> <span class="keyword">if</span> $Symbol<span class="keyword">.</span>eq_symbol_symbol <span class="keyword">(</span>sym<span class="keyword">,</span> $Symbol<span class="keyword">.</span>symbol_PRINT_INT<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">case+</span> vs <span class="keyword">of</span>
      <span class="keyword">|</span> cons <span class="keyword">(</span>V0ALint i<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> print_int <span class="keyword">(</span>i<span class="keyword">)</span>
      <span class="keyword">in</span>
        V0ALtup <span class="keyword">(</span>nil<span class="keyword">)</span>
      <span class="keyword">end</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"eval_opr print_int error\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span> 
             abort <span class="keyword">(</span>ERRORCODE_TYPE_ERROR<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">else</span> <span class="keyword">if</span> $Symbol<span class="keyword">.</span>eq_symbol_symbol <span class="keyword">(</span>sym<span class="keyword">,</span> $Symbol<span class="keyword">.</span>symbol_PRINT<span class="keyword">)</span> <span class="keyword">then</span> <span class="keyword">case+</span> vs <span class="keyword">of</span>
      <span class="keyword">|</span> cons <span class="keyword">(</span>V0ALstr str<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
        <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> print str
      <span class="keyword">in</span>
        V0ALtup <span class="keyword">(</span>nil<span class="keyword">)</span>
      <span class="keyword">end</span>
      <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"eval_opr print error\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span> 
             abort <span class="keyword">(</span>ERRORCODE_TYPE_ERROR<span class="keyword">)</span><span class="keyword">)</span>

    <span class="keyword">else</span> ETRACE_MSG_OPR <span class="keyword">(</span>"eval_opr unsupported opr\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span> 
             abort <span class="keyword">(</span>ERRORCODE_TYPE_ERROR<span class="keyword">)</span><span class="keyword">)</span>
  <span class="comment">(* end of [eval_opr] *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [interp-1.dats] *)</span>



</pre>
</body>
</html>
