<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    .atsyntax {color:#E80000;background-color:#E0E0E0}
    .atsyntax span.comment {color:#787878;font-style:italic}
    .atsyntax span.extern  {color:#A52A2A}
    .atsyntax span.keyword {color:#000000;font-weight:bold}
    .atsyntax span.neuexp  {color:#800080}
    .atsyntax span.staexp  {color:#0000FF}
    .atsyntax span.dynexp  {color:#E80000}
    .atsyntax span.prfexp  {color:#009000}
    .atsyntax span.stacstdec  {text-decoration:none}
    .atsyntax span.stacstuse  {color:#0000CF;text-decoration:underline}
    .atsyntax span.dyncstdec  {text-decoration:none}
    .atsyntax span.dyncstimp  {color:#B80000;text-decoration:underline}
    .atsyntax span.dyncstuse  {color:#B80000;text-decoration:underline}
    body {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre class="atsyntax">


<span class="keyword">staload</span> <span class="staexp">"trans_closure.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"trans1.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"symbol.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"error.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"libfunctions.sats"</span>

<span class="keyword">typedef</span> <span class="staexp"><a name="133"><span class="stacstdec">loc <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fcontrib_2fparcomb_2fSATS_2fposloc_2esats.html#3210"><span class="stacstuse">$Posloc<span class="keyword">.</span>location_t</span></a></span></a></span>

<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anon*)</span> <span class="keyword">=</span> "symbol.dats"</span>

<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anon*)</span> <span class="keyword">=</span> "prelude/DATS/list.dats"</span> 
<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anon*)</span> <span class="keyword">=</span> "prelude/DATS/list0.dats"</span> 
<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anon*)</span> <span class="keyword">=</span> "prelude/DATS/list_vt.dats"</span> 
<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anon*)</span> <span class="keyword">=</span> "libats/DATS/funmap_avltree.dats"</span> 

<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anon*)</span> <span class="keyword">=</span> "symbol.dats"</span>

<span class="keyword">#define</span> <span class="neuexp">:: list0_cons</span>
<span class="keyword">#define</span> <span class="neuexp">cons list0_cons</span>
<span class="keyword">#define</span> <span class="neuexp">nil list0_nil</span>

<span class="keyword">#define</span> <span class="neuexp">Some0 option0_some</span>
<span class="keyword">#define</span> <span class="neuexp">None0 option0_none</span>

<span class="comment">(* ****** ****** *)</span>
<span class="keyword">typedef</span> <span class="staexp"><a name="579"><span class="stacstdec">ctx <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#1634"><span class="stacstuse">symenv_t</span></a> <span class="keyword">(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2299"><span class="stacstuse">v1ar</span></a><span class="keyword">)</span></span></a></span>
<span class="keyword">val</span> ctx_nil <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#1668"><span class="dyncstuse">symenv_make</span></a> <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// empty context
</span>

<span class="keyword">fun</span> ctx2v1arlst <span class="keyword">(</span>Gamma<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2482"><span class="stacstuse">v1arlst</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#2135"><span class="dyncstuse">symenv_listize</span></a> <span class="keyword">(</span>Gamma<span class="keyword">)</span>
  <span class="keyword">val</span> symlst <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2flist0_2esats.html#4772"><span class="dyncstuse">list0_map_fun&lt;</span></a> <span class="staexp"><span class="keyword">@(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#88"><span class="stacstuse">symbol_t</span></a><span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2299"><span class="stacstuse">v1ar</span></a><span class="keyword">)</span></span><span class="keyword">&gt;&lt;</span><span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2299"><span class="stacstuse">v1ar</span></a></span><span class="keyword">&gt;</span> <span class="keyword">(</span>s<span class="keyword">,</span> <span class="keyword">lam</span> x <span class="keyword">=&gt;</span> x<span class="keyword">.</span>1<span class="keyword">)</span>
<span class="keyword">in</span>
  symlst
<span class="keyword">end</span>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="827"><span class="dyncstdec">trans_clo1_d1eclst <span class="keyword">(</span>decs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2579"><span class="stacstuse">d1eclst</span></a></span><span class="keyword">,</span> Gamma<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a><span class="comment">(*new gamma*)</span><span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a><span class="comment">(*esc*)</span><span class="keyword">)</span></span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="917"><span class="dyncstdec">trans_clo1_d1ec <span class="keyword">(</span>dec<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2510"><span class="stacstuse">d1ec</span></a></span><span class="keyword">,</span> Gamma<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a><span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a><span class="keyword">)</span></span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="981"><span class="dyncstdec">trans_clo1_v1aldeclst <span class="keyword">(</span>valdecs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2700"><span class="stacstuse">v1aldeclst</span></a></span><span class="keyword">,</span> Gamma<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a><span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a><span class="keyword">)</span></span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="1060"><span class="dyncstdec">trans_clo1_v1aldeclst_rec <span class="keyword">(</span>valdecs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2700"><span class="stacstuse">v1aldeclst</span></a></span><span class="keyword">,</span> Gamma<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a><span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a><span class="keyword">)</span></span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="1144"><span class="dyncstdec">trans_clo1_v1aldec <span class="keyword">(</span>valdec<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2607"><span class="stacstuse">v1aldec</span></a></span><span class="keyword">,</span> Gamma<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a><span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a><span class="keyword">)</span></span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="1216"><span class="dyncstdec">trans_clo1_v1aldec_rec <span class="keyword">(</span>valdec<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2607"><span class="stacstuse">v1aldec</span></a></span><span class="keyword">,</span> Gamma<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a><span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a><span class="keyword">)</span></span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="1293"><span class="dyncstdec">trans_clo1_e1xp <span class="keyword">(</span>exp<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2022"><span class="stacstuse">e1xp</span></a></span><span class="keyword">,</span> Gamma<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a></span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="1349"><span class="dyncstdec">trans_clo1_e1xplst <span class="keyword">(</span>exps<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2182"><span class="stacstuse">e1xplst</span></a></span><span class="keyword">,</span> Gamma<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a></span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="1413"><span class="dyncstdec">trans_clo1_valdecs <span class="keyword">(</span>valdecs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2700"><span class="stacstuse">v1aldeclst</span></a></span><span class="keyword">,</span> Gamma<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a><span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a><span class="keyword">)</span></span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="1489"><span class="dyncstdec">trans_clo1_e1xplst <span class="keyword">(</span>exps<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2182"><span class="stacstuse">e1xplst</span></a></span><span class="keyword">,</span> Gamma<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a></span></span></a>

<span class="comment">(* the return type is ctx,
  but actually we just need a list of symbols
*)</span>
<span class="keyword">fun</span> trans_clo1_e1xp <span class="keyword">(</span>exp<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2022"><span class="stacstuse">e1xp</span></a></span><span class="keyword">,</span> Gamma<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a></span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> exp_node <span class="keyword">=</span> exp<span class="keyword">.</span>e1xp_node
<span class="keyword">in</span>
  <span class="keyword">case+</span> exp_node <span class="keyword">of</span>
  <span class="keyword">|</span> E1XPann <span class="keyword">(</span>e<span class="keyword">,</span> t<span class="keyword">)</span> <span class="keyword">=&gt;</span> trans_clo1_e1xp <span class="keyword">(</span>e<span class="keyword">,</span> Gamma<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPapp <span class="keyword">(</span>f<span class="keyword">,</span> args<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> esc1 <span class="keyword">=</span> trans_clo1_e1xp <span class="keyword">(</span>f<span class="keyword">,</span> Gamma<span class="keyword">)</span>
    <span class="keyword">val</span> esc2 <span class="keyword">=</span> trans_clo1_e1xp <span class="keyword">(</span>args<span class="keyword">,</span> Gamma<span class="keyword">)</span>
  <span class="keyword">in</span>
    <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#1967"><span class="dyncstuse">symenv_merge</span></a> <span class="keyword">(</span>esc1<span class="keyword">,</span> esc2<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> E1XPbool _ <span class="keyword">=&gt;</span> ctx_nil
  <span class="keyword">|</span> E1XPfix <span class="keyword">(</span>f<span class="keyword">,</span> args<span class="keyword">,</span> body<span class="keyword">,</span> ref_esc<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="comment">// put f into ctx
</span>    <span class="keyword">val</span> new_gamma <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#1783"><span class="dyncstuse">symenv_insert</span></a> <span class="keyword">(</span>ctx_nil<span class="keyword">,</span> f<span class="keyword">.</span>v1ar_nam<span class="keyword">,</span> f<span class="keyword">)</span>
    <span class="keyword">val</span> sym_args <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2flist0_2esats.html#4772"><span class="dyncstuse">list0_map_fun&lt;</span></a><span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2299"><span class="stacstuse">v1ar</span></a></span><span class="keyword">&gt;&lt;</span> <span class="staexp"><span class="keyword">@(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#88"><span class="stacstuse">symbol_t</span></a><span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2299"><span class="stacstuse">v1ar</span></a><span class="keyword">)</span></span><span class="keyword">&gt;</span> <span class="keyword">(</span>
      args<span class="keyword">,</span> <span class="keyword">lam</span> x <span class="keyword">=&gt;</span> <span class="keyword">(</span>x<span class="keyword">.</span>v1ar_nam<span class="keyword">,</span> x<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">val</span> new_gamma <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#1862"><span class="dyncstuse">symenv_inserts</span></a> <span class="keyword">(</span>new_gamma<span class="keyword">,</span> sym_args<span class="keyword">)</span>
    <span class="keyword">val</span> esc <span class="keyword">=</span> trans_clo1_e1xp <span class="keyword">(</span>body<span class="keyword">,</span> new_gamma<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>ref_esc := ctx2v1arlst <span class="keyword">(</span>esc<span class="keyword">)</span>
  <span class="keyword">in</span>
    <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#2061"><span class="dyncstuse">symenv_sub</span></a> <span class="keyword">(</span>esc<span class="keyword">,</span> Gamma<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> E1XPif <span class="keyword">(</span>e_if<span class="keyword">,</span> e_then<span class="keyword">,</span> eo_else<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> esc1 <span class="keyword">=</span> trans_clo1_e1xp <span class="keyword">(</span>e_if<span class="keyword">,</span> Gamma<span class="keyword">)</span>
    <span class="keyword">val</span> esc2 <span class="keyword">=</span> trans_clo1_e1xp <span class="keyword">(</span>e_then<span class="keyword">,</span> Gamma<span class="keyword">)</span>
    <span class="keyword">val</span> esc3 <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> eo_else <span class="keyword">of</span>
                 <span class="keyword">|</span> Some0 e_else <span class="keyword">=&gt;</span> trans_clo1_e1xp <span class="keyword">(</span>e_else<span class="keyword">,</span> Gamma<span class="keyword">)</span>
                 <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ctx_nil
                 <span class="keyword">)</span>
    <span class="keyword">val</span> esc <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#1967"><span class="dyncstuse">symenv_merge</span></a> <span class="keyword">(</span>esc1<span class="keyword">,</span> esc2<span class="keyword">)</span>
    <span class="keyword">val</span> esc <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#1967"><span class="dyncstuse">symenv_merge</span></a> <span class="keyword">(</span>esc<span class="keyword">,</span> esc3<span class="keyword">)</span>
  <span class="keyword">in</span>
    esc
  <span class="keyword">end</span>
  <span class="keyword">|</span> E1XPint _ <span class="keyword">=&gt;</span> ctx_nil
  <span class="keyword">|</span> E1XPlam <span class="keyword">(</span>args<span class="keyword">,</span> body<span class="keyword">,</span> ref_esc<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> sym_args <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2flist0_2esats.html#4772"><span class="dyncstuse">list0_map_fun&lt;</span></a><span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2299"><span class="stacstuse">v1ar</span></a></span><span class="keyword">&gt;&lt;</span> <span class="staexp"><span class="keyword">@(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#88"><span class="stacstuse">symbol_t</span></a><span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2299"><span class="stacstuse">v1ar</span></a><span class="keyword">)</span></span><span class="keyword">&gt;</span> <span class="keyword">(</span>
      args<span class="keyword">,</span> <span class="keyword">lam</span> x <span class="keyword">=&gt;</span> <span class="keyword">(</span>x<span class="keyword">.</span>v1ar_nam<span class="keyword">,</span> x<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">val</span> new_gamma <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#1862"><span class="dyncstuse">symenv_inserts</span></a> <span class="keyword">(</span>ctx_nil<span class="keyword">,</span> sym_args<span class="keyword">)</span>
    <span class="keyword">val</span> esc <span class="keyword">=</span> trans_clo1_e1xp <span class="keyword">(</span>body<span class="keyword">,</span> new_gamma<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>ref_esc := ctx2v1arlst <span class="keyword">(</span>esc<span class="keyword">)</span>
  <span class="keyword">in</span>
    <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#2061"><span class="dyncstuse">symenv_sub</span></a> <span class="keyword">(</span>esc<span class="keyword">,</span> Gamma<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> E1XPlet <span class="keyword">(</span>decs<span class="keyword">,</span> e<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span>Gamma1<span class="keyword">,</span> esc1<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#827"><span class="dyncstuse">trans_clo1_d1eclst</span></a> <span class="keyword">(</span>decs<span class="keyword">,</span> Gamma<span class="keyword">)</span>
    <span class="keyword">val</span> esc2 <span class="keyword">=</span> trans_clo1_e1xp <span class="keyword">(</span>e<span class="keyword">,</span> Gamma1<span class="keyword">)</span>
  <span class="keyword">in</span>
    <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#1967"><span class="dyncstuse">symenv_merge</span></a> <span class="keyword">(</span>esc1<span class="keyword">,</span> esc2<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> E1XPopr <span class="keyword">(</span>opr<span class="keyword">,</span> es<span class="keyword">)</span> <span class="keyword">=&gt;</span>
      <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#1489"><span class="dyncstuse">trans_clo1_e1xplst</span></a> <span class="keyword">(</span>es<span class="keyword">,</span> Gamma<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPproj <span class="keyword">(</span>e<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> trans_clo1_e1xp <span class="keyword">(</span>e<span class="keyword">,</span> Gamma<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPstr _ <span class="keyword">=&gt;</span> ctx_nil
  <span class="keyword">|</span> E1XPtup es <span class="keyword">=&gt;</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#1489"><span class="dyncstuse">trans_clo1_e1xplst</span></a> <span class="keyword">(</span>es<span class="keyword">,</span> Gamma<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPvar v <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> nam <span class="keyword">=</span> v<span class="keyword">.</span>v1ar_nam
    <span class="keyword">val</span> r <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#1711"><span class="dyncstuse">symenv_lookup</span></a> <span class="keyword">(</span>Gamma<span class="keyword">,</span> nam<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> r <span class="keyword">of</span>
    <span class="keyword">|</span> Some0 _ <span class="keyword">=&gt;</span> ctx_nil 
    <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> typ_opt <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2flibfunctions_2esats.html#1526"><span class="dyncstuse">libSymTypFind</span></a> <span class="keyword">(</span>nam<span class="keyword">)</span>  <span class="comment">// check library function
</span>    <span class="keyword">in</span>
      <span class="keyword">case+</span> typ_opt <span class="keyword">of</span>
      <span class="keyword">|</span> Some0 _ <span class="keyword">=&gt;</span> ctx_nil
      <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#1783"><span class="dyncstuse">symenv_insert</span></a> <span class="keyword">(</span>ctx_nil<span class="keyword">,</span> nam<span class="keyword">,</span> v<span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="comment">//  | E1XPfixclo _ =&gt; ETRACE_MSG_OPR ("trans_clo1_e1xp E1XPfixclo is found\n", ETRACE_LEVEL_ERROR,
</span><span class="comment">//                    abort (ERRORCODE_FORBIDDEN))
</span><span class="comment">//  | E1XPlamclo _ =&gt; ETRACE_MSG_OPR ("trans_clo1_e1xp E1XPlamclo is found\n", ETRACE_LEVEL_ERROR,
</span><span class="comment">//                    abort (ERRORCODE_FORBIDDEN))
</span><span class="keyword">end</span>

<span class="comment">(* extern fun trans_clo1_e1xplst (exps: e1xplst, Gamma: ctx): ctx *)</span>
<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#1489"><span class="dyncstimp">trans_clo1_e1xplst</span></a> <span class="keyword">(</span>exps<span class="keyword">,</span> Gamma<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> gamma1 <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2flist0_2esats.html#3829"><span class="dyncstuse">list0_fold_left&lt;</span></a><span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a></span><span class="keyword">&gt;&lt;</span><span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2022"><span class="stacstuse">e1xp</span></a></span><span class="keyword">&gt;</span> <span class="keyword">(</span>
    <span class="keyword">lam</span> <span class="keyword">(</span>init<span class="keyword">,</span> x<span class="keyword">)</span> <span class="keyword">=&gt;</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#1967"><span class="dyncstuse">symenv_merge</span></a> <span class="keyword">(</span>init<span class="keyword">,</span> trans_clo1_e1xp <span class="keyword">(</span>x<span class="keyword">,</span> Gamma<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> ctx_nil<span class="keyword">,</span> exps<span class="keyword">)</span>
<span class="keyword">in</span>
  gamma1
<span class="keyword">end</span>

<span class="comment">(* extern fun trans_clo1_d1eclst (decs: d1eclst, Gamma: ctx): (ctx, ctx) *)</span>
<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#827"><span class="dyncstimp">trans_clo1_d1eclst</span></a> <span class="keyword">(</span>decs<span class="keyword">,</span> Gamma<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> decs <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>dec<span class="keyword">,</span> decs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span>gamma1<span class="keyword">,</span> esc1<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#917"><span class="dyncstuse">trans_clo1_d1ec</span></a> <span class="keyword">(</span>dec<span class="keyword">,</span> Gamma<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span>gamma2<span class="keyword">,</span> esc2<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#827"><span class="dyncstuse">trans_clo1_d1eclst</span></a> <span class="keyword">(</span>decs1<span class="keyword">,</span> gamma1<span class="keyword">)</span>
    <span class="keyword">val</span> esc <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#1967"><span class="dyncstuse">symenv_merge</span></a> <span class="keyword">(</span>esc1<span class="keyword">,</span> esc2<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span>gamma2<span class="keyword">,</span> esc<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>Gamma<span class="keyword">,</span> ctx_nil<span class="keyword">)</span>

<span class="comment">(* extern fun trans_clo1_d1ec (dec: d1ec, Gamma: ctx): (ctx, ctx) *)</span>
<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#917"><span class="dyncstimp">trans_clo1_d1ec</span></a> <span class="keyword">(</span>dec<span class="keyword">,</span> Gamma<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> loc <span class="keyword">=</span> dec<span class="keyword">.</span>d1ec_loc
  <span class="keyword">val</span> dnode <span class="keyword">=</span> dec<span class="keyword">.</span>d1ec_node
  <span class="keyword">val+</span> D1ECval <span class="keyword">(</span>isrec<span class="keyword">,</span> valdecs<span class="keyword">)</span> <span class="keyword">=</span> dnode
<span class="keyword">in</span>
  <span class="keyword">if</span> isrec <span class="keyword">then</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#1060"><span class="dyncstuse">trans_clo1_v1aldeclst_rec</span></a> <span class="keyword">(</span>valdecs<span class="keyword">,</span> Gamma<span class="keyword">)</span>
           <span class="keyword">else</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#981"><span class="dyncstuse">trans_clo1_v1aldeclst</span></a> <span class="keyword">(</span>valdecs<span class="keyword">,</span> Gamma<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="comment">(* extern fun trans_clo1_v1aldeclst (valdecs: v1aldeclst, Gamma: ctx): (ctx, ctx) *)</span>
<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#981"><span class="dyncstimp">trans_clo1_v1aldeclst</span></a> <span class="keyword">(</span>valdecs<span class="keyword">,</span> Gamma<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> valdecs <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>valdec<span class="keyword">,</span> valdecs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span>gamma1<span class="keyword">,</span> esc1<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#1144"><span class="dyncstuse">trans_clo1_v1aldec</span></a> <span class="keyword">(</span>valdec<span class="keyword">,</span> Gamma<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span>gamma2<span class="keyword">,</span> esc2<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#981"><span class="dyncstuse">trans_clo1_v1aldeclst</span></a> <span class="keyword">(</span>valdecs1<span class="keyword">,</span> gamma1<span class="keyword">)</span>
    <span class="keyword">val</span> esc <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#1967"><span class="dyncstuse">symenv_merge</span></a> <span class="keyword">(</span>esc1<span class="keyword">,</span> esc2<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span>gamma2<span class="keyword">,</span> esc<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>Gamma<span class="keyword">,</span> ctx_nil<span class="keyword">)</span>


<span class="comment">(* extern fun trans_clo1_v1aldeclst_rec (valdecs: v1aldeclst, Gamma: ctx): (ctx, ctx) *)</span>
<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#1060"><span class="dyncstimp">trans_clo1_v1aldeclst_rec</span></a> <span class="keyword">(</span>valdecs<span class="keyword">,</span> Gamma<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">fun</span> collect_var <span class="keyword">(</span>valdecs<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2700"><span class="stacstuse">v1aldeclst</span></a></span><span class="keyword">,</span> ctx<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a></span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#579"><span class="stacstuse">ctx</span></a></span> <span class="keyword">=</span> 
    <span class="keyword">case+</span> valdecs <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>valdec<span class="keyword">,</span> valdecs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> v <span class="keyword">=</span> valdec<span class="keyword">.</span>v1aldec_var
      <span class="keyword">val</span> nam <span class="keyword">=</span> v<span class="keyword">.</span>v1ar_nam
      <span class="keyword">val</span> ctx <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#1783"><span class="dyncstuse">symenv_insert</span></a> <span class="keyword">(</span>ctx<span class="keyword">,</span> nam<span class="keyword">,</span> v<span class="keyword">)</span>
    <span class="keyword">in</span>
      collect_var <span class="keyword">(</span>valdecs1<span class="keyword">,</span> ctx<span class="keyword">)</span>
    <span class="keyword">end</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ctx

  <span class="keyword">val</span> vars_ctx <span class="keyword">=</span> collect_var <span class="keyword">(</span>valdecs<span class="keyword">,</span> ctx_nil<span class="keyword">)</span>
  
  <span class="keyword">val</span> Gamma1 <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#1967"><span class="dyncstuse">symenv_merge</span></a> <span class="keyword">(</span>Gamma<span class="keyword">,</span> vars_ctx<span class="keyword">)</span>
 
  <span class="comment">(* this esc is the env for the list of valdec *)</span>
  <span class="comment">(* These two Gamma1's should be same *)</span>
  <span class="keyword">val</span> <span class="keyword">(</span>Gamma1<span class="keyword">,</span> esc<span class="keyword">)</span> <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#981"><span class="dyncstuse">trans_clo1_v1aldeclst</span></a> <span class="keyword">(</span>valdecs<span class="keyword">,</span> Gamma1<span class="keyword">)</span>

  <span class="keyword">fun</span> closure_reset_env <span class="keyword">(</span>e1xp<span class="keyword">:</span> <span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2022"><span class="stacstuse">e1xp</span></a></span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#16468"><span class="stacstuse">void</span></a></span> <span class="keyword">=</span>
    <span class="keyword">case+</span>  e1xp<span class="keyword">.</span>e1xp_node <span class="keyword">of</span>
    <span class="keyword">|</span> E1XPann <span class="keyword">(</span>e1<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> closure_reset_env <span class="keyword">(</span>e1<span class="keyword">)</span>
    <span class="keyword">|</span> E1XPfix <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> _<span class="keyword">,</span> env_ref<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> env <span class="keyword">=</span> <span class="keyword">!</span>env_ref
      <span class="keyword">val</span> env <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2flist0_2esats.html#4772"><span class="dyncstuse">list0_map_fun&lt;</span></a><span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2299"><span class="stacstuse">v1ar</span></a></span><span class="keyword">&gt;&lt;</span> <span class="staexp"><span class="keyword">@(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#88"><span class="stacstuse">symbol_t</span></a><span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2299"><span class="stacstuse">v1ar</span></a><span class="keyword">)</span></span><span class="keyword">&gt;</span> <span class="keyword">(</span>
          env<span class="keyword">,</span> <span class="keyword">lam</span> x <span class="keyword">=&gt;</span> <span class="keyword">@(</span>x<span class="keyword">.</span>v1ar_nam<span class="keyword">,</span> x<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">val</span> env_ctx <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#1862"><span class="dyncstuse">symenv_inserts</span></a> <span class="keyword">(</span>ctx_nil<span class="keyword">,</span> env<span class="keyword">)</span>
      <span class="keyword">val</span> env1_ctx <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#2061"><span class="dyncstuse">symenv_sub</span></a> <span class="keyword">(</span>env_ctx<span class="keyword">,</span> vars_ctx<span class="keyword">)</span>
      <span class="keyword">val</span> env1 <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#2135"><span class="dyncstuse">symenv_listize</span></a> <span class="keyword">(</span>env1_ctx<span class="keyword">)</span>
      <span class="keyword">val</span> env1 <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2flist0_2esats.html#4772"><span class="dyncstuse">list0_map_fun&lt;</span></a> <span class="staexp"><span class="keyword">@(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#88"><span class="stacstuse">symbol_t</span></a><span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2299"><span class="stacstuse">v1ar</span></a><span class="keyword">)</span></span><span class="keyword">&gt;&lt;</span><span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2299"><span class="stacstuse">v1ar</span></a></span><span class="keyword">&gt;</span> <span class="keyword">(</span>
           env1<span class="keyword">,</span> <span class="keyword">lam</span> x <span class="keyword">=&gt;</span> x<span class="keyword">.</span>1<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">!</span>env_ref := env1
    <span class="keyword">end</span>
    <span class="keyword">|</span> E1XPlam <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">,</span> env_ref<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> env <span class="keyword">=</span> <span class="keyword">!</span>env_ref
      <span class="keyword">val</span> env <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2flist0_2esats.html#4772"><span class="dyncstuse">list0_map_fun&lt;</span></a><span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2299"><span class="stacstuse">v1ar</span></a></span><span class="keyword">&gt;&lt;</span> <span class="staexp"><span class="keyword">@(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#88"><span class="stacstuse">symbol_t</span></a><span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2299"><span class="stacstuse">v1ar</span></a><span class="keyword">)</span></span><span class="keyword">&gt;</span> <span class="keyword">(</span>
          env<span class="keyword">,</span> <span class="keyword">lam</span> x <span class="keyword">=&gt;</span> <span class="keyword">@(</span>x<span class="keyword">.</span>v1ar_nam<span class="keyword">,</span> x<span class="keyword">)</span><span class="keyword">)</span>
      <span class="keyword">val</span> env_ctx <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#1862"><span class="dyncstuse">symenv_inserts</span></a> <span class="keyword">(</span>ctx_nil<span class="keyword">,</span> env<span class="keyword">)</span>
      <span class="keyword">val</span> env1_ctx <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#2061"><span class="dyncstuse">symenv_sub</span></a> <span class="keyword">(</span>env_ctx<span class="keyword">,</span> vars_ctx<span class="keyword">)</span>
      <span class="keyword">val</span> env1 <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#2135"><span class="dyncstuse">symenv_listize</span></a> <span class="keyword">(</span>env1_ctx<span class="keyword">)</span>
      <span class="keyword">val</span> env1 <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2flist0_2esats.html#4772"><span class="dyncstuse">list0_map_fun&lt;</span></a> <span class="staexp"><span class="keyword">@(</span><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#88"><span class="stacstuse">symbol_t</span></a><span class="keyword">,</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2299"><span class="stacstuse">v1ar</span></a><span class="keyword">)</span></span><span class="keyword">&gt;&lt;</span><span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2299"><span class="stacstuse">v1ar</span></a></span><span class="keyword">&gt;</span> <span class="keyword">(</span>
           env1<span class="keyword">,</span> <span class="keyword">lam</span> x <span class="keyword">=&gt;</span> x<span class="keyword">.</span>1<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">!</span>env_ref := env1
    <span class="keyword">end</span>
    <span class="keyword">|</span> _ <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>

  <span class="comment">(* All the v1aldec_rec in the list have the same env. *)</span>
  <span class="keyword">val</span> _ <span class="keyword">=</span> <a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fSATS_2flist0_2esats.html#4848"><span class="dyncstuse">list0_map_cloref&lt;</span></a><span class="staexp"><a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans1_2esats.html#2607"><span class="stacstuse">v1aldec</span></a></span><span class="keyword">&gt;&lt;</span><span class="staexp"><a href="XREF/_2fscratch_2fprograms_2fats_5ftrunk_2fprelude_2fbasics_5fsta_2esats.html#15585"><span class="stacstuse">int</span></a></span><span class="keyword">&gt;</span>  <span class="comment">// todo use void instead of int
</span>    <span class="keyword">(</span>valdecs<span class="keyword">,</span> <span class="keyword">lam</span> valdec <span class="keyword">=&gt;</span> <span class="keyword">let</span> 
                  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> closure_reset_env <span class="keyword">(</span>valdec<span class="keyword">.</span>v1aldec_def<span class="keyword">)</span> 
                <span class="keyword">in</span> 0 <span class="keyword">end</span>
    <span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">(</span>Gamma1<span class="keyword">,</span> esc<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="comment">(* extern fun trans_clo1_v1aldec (valdec: v1aldec, Gamma: ctx): (ctx, ctx) *)</span>
<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2edats.html#1144"><span class="dyncstimp">trans_clo1_v1aldec</span></a> <span class="keyword">(</span>valdec<span class="keyword">,</span> Gamma<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> v <span class="keyword">=</span> valdec<span class="keyword">.</span>v1aldec_var
  <span class="keyword">val</span> e <span class="keyword">=</span> valdec<span class="keyword">.</span>v1aldec_def

  <span class="keyword">val</span> esc <span class="keyword">=</span> trans_clo1_e1xp <span class="keyword">(</span>e<span class="keyword">,</span> Gamma<span class="keyword">)</span>

  <span class="keyword">val</span> nam <span class="keyword">=</span> v<span class="keyword">.</span>v1ar_nam
  <span class="keyword">val</span> gamma <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#1783"><span class="dyncstuse">symenv_insert</span></a> <span class="keyword">(</span>Gamma<span class="keyword">,</span> nam<span class="keyword">,</span> v<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">(</span>gamma<span class="keyword">,</span> esc<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">implement</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2ftrans_5fclosure_2esats.html#70"><span class="dyncstimp">trans_closure</span></a> <span class="keyword">(</span>e1xp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> ctx <span class="keyword">=</span> trans_clo1_e1xp <span class="keyword">(</span>e1xp<span class="keyword">,</span> ctx_nil<span class="keyword">)</span>
  <span class="keyword">val</span> ctx <span class="keyword">=</span> <a href="XREF/_2fhome_2fgrad2_2faren_2fcourses_2fcs525_5fCompiler_2fassignment02_2fsymbol_2esats.html#2135"><span class="dyncstuse">symenv_listize</span></a> <span class="keyword">(</span>ctx<span class="keyword">)</span>
   <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">case+</span> ctx <span class="keyword">of</span>
            <span class="keyword">|</span> cons <span class="keyword">(</span>_<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>  <span class="comment">// fprint (stderr_ref, "000000000000000000000000000000000\n")
</span>            <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span><span class="keyword">)</span>  <span class="comment">// fprint (stderr_ref, "111111111111111111111111111111\n")
</span>  <span class="comment">// val e = trans_clo2_e1xp (e1xp, ctx_nil, nil)  // todo remove
</span><span class="keyword">in</span>
  e1xp
<span class="keyword">end</span>












































</pre>
</body>
</html>
