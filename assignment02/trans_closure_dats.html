<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    .atsyntax {color:#E80000;background-color:#E0E0E0}
    .atsyntax span.comment {color:#787878;font-style:italic}
    .atsyntax span.extern  {color:#A52A2A}
    .atsyntax span.keyword {color:#000000;font-weight:bold}
    .atsyntax span.neuexp  {color:#800080}
    .atsyntax span.staexp  {color:#0000FF}
    .atsyntax span.dynexp  {color:#E80000}
    .atsyntax span.prfexp  {color:#009000}
    .atsyntax span.stacstdec  {text-decoration:none}
    .atsyntax span.stacstuse  {color:#0000CF;text-decoration:underline}
    .atsyntax span.dyncstdec  {text-decoration:none}
    .atsyntax span.dyncstimp  {color:#B80000;text-decoration:underline}
    .atsyntax span.dyncstuse  {color:#B80000;text-decoration:underline}
    body {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre class="atsyntax">


<span class="keyword">staload</span> <span class="staexp">"trans_closure.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"trans1.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"symbol.sats"</span>
<span class="keyword">staload</span> <span class="staexp">"error.sats"</span>

<span class="keyword">typedef</span> <span class="staexp"><a name="105"><span class="stacstdec">loc <span class="keyword">=</span> $Posloc<span class="keyword">.</span>location_t</span></a></span>

<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anon*)</span> <span class="keyword">=</span> "symbol.dats"</span>

<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anon*)</span> <span class="keyword">=</span> "prelude/DATS/list.dats"</span> 
<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anon*)</span> <span class="keyword">=</span> "prelude/DATS/list0.dats"</span> 
<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anon*)</span> <span class="keyword">=</span> "prelude/DATS/list_vt.dats"</span> 
<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anon*)</span> <span class="keyword">=</span> "libats/DATS/funmap_avltree.dats"</span> 

<span class="keyword">staload</span> <span class="staexp">_<span class="comment">(*anon*)</span> <span class="keyword">=</span> "symbol.dats"</span>

<span class="keyword">#define</span> <span class="neuexp">:: list0_cons</span>
<span class="keyword">#define</span> <span class="neuexp">cons list0_cons</span>
<span class="keyword">#define</span> <span class="neuexp">nil list0_nil</span>

<span class="keyword">#define</span> <span class="neuexp">Some0 option0_some</span>
<span class="keyword">#define</span> <span class="neuexp">None0 option0_none</span>

<span class="comment">(* ****** ****** *)</span>
<span class="keyword">typedef</span> <span class="staexp"><a name="551"><span class="stacstdec">ctx <span class="keyword">=</span> symenv_t <span class="keyword">(</span>v1ar<span class="keyword">)</span></span></a></span>
<span class="keyword">val</span> ctx_nil <span class="keyword">=</span> symenv_make <span class="keyword">(</span><span class="keyword">)</span> <span class="comment">// empty context
</span>

<span class="keyword">fun</span> ctx2v1arlst <span class="keyword">(</span>Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">v1arlst</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> s <span class="keyword">=</span> symenv_listize <span class="keyword">(</span>Gamma<span class="keyword">)</span>
  <span class="keyword">val</span> symlst <span class="keyword">=</span> list0_map_fun&lt; <span class="staexp"><span class="keyword">@(</span>symbol_t<span class="keyword">,</span> v1ar<span class="keyword">)</span></span><span class="keyword">&gt;&lt;</span><span class="staexp">v1ar</span><span class="keyword">&gt;</span> <span class="keyword">(</span>s<span class="keyword">,</span> <span class="keyword">lam</span> x <span class="keyword">=&gt;</span> x<span class="keyword">.</span>1<span class="keyword">)</span>
<span class="keyword">in</span>
  symlst
<span class="keyword">end</span>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="799"><span class="dyncstdec">trans_clo1_d1eclst <span class="keyword">(</span>decs<span class="keyword">:</span> <span class="staexp">d1eclst</span><span class="keyword">,</span> Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>ctx<span class="comment">(*new gamma*)</span><span class="keyword">,</span> ctx<span class="comment">(*esc*)</span><span class="keyword">)</span></span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="889"><span class="dyncstdec">trans_clo1_d1ec <span class="keyword">(</span>dec<span class="keyword">:</span> <span class="staexp">d1ec</span><span class="keyword">,</span> Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>ctx<span class="keyword">,</span> ctx<span class="keyword">)</span></span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="953"><span class="dyncstdec">trans_clo1_v1aldeclst <span class="keyword">(</span>valdecs<span class="keyword">:</span> <span class="staexp">v1aldeclst</span><span class="keyword">,</span> Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>ctx<span class="keyword">,</span> ctx<span class="keyword">)</span></span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="1032"><span class="dyncstdec">trans_clo1_v1aldeclst_rec <span class="keyword">(</span>valdecs<span class="keyword">:</span> <span class="staexp">v1aldeclst</span><span class="keyword">,</span> Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>ctx<span class="keyword">,</span> ctx<span class="keyword">)</span></span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="1116"><span class="dyncstdec">trans_clo1_v1aldec <span class="keyword">(</span>valdec<span class="keyword">:</span> <span class="staexp">v1aldec</span><span class="keyword">,</span> Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>ctx<span class="keyword">,</span> ctx<span class="keyword">)</span></span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="1188"><span class="dyncstdec">trans_clo1_v1aldec_rec <span class="keyword">(</span>valdec<span class="keyword">:</span> <span class="staexp">v1aldec</span><span class="keyword">,</span> Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>ctx<span class="keyword">,</span> ctx<span class="keyword">)</span></span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="1265"><span class="dyncstdec">trans_clo1_e1xp <span class="keyword">(</span>exp<span class="keyword">:</span> <span class="staexp">e1xp</span><span class="keyword">,</span> Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">ctx</span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="1321"><span class="dyncstdec">trans_clo1_e1xplst <span class="keyword">(</span>exps<span class="keyword">:</span> <span class="staexp">e1xplst</span><span class="keyword">,</span> Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">ctx</span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="1385"><span class="dyncstdec">trans_clo1_valdecs <span class="keyword">(</span>valdecs<span class="keyword">:</span> <span class="staexp">v1aldeclst</span><span class="keyword">,</span> Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>ctx<span class="keyword">,</span> ctx<span class="keyword">)</span></span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="1461"><span class="dyncstdec">trans_clo1_e1xplst <span class="keyword">(</span>exps<span class="keyword">:</span> <span class="staexp">e1xplst</span><span class="keyword">,</span> Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">ctx</span></span></a>

<span class="comment">(* the return type is ctx,
  but actually we just need a list of symbols
*)</span>
<span class="keyword">fun</span> trans_clo1_e1xp <span class="keyword">(</span>exp<span class="keyword">:</span> <span class="staexp">e1xp</span><span class="keyword">,</span> Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">ctx</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> exp_node <span class="keyword">=</span> exp<span class="keyword">.</span>e1xp_node
<span class="keyword">in</span>
  <span class="keyword">case+</span> exp_node <span class="keyword">of</span>
  <span class="keyword">|</span> E1XPann <span class="keyword">(</span>e<span class="keyword">,</span> t<span class="keyword">)</span> <span class="keyword">=&gt;</span> trans_clo1_e1xp <span class="keyword">(</span>e<span class="keyword">,</span> Gamma<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPapp <span class="keyword">(</span>f<span class="keyword">,</span> args<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> esc1 <span class="keyword">=</span> trans_clo1_e1xp <span class="keyword">(</span>f<span class="keyword">,</span> Gamma<span class="keyword">)</span>
    <span class="keyword">val</span> esc2 <span class="keyword">=</span> trans_clo1_e1xp <span class="keyword">(</span>args<span class="keyword">,</span> Gamma<span class="keyword">)</span>
  <span class="keyword">in</span>
    symenv_merge <span class="keyword">(</span>esc1<span class="keyword">,</span> esc2<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> E1XPbool _ <span class="keyword">=&gt;</span> ctx_nil
  <span class="keyword">|</span> E1XPfix <span class="keyword">(</span>f<span class="keyword">,</span> args<span class="keyword">,</span> body<span class="keyword">,</span> ref_esc<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="comment">// val new_gamma = symenv_insert (ctx_nil, f.v1ar_nam, f)
</span>    <span class="comment">// todo: didn't put f into ctx, is this correct?
</span>    <span class="keyword">val</span> new_gamma <span class="keyword">=</span> ctx_nil
    <span class="keyword">val</span> sym_args <span class="keyword">=</span> list0_map_fun&lt;<span class="staexp">v1ar</span><span class="keyword">&gt;&lt;</span> <span class="staexp"><span class="keyword">@(</span>symbol_t<span class="keyword">,</span> v1ar<span class="keyword">)</span></span><span class="keyword">&gt;</span> <span class="keyword">(</span>
      args<span class="keyword">,</span> <span class="keyword">lam</span> x <span class="keyword">=&gt;</span> <span class="keyword">(</span>x<span class="keyword">.</span>v1ar_nam<span class="keyword">,</span> x<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">val</span> new_gamma <span class="keyword">=</span> symenv_inserts <span class="keyword">(</span>new_gamma<span class="keyword">,</span> sym_args<span class="keyword">)</span>
    <span class="keyword">val</span> esc <span class="keyword">=</span> trans_clo1_e1xp <span class="keyword">(</span>body<span class="keyword">,</span> new_gamma<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>ref_esc := ctx2v1arlst <span class="keyword">(</span>esc<span class="keyword">)</span>
  <span class="keyword">in</span>
    symenv_sub <span class="keyword">(</span>esc<span class="keyword">,</span> Gamma<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> E1XPif <span class="keyword">(</span>e_if<span class="keyword">,</span> e_then<span class="keyword">,</span> eo_else<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> esc1 <span class="keyword">=</span> trans_clo1_e1xp <span class="keyword">(</span>e_if<span class="keyword">,</span> Gamma<span class="keyword">)</span>
    <span class="keyword">val</span> esc2 <span class="keyword">=</span> trans_clo1_e1xp <span class="keyword">(</span>e_then<span class="keyword">,</span> Gamma<span class="keyword">)</span>
    <span class="keyword">val</span> esc3 <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> eo_else <span class="keyword">of</span>
                 <span class="keyword">|</span> Some0 e_else <span class="keyword">=&gt;</span> trans_clo1_e1xp <span class="keyword">(</span>e_else<span class="keyword">,</span> Gamma<span class="keyword">)</span>
                 <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ctx_nil
                 <span class="keyword">)</span>
    <span class="keyword">val</span> esc <span class="keyword">=</span> symenv_merge <span class="keyword">(</span>esc1<span class="keyword">,</span> esc2<span class="keyword">)</span>
    <span class="keyword">val</span> esc <span class="keyword">=</span> symenv_merge <span class="keyword">(</span>esc<span class="keyword">,</span> esc3<span class="keyword">)</span>
  <span class="keyword">in</span>
    esc
  <span class="keyword">end</span>
  <span class="keyword">|</span> E1XPint _ <span class="keyword">=&gt;</span> ctx_nil
  <span class="keyword">|</span> E1XPlam <span class="keyword">(</span>args<span class="keyword">,</span> body<span class="keyword">,</span> ref_esc<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> sym_args <span class="keyword">=</span> list0_map_fun&lt;<span class="staexp">v1ar</span><span class="keyword">&gt;&lt;</span> <span class="staexp"><span class="keyword">@(</span>symbol_t<span class="keyword">,</span> v1ar<span class="keyword">)</span></span><span class="keyword">&gt;</span> <span class="keyword">(</span>
      args<span class="keyword">,</span> <span class="keyword">lam</span> x <span class="keyword">=&gt;</span> <span class="keyword">(</span>x<span class="keyword">.</span>v1ar_nam<span class="keyword">,</span> x<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">val</span> new_gamma <span class="keyword">=</span> symenv_inserts <span class="keyword">(</span>ctx_nil<span class="keyword">,</span> sym_args<span class="keyword">)</span>
    <span class="keyword">val</span> esc <span class="keyword">=</span> trans_clo1_e1xp <span class="keyword">(</span>body<span class="keyword">,</span> new_gamma<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span>ref_esc := ctx2v1arlst <span class="keyword">(</span>esc<span class="keyword">)</span>
  <span class="keyword">in</span>
    symenv_sub <span class="keyword">(</span>esc<span class="keyword">,</span> Gamma<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> E1XPlet <span class="keyword">(</span>decs<span class="keyword">,</span> e<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span>Gamma1<span class="keyword">,</span> esc1<span class="keyword">)</span> <span class="keyword">=</span> trans_clo1_d1eclst <span class="keyword">(</span>decs<span class="keyword">,</span> Gamma<span class="keyword">)</span>
    <span class="keyword">val</span> esc2 <span class="keyword">=</span> trans_clo1_e1xp <span class="keyword">(</span>e<span class="keyword">,</span> Gamma1<span class="keyword">)</span>
  <span class="keyword">in</span>
    symenv_merge <span class="keyword">(</span>esc1<span class="keyword">,</span> esc2<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> E1XPopr <span class="keyword">(</span>opr<span class="keyword">,</span> es<span class="keyword">)</span> <span class="keyword">=&gt;</span>
      trans_clo1_e1xplst <span class="keyword">(</span>es<span class="keyword">,</span> Gamma<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPproj <span class="keyword">(</span>e<span class="keyword">,</span> _<span class="keyword">)</span> <span class="keyword">=&gt;</span> trans_clo1_e1xp <span class="keyword">(</span>e<span class="keyword">,</span> Gamma<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPstr _ <span class="keyword">=&gt;</span> ctx_nil
  <span class="keyword">|</span> E1XPtup es <span class="keyword">=&gt;</span> trans_clo1_e1xplst <span class="keyword">(</span>es<span class="keyword">,</span> Gamma<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPvar v <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> r <span class="keyword">=</span> symenv_lookup <span class="keyword">(</span>Gamma<span class="keyword">,</span> v<span class="keyword">.</span>v1ar_nam<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> r <span class="keyword">of</span>
    <span class="keyword">|</span> Some0 _ <span class="keyword">=&gt;</span> ctx_nil 
    <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> symenv_insert <span class="keyword">(</span>ctx_nil<span class="keyword">,</span> v<span class="keyword">.</span>v1ar_nam<span class="keyword">,</span> v<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> E1XPfixclo _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"trans_clo1_e1xp E1XPfixclo is found\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span>
                    abort <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">|</span> E1XPlamclo _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"trans_clo1_e1xp E1XPlamclo is found\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span>
                    abort <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span>

<span class="comment">(* extern fun trans_clo1_e1xplst (exps: e1xplst, Gamma: ctx): ctx *)</span>
<span class="keyword">implement</span> trans_clo1_e1xplst <span class="keyword">(</span>exps<span class="keyword">,</span> Gamma<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> gamma1 <span class="keyword">=</span> list0_fold_left&lt;<span class="staexp">ctx</span><span class="keyword">&gt;&lt;</span><span class="staexp">e1xp</span><span class="keyword">&gt;</span> <span class="keyword">(</span>
    <span class="keyword">lam</span> <span class="keyword">(</span>init<span class="keyword">,</span> x<span class="keyword">)</span> <span class="keyword">=&gt;</span> symenv_merge <span class="keyword">(</span>init<span class="keyword">,</span> trans_clo1_e1xp <span class="keyword">(</span>x<span class="keyword">,</span> Gamma<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> ctx_nil<span class="keyword">,</span> exps<span class="keyword">)</span>
<span class="keyword">in</span>
  gamma1
<span class="keyword">end</span>

<span class="comment">(* extern fun trans_clo1_d1eclst (decs: d1eclst, Gamma: ctx): (ctx, ctx) *)</span>
<span class="keyword">implement</span> trans_clo1_d1eclst <span class="keyword">(</span>decs<span class="keyword">,</span> Gamma<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> decs <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>dec<span class="keyword">,</span> decs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span>gamma1<span class="keyword">,</span> esc1<span class="keyword">)</span> <span class="keyword">=</span> trans_clo1_d1ec <span class="keyword">(</span>dec<span class="keyword">,</span> Gamma<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span>gamma2<span class="keyword">,</span> esc2<span class="keyword">)</span> <span class="keyword">=</span> trans_clo1_d1eclst <span class="keyword">(</span>decs1<span class="keyword">,</span> gamma1<span class="keyword">)</span>
    <span class="keyword">val</span> esc <span class="keyword">=</span> symenv_merge <span class="keyword">(</span>esc1<span class="keyword">,</span> esc2<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span>gamma2<span class="keyword">,</span> esc<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>Gamma<span class="keyword">,</span> ctx_nil<span class="keyword">)</span>

<span class="comment">(* extern fun trans_clo1_d1ec (dec: d1ec, Gamma: ctx): (ctx, ctx) *)</span>
<span class="keyword">implement</span> trans_clo1_d1ec <span class="keyword">(</span>dec<span class="keyword">,</span> Gamma<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> loc <span class="keyword">=</span> dec<span class="keyword">.</span>d1ec_loc
  <span class="keyword">val</span> dnode <span class="keyword">=</span> dec<span class="keyword">.</span>d1ec_node
  <span class="keyword">val+</span> D1ECval <span class="keyword">(</span>isrec<span class="keyword">,</span> valdecs<span class="keyword">)</span> <span class="keyword">=</span> dnode
<span class="keyword">in</span>
  <span class="keyword">if</span> isrec <span class="keyword">then</span> trans_clo1_v1aldeclst_rec <span class="keyword">(</span>valdecs<span class="keyword">,</span> Gamma<span class="keyword">)</span>
           <span class="keyword">else</span> trans_clo1_v1aldeclst <span class="keyword">(</span>valdecs<span class="keyword">,</span> Gamma<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="comment">(* extern fun trans_clo1_v1aldeclst (valdecs: v1aldeclst, Gamma: ctx): (ctx, ctx) *)</span>
<span class="keyword">implement</span> trans_clo1_v1aldeclst <span class="keyword">(</span>valdecs<span class="keyword">,</span> Gamma<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> valdecs <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>valdec<span class="keyword">,</span> valdecs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span>gamma1<span class="keyword">,</span> esc1<span class="keyword">)</span> <span class="keyword">=</span> trans_clo1_v1aldec <span class="keyword">(</span>valdec<span class="keyword">,</span> Gamma<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span>gamma2<span class="keyword">,</span> esc2<span class="keyword">)</span> <span class="keyword">=</span> trans_clo1_v1aldeclst <span class="keyword">(</span>valdecs1<span class="keyword">,</span> gamma1<span class="keyword">)</span>
    <span class="keyword">val</span> esc <span class="keyword">=</span> symenv_merge <span class="keyword">(</span>esc1<span class="keyword">,</span> esc2<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span>gamma2<span class="keyword">,</span> esc<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>Gamma<span class="keyword">,</span> ctx_nil<span class="keyword">)</span>


<span class="comment">(* extern fun trans_clo1_v1aldeclst_rec (valdecs: v1aldeclst, Gamma: ctx): (ctx, ctx) *)</span>
<span class="keyword">implement</span> trans_clo1_v1aldeclst_rec <span class="keyword">(</span>valdecs<span class="keyword">,</span> Gamma<span class="keyword">)</span> <span class="keyword">=</span>
  trans_clo1_v1aldeclst <span class="keyword">(</span>valdecs<span class="keyword">,</span> Gamma<span class="keyword">)</span>  <span class="comment">// todo is this correct?
</span>

<span class="comment">(* extern fun trans_clo1_v1aldec (valdec: v1aldec, Gamma: ctx): (ctx, ctx) *)</span>
<span class="keyword">implement</span> trans_clo1_v1aldec <span class="keyword">(</span>valdec<span class="keyword">,</span> Gamma<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> v <span class="keyword">=</span> valdec<span class="keyword">.</span>v1aldec_var
  <span class="keyword">val</span> e <span class="keyword">=</span> valdec<span class="keyword">.</span>v1aldec_def
  <span class="keyword">val</span> nam <span class="keyword">=</span> v<span class="keyword">.</span>v1ar_nam
  <span class="keyword">val</span> gamma <span class="keyword">=</span> symenv_insert <span class="keyword">(</span>Gamma<span class="keyword">,</span> nam<span class="keyword">,</span> v<span class="keyword">)</span>
  <span class="keyword">val</span> esc <span class="keyword">=</span> trans_clo1_e1xp <span class="keyword">(</span>e<span class="keyword">,</span> gamma<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">(</span>gamma<span class="keyword">,</span> esc<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="comment">(* extern fun trans_clo1_v1aldec_rec (valdec: v1aldec, Gamma: ctx): (ctx, ctx) *)</span>
<span class="keyword">implement</span> trans_clo1_v1aldec_rec <span class="keyword">(</span>valdec<span class="keyword">,</span> Gamma<span class="keyword">)</span> <span class="keyword">=</span> 
  trans_clo1_v1aldec <span class="keyword">(</span>valdec<span class="keyword">,</span> Gamma<span class="keyword">)</span> <span class="comment">// todo is this correct?
</span>

<span class="comment">(* *********** ************** *************** *)</span>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="6153"><span class="dyncstdec">trans_clo2_e1xp_fix <span class="keyword">(</span>f<span class="keyword">:</span> <span class="staexp">v1ar</span><span class="keyword">,</span> args<span class="keyword">:</span> <span class="staexp">v1arlst</span><span class="keyword">,</span> body<span class="keyword">:</span> <span class="staexp">e1xp</span><span class="keyword">,</span> 
  esc<span class="keyword">:</span> <span class="staexp">v1arlst</span><span class="keyword">,</span> Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp">v1arlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">e1xp_node</span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="6276"><span class="dyncstdec">trans_clo2_e1xp_lam <span class="keyword">(</span>args<span class="keyword">:</span> <span class="staexp">v1arlst</span><span class="keyword">,</span> body<span class="keyword">:</span> <span class="staexp">e1xp</span><span class="keyword">,</span> 
  esc<span class="keyword">:</span> <span class="staexp">v1arlst</span><span class="keyword">,</span> Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp">v1arlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">e1xp_node</span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="6390"><span class="dyncstdec">trans_clo2_d1eclst <span class="keyword">(</span>decs<span class="keyword">:</span> <span class="staexp">d1eclst</span><span class="keyword">,</span> 
  Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp">v1arlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>ctx<span class="comment">(*new gamma*)</span><span class="keyword">,</span> d1eclst<span class="keyword">)</span></span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="6494"><span class="dyncstdec">trans_clo2_d1ec <span class="keyword">(</span>dec<span class="keyword">:</span> <span class="staexp">d1ec</span><span class="keyword">,</span> 
  Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp">v1arlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>ctx<span class="keyword">,</span> d1ec<span class="keyword">)</span></span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="6576"><span class="dyncstdec">trans_clo2_v1aldeclst <span class="keyword">(</span>valdecs<span class="keyword">:</span> <span class="staexp">v1aldeclst</span><span class="keyword">,</span> 
  Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp">v1arlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>ctx<span class="keyword">,</span> v1aldeclst<span class="keyword">)</span></span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="6679"><span class="dyncstdec">trans_clo2_v1aldeclst_rec <span class="keyword">(</span>valdecs<span class="keyword">:</span> <span class="staexp">v1aldeclst</span><span class="keyword">,</span> 
  Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp">v1arlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>ctx<span class="keyword">,</span> v1aldeclst<span class="keyword">)</span></span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="6787"><span class="dyncstdec">trans_clo2_v1aldec <span class="keyword">(</span>valdec<span class="keyword">:</span> <span class="staexp">v1aldec</span><span class="keyword">,</span> 
  Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp">v1arlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>ctx<span class="keyword">,</span> v1aldec<span class="keyword">)</span></span></span></a>
<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="6880"><span class="dyncstdec">trans_clo2_v1aldec_rec <span class="keyword">(</span>valdec<span class="keyword">:</span> <span class="staexp">v1aldec</span><span class="keyword">,</span> 
  Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp">v1arlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">v1aldec</span></span></a>

<span class="keyword">extern</span> <span class="keyword">fun</span> <a name="6971"><span class="dyncstdec">trans_clo2_e1xplst <span class="keyword">(</span>exps<span class="keyword">:</span> <span class="staexp">e1xplst</span><span class="keyword">,</span>
  Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp">v1arlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">e1xplst</span></span></a>

<span class="comment">(* var list for the closure environment *)</span>
<span class="comment">(* Gamma: from function arguments and var declaration
   env: the closure info
*)</span>
<span class="keyword">fun</span> trans_clo2_e1xp <span class="keyword">(</span>exp<span class="keyword">:</span> <span class="staexp">e1xp</span><span class="keyword">,</span> Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp">v1arlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">e1xp</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> loc <span class="keyword">=</span> exp<span class="keyword">.</span>e1xp_loc
  <span class="keyword">val</span> node <span class="keyword">=</span> exp<span class="keyword">.</span>e1xp_node
  <span class="keyword">val</span> typ <span class="keyword">=</span> exp<span class="keyword">.</span>e1xp_typ
<span class="keyword">in</span>
  <span class="keyword">case+</span> node <span class="keyword">of</span>
  <span class="keyword">|</span> E1XPann <span class="keyword">(</span>e<span class="keyword">,</span> t<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> e <span class="keyword">=</span> trans_clo2_e1xp <span class="keyword">(</span>e<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">val</span> exp_node <span class="keyword">=</span> E1XPann <span class="keyword">(</span>e<span class="keyword">,</span> e<span class="keyword">.</span>e1xp_typ<span class="keyword">)</span>
  <span class="keyword">in</span>
    e1xp_make <span class="keyword">(</span>loc<span class="keyword">,</span> exp_node<span class="keyword">,</span> e<span class="keyword">.</span>e1xp_typ<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> E1XPapp <span class="keyword">(</span>f<span class="keyword">,</span> args<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> f <span class="keyword">=</span> trans_clo2_e1xp <span class="keyword">(</span>f<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">val</span> args <span class="keyword">=</span> trans_clo2_e1xp <span class="keyword">(</span>args<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">val</span> exp_node <span class="keyword">=</span> E1XPapp <span class="keyword">(</span>f<span class="keyword">,</span> args<span class="keyword">)</span>
  <span class="keyword">in</span>
    e1xp_make <span class="keyword">(</span>loc<span class="keyword">,</span> exp_node<span class="keyword">,</span> typ<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> E1XPbool _ <span class="keyword">=&gt;</span> e1xp_make <span class="keyword">(</span>loc<span class="keyword">,</span> node<span class="keyword">,</span> typ<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPfix <span class="keyword">(</span>f<span class="keyword">,</span> args<span class="keyword">,</span> body<span class="keyword">,</span> ref_esc<span class="keyword">)</span> <span class="keyword">=&gt;</span> 
    e1xp_make <span class="keyword">(</span>loc<span class="keyword">,</span> trans_clo2_e1xp_fix <span class="keyword">(</span>f<span class="keyword">,</span> args<span class="keyword">,</span> body<span class="keyword">,</span> <span class="keyword">!</span>ref_esc<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">,</span> typ<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPif <span class="keyword">(</span>e_if<span class="keyword">,</span> e_then<span class="keyword">,</span> eo_else<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> e_if <span class="keyword">=</span> trans_clo2_e1xp <span class="keyword">(</span>e_if<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">val</span> e_then <span class="keyword">=</span> trans_clo2_e1xp <span class="keyword">(</span>e_then<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">val</span> eo_else <span class="keyword">=</span> <span class="keyword">(</span><span class="keyword">case+</span> eo_else <span class="keyword">of</span>
                 <span class="keyword">|</span> Some0 e_else <span class="keyword">=&gt;</span> Some0 <span class="keyword">(</span>trans_clo2_e1xp <span class="keyword">(</span>e_else<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">)</span>
                 <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> None0 <span class="keyword">(</span><span class="keyword">)</span>
                 <span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>option0 e1xp<span class="keyword">)</span></span>
    <span class="keyword">val</span> exp_node <span class="keyword">=</span> E1XPif <span class="keyword">(</span>e_if<span class="keyword">,</span> e_then<span class="keyword">,</span> eo_else<span class="keyword">)</span>
  <span class="keyword">in</span>
    e1xp_make <span class="keyword">(</span>loc<span class="keyword">,</span> exp_node<span class="keyword">,</span> typ<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> E1XPint _ <span class="keyword">=&gt;</span> e1xp_make <span class="keyword">(</span>loc<span class="keyword">,</span> node<span class="keyword">,</span> typ<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPlam <span class="keyword">(</span>args<span class="keyword">,</span> body<span class="keyword">,</span> ref_esc<span class="keyword">)</span> <span class="keyword">=&gt;</span>
    e1xp_make <span class="keyword">(</span>loc<span class="keyword">,</span> trans_clo2_e1xp_lam <span class="keyword">(</span>args<span class="keyword">,</span> body<span class="keyword">,</span> <span class="keyword">!</span>ref_esc<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">,</span> typ<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPlet <span class="keyword">(</span>decs<span class="keyword">,</span> e<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span>gamma<span class="keyword">,</span> decs1<span class="keyword">)</span> <span class="keyword">=</span> trans_clo2_d1eclst <span class="keyword">(</span>decs<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">val</span> e1 <span class="keyword">=</span> trans_clo2_e1xp <span class="keyword">(</span>e<span class="keyword">,</span> gamma<span class="keyword">,</span> env<span class="keyword">)</span>
  <span class="keyword">in</span>
    e1xp_make <span class="keyword">(</span>loc<span class="keyword">,</span> E1XPlet <span class="keyword">(</span>decs1<span class="keyword">,</span> e1<span class="keyword">)</span><span class="keyword">,</span> typ<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> E1XPopr <span class="keyword">(</span>opr<span class="keyword">,</span> es<span class="keyword">)</span> <span class="keyword">=&gt;</span>
      e1xp_make <span class="keyword">(</span>loc<span class="keyword">,</span> 
                 E1XPopr <span class="keyword">(</span>opr<span class="keyword">,</span> trans_clo2_e1xplst <span class="keyword">(</span>es<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">,</span> 
                 typ<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPproj <span class="keyword">(</span>e<span class="keyword">,</span> i<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> e <span class="keyword">=</span> trans_clo2_e1xp <span class="keyword">(</span>e<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">val</span> exp_node <span class="keyword">=</span> E1XPproj <span class="keyword">(</span>e<span class="keyword">,</span> i<span class="keyword">)</span>
  <span class="keyword">in</span>
    e1xp_make <span class="keyword">(</span>loc<span class="keyword">,</span> exp_node<span class="keyword">,</span> typ<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> E1XPstr _ <span class="keyword">=&gt;</span> e1xp_make <span class="keyword">(</span>loc<span class="keyword">,</span> node<span class="keyword">,</span> typ<span class="keyword">)</span>
  <span class="keyword">|</span> E1XPtup es <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> es <span class="keyword">=</span> trans_clo2_e1xplst <span class="keyword">(</span>es<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span>
  <span class="keyword">in</span>
    e1xp_make <span class="keyword">(</span>loc<span class="keyword">,</span> E1XPtup es<span class="keyword">,</span> typ<span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> E1XPvar v <span class="keyword">=&gt;</span> <span class="keyword">let</span>  <span class="comment">// todo is this necessary?
</span>    <span class="keyword">val</span> vo1 <span class="keyword">=</span> symenv_lookup <span class="keyword">(</span>Gamma<span class="keyword">,</span> v<span class="keyword">.</span>v1ar_nam<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> vo1 <span class="keyword">of</span>
    <span class="keyword">|</span> Some0 v1 <span class="keyword">=&gt;</span> e1xp_make <span class="keyword">(</span>loc<span class="keyword">,</span> E1XPvar v1<span class="keyword">,</span> typ<span class="keyword">)</span>
    <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> vo2 <span class="keyword">=</span> list0_find_cloref&lt;<span class="staexp">v1ar</span><span class="keyword">&gt;</span> <span class="keyword">(</span>env<span class="keyword">,</span> <span class="keyword">lam</span> x <span class="keyword">=&gt;</span> x<span class="keyword">.</span>v1ar_nam <span class="keyword">=</span> v<span class="keyword">.</span>v1ar_nam<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">case+</span> vo2 <span class="keyword">of</span>
      <span class="keyword">|</span> Some0 v2 <span class="keyword">=&gt;</span> e1xp_make <span class="keyword">(</span>loc<span class="keyword">,</span> E1XPvar v2<span class="keyword">,</span> typ<span class="keyword">)</span>
      <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"trans_clo2_e1xp var not found\n"<span class="keyword">,</span> 
          ETRACE_LEVEL_ERROR<span class="keyword">,</span> abort <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> E1XPfixclo _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"trans_clo2_e1xp E1XPfixclo is found\n"<span class="keyword">,</span> 
          ETRACE_LEVEL_ERROR<span class="keyword">,</span> abort <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">|</span> E1XPlamclo _ <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"trans_clo2_e1xp E1XPlamclo is found\n"<span class="keyword">,</span> 
          ETRACE_LEVEL_ERROR<span class="keyword">,</span> abort <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span>

<span class="comment">(* extern fun trans_clo2_e1xp_fix (f: v1ar, args: v1arlst, body: e1xp, 
  esc: v1arlst, Gamma: ctx, env: v1arlst, loc: loc): e1xp
*)</span>
<span class="keyword">implement</span> trans_clo2_e1xp_fix <span class="keyword">(</span>f<span class="keyword">,</span> args<span class="keyword">,</span> body<span class="keyword">,</span> esc<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="comment">// put f into env
</span>  <span class="keyword">val</span> env' <span class="keyword">=</span> f :: env
  <span class="comment">(* find the v1ar in the Gamma or env based on name *)</span>
  <span class="keyword">fun</span> helper <span class="keyword">(</span>v<span class="keyword">:</span> <span class="staexp">v1ar</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp">v1ar</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> vopt1 <span class="keyword">=</span> symenv_lookup <span class="keyword">(</span>Gamma<span class="keyword">,</span> v<span class="keyword">.</span>v1ar_nam<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> vopt1 <span class="keyword">of</span>
    <span class="keyword">|</span> Some0 v1 <span class="keyword">=&gt;</span> v1
    <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> vopt2 <span class="keyword">=</span> list0_find_cloref&lt;<span class="staexp">v1ar</span><span class="keyword">&gt;</span> <span class="keyword">(</span>env'<span class="keyword">,</span> <span class="keyword">lam</span> x <span class="keyword">=&gt;</span> x<span class="keyword">.</span>v1ar_nam <span class="keyword">=</span> v<span class="keyword">.</span>v1ar_nam<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">case+</span> vopt2 <span class="keyword">of</span>
      <span class="keyword">|</span> Some0 v2 <span class="keyword">=&gt;</span> v2
      <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"trans_clo1_e1xp_fix var not found\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span>
                  abort <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  <span class="keyword">val</span> env1 <span class="keyword">=</span> list0_map_cloref&lt;<span class="staexp">v1ar</span><span class="keyword">&gt;&lt;</span><span class="staexp">v1ar</span><span class="keyword">&gt;</span> <span class="keyword">(</span>esc<span class="keyword">,</span> helper<span class="keyword">)</span>  <span class="comment">// f maybe inside env1
</span>
  <span class="keyword">val</span> Gamma1 <span class="keyword">=</span> symenv_inserts <span class="keyword">(</span>ctx_nil<span class="keyword">,</span> 
    list0_map_fun&lt;<span class="staexp">v1ar</span><span class="keyword">&gt;&lt;</span><span class="staexp"><span class="keyword">(</span>symbol_t<span class="keyword">,</span> v1ar<span class="keyword">)</span></span><span class="keyword">&gt;</span> <span class="keyword">(</span>args<span class="keyword">,</span> <span class="keyword">lam</span> x <span class="keyword">=&gt;</span> <span class="keyword">(</span>x<span class="keyword">.</span>v1ar_nam<span class="keyword">,</span> x<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span>

  <span class="keyword">val</span> body_exp <span class="keyword">=</span> trans_clo2_e1xp <span class="keyword">(</span>body<span class="keyword">,</span> Gamma1<span class="keyword">,</span> env1<span class="keyword">)</span>

  <span class="keyword">val</span> exp_node <span class="keyword">=</span> E1XPfixclo <span class="keyword">(</span>f<span class="keyword">,</span> args<span class="keyword">,</span> body_exp<span class="keyword">,</span> env1<span class="keyword">)</span>
<span class="keyword">in</span>
  exp_node
<span class="keyword">end</span>

<span class="comment">(* extern fun trans_clo2_e1xp_lam (args: v1arlst, body: e1xp, 
  esc: v1arlst, Gamma: ctx, env: v1arlst, loc: loc): e1xp
*)</span>
<span class="keyword">implement</span> trans_clo2_e1xp_lam <span class="keyword">(</span>args<span class="keyword">,</span> body<span class="keyword">,</span> esc<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="comment">(* find the v1ar in the Gamma or env based on name *)</span>
  <span class="keyword">fun</span> helper <span class="keyword">(</span>v<span class="keyword">:</span> <span class="staexp">v1ar</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp">v1ar</span> <span class="keyword">=</span> <span class="keyword">let</span>
    <span class="keyword">val</span> vopt1 <span class="keyword">=</span> symenv_lookup <span class="keyword">(</span>Gamma<span class="keyword">,</span> v<span class="keyword">.</span>v1ar_nam<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">case+</span> vopt1 <span class="keyword">of</span>
    <span class="keyword">|</span> Some0 v1 <span class="keyword">=&gt;</span> v1
    <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> vopt2 <span class="keyword">=</span> list0_find_cloref&lt;<span class="staexp">v1ar</span><span class="keyword">&gt;</span> <span class="keyword">(</span>env<span class="keyword">,</span> <span class="keyword">lam</span> x <span class="keyword">=&gt;</span> x<span class="keyword">.</span>v1ar_nam <span class="keyword">=</span> v<span class="keyword">.</span>v1ar_nam<span class="keyword">)</span>
    <span class="keyword">in</span>
      <span class="keyword">case+</span> vopt2 <span class="keyword">of</span>
      <span class="keyword">|</span> Some0 v2 <span class="keyword">=&gt;</span> v2
      <span class="keyword">|</span> None0 <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> ETRACE_MSG_OPR <span class="keyword">(</span>"trans_clo1_e1xp_fix var not found\n"<span class="keyword">,</span> ETRACE_LEVEL_ERROR<span class="keyword">,</span>
                  abort <span class="keyword">(</span>ERRORCODE_FORBIDDEN<span class="keyword">)</span><span class="keyword">)</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  <span class="keyword">val</span> env1 <span class="keyword">=</span> list0_map_cloref&lt;<span class="staexp">v1ar</span><span class="keyword">&gt;&lt;</span><span class="staexp">v1ar</span><span class="keyword">&gt;</span> <span class="keyword">(</span>esc<span class="keyword">,</span> helper<span class="keyword">)</span>

  <span class="keyword">val</span> Gamma1 <span class="keyword">=</span> symenv_inserts <span class="keyword">(</span>ctx_nil<span class="keyword">,</span> 
    list0_map_fun&lt;<span class="staexp">v1ar</span><span class="keyword">&gt;&lt;</span><span class="staexp"><span class="keyword">(</span>symbol_t<span class="keyword">,</span> v1ar<span class="keyword">)</span></span><span class="keyword">&gt;</span> <span class="keyword">(</span>args<span class="keyword">,</span> <span class="keyword">lam</span> x <span class="keyword">=&gt;</span> <span class="keyword">(</span>x<span class="keyword">.</span>v1ar_nam<span class="keyword">,</span> x<span class="keyword">)</span><span class="keyword">)</span><span class="keyword">)</span>

  <span class="keyword">val</span> body_exp <span class="keyword">=</span> trans_clo2_e1xp <span class="keyword">(</span>body<span class="keyword">,</span> Gamma1<span class="keyword">,</span> env1<span class="keyword">)</span>

  <span class="keyword">val</span> exp_node <span class="keyword">=</span> E1XPlamclo <span class="keyword">(</span>args<span class="keyword">,</span> body_exp<span class="keyword">,</span> env1<span class="keyword">)</span>
<span class="keyword">in</span>
  exp_node
<span class="keyword">end</span>

  
<span class="comment">(* extern fun trans_clo2_e1xplst (exps: e1xplst,
  Gamma: ctx, env: v1arlst): e1xplst *)</span>
<span class="keyword">implement</span> trans_clo2_e1xplst <span class="keyword">(</span>exps<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> exps <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>exp<span class="keyword">,</span> exps1<span class="keyword">)</span> <span class="keyword">=&gt;</span>
    cons <span class="keyword">(</span>trans_clo2_e1xp <span class="keyword">(</span>exp<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">,</span> trans_clo2_e1xplst <span class="keyword">(</span>exps1<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> nil <span class="keyword">(</span><span class="keyword">)</span>

<span class="comment">(* extern fun trans_clo2_d1eclst (decs: d1eclst, 
  Gamma: ctx, env: v1arlst): (ctx(*new gamma*), d1eclst) *)</span>
<span class="keyword">implement</span> trans_clo2_d1eclst <span class="keyword">(</span>decs<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> decs <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>dec<span class="keyword">,</span> decs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span>gamma1<span class="keyword">,</span> dec'<span class="keyword">)</span> <span class="keyword">=</span> trans_clo2_d1ec <span class="keyword">(</span>dec<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span>gamma2<span class="keyword">,</span> decs1'<span class="keyword">)</span> <span class="keyword">=</span> trans_clo2_d1eclst <span class="keyword">(</span>decs1<span class="keyword">,</span> gamma1<span class="keyword">,</span> env<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span>gamma2<span class="keyword">,</span> cons <span class="keyword">(</span>dec'<span class="keyword">,</span> decs1'<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>Gamma<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>


<span class="comment">(* extern fun trans_clo2_d1ec (dec: d1ec, 
  Gamma: ctx, env: v1arlst): (ctx, d1ec) *)</span>
<span class="keyword">implement</span> trans_clo2_d1ec <span class="keyword">(</span>dec<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> loc <span class="keyword">=</span> dec<span class="keyword">.</span>d1ec_loc
  <span class="keyword">val</span> dnode <span class="keyword">=</span> dec<span class="keyword">.</span>d1ec_node
  <span class="keyword">val+</span> D1ECval <span class="keyword">(</span>isrec<span class="keyword">,</span> valdecs<span class="keyword">)</span> <span class="keyword">=</span> dnode
  <span class="keyword">val</span> <span class="keyword">(</span>gamma<span class="keyword">,</span> valdecs1<span class="keyword">)</span> <span class="keyword">=</span> 
    <span class="keyword">if</span> isrec <span class="keyword">then</span> trans_clo2_v1aldeclst_rec <span class="keyword">(</span>valdecs<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span>
             <span class="keyword">else</span> trans_clo2_v1aldeclst <span class="keyword">(</span>valdecs<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">(</span>gamma<span class="keyword">,</span> d1ec_make_val <span class="keyword">(</span>loc<span class="keyword">,</span> isrec<span class="keyword">,</span> valdecs1<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span>

<span class="comment">(* extern fun trans_clo2_v1aldeclst (valdecs: v1aldeclst, 
  Gamma: ctx, env: v1arlst): (ctx, v1aldeclst) *)</span>
<span class="keyword">implement</span> trans_clo2_v1aldeclst <span class="keyword">(</span>valdecs<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span>
  <span class="keyword">case+</span> valdecs <span class="keyword">of</span>
  <span class="keyword">|</span> cons <span class="keyword">(</span>valdec<span class="keyword">,</span> valdecs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
    <span class="keyword">val</span> <span class="keyword">(</span>gamma1<span class="keyword">,</span> valdec'<span class="keyword">)</span> <span class="keyword">=</span> trans_clo2_v1aldec <span class="keyword">(</span>valdec<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">val</span> <span class="keyword">(</span>gamma2<span class="keyword">,</span> valdecs1'<span class="keyword">)</span> <span class="keyword">=</span> trans_clo2_v1aldeclst <span class="keyword">(</span>valdecs1<span class="keyword">,</span> gamma1<span class="keyword">,</span> env<span class="keyword">)</span>
  <span class="keyword">in</span>
    <span class="keyword">(</span>gamma2<span class="keyword">,</span> cons <span class="keyword">(</span>valdec'<span class="keyword">,</span> valdecs1'<span class="keyword">)</span><span class="keyword">)</span>
  <span class="keyword">end</span>
  <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">(</span>Gamma<span class="keyword">,</span> nil <span class="keyword">(</span><span class="keyword">)</span><span class="keyword">)</span>

<span class="comment">(* extern fun trans_clo2_v1aldeclst_rec (valdecs: v1aldeclst, 
  Gamma: ctx, env: v1arlst): (ctx, v1aldeclst) *)</span>
<span class="keyword">implement</span> trans_clo2_v1aldeclst_rec <span class="keyword">(</span>valdecs<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> vars <span class="keyword">=</span> list0_map_fun&lt;<span class="staexp">v1aldec</span><span class="keyword">&gt;&lt;</span><span class="staexp"><span class="keyword">(</span>symbol_t<span class="keyword">,</span> v1ar<span class="keyword">)</span></span><span class="keyword">&gt;</span> <span class="keyword">(</span>
    valdecs<span class="keyword">,</span> <span class="keyword">lam</span> x <span class="keyword">=&gt;</span> <span class="keyword">(</span>x<span class="keyword">.</span>v1aldec_var<span class="keyword">.</span>v1ar_nam<span class="keyword">,</span> x<span class="keyword">.</span>v1aldec_var<span class="keyword">)</span><span class="keyword">)</span>

  <span class="keyword">val</span> gamma <span class="keyword">=</span> symenv_inserts <span class="keyword">(</span>Gamma<span class="keyword">,</span> vars<span class="keyword">)</span>

  <span class="keyword">fun</span> trans_clo2_v1aldeclst_rec_impl <span class="keyword">(</span>valdecs<span class="keyword">:</span> <span class="staexp">v1aldeclst</span><span class="keyword">,</span> 
    Gamma<span class="keyword">:</span> <span class="staexp">ctx</span><span class="keyword">,</span> env<span class="keyword">:</span> <span class="staexp">v1arlst</span><span class="keyword">)</span><span class="keyword">:&lt;</span><span class="staexp">cloref1</span><span class="keyword">&gt;</span> <span class="staexp">v1aldeclst</span> <span class="keyword">=</span>
    <span class="keyword">case+</span> valdecs <span class="keyword">of</span>
    <span class="keyword">|</span> cons <span class="keyword">(</span>valdec<span class="keyword">,</span> valdecs1<span class="keyword">)</span> <span class="keyword">=&gt;</span> <span class="keyword">let</span>
      <span class="keyword">val</span> valdec' <span class="keyword">=</span> trans_clo2_v1aldec_rec <span class="keyword">(</span>valdec<span class="keyword">,</span> gamma<span class="keyword">,</span> env<span class="keyword">)</span>
      <span class="keyword">val</span> valdecs1' <span class="keyword">=</span> trans_clo2_v1aldeclst_rec_impl <span class="keyword">(</span>valdecs1<span class="keyword">,</span> gamma<span class="keyword">,</span> env<span class="keyword">)</span>
    <span class="keyword">in</span>
      cons <span class="keyword">(</span>valdec'<span class="keyword">,</span> valdecs1'<span class="keyword">)</span>
    <span class="keyword">end</span>
    <span class="keyword">|</span> nil <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=&gt;</span> nil <span class="keyword">(</span><span class="keyword">)</span>

  <span class="keyword">val</span> ret <span class="keyword">=</span> trans_clo2_v1aldeclst_rec_impl <span class="keyword">(</span>valdecs<span class="keyword">,</span> gamma<span class="keyword">,</span> env<span class="keyword">)</span> 
<span class="keyword">in</span>
  <span class="keyword">(</span>gamma<span class="keyword">,</span> ret<span class="keyword">)</span>  <span class="comment">// todo is this correct?
</span><span class="keyword">end</span>

<span class="comment">(* extern fun trans_clo2_v1aldec (valdec: v1aldec, 
  Gamma: ctx, env: v1arlst): (ctx, v1aldec) *)</span>
<span class="keyword">implement</span> trans_clo2_v1aldec <span class="keyword">(</span>valdec<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> loc <span class="keyword">=</span> valdec<span class="keyword">.</span>v1aldec_loc
  <span class="keyword">val</span> v <span class="keyword">=</span> valdec<span class="keyword">.</span>v1aldec_var
  <span class="keyword">val</span> def <span class="keyword">=</span> valdec<span class="keyword">.</span>v1aldec_def

  <span class="keyword">val</span> nam <span class="keyword">=</span> v<span class="keyword">.</span>v1ar_nam
  <span class="keyword">val</span> gamma <span class="keyword">=</span> symenv_insert <span class="keyword">(</span>Gamma<span class="keyword">,</span> nam<span class="keyword">,</span> v<span class="keyword">)</span>
  <span class="keyword">val</span> def' <span class="keyword">=</span> trans_clo2_e1xp <span class="keyword">(</span>def<span class="keyword">,</span> gamma<span class="keyword">,</span> env<span class="keyword">)</span>

  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span><span class="keyword">(</span>v<span class="keyword">.</span>v1ar_def<span class="keyword">)</span> := <span class="keyword">(</span>Some0 def'<span class="keyword">)</span>
<span class="keyword">in</span>
  <span class="keyword">(</span>gamma<span class="keyword">,</span> v1aldec_make <span class="keyword">(</span>loc<span class="keyword">,</span> v<span class="keyword">,</span> def'<span class="keyword">)</span><span class="keyword">)</span>
<span class="keyword">end</span>

<span class="comment">(* extern fun trans_clo2_v1aldec_rec (valdec: v1aldec, 
  Gamma: ctx, env: v1arlst): v1aldec *)</span>
<span class="keyword">implement</span> trans_clo2_v1aldec_rec <span class="keyword">(</span>valdec<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> loc <span class="keyword">=</span> valdec<span class="keyword">.</span>v1aldec_loc
  <span class="keyword">val</span> v <span class="keyword">=</span> valdec<span class="keyword">.</span>v1aldec_var
  <span class="keyword">val</span> def <span class="keyword">=</span> valdec<span class="keyword">.</span>v1aldec_def

  <span class="keyword">val</span> def' <span class="keyword">=</span> trans_clo2_e1xp <span class="keyword">(</span>def<span class="keyword">,</span> Gamma<span class="keyword">,</span> env<span class="keyword">)</span>

  <span class="keyword">val</span> <span class="keyword">(</span><span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">!</span><span class="keyword">(</span>v<span class="keyword">.</span>v1ar_def<span class="keyword">)</span> := <span class="keyword">(</span>Some0 def'<span class="keyword">)</span>
<span class="keyword">in</span>
  v1aldec_make <span class="keyword">(</span>loc<span class="keyword">,</span> v<span class="keyword">,</span> def'<span class="keyword">)</span>
<span class="keyword">end</span>

<span class="keyword">implement</span> trans_closure <span class="keyword">(</span>e1xp<span class="keyword">)</span> <span class="keyword">=</span> <span class="keyword">let</span>
  <span class="keyword">val</span> _ <span class="keyword">=</span> trans_clo1_e1xp <span class="keyword">(</span>e1xp<span class="keyword">,</span> ctx_nil<span class="keyword">)</span>
  <span class="keyword">val</span> e <span class="keyword">=</span> trans_clo2_e1xp <span class="keyword">(</span>e1xp<span class="keyword">,</span> ctx_nil<span class="keyword">,</span> nil<span class="keyword">)</span>
<span class="keyword">in</span>
  e
<span class="keyword">end</span>












































</pre>
</body>
</html>
