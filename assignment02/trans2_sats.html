<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title></title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <style type="text/css">
    .atsyntax {color:#E80000;background-color:#E0E0E0}
    .atsyntax span.comment {color:#787878;font-style:italic}
    .atsyntax span.extern  {color:#A52A2A}
    .atsyntax span.keyword {color:#000000;font-weight:bold}
    .atsyntax span.neuexp  {color:#800080}
    .atsyntax span.staexp  {color:#0000FF}
    .atsyntax span.dynexp  {color:#E80000}
    .atsyntax span.prfexp  {color:#009000}
    .atsyntax span.stacstdec  {text-decoration:none}
    .atsyntax span.stacstuse  {color:#0000CF;text-decoration:underline}
    .atsyntax span.dyncstdec  {text-decoration:none}
    .atsyntax span.dyncstimp  {color:#B80000;text-decoration:underline}
    .atsyntax span.dyncstuse  {color:#B80000;text-decoration:underline}
    body {color:#E80000;background-color:#E0E0E0}
  </style>
</head>
<body>
<pre class="atsyntax">
<span class="comment">(*
** CAS CS525, Spring 2011
** Instructor: Hongwei Xi
*)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span>
<span class="staexp">Posloc <span class="keyword">=</span> "contrib/parcomb/SATS/posloc.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span> <span class="staexp">Absyn <span class="keyword">=</span> "absyn.sats"</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">staload</span>
<span class="staexp">Trans1 <span class="keyword">=</span> "trans1.sats"</span>
<span class="keyword">typedef</span> <span class="staexp"><a name="244"><span class="stacstdec">e1xp <span class="keyword">=</span> $Trans1<span class="keyword">.</span>e1xp</span></a></span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* desc: type for temporary variable *)</span>
<span class="keyword">abstype</span> <span class="staexp"><a name="334"><span class="stacstdec">tmpvar_t</span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="351"><span class="stacstdec">tmpvar <span class="keyword">=</span> tmpvar_t</span></a></span>

<span class="keyword">fun</span> <a name="374"><span class="dyncstdec">tmpvar_get_name <span class="keyword">(</span>v<span class="keyword">:</span> <span class="staexp">tmpvar</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">string</span></span></a>

<span class="keyword">fun</span> <a name="415"><span class="dyncstdec">fprint_tmpvar <span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp">FILEref</span><span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp">tmpvar</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>
<span class="neuexp"><span class="keyword">overload</span> fprint <span class="keyword">with</span> fprint_tmpvar</span>
<span class="keyword">fun</span> <a name="500"><span class="dyncstdec">print_tmpvar <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp">tmpvar</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>
<span class="neuexp"><span class="keyword">overload</span> print <span class="keyword">with</span> print_tmpvar</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* desc: type for function label *)</span>
<span class="keyword">abstype</span> <span class="staexp"><a name="630"><span class="stacstdec">funlab_t</span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="647"><span class="stacstdec">funlab <span class="keyword">=</span> funlab_t</span></a></span>

<span class="keyword">fun</span> <a name="670"><span class="dyncstdec">fprint_funlab <span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp">FILEref</span><span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp">funlab</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>
<span class="neuexp"><span class="keyword">overload</span> fprint <span class="keyword">with</span> fprint_funlab</span>
<span class="keyword">fun</span> <a name="755"><span class="dyncstdec">print_funlab <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp">funlab</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>
<span class="neuexp"><span class="keyword">overload</span> print <span class="keyword">with</span> print_funlab</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* desc: type for function entry *)</span>
<span class="keyword">abstype</span> <span class="staexp"><a name="885"><span class="stacstdec">funent_t</span></a></span>
<span class="keyword">typedef</span> <span class="staexp"><a name="902"><span class="stacstdec">funent <span class="keyword">=</span> funent_t</span></a></span>

<span class="keyword">fun</span> <a name="925"><span class="dyncstdec">fprint_funent <span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp">FILEref</span><span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp">funent</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>
<span class="neuexp"><span class="keyword">overload</span> fprint <span class="keyword">with</span> fprint_funent</span>
<span class="keyword">fun</span> <a name="1010"><span class="dyncstdec">print_funent <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp">funent</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>
<span class="neuexp"><span class="keyword">overload</span> print <span class="keyword">with</span> print_funent</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* by Zhiqiang Ren ***** *)</span>
<span class="comment">(* valprim is either a literal value or
 * a tag for a temporary variable
 *)</span>
<span class="keyword">datatype</span> <span class="staexp"><a name="1232"><span class="stacstdec">valprim</span></a></span> <span class="keyword">=</span> <span class="comment">// primitive values
</span>  <span class="keyword">|</span> VParg <span class="keyword">of</span> <span class="staexp">int</span> <span class="comment">// function arguments: the ith argument
</span>  <span class="keyword">|</span> VPbool <span class="keyword">of</span> <span class="staexp">bool</span> <span class="comment">// boolean constants
</span>  <span class="keyword">|</span> VPfun <span class="keyword">of</span> <span class="staexp">funlab</span> <span class="comment">// function labels
</span>  <span class="keyword">|</span> VPint <span class="keyword">of</span> <span class="staexp">int</span> <span class="comment">// integer constants
</span>  <span class="keyword">|</span> VPstr <span class="keyword">of</span> <span class="staexp">string</span> <span class="comment">// string constants
</span>  <span class="keyword">|</span> VPtmp <span class="keyword">of</span> <span class="staexp">tmpvar</span> <span class="comment">// tmporaries
</span>  <span class="keyword">|</span> VPtup <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>tmpvar<span class="keyword">,</span> valprimlst<span class="keyword">)</span></span> <span class="comment">// (name of tuples, tuples)
</span>
<span class="comment">(*
** please extend the datatype if you need to
*)</span>
<span class="keyword">where</span> <span class="staexp"><a name="1630"><span class="stacstdec">valprimlst <span class="keyword">=</span> list0 <span class="keyword">(</span>valprim<span class="keyword">)</span></span></a></span>

<span class="keyword">fun</span> <a name="1664"><span class="dyncstdec">fprint_valprim <span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp">FILEref</span><span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp">valprim</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>
<span class="neuexp"><span class="keyword">overload</span> fprint <span class="keyword">with</span> fprint_valprim</span>

<span class="keyword">fun</span> <a name="1753"><span class="dyncstdec">fprint_valprimlst <span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp">FILEref</span><span class="keyword">,</span> xs<span class="keyword">:</span> <span class="staexp">valprimlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>
<span class="neuexp"><span class="keyword">overload</span> fprint <span class="keyword">with</span> fprint_valprimlst</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">datatype</span> <span class="staexp"><a name="1878"><span class="stacstdec">instr_node</span></a></span> <span class="keyword">=</span>
  <span class="keyword">|</span> INSTRcall <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>tmpvar<span class="keyword">,</span> valprim<span class="keyword">,</span> valprimlst<span class="keyword">,</span> bool<span class="comment">(*iswrapper*)</span><span class="keyword">)</span></span> <span class="comment">// fun call
</span>  <span class="comment">// conditional  // no return val, so no tmpvar
</span>  <span class="keyword">|</span> INSTRcond <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>tmpvar<span class="keyword">,</span> valprim<span class="keyword">,</span> instrlst<span class="keyword">,</span> instrlst<span class="keyword">)</span></span> 
  <span class="keyword">|</span> INSTRmove_val <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>tmpvar<span class="comment">(*x*)</span><span class="keyword">,</span> valprim<span class="comment">(*v*)</span><span class="keyword">)</span></span> <span class="comment">// x := v
</span>  <span class="keyword">|</span> INSTRopr <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>tmpvar<span class="keyword">,</span> $Absyn<span class="keyword">.</span>opr<span class="keyword">,</span> valprimlst<span class="keyword">)</span></span> <span class="comment">// primtive operator
</span>  <span class="keyword">|</span> INSTRtup <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>tmpvar<span class="keyword">,</span> valprimlst<span class="keyword">)</span></span> <span class="comment">// create tuple
</span>  <span class="keyword">|</span> INSTRproj <span class="keyword">of</span> <span class="staexp"><span class="keyword">(</span>tmpvar<span class="keyword">,</span> valprim<span class="keyword">,</span> int<span class="keyword">)</span></span> <span class="comment">// projection
</span>
<span class="keyword">where</span> <span class="staexp"><a name="2317"><span class="stacstdec">instr <span class="keyword">=</span> <span class="keyword">'{</span>
  instr_loc<span class="keyword">=</span> $Posloc<span class="keyword">.</span>location_t<span class="keyword">,</span> instr_node <span class="keyword">=</span> instr_node
<span class="keyword">}</span></span></a></span> <span class="comment">// end of [instr]
</span>
<span class="keyword">and</span> <span class="staexp"><a name="2410"><span class="stacstdec">instrlst <span class="keyword">=</span> list0 <span class="keyword">(</span>instr<span class="keyword">)</span></span></a></span>

<span class="keyword">fun</span> <a name="2440"><span class="dyncstdec">fprint_instr <span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp">FILEref</span><span class="keyword">,</span> x<span class="keyword">:</span> <span class="staexp">instr</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>
<span class="neuexp"><span class="keyword">overload</span> fprint <span class="keyword">with</span> fprint_instr</span>
<span class="keyword">fun</span> <a name="2522"><span class="dyncstdec">fprint_instrlst <span class="keyword">(</span>out<span class="keyword">:</span> <span class="staexp">FILEref</span><span class="keyword">,</span> xs<span class="keyword">:</span> <span class="staexp">instrlst</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>
<span class="neuexp"><span class="keyword">overload</span> fprint <span class="keyword">with</span> fprint_instrlst</span>

<span class="keyword">fun</span> <a name="2615"><span class="dyncstdec">print_instr <span class="keyword">(</span>x<span class="keyword">:</span> <span class="staexp">instr</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">void</span></span></a>
<span class="neuexp"><span class="keyword">overload</span> print <span class="keyword">with</span> print_instr</span>

<span class="comment">(* ****** ****** *)</span>

<span class="keyword">fun</span> <a name="2702"><span class="dyncstdec">trans2_exp <span class="keyword">(</span>e<span class="keyword">:</span> <span class="staexp">e1xp</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp"><span class="keyword">(</span>instrlst<span class="keyword">,</span> list0 funent_t<span class="keyword">)</span></span></span></a>

<span class="keyword">fun</span> <a name="2756"><span class="dyncstdec">funent_get_lab <span class="keyword">(</span>ent<span class="keyword">:</span> <span class="staexp">funent</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">funlab</span></span></a>
<span class="keyword">fun</span> <a name="2797"><span class="dyncstdec">funent_get_narg <span class="keyword">(</span>ent<span class="keyword">:</span> <span class="staexp">funent</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">int</span></span></a>
<span class="keyword">fun</span> <a name="2836"><span class="dyncstdec">funent_get_body <span class="keyword">(</span>ent<span class="keyword">:</span> <span class="staexp">funent</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">instrlst</span></span></a>
<span class="keyword">fun</span> <a name="2880"><span class="dyncstdec">funent_get_ret <span class="keyword">(</span>ent<span class="keyword">:</span> <span class="staexp">funent</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">valprim</span></span></a>

<span class="keyword">fun</span> <a name="2923"><span class="dyncstdec">funlab_get_name <span class="keyword">(</span>fl<span class="keyword">:</span> <span class="staexp">funlab</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">string</span></span></a>

<span class="keyword">val</span> <a name="2965"><span class="dyncstdec">mainlab<span class="keyword">:</span> <span class="staexp">funlab</span></span></a>

<span class="keyword">fun</span> <a name="2986"><span class="dyncstdec">funent_make_label <span class="keyword">(</span>
  fl<span class="keyword">:</span> <span class="staexp">funlab</span><span class="keyword">,</span> nargs<span class="keyword">:</span> <span class="staexp">int</span><span class="keyword">,</span> body<span class="keyword">:</span> <span class="staexp">instrlst</span><span class="keyword">,</span> ret<span class="keyword">:</span> <span class="staexp">valprim</span><span class="keyword">)</span><span class="keyword">:</span> <span class="staexp">funent</span></span></a>


<span class="comment">(* ****** ****** *)</span>

<span class="comment">(* end of [trans2.sats] *)</span>




</pre>
</body>
</html>
